{"Id": "74962335", "PostTypeId": "1", "AcceptedAnswerId": "75202550", "CreationDate": "2022-12-30T13:56:34.090", "Score": "1", "ViewCount": "332", "Body": "<p>I am trying to create an azure policy with terraform to add tags to resources.\nI want all the resources to inherit the resource group tags.</p>\n<p>I've been following documentations and examples here and there but I can't figure out how to have the tags being assigned on the resources.</p>\n<p>I think I am close, I do not want to write the tags in every single resources this is not sustainable.</p>\n<p>My code is separated in 3 different files:</p>\n<p><strong>main.tf</strong></p>\n<pre><code>terraform {\n  \n  required_providers {\n    azurerm = {\n      source = &quot;hashicorp/azurerm&quot;\n      version = &quot;=3.37.0&quot;\n    }\n    azuread = {\n      source  = &quot;hashicorp/azuread&quot;\n      version = &quot;2.31.0&quot;\n    }\n  }\n}\n\nprovider &quot;azurerm&quot; {\n    subscription_id = var.azure_subscription_id\n    tenant_id = var.azure_tenant_id\n  features {\n    resource_group {\n      prevent_deletion_if_contains_resources = false\n    }\n  }\n}\n\n#create azure resource group\nresource &quot;azurerm_resource_group&quot; &quot;rg&quot; {\n  name     = var.azure_rg_name\n  location = var.azure_resource_group_location\n  tags = {\n    costcenter = var.azure_costcenter\n    projectcode = var.azure_project_code\n    environment = var.azure_env_code\n    client = var.azure_client_code\n\n  }\n}\n#Create azure storage account\nresource &quot;azurerm_storage_account&quot; &quot;sa&quot; {\n  name                     = lower(&quot;${var.azure_project_code}${var.azure_env_code}sa01&quot;)\n  resource_group_name      = azurerm_resource_group.rg.name\n  location                 = var.azure_resource_group_location\n  account_tier             = &quot;Standard&quot;\n  account_replication_type = &quot;LRS&quot;\n}\n\n#Create container in previously created sa\nresource &quot;azurerm_storage_container&quot; &quot;ctnr2&quot; {\n  name                  = lower(&quot;${var.azure_project_code}${var.azure_env_code}tfstate01&quot;)\n  storage_account_name  = azurerm_storage_account.sa.name\n  container_access_type = &quot;private&quot;\n}\n\n#create azure policy definition\nresource &quot;azurerm_policy_definition&quot; &quot;az_pol_def&quot; {\n  name         = &quot;Append a tag and its value to resources&quot;\n  policy_type  = &quot;Custom&quot;\n  mode         = &quot;Indexed&quot;\n  display_name = &quot;Append a tag and its value to resources&quot;\n\n  metadata = jsonencode({\n    &quot;version&quot; : &quot;1.0.1&quot;,\n    &quot;category&quot; : &quot;Tags  &quot;\n    }\n  )\n  \n\n  policy_rule = jsonencode({\n      &quot;if&quot;: {\n        &quot;field&quot;: &quot;[concat('tags[', parameters('tagName'), ']')]&quot;,\n        &quot;exists&quot;: &quot;false&quot;\n      },\n      &quot;then&quot;: {\n        &quot;effect&quot;: &quot;append&quot;,\n        &quot;details&quot;: [\n          {\n            &quot;field&quot;: &quot;[concat('tags[', parameters('tagName'), ']')]&quot;,\n            &quot;value&quot;: &quot;[parameters('tagValue')]&quot;\n          }\n        ]\n      } \n  })\n}\n#assign azure policy created previously\nresource &quot;azurerm_resource_group_policy_assignment&quot; &quot;az_pol_assign&quot; {\n  name                 = &quot;Append a tag and its value to resources&quot;\n  resource_group_id    = azurerm_resource_group.rg.id\n  policy_definition_id = azurerm_policy_definition.az_pol_def.id\n\n  parameters = jsonencode({\n    &quot;parameters&quot;: {\n      &quot;tagName&quot;: {\n        &quot;type&quot;: &quot;String&quot;,\n        &quot;metadata&quot;: {\n          &quot;displayName&quot;: &quot;Tag Name&quot;,\n          &quot;description&quot;: &quot;Name of the tag, such as 'environment'&quot;\n        }\n      },\n      &quot;tagValue&quot;: {\n        &quot;type&quot;: &quot;String&quot;,\n        &quot;metadata&quot;: {\n          &quot;displayName&quot;: &quot;Tag Value&quot;,\n          &quot;description&quot;: &quot;Value of the tag, such as 'production'&quot;\n        }\n      }\n    },\n  })\n}\n</code></pre>\n<p><strong>variable.tf</strong></p>\n<pre><code>variable &quot;azure_resource_group_location&quot; {\n  default = &quot;west europe&quot;\n  description   = &quot;Location of the resource group.&quot;\n}\n\nvariable &quot;azure_subscription_id&quot; {\n  type        = string\n  description = &quot;Azure Subscription Id&quot;\n}\n\nvariable &quot;azure_tenant_id&quot; {\n  type        = string\n  description = &quot;Azure Tenant Id&quot;\n}\n\nvariable &quot;azure_rg_name&quot; {\n  type        = string\n  description = &quot;Azure Resource Group Name&quot;\n}\n\nvariable &quot;azure_costcenter&quot; {\n  type        = string\n  description = &quot;Azure Tag Cost Center&quot;\n}\n\nvariable &quot;azure_client_code&quot; {\n  type        = string\n  description = &quot;Azure Tag Client&quot;\n}\n\nvariable &quot;azure_project_code&quot; {\n  type        = string\n  description = &quot;Azure Tag Project Code&quot;\n}\n\nvariable &quot;azure_env_code&quot; {\n  type        = string\n  description = &quot;Azure Tag Environment Code&quot;\n}\n</code></pre>\n<p><strong>resource_group_name.tfvars</strong></p>\n<pre><code>#Azure tenant id\nazure_tenant_id =&quot;********-****-****-****-************&quot;\n#Azure subscription\nazure_subscription_id = &quot;********-****-****-****-************&quot;\n#Azure resource group location\nazure_resource_group_location = &quot;west europe&quot;\n#Azure RG name\nazure_rg_name = &quot;resource_group_name&quot;\n#Azure tag\nazure_costcenter = &quot;missions&quot;\n#Azure tag project code\nazure_project_code = &quot;test_project&quot;\n#Azure tag client code\nazure_client_code = &quot;leanne&quot;\n#Environement tag code :\nazure_env_code=&quot;dev&quot;\n</code></pre>\n<p>I understand that &quot;parameter_values&quot; should be used for my tags, but I'm not sure how?</p>\n<p>Here's an error message which might help.\n<a href=\"https://i.stack.imgur.com/V3LFk.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.stack.imgur.com/V3LFk.png\" alt=\"error message\" /></a></p>\n<p>Any help would be much appreciated.</p>\n<p>Thanks in advance !</p>\n", "OwnerUserId": "8014576", "LastEditorUserId": "8014576", "LastEditDate": "2022-12-30T14:23:01.623", "LastActivityDate": "2023-01-22T17:38:50.760", "Title": "Create Azure policy with Terraform", "Tags": "<json><azure><terraform><tags><azure-policy>", "AnswerCount": "1", "CommentCount": "0", "ContentLicense": "CC BY-SA 4.0", "history": [{"Id": "285230640", "PostHistoryTypeId": "2", "PostId": "74962335", "RevisionGUID": "328de6e7-e1b4-4a04-888c-f33441c281e3", "CreationDate": "2022-12-30T13:56:34.090", "UserId": "8014576", "Text": "I am trying to create an azure policy with terraform to add tags to resources.\r\nI want all the resources to inherit the resource group tags.\r\n\r\nI've been following documentations and examples here and there but I can't figure out how to have the tags being assigned on the resources.\r\n\r\nI think I am close, I do not want to write the tags in every single resources this is not sustainable.\r\n\r\nMy code is separated in 3 different files:\r\n\r\n**main.tf**\r\n\r\n    terraform {\r\n      \r\n      required_providers {\r\n        azurerm = {\r\n          source = \"hashicorp/azurerm\"\r\n          version = \"=3.37.0\"\r\n        }\r\n        azuread = {\r\n          source  = \"hashicorp/azuread\"\r\n          version = \"2.31.0\"\r\n        }\r\n      }\r\n    }\r\n    \r\n    provider \"azurerm\" {\r\n        subscription_id = var.azure_subscription_id\r\n        tenant_id = var.azure_tenant_id\r\n      features {\r\n        resource_group {\r\n          prevent_deletion_if_contains_resources = false\r\n        }\r\n      }\r\n    }\r\n    \r\n    #create azure resource group\r\n    resource \"azurerm_resource_group\" \"rg\" {\r\n      name     = var.azure_rg_name\r\n      location = var.azure_resource_group_location\r\n      tags = {\r\n        costcenter = var.azure_costcenter\r\n        projectcode = var.azure_project_code\r\n        environment = var.azure_env_code\r\n        client = var.azure_client_code\r\n    \r\n      }\r\n    }\r\n    #Create azure storage account\r\n    resource \"azurerm_storage_account\" \"sa\" {\r\n      name                     = lower(\"${var.azure_project_code}${var.azure_env_code}sa01\")\r\n      resource_group_name      = azurerm_resource_group.rg.name\r\n      location                 = var.azure_resource_group_location\r\n      account_tier             = \"Standard\"\r\n      account_replication_type = \"LRS\"\r\n    }\r\n    \r\n    #Create container in previously created sa\r\n    resource \"azurerm_storage_container\" \"ctnr2\" {\r\n      name                  = lower(\"${var.azure_project_code}${var.azure_env_code}tfstate01\")\r\n      storage_account_name  = azurerm_storage_account.sa.name\r\n      container_access_type = \"private\"\r\n    }\r\n    \r\n    #create azure policy definition\r\n    resource \"azurerm_policy_definition\" \"az_pol_def\" {\r\n      name         = \"Append a tag and its value to resources\"\r\n      policy_type  = \"Custom\"\r\n      mode         = \"Indexed\"\r\n      display_name = \"Append a tag and its value to resources\"\r\n    \r\n      metadata = jsonencode({\r\n        \"version\" : \"1.0.1\",\r\n        \"category\" : \"Tags  \"\r\n        }\r\n      )\r\n      \r\n    \r\n      policy_rule = jsonencode({\r\n          \"if\": {\r\n            \"field\": \"[concat('tags[', parameters('tagName'), ']')]\",\r\n            \"exists\": \"false\"\r\n          },\r\n          \"then\": {\r\n            \"effect\": \"append\",\r\n            \"details\": [\r\n              {\r\n                \"field\": \"[concat('tags[', parameters('tagName'), ']')]\",\r\n                \"value\": \"[parameters('tagValue')]\"\r\n              }\r\n            ]\r\n          } \r\n      })\r\n    }\r\n    #assign azure policy created previously\r\n    resource \"azurerm_resource_group_policy_assignment\" \"az_pol_assign\" {\r\n      name                 = \"Append a tag and its value to resources\"\r\n      resource_group_id    = azurerm_resource_group.rg.id\r\n      policy_definition_id = azurerm_policy_definition.az_pol_def.id\r\n    \r\n      parameters = jsonencode({\r\n        \"parameters\": {\r\n          \"tagName\": {\r\n            \"type\": \"String\",\r\n            \"metadata\": {\r\n              \"displayName\": \"Tag Name\",\r\n              \"description\": \"Name of the tag, such as 'environment'\"\r\n            }\r\n          },\r\n          \"tagValue\": {\r\n            \"type\": \"String\",\r\n            \"metadata\": {\r\n              \"displayName\": \"Tag Value\",\r\n              \"description\": \"Value of the tag, such as 'production'\"\r\n            }\r\n          }\r\n        },\r\n      })\r\n    }\r\n\r\n**variable.tf**\r\n\r\n    variable \"azure_resource_group_location\" {\r\n      default = \"west europe\"\r\n      description   = \"Location of the resource group.\"\r\n    }\r\n    \r\n    variable \"azure_subscription_id\" {\r\n      type        = string\r\n      description = \"Azure Subscription Id\"\r\n    }\r\n    \r\n    variable \"azure_tenant_id\" {\r\n      type        = string\r\n      description = \"Azure Tenant Id\"\r\n    }\r\n    \r\n    variable \"azure_rg_name\" {\r\n      type        = string\r\n      description = \"Azure Resource Group Name\"\r\n    }\r\n\r\n    variable \"azure_costcenter\" {\r\n      type        = string\r\n      description = \"Azure Tag Cost Center\"\r\n    }\r\n    \r\n    variable \"azure_client_code\" {\r\n      type        = string\r\n      description = \"Azure Tag Client\"\r\n    }\r\n    \r\n    variable \"azure_project_code\" {\r\n      type        = string\r\n      description = \"Azure Tag Project Code\"\r\n    }\r\n    \r\n    variable \"azure_env_code\" {\r\n      type        = string\r\n      description = \"Azure Tag Environment Code\"\r\n    }\r\n\r\n**resource_group_name.tfvars**\r\n\r\n    #Azure tenant id\r\n    azure_tenant_id =\"********-****-****-****-************\"\r\n    #Azure subscription\r\n    azure_subscription_id = \"********-****-****-****-************\"\r\n    #Azure resource group location\r\n    azure_resource_group_location = \"west europe\"\r\n    #Azure RG name\r\n    azure_rg_name = \"resource_group_name\"\r\n    #Azure tag\r\n    azure_costcenter = \"missions\"\r\n    #Azure tag project code\r\n    azure_project_code = \"test_project\"\r\n    #Azure tag client code\r\n    azure_client_code = \"leanne\"\r\n    #Environement tag code :\r\n    azure_env_code=\"dev\"\r\n \r\nI understand that \"parameter_values\" should be used for my tags, but I'm not sure how?\r\n\r\nAny help would be much appreciated.\r\n\r\nThanks in advance !", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "I am trying to create an azure policy with terraform to add tags to resources. ", "keywords": ["policy"]}, {"source": "Text", "text": "My code is separated in 3 different files: **main.tf** terraform { required_providers { azurerm = { source = \"hashicorp/azurerm\" version = \"=3.37.0\" } azuread = { source = \"hashicorp/azuread\" version = \"2.31.0\" } } } provider \"azurerm\" { subscription_id = var.azure_subscription_id tenant_id = var.azure_tenant_id features { resource_group { prevent_deletion_if_contains_resources = false } } } #create azure resource group resource \"azurerm_resource_group\" \"rg\" { name = var.azure_rg_name location = var.azure_resource_group_location tags = { costcenter = var.azure_costcenter projectcode = var.azure_project_code environment = var.azure_env_code client = var.azure_client_code } } #Create azure storage account resource \"azurerm_storage_account\" \"sa\" { name = lower(\"${var.azure_project_code}${var.azure_env_code}sa01\") resource_group_name = azurerm_resource_group.rg.name location = var.azure_resource_group_location account_tier = \"Standard\" account_replication_type = \"LRS\" } #Create container in previously created sa resource \"azurerm_storage_container\" \"ctnr2\" { name = lower(\"${var.azure_project_code}${var.azure_env_code}tfstate01\") storage_account_name = azurerm_storage_account.sa.name container_access_type = \"private\" } #create azure policy definition resource \"azurerm_policy_definition\" \"az_pol_def\" { name = \"Append a tag and its value to resources\" policy_type = \"Custom\" mode = \"Indexed\" display_name = \"Append a tag and its value to resources\" metadata = jsonencode({ \"version\" : \"1.0.1\", \"category\" : \"Tags \" } ) policy_rule = jsonencode({ \"if\": { \"field\": \"[concat('tags[', parameters('tagName'), ']')]\", \"exists\": \"false\" }, \"then\": { \"effect\": \"append\", \"details\": [ { \"field\": \"[concat('tags[', parameters('tagName'), ']')]\", \"value\": \"[parameters('tagValue')]\" } ] } }) } #assign azure policy created previously resource \"azurerm_resource_group_policy_assignment\" \"az_pol_assign\" { name = \"Append a tag and its value to resources\" resource_group_id = azurerm_resource_group.rg.id policy_definition_id = azurerm_policy_definition.az_pol_def.id parameters = jsonencode({ \"parameters\": { \"tagName\": { \"type\": \"String\", \"metadata\": { \"displayName\": \"Tag Name\", \"description\": \"Name of the tag, such as 'environment'\" } }, \"tagValue\": { \"type\": \"String\", \"metadata\": { \"displayName\": \"Tag Value\", \"description\": \"Value of the tag, such as 'production'\" } } }, }) } **variable.tf** variable \"azure_resource_group_location\" { default = \"west europe\" description = \"Location of the resource group.\" } variable \"azure_subscription_id\" { type = string description = \"Azure Subscription Id\" } variable \"azure_tenant_id\" { type = string description = \"Azure Tenant Id\" } variable \"azure_rg_name\" { type = string description = \"Azure Resource Group Name\" } variable \"azure_costcenter\" { type = string description = \"Azure Tag Cost Center\" } variable \"azure_client_code\" { type = string description = \"Azure Tag Client\" } variable \"azure_project_code\" { type = string description = \"Azure Tag Project Code\" } variable \"azure_env_code\" { type = string description = \"Azure Tag Environment Code\" } **resource_group_name.tfvars** #Azure tenant id azure_tenant_id =\"********-****-****-****-************\" #Azure subscription azure_subscription_id = \"********-****-****-****-************\" #Azure resource group location azure_resource_group_location = \"west europe\" #Azure RG name azure_rg_name = \"resource_group_name\" #Azure tag azure_costcenter = \"missions\" #Azure tag project code azure_project_code = \"test_project\" #Azure tag client code azure_client_code = \"leanne\" #Environement tag code : azure_env_code=\"dev\" I understand that \"parameter_values\" should be used for my tags, but I'm not sure how", "keywords": ["cost", "storage", "provider", "billing mode", "policy", "test"]}]}, {"Id": "285230642", "PostHistoryTypeId": "1", "PostId": "74962335", "RevisionGUID": "328de6e7-e1b4-4a04-888c-f33441c281e3", "CreationDate": "2022-12-30T13:56:34.090", "UserId": "8014576", "Text": "Create Azure policy with Terraform", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "Create Azure policy with Terraform", "keywords": ["policy"]}]}, {"Id": "285230643", "PostHistoryTypeId": "3", "PostId": "74962335", "RevisionGUID": "328de6e7-e1b4-4a04-888c-f33441c281e3", "CreationDate": "2022-12-30T13:56:34.090", "UserId": "8014576", "Text": "<json><azure><terraform><tags><azure-policy>", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "285231906", "PostHistoryTypeId": "5", "PostId": "74962335", "RevisionGUID": "9b8cc2fe-2a2c-42e4-8259-bf6a0c48e342", "CreationDate": "2022-12-30T14:23:01.623", "UserId": "8014576", "Comment": "added 119 characters in body", "Text": "I am trying to create an azure policy with terraform to add tags to resources.\r\nI want all the resources to inherit the resource group tags.\r\n\r\nI've been following documentations and examples here and there but I can't figure out how to have the tags being assigned on the resources.\r\n\r\nI think I am close, I do not want to write the tags in every single resources this is not sustainable.\r\n\r\nMy code is separated in 3 different files:\r\n\r\n**main.tf**\r\n\r\n    terraform {\r\n      \r\n      required_providers {\r\n        azurerm = {\r\n          source = \"hashicorp/azurerm\"\r\n          version = \"=3.37.0\"\r\n        }\r\n        azuread = {\r\n          source  = \"hashicorp/azuread\"\r\n          version = \"2.31.0\"\r\n        }\r\n      }\r\n    }\r\n    \r\n    provider \"azurerm\" {\r\n        subscription_id = var.azure_subscription_id\r\n        tenant_id = var.azure_tenant_id\r\n      features {\r\n        resource_group {\r\n          prevent_deletion_if_contains_resources = false\r\n        }\r\n      }\r\n    }\r\n    \r\n    #create azure resource group\r\n    resource \"azurerm_resource_group\" \"rg\" {\r\n      name     = var.azure_rg_name\r\n      location = var.azure_resource_group_location\r\n      tags = {\r\n        costcenter = var.azure_costcenter\r\n        projectcode = var.azure_project_code\r\n        environment = var.azure_env_code\r\n        client = var.azure_client_code\r\n    \r\n      }\r\n    }\r\n    #Create azure storage account\r\n    resource \"azurerm_storage_account\" \"sa\" {\r\n      name                     = lower(\"${var.azure_project_code}${var.azure_env_code}sa01\")\r\n      resource_group_name      = azurerm_resource_group.rg.name\r\n      location                 = var.azure_resource_group_location\r\n      account_tier             = \"Standard\"\r\n      account_replication_type = \"LRS\"\r\n    }\r\n    \r\n    #Create container in previously created sa\r\n    resource \"azurerm_storage_container\" \"ctnr2\" {\r\n      name                  = lower(\"${var.azure_project_code}${var.azure_env_code}tfstate01\")\r\n      storage_account_name  = azurerm_storage_account.sa.name\r\n      container_access_type = \"private\"\r\n    }\r\n    \r\n    #create azure policy definition\r\n    resource \"azurerm_policy_definition\" \"az_pol_def\" {\r\n      name         = \"Append a tag and its value to resources\"\r\n      policy_type  = \"Custom\"\r\n      mode         = \"Indexed\"\r\n      display_name = \"Append a tag and its value to resources\"\r\n    \r\n      metadata = jsonencode({\r\n        \"version\" : \"1.0.1\",\r\n        \"category\" : \"Tags  \"\r\n        }\r\n      )\r\n      \r\n    \r\n      policy_rule = jsonencode({\r\n          \"if\": {\r\n            \"field\": \"[concat('tags[', parameters('tagName'), ']')]\",\r\n            \"exists\": \"false\"\r\n          },\r\n          \"then\": {\r\n            \"effect\": \"append\",\r\n            \"details\": [\r\n              {\r\n                \"field\": \"[concat('tags[', parameters('tagName'), ']')]\",\r\n                \"value\": \"[parameters('tagValue')]\"\r\n              }\r\n            ]\r\n          } \r\n      })\r\n    }\r\n    #assign azure policy created previously\r\n    resource \"azurerm_resource_group_policy_assignment\" \"az_pol_assign\" {\r\n      name                 = \"Append a tag and its value to resources\"\r\n      resource_group_id    = azurerm_resource_group.rg.id\r\n      policy_definition_id = azurerm_policy_definition.az_pol_def.id\r\n    \r\n      parameters = jsonencode({\r\n        \"parameters\": {\r\n          \"tagName\": {\r\n            \"type\": \"String\",\r\n            \"metadata\": {\r\n              \"displayName\": \"Tag Name\",\r\n              \"description\": \"Name of the tag, such as 'environment'\"\r\n            }\r\n          },\r\n          \"tagValue\": {\r\n            \"type\": \"String\",\r\n            \"metadata\": {\r\n              \"displayName\": \"Tag Value\",\r\n              \"description\": \"Value of the tag, such as 'production'\"\r\n            }\r\n          }\r\n        },\r\n      })\r\n    }\r\n\r\n**variable.tf**\r\n\r\n    variable \"azure_resource_group_location\" {\r\n      default = \"west europe\"\r\n      description   = \"Location of the resource group.\"\r\n    }\r\n    \r\n    variable \"azure_subscription_id\" {\r\n      type        = string\r\n      description = \"Azure Subscription Id\"\r\n    }\r\n    \r\n    variable \"azure_tenant_id\" {\r\n      type        = string\r\n      description = \"Azure Tenant Id\"\r\n    }\r\n    \r\n    variable \"azure_rg_name\" {\r\n      type        = string\r\n      description = \"Azure Resource Group Name\"\r\n    }\r\n\r\n    variable \"azure_costcenter\" {\r\n      type        = string\r\n      description = \"Azure Tag Cost Center\"\r\n    }\r\n    \r\n    variable \"azure_client_code\" {\r\n      type        = string\r\n      description = \"Azure Tag Client\"\r\n    }\r\n    \r\n    variable \"azure_project_code\" {\r\n      type        = string\r\n      description = \"Azure Tag Project Code\"\r\n    }\r\n    \r\n    variable \"azure_env_code\" {\r\n      type        = string\r\n      description = \"Azure Tag Environment Code\"\r\n    }\r\n\r\n**resource_group_name.tfvars**\r\n\r\n    #Azure tenant id\r\n    azure_tenant_id =\"********-****-****-****-************\"\r\n    #Azure subscription\r\n    azure_subscription_id = \"********-****-****-****-************\"\r\n    #Azure resource group location\r\n    azure_resource_group_location = \"west europe\"\r\n    #Azure RG name\r\n    azure_rg_name = \"resource_group_name\"\r\n    #Azure tag\r\n    azure_costcenter = \"missions\"\r\n    #Azure tag project code\r\n    azure_project_code = \"test_project\"\r\n    #Azure tag client code\r\n    azure_client_code = \"leanne\"\r\n    #Environement tag code :\r\n    azure_env_code=\"dev\"\r\n \r\nI understand that \"parameter_values\" should be used for my tags, but I'm not sure how?\r\n\r\nHere's an error message which might help.\r\n[![error message][1]][1]\r\n\r\nAny help would be much appreciated.\r\n\r\nThanks in advance !\r\n\r\n\r\n  [1]: https://i.stack.imgur.com/V3LFk.png", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "I am trying to create an azure policy with terraform to add tags to resources. ", "keywords": ["policy"]}, {"source": "Text", "text": "My code is separated in 3 different files: **main.tf** terraform { required_providers { azurerm = { source = \"hashicorp/azurerm\" version = \"=3.37.0\" } azuread = { source = \"hashicorp/azuread\" version = \"2.31.0\" } } } provider \"azurerm\" { subscription_id = var.azure_subscription_id tenant_id = var.azure_tenant_id features { resource_group { prevent_deletion_if_contains_resources = false } } } #create azure resource group resource \"azurerm_resource_group\" \"rg\" { name = var.azure_rg_name location = var.azure_resource_group_location tags = { costcenter = var.azure_costcenter projectcode = var.azure_project_code environment = var.azure_env_code client = var.azure_client_code } } #Create azure storage account resource \"azurerm_storage_account\" \"sa\" { name = lower(\"${var.azure_project_code}${var.azure_env_code}sa01\") resource_group_name = azurerm_resource_group.rg.name location = var.azure_resource_group_location account_tier = \"Standard\" account_replication_type = \"LRS\" } #Create container in previously created sa resource \"azurerm_storage_container\" \"ctnr2\" { name = lower(\"${var.azure_project_code}${var.azure_env_code}tfstate01\") storage_account_name = azurerm_storage_account.sa.name container_access_type = \"private\" } #create azure policy definition resource \"azurerm_policy_definition\" \"az_pol_def\" { name = \"Append a tag and its value to resources\" policy_type = \"Custom\" mode = \"Indexed\" display_name = \"Append a tag and its value to resources\" metadata = jsonencode({ \"version\" : \"1.0.1\", \"category\" : \"Tags \" } ) policy_rule = jsonencode({ \"if\": { \"field\": \"[concat('tags[', parameters('tagName'), ']')]\", \"exists\": \"false\" }, \"then\": { \"effect\": \"append\", \"details\": [ { \"field\": \"[concat('tags[', parameters('tagName'), ']')]\", \"value\": \"[parameters('tagValue')]\" } ] } }) } #assign azure policy created previously resource \"azurerm_resource_group_policy_assignment\" \"az_pol_assign\" { name = \"Append a tag and its value to resources\" resource_group_id = azurerm_resource_group.rg.id policy_definition_id = azurerm_policy_definition.az_pol_def.id parameters = jsonencode({ \"parameters\": { \"tagName\": { \"type\": \"String\", \"metadata\": { \"displayName\": \"Tag Name\", \"description\": \"Name of the tag, such as 'environment'\" } }, \"tagValue\": { \"type\": \"String\", \"metadata\": { \"displayName\": \"Tag Value\", \"description\": \"Value of the tag, such as 'production'\" } } }, }) } **variable.tf** variable \"azure_resource_group_location\" { default = \"west europe\" description = \"Location of the resource group.\" } variable \"azure_subscription_id\" { type = string description = \"Azure Subscription Id\" } variable \"azure_tenant_id\" { type = string description = \"Azure Tenant Id\" } variable \"azure_rg_name\" { type = string description = \"Azure Resource Group Name\" } variable \"azure_costcenter\" { type = string description = \"Azure Tag Cost Center\" } variable \"azure_client_code\" { type = string description = \"Azure Tag Client\" } variable \"azure_project_code\" { type = string description = \"Azure Tag Project Code\" } variable \"azure_env_code\" { type = string description = \"Azure Tag Environment Code\" } **resource_group_name.tfvars** #Azure tenant id azure_tenant_id =\"********-****-****-****-************\" #Azure subscription azure_subscription_id = \"********-****-****-****-************\" #Azure resource group location azure_resource_group_location = \"west europe\" #Azure RG name azure_rg_name = \"resource_group_name\" #Azure tag azure_costcenter = \"missions\" #Azure tag project code azure_project_code = \"test_project\" #Azure tag client code azure_client_code = \"leanne\" #Environement tag code : azure_env_code=\"dev\" I understand that \"parameter_values\" should be used for my tags, but I'm not sure how? ", "keywords": ["cost", "storage", "provider", "billing mode", "policy", "test"]}]}], "answers": [{"Id": "75202550", "PostTypeId": "2", "ParentId": "74962335", "CreationDate": "2023-01-22T17:38:50.760", "Score": "1", "Body": "<p>You <em>declared</em> the policy parameters in the policy <em>assignment</em> (<code>az_pol_assign</code>).<br />\nInstead you should declare the parameters in the policy <em>definition</em> (<code>az_pol_def</code>).</p>\n<p>In your policy <em>assignment</em> you can then set the values that you want to pass as parameters:</p>\n<pre><code>#assign azure policy created previously\nresource &quot;azurerm_resource_group_policy_assignment&quot; &quot;az_pol_assign&quot; {\n  name                 = &quot;Append a tag and its value to resources&quot;\n  resource_group_id    = azurerm_resource_group.rg.id\n  policy_definition_id = azurerm_policy_definition.az_pol_def.id\n\n  parameters = jsonencode({\n    tagName = {\n      value = &quot;environment&quot;\n    },\n    tagValue = {\n      value = &quot;production&quot;\n    }\n  })\n}\n</code></pre>\n<p><strong>NOTE</strong> When you use <code>jsonencode()</code> you don't need to use plain JSON, you can use the simpler HashiCorp configuration language (HCL) syntax as I did in my example.</p>\n", "OwnerUserId": "3649441", "LastActivityDate": "2023-01-22T17:38:50.760", "CommentCount": "1", "ContentLicense": "CC BY-SA 4.0", "comments": [{"Id": "132863214", "PostId": "75202550", "Score": "1", "Text": "Thank you, I figured out how to fix my error thanks to your explainations.", "CreationDate": "2023-01-31T09:36:57.040", "UserId": "8014576", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "history": [{"Id": "286628951", "PostHistoryTypeId": "2", "PostId": "75202550", "RevisionGUID": "c416fece-fe57-4a90-963e-f7ed9b245452", "CreationDate": "2023-01-22T17:38:50.760", "UserId": "3649441", "Text": "You *declared* the policy parameters in the policy *assignment* (`az_pol_assign`).  \r\nInstead you should declare the parameters in the policy *definition* (`az_pol_def`).\r\n\r\nIn your policy *assignment* you can then set the values that you want to pass as parameters:\r\n\r\n```terraform\r\n#assign azure policy created previously\r\nresource \"azurerm_resource_group_policy_assignment\" \"az_pol_assign\" {\r\n  name                 = \"Append a tag and its value to resources\"\r\n  resource_group_id    = azurerm_resource_group.rg.id\r\n  policy_definition_id = azurerm_policy_definition.az_pol_def.id\r\n\r\n  parameters = jsonencode({\r\n    tagName = {\r\n      value = \"environment\"\r\n    },\r\n    tagValue = {\r\n      value = \"production\"\r\n    }\r\n  })\r\n}\r\n```\r\n\r\n**NOTE** When you use `jsonencode()` you don't need to use plain JSON, you can use the simpler HashiCorp configuration language (HCL) syntax as I did in my example.\r\n", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "You *declared* the policy parameters in the policy *assignment* (`az_pol_assign`). ", "keywords": ["policy"]}, {"source": "Text", "text": "Instead you should declare the parameters in the policy *definition* (`az_pol_def`). ", "keywords": ["policy"]}, {"source": "Text", "text": "In your policy *assignment* you can then set the values that you want to pass as parameters: ```terraform #assign azure policy created previously resource \"azurerm_resource_group_policy_assignment\" \"az_pol_assign\" { name = \"Append a tag and its value to resources\" resource_group_id = azurerm_resource_group.rg.id policy_definition_id = azurerm_policy_definition.az_pol_def.id parameters = jsonencode({ tagName = { value = \"environment\" }, tagValue = { value = \"production\" } }) } ``` ", "keywords": ["policy"]}]}], "filtered-sentences": [{"source": "Body", "text": "You declared the policy parameters in the policy assignment (az_pol_assign). ", "keywords": ["policy"]}, {"source": "Body", "text": "Instead you should declare the parameters in the policy definition (az_pol_def). ", "keywords": ["policy"]}, {"source": "Body", "text": "In your policy assignment you can then set the values that you want to pass as parameters: NOTE When you use jsonencode() you don't need to use plain JSON, you can use the simpler HashiCorp configuration language (HCL) syntax as I did in my example.", "keywords": ["policy"]}]}], "contains-topic": true, "filtered-sentences": [{"source": "Title", "text": "Create Azure policy with Terraform", "keywords": ["policy"]}, {"source": "Body", "text": "I am trying to create an azure policy with terraform to add tags to resources. ", "keywords": ["policy"]}]}