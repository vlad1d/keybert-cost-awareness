{"Id": "60699151", "PostTypeId": "1", "AcceptedAnswerId": "60725570", "CreationDate": "2020-03-16T00:53:12.277", "Score": "2", "ViewCount": "1582", "Body": "<p>I want to create custom images that are 4GB for cost-saving purposes on a side project. I've been able set the size for the Azure-provided Ubuntu 18.04 <strong>base</strong> image in Terraform successfully using the following:</p>\n\n<pre><code>resource \"azurerm_managed_disk\" \"example-disk\" {\n  ...\n  create_option = \"FromImage\"\n  disk_size_gb = \"4\"\n}\n\nresource \"azurerm_virtual_machine\" \"example\" {\n  ...\n  vm_size = \"Standard_B1s\"\n\n  storage_image_reference {\n    publisher = \"Canonical\"\n    offer = \"UbuntuServer\"\n    sku = \"18.04-LTS\"\n    version = \"latest\"\n  }\n\n  storage_os_disk {\n    name = azurerm_managed_disk.example-disk.name\n    managed_disk_id = azurerm_managed_disk.example-disk.id\n    create_option = \"Attach\"\n    caching = \"ReadWrite\"\n  }\n  ...\n}\n</code></pre>\n\n<p>So I tried making the following changes to use a custom Packer image that I had created from this Ubuntu base image (per the terraform-provider-azurerm docs using a managed disk + custom image not very straightforward, but that's neither here not there):</p>\n\n<pre><code>variable \"packer_image_id\" {}\n\nvariable \"packer_image_name\" {}\n\ndata \"azurerm_image\" \"custom\" {\n  ...\n  name = var.packer_image_name\n}\n\nresource \"azurerm_virtual_machine\" \"example\" {\n  ...\n  vm_size = \"Standard_B1s\"\n\n  delete_os_disk_on_termination = true\n\n  storage_image_reference {\n    id = data.azurerm_image.custom.id\n  }\n\n  storage_os_disk {\n    create_option = \"FromImage\"\n    caching = \"ReadWrite\"\n    disk_size_gb = \"4\"\n  }\n  ...\n}\n</code></pre>\n\n<p>When I make that change but I get the error:</p>\n\n<pre><code>Error: compute.VirtualMachinesClient#CreateOrUpdate: Failure sending request: StatusCode=0 -- Original Error: autorest/azure: Service returned an error. Status=&lt;nil&gt; Code=\"OperationNotAllowed\" Message=\"The specified disk size 4 GB is smaller than the size of the corresponding disk in the VM image: 30 GB. This is not allowed. Please choose equal or greater size or do not specify an explicit size.\" Target=\"osDisk.diskSizeGB\"\n</code></pre>\n\n<p>\"No big deal\", I thought, \"I'll just make the actual image 4GB\". So, I tried adding the line <code>\"os_disk_size_gb\": 4</code> to my Packer template:</p>\n\n<pre><code>{\n  \"variables\": [ ... ],\n  \"builders\": [\n    {\n      \"type\": \"azure-arm\",\n      \"client_id\": \"{{ user `azure_client_id` }}\",\n      \"client_secret\": \"{{ user `azure_client_secret` }}\",\n      \"subscription_id\": \"{{ user `azure_subscription_id` }}\",\n      \"tenant_id\": \"{{ user `azure_tenant_id` }}\",\n      \"location\": \"eastus2\",\n      \"vm_size\": \"Standard_B1s\",\n      \"os_type\": \"Linux\",\n      \"os_disk_size_gb\": 4,\n      \"image_publisher\": \"Canonical\",\n      \"image_offer\": \"UbuntuServer\",\n      \"image_sku\": \"18.04-LTS\",\n      \"ssh_username\": \"packer\",\n      \"managed_image_name\": \"example-{{ isotime \\\"20060102-150405\\\" }}\",\n      \"managed_image_resource_group_name\": \"packer-images\",\n      \"azure_tags\": {}\n    }\n  ],\n  \"provisioners\": [ ... (omitting for space: just a \"remote-exec\" that creates a new user, downloads Tomcat, and enables service) ]\n}\n</code></pre>\n\n<p>But I get this error:</p>\n\n<pre><code>==&gt; azure-arm: ERROR:   -&gt; OperationNotAllowed : The specified disk size 4 GB is smaller than the size of the corresponding disk in the VM image: 30 GB. This is not allowed. Please choose equal or greater size or do not specify an explicit size.\n</code></pre>\n\n<p>Removing both <code>disk_size_gb = \"4\"</code> from the Terraform plan and <code>\"os_disk_size_gb\": 4</code> from the Packer template results in successful image creation and deploy, but I'm running a 30GB VM disk which is way larger than what I need. Is there anything I'm missing here? Or it is just not possible to have have custom images in Azure less than 30GB using Packer + Terraform?</p>\n", "OwnerUserId": "2844863", "LastEditorUserId": "2844863", "LastEditDate": "2020-03-17T14:39:35.357", "LastActivityDate": "2020-03-17T15:36:59.703", "Title": "How do I create custom Azure images smaller than 30GB with Packer + Terraform?", "Tags": "<azure><terraform><packer><terraform-provider-azure>", "AnswerCount": "1", "CommentCount": "2", "ContentLicense": "CC BY-SA 4.0", "comments": [{"Id": "107393847", "PostId": "60699151", "Score": "0", "Text": "Provide the packer scripts and template.", "CreationDate": "2020-03-16T02:11:18.877", "UserId": "684908", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "107438401", "PostId": "60699151", "Score": "0", "Text": "@AndyShinn Added Packer template", "CreationDate": "2020-03-17T14:41:03.673", "UserId": "2844863", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "history": [{"Id": "216998616", "PostHistoryTypeId": "2", "PostId": "60699151", "RevisionGUID": "5d867d9a-7bf5-4437-a758-c201e8d8b400", "CreationDate": "2020-03-16T00:53:12.277", "UserId": "2844863", "Text": "I want to create custom images that are 4GB for cost-saving purposes on a side project. I've been able set the size for the Azure-provided Ubuntu 18.04 **base** image in Terraform successfully using the following:\r\n\r\n```\r\nresource \"azurerm_managed_disk\" \"example-disk\" {\r\n  ...\r\n  create_option = \"FromImage\"\r\n  disk_size_gb = \"4\"\r\n}\r\n\r\nresource \"azurerm_virtual_machine\" \"example\" {\r\n  ...\r\n  vm_size = \"Standard_B1s\"\r\n\r\n  storage_image_reference {\r\n    publisher = \"Canonical\"\r\n    offer = \"UbuntuServer\"\r\n    sku = \"18.04-LTS\"\r\n    version = \"latest\"\r\n  }\r\n\r\n  storage_os_disk {\r\n    name = azurerm_managed_disk.example-disk.name\r\n    managed_disk_id = azurerm_managed_disk.example-disk.id\r\n    create_option = \"Attach\"\r\n    caching = \"ReadWrite\"\r\n  }\r\n  ...\r\n}\r\n```\r\n\r\nSo I tried making the following changes to use a custom Packer image that I had created from this Ubuntu base image (per the terraform-provider-azurerm docs using a managed disk + custom image not very straightforward, but that's neither here not there):\r\n\r\n```\r\nvariable \"packer_image_id\" {}\r\n\r\nvariable \"packer_image_name\" {}\r\n\r\ndata \"azurerm_image\" \"custom\" {\r\n  ...\r\n  name = var.packer_image_name\r\n}\r\n\r\nresource \"azurerm_virtual_machine\" \"example\" {\r\n  ...\r\n  vm_size = \"Standard_B1s\"\r\n\r\n  delete_os_disk_on_termination = true\r\n\r\n  storage_image_reference {\r\n    id = data.azurerm_image.custom.id\r\n  }\r\n\r\n  storage_os_disk {\r\n    create_option = \"FromImage\"\r\n    caching = \"ReadWrite\"\r\n    disk_size_gb = \"4\"\r\n  }\r\n  ...\r\n}\r\n```\r\n\r\nWhen I make that change but I get the error:\r\n\r\n```\r\nError: compute.VirtualMachinesClient#CreateOrUpdate: Failure sending request: StatusCode=0 -- Original Error: autorest/azure: Service returned an error. Status=<nil> Code=\"OperationNotAllowed\" Message=\"The specified disk size 4 GB is smaller than the size of the corresponding disk in the VM image: 30 GB. This is not allowed. Please choose equal or greater size or do not specify an explicit size.\" Target=\"osDisk.diskSizeGB\"\r\n```\r\n\r\n\"No big deal\", I thought, \"I'll just make the actual image 4GB\". So, I tried adding the line ```\"os_disk_size_gb\": 4``` to my Packer template's builder section, but I get this error:\r\n\r\n```\r\n==> azure-arm: ERROR:   -> OperationNotAllowed : The specified disk size 4 GB is smaller than the size of the corresponding disk in the VM image: 30 GB. This is not allowed. Please choose equal or greater size or do not specify an explicit size.\r\n```\r\n\r\nRemoving both references to 4GB in the Packer template and the Terraform plan deploys successfully, but I have a 30GB VM disk which is way larger than what I need. Is there anything I'm missing here? Or it is just not possible to have have custom images in Azure less than 30GB using Packer + Terraform?", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "I want to create custom images that are 4GB for cost-saving purposes on a side project. ", "keywords": ["cost"]}, {"source": "Text", "text": "So I tried making the following changes to use a custom Packer image that I had created from this Ubuntu base image (per the terraform-provider-azurerm docs using a managed disk + custom image not very straightforward, but that's neither here not there): ``` variable \"packer_image_id\" {} variable \"packer_image_name\" {} data \"azurerm_image\" \"custom\" { ... name = var.packer_image_name } resource \"azurerm_virtual_machine\" \"example\" { ... vm_size = \"Standard_B1s\" delete_os_disk_on_termination = true storage_image_reference { id = data.azurerm_image.custom.id } storage_os_disk { create_option = \"FromImage\" caching = \"ReadWrite\" disk_size_gb = \"4\" } ... } ``` ", "keywords": ["provider", "change"]}, {"source": "Text", "text": "When I make that change but I get the error: ``` ", "keywords": ["change"]}]}, {"Id": "216998617", "PostHistoryTypeId": "1", "PostId": "60699151", "RevisionGUID": "5d867d9a-7bf5-4437-a758-c201e8d8b400", "CreationDate": "2020-03-16T00:53:12.277", "UserId": "2844863", "Text": "How do I create custom Azure images smaller than 30GB with Packer + Terraform?", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "216998618", "PostHistoryTypeId": "3", "PostId": "60699151", "RevisionGUID": "5d867d9a-7bf5-4437-a758-c201e8d8b400", "CreationDate": "2020-03-16T00:53:12.277", "UserId": "2844863", "Text": "<azure><terraform><packer><terraform-provider-azure>", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "217106402", "PostHistoryTypeId": "5", "PostId": "60699151", "RevisionGUID": "b3c527da-7153-4c13-9b4b-b8a344052486", "CreationDate": "2020-03-17T14:39:35.357", "UserId": "2844863", "Comment": "Added Packer template", "Text": "I want to create custom images that are 4GB for cost-saving purposes on a side project. I've been able set the size for the Azure-provided Ubuntu 18.04 **base** image in Terraform successfully using the following:\r\n\r\n```\r\nresource \"azurerm_managed_disk\" \"example-disk\" {\r\n  ...\r\n  create_option = \"FromImage\"\r\n  disk_size_gb = \"4\"\r\n}\r\n\r\nresource \"azurerm_virtual_machine\" \"example\" {\r\n  ...\r\n  vm_size = \"Standard_B1s\"\r\n\r\n  storage_image_reference {\r\n    publisher = \"Canonical\"\r\n    offer = \"UbuntuServer\"\r\n    sku = \"18.04-LTS\"\r\n    version = \"latest\"\r\n  }\r\n\r\n  storage_os_disk {\r\n    name = azurerm_managed_disk.example-disk.name\r\n    managed_disk_id = azurerm_managed_disk.example-disk.id\r\n    create_option = \"Attach\"\r\n    caching = \"ReadWrite\"\r\n  }\r\n  ...\r\n}\r\n```\r\n\r\nSo I tried making the following changes to use a custom Packer image that I had created from this Ubuntu base image (per the terraform-provider-azurerm docs using a managed disk + custom image not very straightforward, but that's neither here not there):\r\n\r\n```\r\nvariable \"packer_image_id\" {}\r\n\r\nvariable \"packer_image_name\" {}\r\n\r\ndata \"azurerm_image\" \"custom\" {\r\n  ...\r\n  name = var.packer_image_name\r\n}\r\n\r\nresource \"azurerm_virtual_machine\" \"example\" {\r\n  ...\r\n  vm_size = \"Standard_B1s\"\r\n\r\n  delete_os_disk_on_termination = true\r\n\r\n  storage_image_reference {\r\n    id = data.azurerm_image.custom.id\r\n  }\r\n\r\n  storage_os_disk {\r\n    create_option = \"FromImage\"\r\n    caching = \"ReadWrite\"\r\n    disk_size_gb = \"4\"\r\n  }\r\n  ...\r\n}\r\n```\r\n\r\nWhen I make that change but I get the error:\r\n\r\n```\r\nError: compute.VirtualMachinesClient#CreateOrUpdate: Failure sending request: StatusCode=0 -- Original Error: autorest/azure: Service returned an error. Status=<nil> Code=\"OperationNotAllowed\" Message=\"The specified disk size 4 GB is smaller than the size of the corresponding disk in the VM image: 30 GB. This is not allowed. Please choose equal or greater size or do not specify an explicit size.\" Target=\"osDisk.diskSizeGB\"\r\n```\r\n\r\n\"No big deal\", I thought, \"I'll just make the actual image 4GB\". So, I tried adding the line `\"os_disk_size_gb\": 4` to my Packer template:\r\n\r\n```\r\n{\r\n  \"variables\": [ ... ],\r\n  \"builders\": [\r\n    {\r\n      \"type\": \"azure-arm\",\r\n      \"client_id\": \"{{ user `azure_client_id` }}\",\r\n      \"client_secret\": \"{{ user `azure_client_secret` }}\",\r\n      \"subscription_id\": \"{{ user `azure_subscription_id` }}\",\r\n      \"tenant_id\": \"{{ user `azure_tenant_id` }}\",\r\n      \"location\": \"eastus2\",\r\n      \"vm_size\": \"Standard_B1s\",\r\n      \"os_type\": \"Linux\",\r\n      \"os_disk_size_gb\": 4,\r\n      \"image_publisher\": \"Canonical\",\r\n      \"image_offer\": \"UbuntuServer\",\r\n      \"image_sku\": \"18.04-LTS\",\r\n      \"ssh_username\": \"packer\",\r\n      \"managed_image_name\": \"example-{{ isotime \\\"20060102-150405\\\" }}\",\r\n      \"managed_image_resource_group_name\": \"packer-images\",\r\n      \"azure_tags\": {}\r\n    }\r\n  ],\r\n  \"provisioners\": [ ... (omitting for space: just a \"remote-exec\" that creates a new user, downloads Tomcat, and enables service) ]\r\n}\r\n```\r\n\r\nBut I get this error:\r\n\r\n```\r\n==> azure-arm: ERROR:   -> OperationNotAllowed : The specified disk size 4 GB is smaller than the size of the corresponding disk in the VM image: 30 GB. This is not allowed. Please choose equal or greater size or do not specify an explicit size.\r\n```\r\n\r\nRemoving both `disk_size_gb = \"4\"` from the Terraform plan and `\"os_disk_size_gb\": 4` from the Packer template results in successful image creation and deploy, but I'm running a 30GB VM disk which is way larger than what I need. Is there anything I'm missing here? Or it is just not possible to have have custom images in Azure less than 30GB using Packer + Terraform?", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "I want to create custom images that are 4GB for cost-saving purposes on a side project. ", "keywords": ["cost"]}, {"source": "Text", "text": "So I tried making the following changes to use a custom Packer image that I had created from this Ubuntu base image (per the terraform-provider-azurerm docs using a managed disk + custom image not very straightforward, but that's neither here not there): ``` variable \"packer_image_id\" {} variable \"packer_image_name\" {} data \"azurerm_image\" \"custom\" { ... name = var.packer_image_name } resource \"azurerm_virtual_machine\" \"example\" { ... vm_size = \"Standard_B1s\" delete_os_disk_on_termination = true storage_image_reference { id = data.azurerm_image.custom.id } storage_os_disk { create_option = \"FromImage\" caching = \"ReadWrite\" disk_size_gb = \"4\" } ... } ``` ", "keywords": ["provider", "change"]}, {"source": "Text", "text": "When I make that change but I get the error: ``` ", "keywords": ["change"]}]}], "answers": [{"Id": "60725570", "PostTypeId": "2", "ParentId": "60699151", "CreationDate": "2020-03-17T15:36:59.703", "Score": "3", "Body": "<p>This is not a packer restriction but rather an restriction of Azure with regards to the base image. Those image files can be as small as 1 GB, but the default Ubuntu image has a 30GB OS disk. And you can't create a VM with a disk smaller than the base image.</p>\n\n<p><a href=\"https://docs.azure.cn/en-us/articles/azure-marketplace/imageguide#3-\" rel=\"nofollow noreferrer\">https://docs.azure.cn/en-us/articles/azure-marketplace/imageguide#3-</a></p>\n\n<blockquote>\n  <p>VHD image files must be between 1GB and 1TB in size.</p>\n</blockquote>\n\n<p>You probably need to create the whole image from scratch if you want to go below 30GB. See e.g. <a href=\"https://docs.azure.cn/en-us/articles/azure-marketplace/imagecreateonlocal\" rel=\"nofollow noreferrer\">https://docs.azure.cn/en-us/articles/azure-marketplace/imagecreateonlocal</a></p>\n", "OwnerUserId": "336378", "LastActivityDate": "2020-03-17T15:36:59.703", "CommentCount": "1", "ContentLicense": "CC BY-SA 4.0", "comments": [{"Id": "108006598", "PostId": "60725570", "Score": "0", "Text": "Thanks for the clarification. It turns out my initial assumption was also incorrect: I thought that I was able to provision a VM using the base Ubuntu image at 4GB just fine. Perhaps it was ignored or just silently erroring while the infrastructure was running, because after I destroyed and re-applied it fails and doesn't allow the 4GB.", "CreationDate": "2020-04-05T23:25:33.783", "UserId": "2844863", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "history": [{"Id": "217110555", "PostHistoryTypeId": "2", "PostId": "60725570", "RevisionGUID": "f28b3f54-92d5-45b2-8700-a38d6ce47db8", "CreationDate": "2020-03-17T15:36:59.703", "UserId": "336378", "Text": "This is not a packer restriction but rather an restriction of Azure with regards to the base image. Those image files can be as small as 1 GB, but the default Ubuntu image has a 30GB OS disk. And you can't create a VM with a disk smaller than the base image.\r\n\r\nhttps://docs.azure.cn/en-us/articles/azure-marketplace/imageguide#3-\r\n\r\n> VHD image files must be between 1GB and 1TB in size.\r\n\r\nYou probably need to create the whole image from scratch if you want to go below 30GB. See e.g. https://docs.azure.cn/en-us/articles/azure-marketplace/imagecreateonlocal", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "filtered-sentences": []}], "contains-topic": true, "filtered-sentences": [{"source": "Body", "text": "I want to create custom images that are 4GB for cost-saving purposes on a side project. ", "keywords": ["cost"]}, {"source": "Body", "text": "I've been able set the size for the Azure-provided Ubuntu 18.04 base image in Terraform successfully using the following: So I tried making the following changes to use a custom Packer image that I had created from this Ubuntu base image (per the terraform-provider-azurerm docs using a managed disk + custom image not very straightforward, but that's neither here not there): When I make that change but I get the error: \"No big deal\", I thought, \"I'll just make the actual image 4GB\". ", "keywords": ["provider", "change"]}]}