{"Id": "62666287", "PostTypeId": "1", "AcceptedAnswerId": "62673248", "CreationDate": "2020-06-30T21:17:15.390", "Score": "-1", "ViewCount": "2645", "Body": "<p>I have a terraform script for creating a virtual network and subnets in azure. The code inherits a module which has the  both creation of vnet and subnet. I am trying to create a VNET and two subnet, but want to enable service end point for a specific subnet only. <strong>Need help on how to do it</strong></p>\n<pre><code>module &quot;vnet&quot; { \n        source                          = &quot;./modules/VirtualNetwork&quot;\n        VirtualNetwork_Name             = &quot;${var.prefix}-${var.resource_group_name}-VNET1&quot;\n        Resource_Group_Name             = azurerm_resource_group.resource_group.name\n        Location                        = azurerm_resource_group.resource_group.location\n        VirtualNetwork_AddressSpace     = [&quot;10.4.0.0/23&quot;]\n        Subnet_Name                     = [&quot;snet-1&quot;,&quot;snet-2&quot;]\n        Subnet_Addresses                = [&quot;10.4.0.0/24&quot;,&quot;10.4.1.0/24&quot;]\n       \n        Service_Endpoints               = vnet.Subnet_Name == &quot;snet-1&quot; ? [&quot;Microsoft.AzureCosmosDB&quot;] : [&quot;&quot;]\n   \nif subnet==&quot;snet-1&quot; then [&quot;Microsoft.AzureCosmosDB&quot;] else [&quot;nothing&quot;]\n\n        Tags                            = {\n                                                environment     = &quot;prod&quot;\n                                                resource        = &quot;VNET&quot;\n                                                cost_center     = &quot;Test Cost Ceneter&quot;\n                                            }                       \n\n}\n</code></pre>\n<p>The below code is for network module</p>\n<pre><code># Creates the virtual network for the resources\nresource &quot;azurerm_virtual_network&quot; &quot;vnet&quot; {\n\n  name                = var.VirtualNetwork_Name\n  location            = var.Location\n  resource_group_name = var.Resource_Group_Name\n  address_space       = var.VirtualNetwork_AddressSpace\n  tags                = var.Tags\n}\n\n\n\n# Create two subnet for the vnet\nresource &quot;azurerm_subnet&quot; &quot;subnet&quot; {\n\n  name                    = var.Subnet_Name[count.index]\n  address_prefix          = var.Subnet_Addresses[count.index]\n  resource_group_name     = var.Resource_Group_Name\n  virtual_network_name    = azurerm_virtual_network.vnet.name\n  count                   = length(var.Subnet_Name)\n  # service_endpoints       = [&quot;Microsoft.AzureCosmosDB&quot;]\n  service_endpoints       = var.Service_Endpoints\n}\n</code></pre>\n", "OwnerUserId": "1752280", "LastEditorUserId": "1752280", "LastEditDate": "2020-06-30T21:27:10.863", "LastActivityDate": "2020-07-03T08:56:57.343", "Title": "Terraform conditional creation of Service endpoint for a subnet", "Tags": "<azure><terraform><azure-virtual-network><terraform-provider-azure>", "AnswerCount": "2", "CommentCount": "2", "ContentLicense": "CC BY-SA 4.0", "comments": [{"Id": "110822080", "PostId": "62666287", "Score": "0", "Text": "What is your issue exactly? you can't find documentation around that? You deployment throws errors ?", "CreationDate": "2020-06-30T22:19:23.197", "UserId": "4167200", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "110830357", "PostId": "62666287", "Score": "0", "Text": "@thomas , if you read the question, u will understand what i am asking  I am trying to create a VNET and two subnet, but want to enable service end point for a specific subnet only. Need help on how to do it", "CreationDate": "2020-07-01T07:35:44.253", "UserId": "1752280", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "history": [{"Id": "225611269", "PostHistoryTypeId": "2", "PostId": "62666287", "RevisionGUID": "f855999b-cabc-46a4-bdcb-1261f2a84442", "CreationDate": "2020-06-30T21:17:15.390", "UserId": "1752280", "Text": "I have a terraform script for creating a virtual network and subnets in azure. The code inherits a module which has the  both creation of vnet and subnet. I am trying to create a VNET and two subnet, but want to enable service end point for a specific subnet only. **Need help on how to do it**\r\n\r\n        module \"vnet\" { \r\n            source                          = \"./modules/VirtualNetwork\"\r\n            VirtualNetwork_Name             = \"${var.prefix}-${var.resource_group_name}-VNET1\"\r\n            Resource_Group_Name             = azurerm_resource_group.resource_group.name\r\n            Location                        = azurerm_resource_group.resource_group.location\r\n            VirtualNetwork_AddressSpace     = [\"10.4.0.0/23\"]\r\n            Subnet_Name                     = [\"snet-1\",\"snet-2\"]\r\n            Subnet_Addresses                = [\"10.4.0.0/24\",\"10.4.1.0/24\"]\r\n            ***Service_Endpoints               = <how do it do it for  a specific network >***\r\n       \r\n            Tags                            = {\r\n                                                    environment     = \"prod\"\r\n                                                    resource        = \"VNET\"\r\n                                                    cost_center     = \"Test Cost Ceneter\"\r\n                                                }                       \r\n    \r\n    }\r\n\r\nThe below code is for network module\r\n\r\n    # Creates the virtual network for the resources\r\n    resource \"azurerm_virtual_network\" \"vnet\" {\r\n    \r\n      name                = var.VirtualNetwork_Name\r\n      location            = var.Location\r\n      resource_group_name = var.Resource_Group_Name\r\n      address_space       = var.VirtualNetwork_AddressSpace\r\n      tags                = var.Tags\r\n    }\r\n    \r\n    \r\n    \r\n    # Create two subnet for the vnet\r\n    resource \"azurerm_subnet\" \"subnet\" {\r\n    \r\n      name                    = var.Subnet_Name[count.index]\r\n      address_prefix          = var.Subnet_Addresses[count.index]\r\n      resource_group_name     = var.Resource_Group_Name\r\n      virtual_network_name    = azurerm_virtual_network.vnet.name\r\n      count                   = length(var.Subnet_Name)\r\n      # service_endpoints       = [\"Microsoft.AzureCosmosDB\"]\r\n      service_endpoints       = var.Service_Endpoints\r\n    }\r\n\r\n\r\n\r\n", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "**Need help on how to do it** module \"vnet\" { source = \"./modules/VirtualNetwork\" VirtualNetwork_Name = \"${var.prefix}-${var.resource_group_name}-VNET1\" Resource_Group_Name = azurerm_resource_group.resource_group.name Location = azurerm_resource_group.resource_group.location VirtualNetwork_AddressSpace = [\"10.4.0.0/23\"] Subnet_Name = [\"snet-1\",\"snet-2\"] Subnet_Addresses = [\"10.4.0.0/24\",\"10.4.1.0/24\"] ***Service_Endpoints = *** Tags = { environment = \"prod\" resource = \"VNET\" cost_center = \"Test Cost Ceneter\" } } The below code is for network module # Creates the virtual network for the resources resource \"azurerm_virtual_network\" \"vnet\" { name = var.VirtualNetwork_Name location = var.Location resource_group_name = var.Resource_Group_Name address_space = var.VirtualNetwork_AddressSpace tags = var.Tags } # Create two subnet for the vnet resource \"azurerm_subnet\" \"subnet\" { name = var.Subnet_Name[count.index] address_prefix = var.Subnet_Addresses[count.index] resource_group_name = var.Resource_Group_Name virtual_network_name = azurerm_virtual_network.vnet.name count = length(var.Subnet_Name) # service_endpoints = [\"Microsoft.AzureCosmosDB\"] service_endpoints = var.Service_Endpoints }", "keywords": ["cost", "test"]}]}, {"Id": "225611270", "PostHistoryTypeId": "1", "PostId": "62666287", "RevisionGUID": "f855999b-cabc-46a4-bdcb-1261f2a84442", "CreationDate": "2020-06-30T21:17:15.390", "UserId": "1752280", "Text": "Terraform conditional creation of Service endpoint for a subnet", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "225611271", "PostHistoryTypeId": "3", "PostId": "62666287", "RevisionGUID": "f855999b-cabc-46a4-bdcb-1261f2a84442", "CreationDate": "2020-06-30T21:17:15.390", "UserId": "1752280", "Text": "<azure><terraform><azure-virtual-network><terraform-provider-azure>", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "225611739", "PostHistoryTypeId": "5", "PostId": "62666287", "RevisionGUID": "0a7be77c-0eb5-46ce-823a-0e564e79a9c6", "CreationDate": "2020-06-30T21:27:10.863", "UserId": "1752280", "Comment": "added 71 characters in body", "Text": "I have a terraform script for creating a virtual network and subnets in azure. The code inherits a module which has the  both creation of vnet and subnet. I am trying to create a VNET and two subnet, but want to enable service end point for a specific subnet only. **Need help on how to do it**\r\n\r\n    module \"vnet\" { \r\n            source                          = \"./modules/VirtualNetwork\"\r\n            VirtualNetwork_Name             = \"${var.prefix}-${var.resource_group_name}-VNET1\"\r\n            Resource_Group_Name             = azurerm_resource_group.resource_group.name\r\n            Location                        = azurerm_resource_group.resource_group.location\r\n            VirtualNetwork_AddressSpace     = [\"10.4.0.0/23\"]\r\n            Subnet_Name                     = [\"snet-1\",\"snet-2\"]\r\n            Subnet_Addresses                = [\"10.4.0.0/24\",\"10.4.1.0/24\"]\r\n           \r\n            Service_Endpoints               = vnet.Subnet_Name == \"snet-1\" ? [\"Microsoft.AzureCosmosDB\"] : [\"\"]\r\n       \r\n    if subnet==\"snet-1\" then [\"Microsoft.AzureCosmosDB\"] else [\"nothing\"]\r\n    \r\n            Tags                            = {\r\n                                                    environment     = \"prod\"\r\n                                                    resource        = \"VNET\"\r\n                                                    cost_center     = \"Test Cost Ceneter\"\r\n                                                }                       \r\n    \r\n    }\r\n\r\nThe below code is for network module\r\n\r\n    # Creates the virtual network for the resources\r\n    resource \"azurerm_virtual_network\" \"vnet\" {\r\n    \r\n      name                = var.VirtualNetwork_Name\r\n      location            = var.Location\r\n      resource_group_name = var.Resource_Group_Name\r\n      address_space       = var.VirtualNetwork_AddressSpace\r\n      tags                = var.Tags\r\n    }\r\n    \r\n    \r\n    \r\n    # Create two subnet for the vnet\r\n    resource \"azurerm_subnet\" \"subnet\" {\r\n    \r\n      name                    = var.Subnet_Name[count.index]\r\n      address_prefix          = var.Subnet_Addresses[count.index]\r\n      resource_group_name     = var.Resource_Group_Name\r\n      virtual_network_name    = azurerm_virtual_network.vnet.name\r\n      count                   = length(var.Subnet_Name)\r\n      # service_endpoints       = [\"Microsoft.AzureCosmosDB\"]\r\n      service_endpoints       = var.Service_Endpoints\r\n    }\r\n\r\n\r\n\r\n", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "**Need help on how to do it** module \"vnet\" { source = \"./modules/VirtualNetwork\" VirtualNetwork_Name = \"${var.prefix}-${var.resource_group_name}-VNET1\" Resource_Group_Name = azurerm_resource_group.resource_group.name Location = azurerm_resource_group.resource_group.location VirtualNetwork_AddressSpace = [\"10.4.0.0/23\"] Subnet_Name = [\"snet-1\",\"snet-2\"] Subnet_Addresses = [\"10.4.0.0/24\",\"10.4.1.0/24\"] Service_Endpoints = vnet.Subnet_Name == \"snet-1\" ? [\"Microsoft.AzureCosmosDB\"] : [\"\"] if subnet==\"snet-1\" then [\"Microsoft.AzureCosmosDB\"] else [\"nothing\"] Tags = { environment = \"prod\" resource = \"VNET\" cost_center = \"Test Cost Ceneter\" } } The below code is for network module # Creates the virtual network for the resources resource \"azurerm_virtual_network\" \"vnet\" { name = var.VirtualNetwork_Name location = var.Location resource_group_name = var.Resource_Group_Name address_space = var.VirtualNetwork_AddressSpace tags = var.Tags } # Create two subnet for the vnet resource \"azurerm_subnet\" \"subnet\" { name = var.Subnet_Name[count.index] address_prefix = var.Subnet_Addresses[count.index] resource_group_name = var.Resource_Group_Name virtual_network_name = azurerm_virtual_network.vnet.name count = length(var.Subnet_Name) # service_endpoints = [\"Microsoft.AzureCosmosDB\"] service_endpoints = var.Service_Endpoints }", "keywords": ["cost", "test"]}]}], "answers": [{"Id": "62669175", "PostTypeId": "2", "ParentId": "62666287", "CreationDate": "2020-07-01T03:22:17.827", "Score": "3", "Body": "<p>According to your requirement, you just want to enable a service endpoint for a specific subnet only. You can set the <a href=\"https://www.terraform.io/docs/configuration/expressions.html#conditional-expressions\" rel=\"nofollow noreferrer\">conditional-expressions</a> in the <code>azurerm_subnet</code> block.</p>\n<p>You could change the code like this and I have validated it on my side.</p>\n<p><strong>main.if</strong> in the root directory.</p>\n<pre><code>variable &quot;subnet_name&quot; {\n    default = [&quot;subnet1&quot;,&quot;subnet2&quot;]\n}\n# retrieve a specific subnet via the index of subnet list.\nlocals {\n    subnet_name_enable_service_endpoint = element(var.subnet_name,0)\n}\n\n...\n\nmodule &quot;vnet&quot; { \n       \n        source                          = &quot;./modules/VirtualNetwork&quot;\n        VirtualNetwork_Name             = &quot;${var.prefix}-${var.resource_group_name}-VNET1&quot;\n        Resource_Group_Name             = azurerm_resource_group.main.name\n        Location                        = azurerm_resource_group.main.location\n        VirtualNetwork_AddressSpace     = [&quot;10.4.0.0/23&quot;]\n        Subnet_Addresses                = [&quot;10.4.0.0/24&quot;,&quot;10.4.1.0/24&quot;]\n        Subnet_Name                     = var.subnet_name\n        specfic_subnet_name             = local.subnet_name_enable_service_endpoint\n        Service_Endpoints               = [&quot;Microsoft.AzureCosmosDB&quot;]\n\n        Tags                            = {\n                                                environment     = &quot;prod&quot;\n                                                resource        = &quot;VNET&quot;\n                                                cost_center     = &quot;Test Cost Ceneter&quot;\n                                            }                       \n\n}\n</code></pre>\n<p>Network module configuration is in the path <code>./modules/VirtualNetwork</code>.</p>\n<pre><code># declare a variable for accepting the specific subnet.\nvariable &quot;specfic_subnet_name&quot; {\n    \n}\n...\n#Create Virtual Network in Primary Resource Group\nresource &quot;azurerm_virtual_network&quot; &quot;primary&quot; {\n  name                = var.VirtualNetwork_Name\n  resource_group_name = var.Resource_Group_Name\n  address_space       = var.VirtualNetwork_AddressSpace\n  location            = var.Location\n\n  tags = var.Tags\n\n}\n\n\n#Create Subnet in Virtual Network\nresource &quot;azurerm_subnet&quot; &quot;primary&quot; {\n  count = length(var.Subnet_Name)\n  name                 = var.Subnet_Name[count.index]\n  resource_group_name  = var.Resource_Group_Name\n  virtual_network_name = azurerm_virtual_network.primary.name\n  address_prefixes     = [element(var.Subnet_Addresses,count.index)]\n  service_endpoints    = element(var.Subnet_Name,count.index) == var.specfic_subnet_name ? var.Service_Endpoints : [&quot;&quot;]\n  \n}\n</code></pre>\n", "OwnerUserId": "9833314", "LastEditorUserId": "9833314", "LastEditDate": "2020-07-03T08:56:57.343", "LastActivityDate": "2020-07-03T08:56:57.343", "CommentCount": "10", "ContentLicense": "CC BY-SA 4.0", "comments": [{"Id": "110830413", "PostId": "62669175", "Score": "0", "Text": "If you see the above code will create 2 subnets and enable service endpoints for both the subnets. I need to do it for only one of the subnets", "CreationDate": "2020-07-01T07:38:00.950", "UserId": "1752280", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "110830510", "PostId": "62669175", "Score": "0", "Text": "Yes, do you try my configuration files? It just enable services endpoints for one specific subnet snet-1 in my example. I use `service_endpoints   = element(var.Subnet_Name,count.index) == \"snet-1\" ? var.Service_Endpoints : [\"\"]` in the `azurerm_subnet` block.", "CreationDate": "2020-07-01T07:41:20.130", "UserId": "9833314", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "110830855", "PostId": "62669175", "Score": "0", "Text": "I am using a module and seems like you are asking me to write the condition in the module which is not desirable. If i put the same code in the place i consume the mode i.e module \"vnet\" { , i get the following error. Error: Reference to \"count\" in non-counted context\n\n  on 02_VirtualNetworks.tf line 11, in module \"vnet\":\n  11:         Service_Endpoints              = element(var.Subnet_Name,count.index) == \"snet-1\" ? [\"Microsoft.AzureCosmosDB\"] : [\"\"]\n\nThe \"count\" object can be used only in \"resource\" and \"data\" blocks, and only\nwhen the \"count\" argument is set.", "CreationDate": "2020-07-01T07:54:31.607", "UserId": "1752280", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "If i put the same code in the place i consume the mode i.e module \"vnet\" { , i get the following error. ", "keywords": ["billing mode"]}]}, {"Id": "110831020", "PostId": "62669175", "Score": "1", "Text": "I mean to write the condition in the azurerm_subnet block in the configuration files. You may copy all my configuration file, I edit some places according to your configuration files. This works on my side.  The main configuration is under the root directory, the Network module configuration files are under `/modules/VirtualNetwork`.", "CreationDate": "2020-07-01T08:00:14.800", "UserId": "9833314", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "110832527", "PostId": "62669175", "Score": "0", "Text": "unfortunately didnt work, but i took a cue out of your approach and solved it in a different way. see the response below", "CreationDate": "2020-07-01T08:51:18.643", "UserId": "1752280", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "110864686", "PostId": "62669175", "Score": "0", "Text": "I suggest trying my solution again and if my solution is helpful and also it could help other people in the same scenario. Please accept it as an answer,", "CreationDate": "2020-07-02T07:49:25.163", "UserId": "9833314", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "110877947", "PostId": "62669175", "Score": "0", "Text": "unfortunately, the solution didn't work for me. You cant hardcode values inside a module when u are trying to define it as reusable component.", "CreationDate": "2020-07-02T14:56:03.023", "UserId": "1752280", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "110878145", "PostId": "62669175", "Score": "0", "Text": "I dont understand you mean that hardcode inside a module\uff1fI seems that both solution looks the same but my solution include dynamic conditional expression.", "CreationDate": "2020-07-02T15:02:00.417", "UserId": "9833314", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "110878953", "PostId": "62669175", "Score": "0", "Text": "If I need to create a new VNET/Subnet, I can inherit my module and assign values for VNET name/address same for Subnet name/address. With your option i need to make sure the subnet name always snet-1. I am creating modules to reusability purpose", "CreationDate": "2020-07-02T15:25:55.680", "UserId": "1752280", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "110899836", "PostId": "62669175", "Score": "0", "Text": "I see. at the original, I just follow your question`if subnet==\"snet-1\" then [\"Microsoft.AzureCosmosDB\"] else [\"nothing\"]`. In this case, you just need to provide a variable for that dynamic specific subnet. Please check my edit. The logic is the same.", "CreationDate": "2020-07-03T08:59:21.700", "UserId": "9833314", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "history": [{"Id": "225623527", "PostHistoryTypeId": "2", "PostId": "62669175", "RevisionGUID": "1fcb3b64-ca3c-4aeb-b212-af18417603d6", "CreationDate": "2020-07-01T03:22:17.827", "UserId": "9833314", "Text": "According to your requirement, you just want to enable a service endpoint for a specific subnet only. You can set the [conditional-expressions][1] in the subnet block.\r\n\r\nYou could change the code like this and I have validated it on my side.\r\n\r\n    module \"vnet\" { \r\n           \r\n            source                          = \"./modules/VirtualNetwork\"\r\n            VirtualNetwork_Name             = \"${var.prefix}-${var.resource_group_name}-VNET1\"\r\n            Resource_Group_Name             = azurerm_resource_group.main.name\r\n            Location                        = azurerm_resource_group.main.location\r\n            VirtualNetwork_AddressSpace     = [\"10.4.0.0/23\"]\r\n            Subnet_Name                     = [\"snet-1\",\"snet-2\"]\r\n            Subnet_Addresses                = [\"10.4.0.0/24\",\"10.4.1.0/24\"]      \r\n            Service_Endpoints               = [\"Microsoft.AzureCosmosDB\"]\r\n    \r\n            Tags                            = {\r\n                                                    environment     = \"prod\"\r\n                                                    resource        = \"VNET\"\r\n                                                    cost_center     = \"Test Cost Ceneter\"\r\n                                                }                       \r\n    \r\n    }\r\n\r\n\r\nNetwork module\r\n\r\n\r\n    #Create Virtual Network in Primary Resource Group\r\n    resource \"azurerm_virtual_network\" \"primary\" {\r\n      name                = var.VirtualNetwork_Name\r\n      resource_group_name = var.Resource_Group_Name\r\n      address_space       = var.VirtualNetwork_AddressSpace\r\n      location            = var.Location\r\n    \r\n      tags = var.Tags\r\n    \r\n    }\r\n    \r\n    \r\n    #Create Subnet in Virtual Network\r\n    resource \"azurerm_subnet\" \"primary\" {\r\n      count = length(var.Subnet_Name)\r\n      name                 = var.Subnet_Name[count.index]\r\n      resource_group_name  = var.Resource_Group_Name\r\n      virtual_network_name = azurerm_virtual_network.primary.name\r\n      address_prefixes     = [element(var.Subnet_Addresses,count.index)]\r\n      service_endpoints    = element(var.Subnet_Name,count.index) == \"snet-1\" ? var.Service_Endpoints : [\"\"]\r\n      \r\n    }\r\n\r\n\r\n  [1]: https://www.terraform.io/docs/configuration/expressions.html#conditional-expressions", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "You could change the code like this and I have validated it on my side. ", "keywords": ["change"]}, {"source": "Text", "text": "module \"vnet\" { source = \"./modules/VirtualNetwork\" VirtualNetwork_Name = \"${var.prefix}-${var.resource_group_name}-VNET1\" Resource_Group_Name = azurerm_resource_group.main.name Location = azurerm_resource_group.main.location VirtualNetwork_AddressSpace = [\"10.4.0.0/23\"] Subnet_Name = [\"snet-1\",\"snet-2\"] Subnet_Addresses = [\"10.4.0.0/24\",\"10.4.1.0/24\"] Service_Endpoints = [\"Microsoft.AzureCosmosDB\"] Tags = { environment = \"prod\" resource = \"VNET\" cost_center = \"Test Cost Ceneter\" } } Network module #Create Virtual Network in Primary Resource Group resource \"azurerm_virtual_network\" \"primary\" { name = var.VirtualNetwork_Name resource_group_name = var.Resource_Group_Name address_space = var.VirtualNetwork_AddressSpace location = var.Location tags = var.Tags } #Create Subnet in Virtual Network resource \"azurerm_subnet\" \"primary\" { count = length(var.Subnet_Name) name = var.Subnet_Name[count.index] resource_group_name = var.Resource_Group_Name virtual_network_name = azurerm_virtual_network.primary.name address_prefixes = [element(var.Subnet_Addresses,count.index)] service_endpoints = element(var.Subnet_Name,count.index) == \"snet-1\" ? var.Service_Endpoints : [\"\"] } [1]: https://www.terraform.io/docs/configuration/expressions.html#conditional-expressions", "keywords": ["cost", "test"]}]}, {"Id": "225623698", "PostHistoryTypeId": "5", "PostId": "62669175", "RevisionGUID": "eb746f47-c5ab-4d5f-94ff-be981b553b66", "CreationDate": "2020-07-01T03:27:37.257", "UserId": "9833314", "Comment": "added 10 characters in body", "Text": "According to your requirement, you just want to enable a service endpoint for a specific subnet only. You can set the [conditional-expressions][1] in the `azurerm_subnet` block.\r\n\r\nYou could change the code like this and I have validated it on my side.\r\n\r\n    module \"vnet\" { \r\n           \r\n            source                          = \"./modules/VirtualNetwork\"\r\n            VirtualNetwork_Name             = \"${var.prefix}-${var.resource_group_name}-VNET1\"\r\n            Resource_Group_Name             = azurerm_resource_group.main.name\r\n            Location                        = azurerm_resource_group.main.location\r\n            VirtualNetwork_AddressSpace     = [\"10.4.0.0/23\"]\r\n            Subnet_Name                     = [\"snet-1\",\"snet-2\"]\r\n            Subnet_Addresses                = [\"10.4.0.0/24\",\"10.4.1.0/24\"]      \r\n            Service_Endpoints               = [\"Microsoft.AzureCosmosDB\"]\r\n    \r\n            Tags                            = {\r\n                                                    environment     = \"prod\"\r\n                                                    resource        = \"VNET\"\r\n                                                    cost_center     = \"Test Cost Ceneter\"\r\n                                                }                       \r\n    \r\n    }\r\n\r\n\r\nNetwork module\r\n\r\n\r\n    #Create Virtual Network in Primary Resource Group\r\n    resource \"azurerm_virtual_network\" \"primary\" {\r\n      name                = var.VirtualNetwork_Name\r\n      resource_group_name = var.Resource_Group_Name\r\n      address_space       = var.VirtualNetwork_AddressSpace\r\n      location            = var.Location\r\n    \r\n      tags = var.Tags\r\n    \r\n    }\r\n    \r\n    \r\n    #Create Subnet in Virtual Network\r\n    resource \"azurerm_subnet\" \"primary\" {\r\n      count = length(var.Subnet_Name)\r\n      name                 = var.Subnet_Name[count.index]\r\n      resource_group_name  = var.Resource_Group_Name\r\n      virtual_network_name = azurerm_virtual_network.primary.name\r\n      address_prefixes     = [element(var.Subnet_Addresses,count.index)]\r\n      service_endpoints    = element(var.Subnet_Name,count.index) == \"snet-1\" ? var.Service_Endpoints : [\"\"]\r\n      \r\n    }\r\n\r\n\r\n  [1]: https://www.terraform.io/docs/configuration/expressions.html#conditional-expressions", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "You could change the code like this and I have validated it on my side. ", "keywords": ["change"]}, {"source": "Text", "text": "module \"vnet\" { source = \"./modules/VirtualNetwork\" VirtualNetwork_Name = \"${var.prefix}-${var.resource_group_name}-VNET1\" Resource_Group_Name = azurerm_resource_group.main.name Location = azurerm_resource_group.main.location VirtualNetwork_AddressSpace = [\"10.4.0.0/23\"] Subnet_Name = [\"snet-1\",\"snet-2\"] Subnet_Addresses = [\"10.4.0.0/24\",\"10.4.1.0/24\"] Service_Endpoints = [\"Microsoft.AzureCosmosDB\"] Tags = { environment = \"prod\" resource = \"VNET\" cost_center = \"Test Cost Ceneter\" } } Network module #Create Virtual Network in Primary Resource Group resource \"azurerm_virtual_network\" \"primary\" { name = var.VirtualNetwork_Name resource_group_name = var.Resource_Group_Name address_space = var.VirtualNetwork_AddressSpace location = var.Location tags = var.Tags } #Create Subnet in Virtual Network resource \"azurerm_subnet\" \"primary\" { count = length(var.Subnet_Name) name = var.Subnet_Name[count.index] resource_group_name = var.Resource_Group_Name virtual_network_name = azurerm_virtual_network.primary.name address_prefixes = [element(var.Subnet_Addresses,count.index)] service_endpoints = element(var.Subnet_Name,count.index) == \"snet-1\" ? var.Service_Endpoints : [\"\"] } [1]: https://www.terraform.io/docs/configuration/expressions.html#conditional-expressions", "keywords": ["cost", "test"]}]}, {"Id": "225636123", "PostHistoryTypeId": "5", "PostId": "62669175", "RevisionGUID": "7d35bb31-5dc7-4a50-b7f5-c2dc62037da7", "CreationDate": "2020-07-01T08:01:37.300", "UserId": "9833314", "Comment": "added 95 characters in body", "Text": "According to your requirement, you just want to enable a service endpoint for a specific subnet only. You can set the [conditional-expressions][1] in the `azurerm_subnet` block.\r\n\r\nYou could change the code like this and I have validated it on my side.\r\n\r\n**main.if** in the root directory.\r\n\r\n    module \"vnet\" { \r\n           \r\n            source                          = \"./modules/VirtualNetwork\"\r\n            VirtualNetwork_Name             = \"${var.prefix}-${var.resource_group_name}-VNET1\"\r\n            Resource_Group_Name             = azurerm_resource_group.main.name\r\n            Location                        = azurerm_resource_group.main.location\r\n            VirtualNetwork_AddressSpace     = [\"10.4.0.0/23\"]\r\n            Subnet_Name                     = [\"snet-1\",\"snet-2\"]\r\n            Subnet_Addresses                = [\"10.4.0.0/24\",\"10.4.1.0/24\"]      \r\n            Service_Endpoints               = [\"Microsoft.AzureCosmosDB\"]\r\n    \r\n            Tags                            = {\r\n                                                    environment     = \"prod\"\r\n                                                    resource        = \"VNET\"\r\n                                                    cost_center     = \"Test Cost Ceneter\"\r\n                                                }                       \r\n    \r\n    }\r\n\r\n\r\nNetwork module configuration is in the path `./modules/VirtualNetwork`.\r\n\r\n\r\n    #Create Virtual Network in Primary Resource Group\r\n    resource \"azurerm_virtual_network\" \"primary\" {\r\n      name                = var.VirtualNetwork_Name\r\n      resource_group_name = var.Resource_Group_Name\r\n      address_space       = var.VirtualNetwork_AddressSpace\r\n      location            = var.Location\r\n    \r\n      tags = var.Tags\r\n    \r\n    }\r\n    \r\n    \r\n    #Create Subnet in Virtual Network\r\n    resource \"azurerm_subnet\" \"primary\" {\r\n      count = length(var.Subnet_Name)\r\n      name                 = var.Subnet_Name[count.index]\r\n      resource_group_name  = var.Resource_Group_Name\r\n      virtual_network_name = azurerm_virtual_network.primary.name\r\n      address_prefixes     = [element(var.Subnet_Addresses,count.index)]\r\n      service_endpoints    = element(var.Subnet_Name,count.index) == \"snet-1\" ? var.Service_Endpoints : [\"\"]\r\n      \r\n    }\r\n\r\n\r\n  [1]: https://www.terraform.io/docs/configuration/expressions.html#conditional-expressions", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "You could change the code like this and I have validated it on my side. ", "keywords": ["change"]}, {"source": "Text", "text": "**main.if** in the root directory. module \"vnet\" { source = \"./modules/VirtualNetwork\" VirtualNetwork_Name = \"${var.prefix}-${var.resource_group_name}-VNET1\" Resource_Group_Name = azurerm_resource_group.main.name Location = azurerm_resource_group.main.location VirtualNetwork_AddressSpace = [\"10.4.0.0/23\"] Subnet_Name = [\"snet-1\",\"snet-2\"] Subnet_Addresses = [\"10.4.0.0/24\",\"10.4.1.0/24\"] Service_Endpoints = [\"Microsoft.AzureCosmosDB\"] Tags = { environment = \"prod\" resource = \"VNET\" cost_center = \"Test Cost Ceneter\" } } Network module configuration is in the path `./modules/VirtualNetwork`", "keywords": ["cost", "test"]}]}, {"Id": "225800232", "PostHistoryTypeId": "5", "PostId": "62669175", "RevisionGUID": "30e8ec0d-b7da-4c09-bc6d-e4c8ea4d613c", "CreationDate": "2020-07-03T08:56:57.343", "UserId": "9833314", "Comment": "added 479 characters in body", "Text": "According to your requirement, you just want to enable a service endpoint for a specific subnet only. You can set the [conditional-expressions][1] in the `azurerm_subnet` block.\r\n\r\nYou could change the code like this and I have validated it on my side.\r\n\r\n**main.if** in the root directory.\r\n\r\n    variable \"subnet_name\" {\r\n        default = [\"subnet1\",\"subnet2\"]\r\n    }\r\n    # retrieve a specific subnet via the index of subnet list.\r\n    locals {\r\n        subnet_name_enable_service_endpoint = element(var.subnet_name,0)\r\n    }\r\n    \r\n    ...\r\n    \r\n    module \"vnet\" { \r\n           \r\n            source                          = \"./modules/VirtualNetwork\"\r\n            VirtualNetwork_Name             = \"${var.prefix}-${var.resource_group_name}-VNET1\"\r\n            Resource_Group_Name             = azurerm_resource_group.main.name\r\n            Location                        = azurerm_resource_group.main.location\r\n            VirtualNetwork_AddressSpace     = [\"10.4.0.0/23\"]\r\n            Subnet_Addresses                = [\"10.4.0.0/24\",\"10.4.1.0/24\"]\r\n            Subnet_Name                     = var.subnet_name\r\n            specfic_subnet_name             = local.subnet_name_enable_service_endpoint\r\n            Service_Endpoints               = [\"Microsoft.AzureCosmosDB\"]\r\n    \r\n            Tags                            = {\r\n                                                    environment     = \"prod\"\r\n                                                    resource        = \"VNET\"\r\n                                                    cost_center     = \"Test Cost Ceneter\"\r\n                                                }                       \r\n    \r\n    }\r\n\r\nNetwork module configuration is in the path `./modules/VirtualNetwork`.\r\n\r\n    # declare a variable for accepting the specific subnet.\r\n    variable \"specfic_subnet_name\" {\r\n        \r\n    }\r\n    ...\r\n    #Create Virtual Network in Primary Resource Group\r\n    resource \"azurerm_virtual_network\" \"primary\" {\r\n      name                = var.VirtualNetwork_Name\r\n      resource_group_name = var.Resource_Group_Name\r\n      address_space       = var.VirtualNetwork_AddressSpace\r\n      location            = var.Location\r\n    \r\n      tags = var.Tags\r\n    \r\n    }\r\n    \r\n    \r\n    #Create Subnet in Virtual Network\r\n    resource \"azurerm_subnet\" \"primary\" {\r\n      count = length(var.Subnet_Name)\r\n      name                 = var.Subnet_Name[count.index]\r\n      resource_group_name  = var.Resource_Group_Name\r\n      virtual_network_name = azurerm_virtual_network.primary.name\r\n      address_prefixes     = [element(var.Subnet_Addresses,count.index)]\r\n      service_endpoints    = element(var.Subnet_Name,count.index) == var.specfic_subnet_name ? var.Service_Endpoints : [\"\"]\r\n      \r\n    }\r\n\r\n\r\n  [1]: https://www.terraform.io/docs/configuration/expressions.html#conditional-expressions\r\n\r\n\r\n", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "You could change the code like this and I have validated it on my side. ", "keywords": ["change"]}, {"source": "Text", "text": "**main.if** in the root directory. variable \"subnet_name\" { default = [\"subnet1\",\"subnet2\"] } # retrieve a specific subnet via the index of subnet list. locals { subnet_name_enable_service_endpoint = element(var.subnet_name,0) } ... module \"vnet\" { source = \"./modules/VirtualNetwork\" VirtualNetwork_Name = \"${var.prefix}-${var.resource_group_name}-VNET1\" Resource_Group_Name = azurerm_resource_group.main.name Location = azurerm_resource_group.main.location VirtualNetwork_AddressSpace = [\"10.4.0.0/23\"] Subnet_Addresses = [\"10.4.0.0/24\",\"10.4.1.0/24\"] Subnet_Name = var.subnet_name specfic_subnet_name = local.subnet_name_enable_service_endpoint Service_Endpoints = [\"Microsoft.AzureCosmosDB\"] Tags = { environment = \"prod\" resource = \"VNET\" cost_center = \"Test Cost Ceneter\" } } Network module configuration is in the path `./modules/VirtualNetwork`. ", "keywords": ["cost", "test"]}]}], "filtered-sentences": [{"source": "Body", "text": "You could change the code like this and I have validated it on my side. ", "keywords": ["change"]}]}, {"Id": "62673248", "PostTypeId": "2", "ParentId": "62666287", "CreationDate": "2020-07-01T08:56:49.263", "Score": "0", "Body": "<p><strong>./modules/VirtualNetwork only the subnet creation part</strong></p>\n<pre><code># Create two subnet for the vnet\nresource &quot;azurerm_subnet&quot; &quot;subnet&quot; {\n\n  name                    = var.Subnet_Name[count.index]\n  address_prefix          = var.Subnet_Addresses[count.index]\n  resource_group_name     = var.Resource_Group_Name\n  virtual_network_name    = azurerm_virtual_network.vnet.name\n  count                   = length(var.Subnet_Name)\n \n  service_endpoints       =  element(var.Service_Endpoints,count.index) \n}\n</code></pre>\n<p><strong>main.tf</strong></p>\n<pre><code>module &quot;vnet&quot; { \n        source                          = &quot;./modules/VirtualNetwork&quot;\n        VirtualNetwork_Name             = &quot;${var.prefix}-${var.resource_group_name}-VNET1&quot;\n        Resource_Group_Name             = azurerm_resource_group.resource_group.name\n        Location                        = azurerm_resource_group.resource_group.location\n        VirtualNetwork_AddressSpace     = [&quot;10.4.0.0/23&quot;]\n        Subnet_Name                     = [&quot;snet-1&quot;,&quot;snet-2&quot;]\n        Subnet_Addresses                = [&quot;10.4.0.0/24&quot;,&quot;10.4.1.0/24&quot;]\n       \n        Service_Endpoints               = [[&quot;Microsoft.AzureCosmosDB&quot;,&quot;&quot;], [&quot;&quot;]] \n}\n   \n\n     \n</code></pre>\n<p>The key is to pass the service end point as a list Service_Endpoints               = [[&quot;Microsoft.AzureCosmosDB&quot;,&quot;&quot;], [&quot;&quot;]]. Based on the index of the subnet it will assign the service end point</p>\n", "OwnerUserId": "1752280", "LastActivityDate": "2020-07-01T08:56:49.263", "CommentCount": "0", "ContentLicense": "CC BY-SA 4.0", "history": [{"Id": "225640092", "PostHistoryTypeId": "2", "PostId": "62673248", "RevisionGUID": "2ace8da0-9a1b-4371-a0fc-da61ac10db23", "CreationDate": "2020-07-01T08:56:49.263", "UserId": "1752280", "Text": "**./modules/VirtualNetwork only the subnet creation part**\r\n\r\n    # Create two subnet for the vnet\r\n    resource \"azurerm_subnet\" \"subnet\" {\r\n    \r\n      name                    = var.Subnet_Name[count.index]\r\n      address_prefix          = var.Subnet_Addresses[count.index]\r\n      resource_group_name     = var.Resource_Group_Name\r\n      virtual_network_name    = azurerm_virtual_network.vnet.name\r\n      count                   = length(var.Subnet_Name)\r\n     \r\n      service_endpoints       =  element(var.Service_Endpoints,count.index) \r\n    }\r\n\r\n\r\n**main.tf**\r\n\r\n    module \"vnet\" { \r\n            source                          = \"./modules/VirtualNetwork\"\r\n            VirtualNetwork_Name             = \"${var.prefix}-${var.resource_group_name}-VNET1\"\r\n            Resource_Group_Name             = azurerm_resource_group.resource_group.name\r\n            Location                        = azurerm_resource_group.resource_group.location\r\n            VirtualNetwork_AddressSpace     = [\"10.4.0.0/23\"]\r\n            Subnet_Name                     = [\"snet-1\",\"snet-2\"]\r\n            Subnet_Addresses                = [\"10.4.0.0/24\",\"10.4.1.0/24\"]\r\n           \r\n            Service_Endpoints               = [[\"Microsoft.AzureCosmosDB\",\"\"], [\"\"]] \r\n    }\r\n       \r\n\r\n         \r\n\r\nThe key is to pass the service end point as a list Service_Endpoints               = [[\"Microsoft.AzureCosmosDB\",\"\"], [\"\"]]. Based on the index of the subnet it will assign the service end point\r\n", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "filtered-sentences": []}], "contains-topic": true, "filtered-sentences": []}