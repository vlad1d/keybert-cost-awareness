{"Id": "72088958", "PostTypeId": "1", "CreationDate": "2022-05-02T15:28:51.117", "Score": "2", "ViewCount": "877", "Body": "<p>I am trying to set-up my terraform's <code>main.tf</code> by using service accounts that get impersonated by authorized users... I followed <a href=\"https://medium.com/google-cloud/a-hitchhikers-guide-to-gcp-service-account-impersonation-in-terraform-af98853ebd37\" rel=\"nofollow noreferrer\">this guide</a> to set this up, and it works, I can create a bucket within my project and within my organization.</p>\n<p>Now in order to do more specific stuff, like declare these blocks</p>\n<pre><code>data &quot;google_organization&quot; &quot;org&quot; {\n  organization = var.organization.id\n}\ndata &quot;google_billing_account&quot; &quot;acct&quot; {\n  billing_account = var.billing_account.id\n  open            = var.billing_account.active\n}\n</code></pre>\n<p>I figured (but I may be wrong) that I need to include more elements in the scope of my provider, like this :</p>\n<pre><code>provider &quot;google&quot; {\n  alias = &quot;super_admin_impersonation&quot;\n  scopes = [\n    &quot;https://www.googleapis.com/auth/cloud-platform&quot;,\n    &quot;https://www.googleapis.com/auth/userinfo.email&quot;,\n    &quot;https://www.googleapis.com/auth/admin.directory.orgunit&quot;,  # I added this\n    &quot;https://www.googleapis.com/auth/cloud-billing&quot;  # And this\n  ]\n}\n</code></pre>\n<p>and so, also add them to the <code>google_service_account_access_token</code> block</p>\n<pre><code>data &quot;google_service_account_access_token&quot; &quot;super_admin&quot; {\n  provider               = google.super_admin_impersonation\n  target_service_account = &quot;${var.service_acc_terraform_super_admin.name}@${var.project_infra_genesis.id}.${var.service_acc_terraform_super_admin.suffix}&quot;\n  scopes                 = [&quot;cloud-platform&quot;, &quot;userinfo-email&quot;, &quot;admin.directory.orgunit&quot;, &quot;cloud-billing&quot;]\n  lifetime               = &quot;1200s&quot;\n}\n</code></pre>\n<p>The problem, is that when I add <code>&quot;admin.directory.orgunit&quot;, &quot;cloud-billing&quot;</code> to this block's scope, I get this error :</p>\n<pre><code>\u2577\n\u2502 Error: googleapi: Error 400: Request contains an invalid argument., badRequest\n\u2502\n\u2502   with data.google_service_account_access_token.super_admin,\n\u2502   on main.tf line 22, in data &quot;google_service_account_access_token&quot; &quot;super_admin&quot;:\n\u2502   22: data &quot;google_service_account_access_token&quot; &quot;super_admin&quot; {\n\u2502\n\u2575\n</code></pre>\n<p><a href=\"https://developers.google.com/identity/protocols/oauth2/scopes\" rel=\"nofollow noreferrer\">Google's official Oauth2 scopes for their APIs</a> is where I determine the names of scopes...</p>\n<p>My question is: how do you know which scopes can be used in <code>google_service_account_access_token</code>? Is there a complete list I can refer to in order to include more in this block?</p>\n", "OwnerUserId": "4375983", "LastActivityDate": "2022-05-02T19:09:59.447", "Title": "How to use \"google_service_account_access_token\" scopes", "Tags": "<google-cloud-platform><terraform><terraform-provider-gcp><infrastructure-as-code>", "AnswerCount": "0", "CommentCount": "1", "ContentLicense": "CC BY-SA 4.0", "comments": [{"Id": "127843434", "PostId": "72088958", "Score": "0", "Text": "Not an expert in Roles/SA. When you are creating SA token, you have add those roles I guess(You may try those). If you are looking for list of scopes then you can look @ https://cloud.google.com/iam/docs/understanding-roles", "CreationDate": "2022-05-24T16:11:49.790", "UserId": "1686903", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "history": [{"Id": "269331890", "PostHistoryTypeId": "2", "PostId": "72088958", "RevisionGUID": "bfeaaa9a-0c18-4a70-afab-49148f2f43b1", "CreationDate": "2022-05-02T15:28:51.117", "UserId": "4375983", "Text": "I am trying to set-up my terraform's `main.tf` by using service accounts that get impersonated by authorized users... I followed [this guide][1] to set this up, and it works, I can create a bucket within my project and within my organization.\r\n\r\nNow in order to do more specific stuff, like declare these blocks \r\n\r\n    data \"google_organization\" \"org\" {\r\n      organization = var.organization.id\r\n    }\r\n    data \"google_billing_account\" \"acct\" {\r\n      billing_account = var.billing_account.id\r\n      open            = var.billing_account.active\r\n    }\r\n\r\nI figured (but I may be wrong) that I need to include more elements in the scope of my provider, like this :\r\n\r\n    provider \"google\" {\r\n      alias = \"super_admin_impersonation\"\r\n      scopes = [\r\n        \"https://www.googleapis.com/auth/cloud-platform\",\r\n        \"https://www.googleapis.com/auth/userinfo.email\",\r\n        \"https://www.googleapis.com/auth/admin.directory.orgunit\",  # I added this\r\n        \"https://www.googleapis.com/auth/cloud-billing\"  # And this\r\n      ]\r\n    }\r\n\r\nand so, also add them to the `google_service_account_access_token` block\r\n\r\n    data \"google_service_account_access_token\" \"super_admin\" {\r\n      provider               = google.super_admin_impersonation\r\n      target_service_account = \"${var.service_acc_terraform_super_admin.name}@${var.project_infra_genesis.id}.${var.service_acc_terraform_super_admin.suffix}\"\r\n      scopes                 = [\"cloud-platform\", \"userinfo-email\", \"admin.directory.orgunit\", \"cloud-billing\"]\r\n      lifetime               = \"1200s\"\r\n    }\r\n\r\nThe problem, is that when I add `\"admin.directory.orgunit\", \"cloud-billing\"` to this block's scope, I get this error :\r\n\r\n    \u2577\r\n    \u2502 Error: googleapi: Error 400: Request contains an invalid argument., badRequest\r\n    \u2502\r\n    \u2502   with data.google_service_account_access_token.super_admin,\r\n    \u2502   on main.tf line 22, in data \"google_service_account_access_token\" \"super_admin\":\r\n    \u2502   22: data \"google_service_account_access_token\" \"super_admin\" {\r\n    \u2502\r\n    \u2575\r\n\r\n[Google's official Oauth2 scopes for their APIs][2] is where I determine the names of scopes... \r\n\r\nMy question is: how do you know which scopes can be used in `google_service_account_access_token`? Is there a complete list I can refer to in order to include more in this block?\r\n\r\n  [1]: https://medium.com/google-cloud/a-hitchhikers-guide-to-gcp-service-account-impersonation-in-terraform-af98853ebd37\r\n  [2]: https://developers.google.com/identity/protocols/oauth2/scopes", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "Now in order to do more specific stuff, like declare these blocks data \"google_organization\" \"org\" { organization = var.organization.id } data \"google_billing_account\" \"acct\" { billing_account = var.billing_account.id open = var.billing_account.active } I figured (but I may be wrong) that I need to include more elements in the scope of my provider, like this : provider \"google\" { alias = \"super_admin_impersonation\" scopes = [ \"https://www.googleapis.com/auth/cloud-platform\", \"https://www.googleapis.com/auth/userinfo.email\", \"https://www.googleapis.com/auth/admin.directory.orgunit\", # I added this \"https://www.googleapis.com/auth/cloud-billing\" # And this ] } and so, also add them to the `google_service_account_access_token` block data \"google_service_account_access_token\" \"super_admin\" { provider = google.super_admin_impersonation target_service_account = \"${var.service_acc_terraform_super_admin.name}@${var.project_infra_genesis.id}.${var.service_acc_terraform_super_admin.suffix}\" scopes = [\"cloud-platform\", \"userinfo-email\", \"admin.directory.orgunit\", \"cloud-billing\"] lifetime = \"1200s\" } The problem, is that when I add `\"admin.directory.orgunit\", \"cloud-billing\"` to this block's scope, I get this error : \u2577 \u2502 Error: googleapi: Error 400: Request contains an invalid argument., badRequest \u2502 \u2502 with data.google_service_account_access_token.super_admin, \u2502 on main.tf line 22, in data \"google_service_account_access_token\" \"super_admin\": \u2502 22: data \"google_service_account_access_token\" \"super_admin\" { \u2502 \u2575 [Google's official Oauth2 scopes for their APIs][2] is where I determine the names of scopes... ", "keywords": ["bill", "provider"]}]}, {"Id": "269331892", "PostHistoryTypeId": "1", "PostId": "72088958", "RevisionGUID": "bfeaaa9a-0c18-4a70-afab-49148f2f43b1", "CreationDate": "2022-05-02T15:28:51.117", "UserId": "4375983", "Text": "How to use \"google_service_account_access_token\" scopes", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "269331893", "PostHistoryTypeId": "3", "PostId": "72088958", "RevisionGUID": "bfeaaa9a-0c18-4a70-afab-49148f2f43b1", "CreationDate": "2022-05-02T15:28:51.117", "UserId": "4375983", "Text": "<google-cloud-platform><terraform><terraform-provider-gcp><infrastructure-as-code>", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "contains-topic": true, "filtered-sentences": [{"source": "Body", "text": "Now in order to do more specific stuff, like declare these blocks I figured (but I may be wrong) that I need to include more elements in the scope of my provider, like this : and so, also add them to the google_service_account_access_token block ", "keywords": ["provider"]}, {"source": "Body", "text": "The problem, is that when I add \"admin.directory.orgunit\", \"cloud-billing\" to this block's scope, I get this error : Google's official Oauth2 scopes for their APIs is where I determine the names of scopes... ", "keywords": ["bill"]}]}