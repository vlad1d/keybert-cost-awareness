{"Id": "72920731", "PostTypeId": "1", "AcceptedAnswerId": "72920902", "CreationDate": "2022-07-09T10:48:46.120", "Score": "2", "ViewCount": "6818", "Body": "<p><strong>Objective</strong>: I am trying to create azure resources with <code>Terraform</code></p>\n<p><strong>Code I used in</strong> <code>main.tf</code>:</p>\n<pre><code>resource &quot;azurerm_subnet&quot; &quot;clientdata_snet&quot; {\n  count                = var.clientdata_subnet_address_space != null ? 1 : 0\n  name                 = &quot;ClientDataSubnet&quot;\n  resource_group_name  = var.resource_group_name\n  virtual_network_name = azurerm_virtual_network.vnet.name\n  address_prefixes     = [&quot;${var.clientdata_subnet_address_space}&quot;]\n  service_endpoints    = var.service_endpoints\n}\n</code></pre>\n<p>and now subsequently want to use <code>client_snet.id</code> for creating storage endpoint</p>\n<pre><code>resource &quot;azurerm_private_endpoint&quot; &quot;sa_pe_blob&quot; {\n  name                = &quot;pe-stdlorpcbcntldevwe-blob-${random_string.postfix.result}&quot;\n  location            = var.location\n  resource_group_name = var.resource_group_name\n  subnet_id           = azurerm_subnet.clientdata_snet.id\n</code></pre>\n<p><strong>Error I get is:</strong></p>\n<pre><code> Error: Missing resource instance key\n    \u2502 \n    \u2502   on main.tf line 470, in resource &quot;azurerm_private_endpoint&quot; &quot;sa_pe_blob&quot;:\n    \u2502  470:   subnet_id           = azurerm_subnet.clientdata_snet.id\n    \u2502 \n    \u2502 Because azurerm_subnet.clientdata_snet has &quot;count&quot; set, its attributes must be accessed on specific instances.\n    \u2502 \n    \u2502 For example, to correlate with indices of a referring resource, use:\n    \u2502     azurerm_subnet.clientdata_snet[count.index]\n</code></pre>\n<p>Then I referred to some posts here.. where I need to use like below:</p>\n<pre><code>  subnet_id           = azurerm_subnet.clientdata_snet[count.index].id\n</code></pre>\n<p>then its giving me this error:</p>\n<pre><code>Error: Reference to &quot;count&quot; in non-counted context\n    \u2502 \n    \u2502   on main.tf line 470, in resource &quot;azurerm_private_endpoint&quot; &quot;sa_pe_blob&quot;:\n    \u2502  470:   subnet_id           = azurerm_subnet.clientdata_snet[count.index].id\n\u2502 \n\u2502 The &quot;count&quot; object can only be used in &quot;module&quot;, &quot;resource&quot;, and &quot;data&quot; blocks, and only when the &quot;count&quot; argument is set.\n</code></pre>\n<p>Really confused, both ways its giving me error. I have only root module, I dont have any other modules.Can someone suggest what is correct way to do it ?</p>\n", "OwnerUserId": "9375954", "LastActivityDate": "2022-07-09T11:15:26.690", "Title": "How to fix the \"count\" object can only be used in \"module\", \"resource\", and \"data\" blocks, and only when the \"count\" argument", "Tags": "<terraform><terraform-provider-azure><terraform0.12+>", "AnswerCount": "1", "CommentCount": "0", "ContentLicense": "CC BY-SA 4.0", "history": [{"Id": "273875604", "PostHistoryTypeId": "2", "PostId": "72920731", "RevisionGUID": "7acd9d83-855e-4462-b2e0-9ee51fe19abb", "CreationDate": "2022-07-09T10:48:46.120", "UserId": "9375954", "Text": "**Objective**: I am trying to create azure resources with `Terraform`\r\n\r\n**Code I used in** `main.tf`:\r\n\r\n    resource \"azurerm_subnet\" \"clientdata_snet\" {\r\n      count                = var.clientdata_subnet_address_space != null ? 1 : 0\r\n      name                 = \"ClientDataSubnet\"\r\n      resource_group_name  = var.resource_group_name\r\n      virtual_network_name = azurerm_virtual_network.vnet.name\r\n      address_prefixes     = [\"${var.clientdata_subnet_address_space}\"]\r\n      service_endpoints    = var.service_endpoints\r\n    }\r\n\r\n\r\nand now subsequently want to use `client_snet.id` for creating storage endpoint\r\n\r\n    resource \"azurerm_private_endpoint\" \"sa_pe_blob\" {\r\n      name                = \"pe-stdlorpcbcntldevwe-blob-${random_string.postfix.result}\"\r\n      location            = var.location\r\n      resource_group_name = var.resource_group_name\r\n      subnet_id           = azurerm_subnet.clientdata_snet.id\r\n\r\n\r\n**Error I get is:**\r\n\r\n     Error: Missing resource instance key\r\n        \u2502 \r\n        \u2502   on main.tf line 470, in resource \"azurerm_private_endpoint\" \"sa_pe_blob\":\r\n        \u2502  470:   subnet_id           = azurerm_subnet.clientdata_snet.id\r\n        \u2502 \r\n        \u2502 Because azurerm_subnet.clientdata_snet has \"count\" set, its attributes must be accessed on specific instances.\r\n        \u2502 \r\n        \u2502 For example, to correlate with indices of a referring resource, use:\r\n        \u2502     azurerm_subnet.clientdata_snet[count.index]\r\n\r\n    \r\nThen I referred to some posts here.. where I need to use like below:\r\n\r\n      subnet_id           = azurerm_subnet.clientdata_snet[count.index].id\r\n\r\nthen its giving me this error:\r\n \r\n\r\n    Error: Reference to \"count\" in non-counted context\r\n        \u2502 \r\n        \u2502   on main.tf line 470, in resource \"azurerm_private_endpoint\" \"sa_pe_blob\":\r\n        \u2502  470:   subnet_id           = azurerm_subnet.clientdata_snet[count.index].id\r\n    \u2502 \r\n    \u2502 The \"count\" object can only be used in \"module\", \"resource\", and \"data\" blocks, and only when the \"count\" argument is set.\r\n\r\n   \r\n\r\nReally confused, both ways its giving me error. I have only root module, I dont have any other modules.Can someone suggest what is correct way to do it ?\r\n\r\n\r\n", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "**Objective**: I am trying to create azure resources with `Terraform` **Code I used in** `main.tf`: resource \"azurerm_subnet\" \"clientdata_snet\" { count = var.clientdata_subnet_address_space != null ? 1 : 0 name = \"ClientDataSubnet\" resource_group_name = var.resource_group_name virtual_network_name = azurerm_virtual_network.vnet.name address_prefixes = [\"${var.clientdata_subnet_address_space}\"] service_endpoints = var.service_endpoints } and now subsequently want to use `client_snet.id` for creating storage endpoint resource \"azurerm_private_endpoint\" \"sa_pe_blob\" { name = \"pe-stdlorpcbcntldevwe-blob-${random_string.postfix.result}\" location = var.location resource_group_name = var.resource_group_name subnet_id = azurerm_subnet.clientdata_snet.id **Error I get is:** Error: Missing resource instance key \u2502 \u2502 on main.tf line 470, in resource \"azurerm_private_endpoint\" \"sa_pe_blob\": \u2502 470: subnet_id = azurerm_subnet.clientdata_snet.id \u2502 \u2502 Because azurerm_subnet.clientdata_snet has \"count\" set, its attributes must be accessed on specific instances. \u2502 \u2502 For example, to correlate with indices of a referring resource, use: \u2502 azurerm_subnet.clientdata_snet[count.index] Then I referred to some posts here.. where I need to use like below: subnet_id = azurerm_subnet.clientdata_snet[count.index].id then its giving me this error: Error: Reference to \"count\" in non-counted context \u2502 \u2502 on main.tf line 470, in resource \"azurerm_private_endpoint\" \"sa_pe_blob\": \u2502 470: subnet_id = azurerm_subnet.clientdata_snet[count.index].id \u2502 \u2502 The \"count\" object can only be used in \"module\", \"resource\", and \"data\" blocks, and only when the \"count\" argument is set. ", "keywords": ["instance", "storage"]}]}, {"Id": "273875606", "PostHistoryTypeId": "1", "PostId": "72920731", "RevisionGUID": "7acd9d83-855e-4462-b2e0-9ee51fe19abb", "CreationDate": "2022-07-09T10:48:46.120", "UserId": "9375954", "Text": "How to fix the \"count\" object can only be used in \"module\", \"resource\", and \"data\" blocks, and only when the \"count\" argument", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "273875607", "PostHistoryTypeId": "3", "PostId": "72920731", "RevisionGUID": "7acd9d83-855e-4462-b2e0-9ee51fe19abb", "CreationDate": "2022-07-09T10:48:46.120", "UserId": "9375954", "Text": "<terraform><terraform-provider-azure><terraform0.12+>", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "answers": [{"Id": "72920902", "PostTypeId": "2", "ParentId": "72920731", "CreationDate": "2022-07-09T11:15:26.690", "Score": "3", "Body": "<p>If you are using <code>count</code> meta-argument, you have to use either the right index or use the same way of creating the second resource, by referencing the same variable to decide what the count will be. So the options are:</p>\n<pre><code>resource &quot;azurerm_private_endpoint&quot; &quot;sa_pe_blob&quot; {\n  name                = &quot;pe-stdlorpcbcntldevwe-blob-${random_string.postfix.result}&quot;\n  location            = var.location\n  resource_group_name = var.resource_group_name\n  subnet_id           = azurerm_subnet.clientdata_snet[0].id # exact index\n}\n</code></pre>\n<p>As you can see, the <code>subnet_id</code> is now referencing a previously created resource with index of <code>0</code>. To understand how references to instances work when <code>count</code> is used, look in [1].</p>\n<p>The second way you could do it is like this:</p>\n<pre><code>resource &quot;azurerm_private_endpoint&quot; &quot;sa_pe_blob&quot; {\n  count               = var.clientdata_subnet_address_space != null ? 1 : 0\n  name                = &quot;pe-stdlorpcbcntldevwe-blob-${random_string.postfix.result}&quot;\n  location            = var.location\n  resource_group_name = var.resource_group_name\n  subnet_id           = azurerm_subnet.clientdata_snet[count.index].id # using count.index\n}\n</code></pre>\n<p>This way you will create a dependency between the subnet and the endpoint resources.</p>\n<p>As you can see here, the resources created with <code>count</code> can be referenced either by specifying the exact index which is fine when there is only one resource, but much harder when there are more and the code would have to be repeated. The other way is to use the same variable with the <code>count</code> meta-argument.</p>\n<p>I strongly suggest going through the documentation to understand the <code>count</code> meta-argument better.</p>\n<hr />\n<p>[1] <a href=\"https://www.terraform.io/language/meta-arguments/count#referring-to-instances\" rel=\"nofollow noreferrer\">https://www.terraform.io/language/meta-arguments/count#referring-to-instances</a></p>\n", "OwnerUserId": "8343484", "LastActivityDate": "2022-07-09T11:15:26.690", "CommentCount": "6", "ContentLicense": "CC BY-SA 4.0", "comments": [{"Id": "128796799", "PostId": "72920902", "Score": "0", "Text": "Hi @Marko-e  The index method works (1st option you made). However second method is not working (at time of posting I have tried that method) It throws error.  Seems second method is effective as it creates dependency between endpoint and subnet", "CreationDate": "2022-07-09T12:08:24.153", "UserId": "9375954", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "128796836", "PostId": "72920902", "Score": "0", "Text": "What error does it throw?", "CreationDate": "2022-07-09T12:11:56.123", "UserId": "8343484", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "128796854", "PostId": "72920902", "Score": "0", "Text": "This one `Error: Reference to \"count\" in non-counted context\n    \u2502 \n    \u2502   on main.tf line 470, in resource \"azurerm_private_endpoint\" \"sa_pe_blob\":\n    \u2502  470:   subnet_id           = azurerm_subnet.clientdata_snet[count.index].id\n\u2502 \n\u2502 The \"count\" object can only be used in \"module\", \"resource\", and \"data\" blocks, and only when the \"count\" argument is set. `  I am not sure why it throws this as I used count for subnet creation", "CreationDate": "2022-07-09T12:13:04.507", "UserId": "9375954", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "128796873", "PostId": "72920902", "Score": "0", "Text": "If you pay close attention I added the following line: `count  = var.clientdata_subnet_address_space != null ? 1 : 0` to the `azurerm_private_endpoint` resource.", "CreationDate": "2022-07-09T12:15:29.187", "UserId": "8343484", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "If you pay close attention I added the following line: `count = var.clientdata_subnet_address_space != null ? 1 : 0` to the `azurerm_private_endpoint` resource.", "keywords": ["pay"]}]}, {"Id": "128796923", "PostId": "72920902", "Score": "0", "Text": "apologies.. Oh my bad.. how did I miss it, Yep giving it a try.. Ok so Now I understand when ever we  want to use index method to get attribute, then use count in definition of new resource as well not in just original resource from where you need to fetch attribute. Thanks for this guidance.. Everyday learning :)", "CreationDate": "2022-07-09T12:21:28.830", "UserId": "9375954", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "128797092", "PostId": "72920902", "Score": "1", "Text": "Yup, something like that. I will try one other thing and maybe update the answer with that option as well.", "CreationDate": "2022-07-09T12:39:28.870", "UserId": "8343484", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "history": [{"Id": "273876497", "PostHistoryTypeId": "2", "PostId": "72920902", "RevisionGUID": "e93a2d0f-7af7-43d6-a648-1a14e5115874", "CreationDate": "2022-07-09T11:15:26.690", "UserId": "8343484", "Text": "If you are using `count` meta-argument, you have to use either the right index or use the same way of creating the second resource, by referencing the same variable to decide what the count will be. So the options are:\r\n\r\n```hcl\r\nresource \"azurerm_private_endpoint\" \"sa_pe_blob\" {\r\n  name                = \"pe-stdlorpcbcntldevwe-blob-${random_string.postfix.result}\"\r\n  location            = var.location\r\n  resource_group_name = var.resource_group_name\r\n  subnet_id           = azurerm_subnet.clientdata_snet[0].id # exact index\r\n}\r\n```\r\n\r\nAs you can see, the `subnet_id` is now referencing a previously created resource with index of `0`. To understand how references to instances work when `count` is used, look in [1].\r\n\r\nThe second way you could do it is like this:\r\n\r\n```hcl\r\nresource \"azurerm_private_endpoint\" \"sa_pe_blob\" {\r\n  count               = var.clientdata_subnet_address_space != null ? 1 : 0\r\n  name                = \"pe-stdlorpcbcntldevwe-blob-${random_string.postfix.result}\"\r\n  location            = var.location\r\n  resource_group_name = var.resource_group_name\r\n  subnet_id           = azurerm_subnet.clientdata_snet[count.index].id # using count.index\r\n}\r\n```\r\n\r\nThis way you will create a dependency between the subnet and the endpoint resources.\r\n\r\nAs you can see here, the resources created with `count` can be referenced either by specifying the exact index which is fine when there is only one resource, but much harder when there are more and the code would have to be repeated. The other way is to use the same variable with the `count` meta-argument.\r\n\r\nI strongly suggest going through the documentation to understand the `count` meta-argument better.\r\n\r\n---\r\n\r\n[1] https://www.terraform.io/language/meta-arguments/count#referring-to-instances", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "filtered-sentences": []}], "contains-topic": true, "filtered-sentences": [{"source": "Body", "text": "Objective: I am trying to create azure resources with Terraform Code I used in main.tf: and now subsequently want to use client_snet.id for creating storage endpoint Error I get is: Then I referred to some posts here.. where I need to use like below: then its giving me this error: Really confused, both ways its giving me error. ", "keywords": ["storage"]}]}