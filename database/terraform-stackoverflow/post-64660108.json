{"Id": "64660108", "PostTypeId": "1", "CreationDate": "2020-11-03T09:31:49.020", "Score": "1", "ViewCount": "1491", "Body": "<p>I'm trying to use terraform to deploy budget alert for Azure, unfortunately there's no native resource in terraform for that, so I'm using azurerm_subscription_template_deployment along with ARM template.</p>\n<p>I noticed a strange thing is after the deployment, everything seem fine, I can see the resource (in ARM template) by doing terraform state show.</p>\n<p>However, when I do destroy, it doesn't seem to delete the budget alert, it's still there, and if I do terraform state list, it's showing everything is deleted without a trace, but actual resource is still there.</p>\n<p>I noticed terraform has the following for azurerm_resource_group_template_deployment, I assume this is also for subscrption deployment</p>\n<p><strong>&quot;This resource will automatically attempt to delete resources deployed by the ARM Template when it is deleted. You can opt-out of this by setting the delete_nested_items_during_deletion field within the template_deployment block of the features block to false.&quot;</strong></p>\n<p>so If I understand this correctly, If my features block is by default, it should delete the actual resource, when doing destroy.</p>\n<p>why it's not behaving correctly?</p>\n<p>code as following</p>\n<pre><code>resource &quot;azurerm_subscription_template_deployment&quot; &quot;budgetalert&quot; {\n  name     = &quot;mcs_budget_alert&quot;\n  location = var.location\n\n  template_content = &lt;&lt;-TEMPLATE\n {\n  &quot;$schema&quot;: &quot;https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#&quot;,\n      &quot;contentVersion&quot;: &quot;1.0.0.0&quot;,\n      &quot;parameters&quot;: {\n        &quot;client_initial&quot;: {\n          &quot;type&quot;: &quot;string&quot;,\n          &quot;metadata&quot;: {\n            &quot;description&quot;: &quot;Name of the Budget. It should be unique within a resource group.&quot;\n          }\n        },\n        &quot;amount&quot;: {\n          &quot;type&quot;: &quot;string&quot;,\n          &quot;defaultValue&quot;: &quot;1000&quot;,\n          &quot;metadata&quot;: {\n            &quot;description&quot;: &quot;The total amount of cost or usage to track with the budget&quot;\n          }\n        },\n        &quot;timeGrain&quot;: {\n          &quot;type&quot;: &quot;string&quot;,\n          &quot;defaultValue&quot;: &quot;Monthly&quot;,\n          &quot;allowedValues&quot;: [\n            &quot;Monthly&quot;,\n            &quot;Quarterly&quot;,\n            &quot;Annually&quot;\n          ],\n          &quot;metadata&quot;: {\n            &quot;description&quot;: &quot;The time covered by a budget. Tracking of the amount will be reset based on the time grain.&quot;\n          }\n        },\n        &quot;startDate&quot;: {\n          &quot;type&quot;: &quot;string&quot;,\n          &quot;metadata&quot;: {\n            &quot;description&quot;: &quot;The start date must be first of the month in YYYY-MM-DD format. Future start date should not be more than three months. Past start date should be selected within the timegrain preiod.&quot;\n          }\n        },\n        &quot;endDate&quot;: {\n          &quot;type&quot;: &quot;string&quot;,\n          &quot;metadata&quot;: {\n            &quot;description&quot;: &quot;The end date for the budget in YYYY-MM-DD format. If not provided, we default this to 10 years from the start date.&quot;\n          }\n        },\n        &quot;operator&quot;: {\n          &quot;type&quot;: &quot;string&quot;,\n          &quot;defaultValue&quot;: &quot;GreaterThan&quot;,\n          &quot;allowedValues&quot;: [\n            &quot;EqualTo&quot;,\n            &quot;GreaterThan&quot;,\n            &quot;GreaterThanOrEqualTo&quot;\n          ],\n          &quot;metadata&quot;: {\n            &quot;description&quot;: &quot;The comparison operator.&quot;\n          }\n        },\n        &quot;contactGroups&quot;: {\n          &quot;type&quot;: &quot;string&quot;,\n          &quot;metadata&quot;: {\n            &quot;description&quot;: &quot;The list of action groups to send the budget notification to when the threshold is exceeded. It accepts array of strings.&quot;\n        }\n        },\n        &quot;threshold&quot;: {\n          &quot;type&quot;: &quot;string&quot;,\n          &quot;defaultValue&quot;: &quot;90&quot;,\n          &quot;metadata&quot;: {\n            &quot;description&quot;: &quot;Threshold value associated with a notification. Notification is sent when the cost exceeded the threshold. It is always percent and has to be between 0 and 1000.&quot;\n          }\n        }\n    },\n      &quot;variables&quot;:{\n        &quot;resourcegroupID&quot;: &quot;[concat(subscription().id, '/resourceGroups/', 'ccl_mcs_maintain')]&quot;,\n        &quot;actionGroupName&quot;: &quot;budget Action Group&quot;\n    },\n      &quot;resources&quot;: [\n        {\n          &quot;type&quot;: &quot;Microsoft.Consumption/budgets&quot;,\n          &quot;apiVersion&quot;: &quot;2019-10-01&quot;,\n          &quot;name&quot;: &quot;[concat(parameters('client_initial'), '-MCS-BudgetAlert')]&quot;,\n          &quot;properties&quot;: {\n            &quot;category&quot;: &quot;Cost&quot;,\n            &quot;amount&quot;: &quot;[parameters('amount')]&quot;,\n            &quot;timeGrain&quot;: &quot;[parameters('timeGrain')]&quot;,\n            &quot;timePeriod&quot;: {\n              &quot;startDate&quot;: &quot;[parameters('startDate')]&quot;,\n              &quot;endDate&quot;: &quot;[parameters('endDate')]&quot;\n            },\n            &quot;notifications&quot;: {\n              &quot;First-Notification&quot;: {\n                &quot;enabled&quot;: true,\n                &quot;operator&quot;: &quot;[parameters('operator')]&quot;,\n                &quot;threshold&quot;: &quot;[parameters('threshold')]&quot;,\n                &quot;contactGroups&quot;: &quot;[array(parameters('contactGroups'))]&quot;\n              \n               }\n            }\n          },\n          &quot;dependsOn&quot;: []\n        }\n      ]\n }\n  TEMPLATE\n\n  // NOTE: whilst we show an inline template here, we recommend\n  // sourcing this from a file for readability/editor support\n  #parameters_content = file(&quot;./modules/budget_alert/parameters.json&quot;)\n  parameters_content = &lt;&lt;-PARAMETER\n  {\n    &quot;client_initial&quot;: {\n      &quot;value&quot;: ${jsonencode(var.client_initial)}\n    },\n    &quot;amount&quot;: {\n      &quot;value&quot;: ${jsonencode(var.amount)}\n    },\n    &quot;timeGrain&quot;: {\n      &quot;value&quot;: ${jsonencode(var.timeGrain)}\n    },\n    &quot;startDate&quot;: {\n      &quot;value&quot;: ${jsonencode(var.startDate)}\n    },\n    &quot;endDate&quot;: {\n      &quot;value&quot;: ${jsonencode(var.endDate)}\n    },\n    &quot;operator&quot;: {\n      &quot;value&quot;: ${jsonencode(var.operator)}\n    },\n    &quot;threshold&quot;: {\n      &quot;value&quot;: ${jsonencode(var.threshold)}\n    },\n    &quot;contactGroups&quot;: {\n     &quot;value&quot;: ${jsonencode(var.contactGroups)}\n    }\n  }\n  PARAMETER\n\n\n}\n</code></pre>\n", "OwnerUserId": "13530536", "LastEditorUserId": "13530536", "LastEditDate": "2020-11-09T02:15:42.407", "LastActivityDate": "2020-11-09T02:15:42.407", "Title": "terraform destroy arm template resource, but resource still there?", "Tags": "<terraform><terraform-provider-azure>", "AnswerCount": "1", "CommentCount": "0", "FavoriteCount": "0", "ContentLicense": "CC BY-SA 4.0", "history": [{"Id": "234146467", "PostHistoryTypeId": "2", "PostId": "64660108", "RevisionGUID": "773ffd76-2cb5-4a07-9381-58647cc95956", "CreationDate": "2020-11-03T09:31:49.020", "UserId": "13530536", "Text": "I'm trying to use terraform to deploy budget alert for Azure, unfortunately there's no native resource in terraform for that, so I'm using azurerm_subscription_template_deployment along with ARM template.\r\n\r\nI noticed a strange thing is after the deployment, everything seem fine, I can see the resource (in ARM template) by doing terraform state show.\r\n\r\nHowever, when I do destroy, it doesn't seem to delete the budget alert, it's still there, and if I do terraform state list, it's showing everything is deleted without a trace, but actual resource is still there.\r\n\r\nI noticed terraform has the following for azurerm_resource_group_template_deployment, I assume this is also for subscrption deployment\r\n\r\n\r\n**\"This resource will automatically attempt to delete resources deployed by the ARM Template when it is deleted. You can opt-out of this by setting the delete_nested_items_during_deletion field within the template_deployment block of the features block to false.\"**\r\n\r\n\r\nso If I understand this correctly, If my features block is by default, it should delete the actual resource, when doing destroy.\r\n\r\nwhy it's not behaving correctly?", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "234146468", "PostHistoryTypeId": "1", "PostId": "64660108", "RevisionGUID": "773ffd76-2cb5-4a07-9381-58647cc95956", "CreationDate": "2020-11-03T09:31:49.020", "UserId": "13530536", "Text": "terraform destroy arm template resource, but resource still there?", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "234146469", "PostHistoryTypeId": "3", "PostId": "64660108", "RevisionGUID": "773ffd76-2cb5-4a07-9381-58647cc95956", "CreationDate": "2020-11-03T09:31:49.020", "UserId": "13530536", "Text": "<terraform><terraform-provider-azure>", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "234518123", "PostHistoryTypeId": "5", "PostId": "64660108", "RevisionGUID": "a2597970-c122-4bcd-8a3b-64286332c1da", "CreationDate": "2020-11-09T02:15:42.407", "UserId": "13530536", "Comment": "added 4633 characters in body", "Text": "I'm trying to use terraform to deploy budget alert for Azure, unfortunately there's no native resource in terraform for that, so I'm using azurerm_subscription_template_deployment along with ARM template.\r\n\r\nI noticed a strange thing is after the deployment, everything seem fine, I can see the resource (in ARM template) by doing terraform state show.\r\n\r\nHowever, when I do destroy, it doesn't seem to delete the budget alert, it's still there, and if I do terraform state list, it's showing everything is deleted without a trace, but actual resource is still there.\r\n\r\nI noticed terraform has the following for azurerm_resource_group_template_deployment, I assume this is also for subscrption deployment\r\n\r\n\r\n**\"This resource will automatically attempt to delete resources deployed by the ARM Template when it is deleted. You can opt-out of this by setting the delete_nested_items_during_deletion field within the template_deployment block of the features block to false.\"**\r\n\r\n\r\nso If I understand this correctly, If my features block is by default, it should delete the actual resource, when doing destroy.\r\n\r\nwhy it's not behaving correctly?\r\n\r\n\r\ncode as following\r\n\r\n```\r\nresource \"azurerm_subscription_template_deployment\" \"budgetalert\" {\r\n  name     = \"mcs_budget_alert\"\r\n  location = var.location\r\n\r\n  template_content = <<-TEMPLATE\r\n {\r\n  \"$schema\": \"https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#\",\r\n      \"contentVersion\": \"1.0.0.0\",\r\n      \"parameters\": {\r\n        \"client_initial\": {\r\n          \"type\": \"string\",\r\n          \"metadata\": {\r\n            \"description\": \"Name of the Budget. It should be unique within a resource group.\"\r\n          }\r\n        },\r\n        \"amount\": {\r\n          \"type\": \"string\",\r\n          \"defaultValue\": \"1000\",\r\n          \"metadata\": {\r\n            \"description\": \"The total amount of cost or usage to track with the budget\"\r\n          }\r\n        },\r\n        \"timeGrain\": {\r\n          \"type\": \"string\",\r\n          \"defaultValue\": \"Monthly\",\r\n          \"allowedValues\": [\r\n            \"Monthly\",\r\n            \"Quarterly\",\r\n            \"Annually\"\r\n          ],\r\n          \"metadata\": {\r\n            \"description\": \"The time covered by a budget. Tracking of the amount will be reset based on the time grain.\"\r\n          }\r\n        },\r\n        \"startDate\": {\r\n          \"type\": \"string\",\r\n          \"metadata\": {\r\n            \"description\": \"The start date must be first of the month in YYYY-MM-DD format. Future start date should not be more than three months. Past start date should be selected within the timegrain preiod.\"\r\n          }\r\n        },\r\n        \"endDate\": {\r\n          \"type\": \"string\",\r\n          \"metadata\": {\r\n            \"description\": \"The end date for the budget in YYYY-MM-DD format. If not provided, we default this to 10 years from the start date.\"\r\n          }\r\n        },\r\n        \"operator\": {\r\n          \"type\": \"string\",\r\n          \"defaultValue\": \"GreaterThan\",\r\n          \"allowedValues\": [\r\n            \"EqualTo\",\r\n            \"GreaterThan\",\r\n            \"GreaterThanOrEqualTo\"\r\n          ],\r\n          \"metadata\": {\r\n            \"description\": \"The comparison operator.\"\r\n          }\r\n        },\r\n        \"contactGroups\": {\r\n          \"type\": \"string\",\r\n          \"metadata\": {\r\n            \"description\": \"The list of action groups to send the budget notification to when the threshold is exceeded. It accepts array of strings.\"\r\n        }\r\n        },\r\n        \"threshold\": {\r\n          \"type\": \"string\",\r\n          \"defaultValue\": \"90\",\r\n          \"metadata\": {\r\n            \"description\": \"Threshold value associated with a notification. Notification is sent when the cost exceeded the threshold. It is always percent and has to be between 0 and 1000.\"\r\n          }\r\n        }\r\n    },\r\n      \"variables\":{\r\n        \"resourcegroupID\": \"[concat(subscription().id, '/resourceGroups/', 'ccl_mcs_maintain')]\",\r\n        \"actionGroupName\": \"budget Action Group\"\r\n    },\r\n      \"resources\": [\r\n        {\r\n          \"type\": \"Microsoft.Consumption/budgets\",\r\n          \"apiVersion\": \"2019-10-01\",\r\n          \"name\": \"[concat(parameters('client_initial'), '-MCS-BudgetAlert')]\",\r\n          \"properties\": {\r\n            \"category\": \"Cost\",\r\n            \"amount\": \"[parameters('amount')]\",\r\n            \"timeGrain\": \"[parameters('timeGrain')]\",\r\n            \"timePeriod\": {\r\n              \"startDate\": \"[parameters('startDate')]\",\r\n              \"endDate\": \"[parameters('endDate')]\"\r\n            },\r\n            \"notifications\": {\r\n              \"First-Notification\": {\r\n                \"enabled\": true,\r\n                \"operator\": \"[parameters('operator')]\",\r\n                \"threshold\": \"[parameters('threshold')]\",\r\n                \"contactGroups\": \"[array(parameters('contactGroups'))]\"\r\n              \r\n               }\r\n            }\r\n          },\r\n          \"dependsOn\": []\r\n        }\r\n      ]\r\n }\r\n  TEMPLATE\r\n\r\n  // NOTE: whilst we show an inline template here, we recommend\r\n  // sourcing this from a file for readability/editor support\r\n  #parameters_content = file(\"./modules/budget_alert/parameters.json\")\r\n  parameters_content = <<-PARAMETER\r\n  {\r\n    \"client_initial\": {\r\n      \"value\": ${jsonencode(var.client_initial)}\r\n    },\r\n    \"amount\": {\r\n      \"value\": ${jsonencode(var.amount)}\r\n    },\r\n    \"timeGrain\": {\r\n      \"value\": ${jsonencode(var.timeGrain)}\r\n    },\r\n    \"startDate\": {\r\n      \"value\": ${jsonencode(var.startDate)}\r\n    },\r\n    \"endDate\": {\r\n      \"value\": ${jsonencode(var.endDate)}\r\n    },\r\n    \"operator\": {\r\n      \"value\": ${jsonencode(var.operator)}\r\n    },\r\n    \"threshold\": {\r\n      \"value\": ${jsonencode(var.threshold)}\r\n    },\r\n    \"contactGroups\": {\r\n     \"value\": ${jsonencode(var.contactGroups)}\r\n    }\r\n  }\r\n  PARAMETER\r\n\r\n\r\n}\r\n```", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "It should be unique within a resource group.\" } }, \"amount\": { \"type\": \"string\", \"defaultValue\": \"1000\", \"metadata\": { \"description\": \"The total amount of cost or usage to track with the budget\" } }, \"timeGrain\": { \"type\": \"string\", \"defaultValue\": \"Monthly\", \"allowedValues\": [ \"Monthly\", \"Quarterly\", \"Annually\" ], \"metadata\": { \"description\": \"The time covered by a budget. ", "keywords": ["cost"]}, {"source": "Text", "text": "Notification is sent when the cost exceeded the threshold. ", "keywords": ["cost"]}, {"source": "Text", "text": "It is always percent and has to be between 0 and 1000.\" } } }, \"variables\":{ \"resourcegroupID\": \"[concat(subscription().id, '/resourceGroups/', 'ccl_mcs_maintain')]\", \"actionGroupName\": \"budget Action Group\" }, \"resources\": [ { \"type\": \"Microsoft.Consumption/budgets\", \"apiVersion\": \"2019-10-01\", \"name\": \"[concat(parameters('client_initial'), '-MCS-BudgetAlert')]\", \"properties\": { \"category\": \"Cost\", \"amount\": \"[parameters('amount')]\", \"timeGrain\": \"[parameters('timeGrain')]\", \"timePeriod\": { \"startDate\": \"[parameters('startDate')]\", \"endDate\": \"[parameters('endDate')]\" ", "keywords": ["cost"]}]}], "answers": [{"Id": "64673295", "PostTypeId": "2", "ParentId": "64660108", "CreationDate": "2020-11-04T01:55:53.883", "Score": "0", "Body": "<p>Your understanding is correct but unfortunately, the <code>delete_nested_items_during_deletion</code> field does not take effect on the resources <code>azurerm_subscription_template_deployment</code>. It removes the ARM template partition in the <code>.tfstate</code> file when you run <code>terraform destroy</code>. It also does not be mentioned in the <a href=\"https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/subscription_template_deployment\" rel=\"nofollow noreferrer\">document</a>.</p>\n<p>The field is only available on <code>azurerm_resource_group_template_deployment</code> after my validation. You may have a feature request <a href=\"https://github.com/terraform-providers/terraform-provider-azurerm/issues/1216\" rel=\"nofollow noreferrer\">like this</a>.</p>\n", "OwnerUserId": "9833314", "LastActivityDate": "2020-11-04T01:55:53.883", "CommentCount": "5", "ContentLicense": "CC BY-SA 4.0", "comments": [{"Id": "114351571", "PostId": "64673295", "Score": "0", "Text": "Thanks for that. so what effect does it do when i run destroy for azurerm_subscription_template_deployment ? does it only delete the template within terraform, and not deleting actual resource?", "CreationDate": "2020-11-04T02:07:04.767", "UserId": "13530536", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "114351987", "PostId": "64673295", "Score": "0", "Text": "Yes, Terraform cannot delete these resources during a destroy because Terraform does not know about the individual resources created by Azure using a deployment template. Destroying a template deployment removes the associated deployment operations, but will not delete the Azure resources created by the deployment. Refer [here](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/template_deployment#note)", "CreationDate": "2020-11-04T02:49:39.663", "UserId": "9833314", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "114352169", "PostId": "64673295", "Score": "0", "Text": "Do you still have any questions?", "CreationDate": "2020-11-04T03:10:23.793", "UserId": "9833314", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "114376647", "PostId": "64673295", "Score": "0", "Text": "Hi Nancy, thanks very much for that. Although what puzzling me is the note you provided is for azurerm_template_deployment, I don't see the same note saying about azurerm_subscription_template_deployment. and it's strange that resources deployed by azurerm_resource_group_template_deployment can be deleted after running destroy, but not the same case for azurerm_subscription_template_deployment...", "CreationDate": "2020-11-04T21:15:08.630", "UserId": "13530536", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "114380902", "PostId": "64673295", "Score": "0", "Text": "This is the common working mechanical. Terraform indeed does not know about the individual resources created by Azure using a deployment template. Also, genuine knowledge comes from practice. We all face the same result. I think the `delete_nested_items_during_deletion` field may add in the future. However, usually, there is a workaround case by case. You may show your full code, I can validate it too.", "CreationDate": "2020-11-05T02:05:18.127", "UserId": "9833314", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "history": [{"Id": "234200928", "PostHistoryTypeId": "2", "PostId": "64673295", "RevisionGUID": "c6ad93d9-5166-4877-b7f9-2a87c49fe18c", "CreationDate": "2020-11-04T01:55:53.883", "UserId": "9833314", "Text": "Your understanding is correct but unfortunately, the `delete_nested_items_during_deletion` field does not take effect on the resources `azurerm_subscription_template_deployment`. It removes the ARM template partition in the `.tfstate` file when you run `terraform destroy`. It also does not be mentioned in the [document][1].\r\n\r\nThe field is only available on `azurerm_resource_group_template_deployment` after my validation. You may have a feature request [like this][2].\r\n\r\n\r\n  [1]: https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/subscription_template_deployment\r\n  [2]: https://github.com/terraform-providers/terraform-provider-azurerm/issues/1216", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "You may have a feature request [like this][2]. ", "keywords": ["feature"]}, {"source": "Text", "text": "[1]: https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/subscription_template_deployment [2]: https://github.com/terraform-providers/terraform-provider-azurerm/issues/1216", "keywords": ["provider"]}]}], "filtered-sentences": [{"source": "Body", "text": "You may have a feature request like this.", "keywords": ["feature"]}]}], "contains-topic": true, "filtered-sentences": []}