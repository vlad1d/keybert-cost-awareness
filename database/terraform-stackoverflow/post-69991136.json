{"Id": "69991136", "PostTypeId": "1", "CreationDate": "2021-11-16T14:39:53.213", "Score": "0", "ViewCount": "353", "Body": "<p>I\u2019m creating a new Alias and Subscription for an Enrollment Account by using the following terraform code:</p>\n<pre><code>data &quot;azurerm_billing_enrollment_account_scope&quot; &quot;example&quot; {\n  billing_account_name    = &quot;1234567890&quot;\n  enrollment_account_name = &quot;0123456&quot;\n}\n\nresource &quot;azurerm_subscription&quot; &quot;example&quot; {\n  subscription_name = &quot;My Example EA Subscription&quot;\n  billing_scope_id  = data.azurerm_billing_enrollment_account_scope.example.id\n}\n</code></pre>\n<p>Next, manages a policy set definition and subscription policy assignment by using the following TF code:</p>\n<pre><code>data &quot;azurerm_subscriptions&quot; &quot;availablesubscriptions&quot; {\n  display_name_prefix = var.subscription_name\n}\n\nresource &quot;azurerm_policy_set_definition&quot; &quot;tag_definition&quot; {\n  name         = &quot;${var.subscription_name}-tag-def&quot;\n  display_name = &quot;${var.subscription_name}-tag-def&quot;\n  description  = &quot;Append the default tags definition&quot;\n  policy_type  = &quot;Custom&quot;\n  policy_definitions = templatefile(&quot;${path.module}/templates/tag_definitions.json&quot;,\n  { environmentType = var.environment_Type})\n  \n  metadata = &lt;&lt;METADATA\n    { &quot;category&quot; : &quot;Tags&quot; }\n  METADATA\n  lifecycle { ignore_changes = [metadata] }\n}\n\nresource &quot;azurerm_subscription_policy_assignment&quot; &quot;tag_assignment&quot; {\n  name         = &quot;${var.subscription_name}-tag-assignment&quot;\n  display_name = &quot;${var.subscription_name}-tag-assignment&quot;\n  description  = &quot;Append the default tags assignment&quot;\n  subscription_id      = data.azurerm_subscriptions.availablesubscriptions.subscriptions[0].subscription_id\n  policy_definition_id = azurerm_policy_set_definition.tag_definition.id\n}\n</code></pre>\n<p>I have configured the release pipeline in Azure DevOps, for creating above infrastructure. But in the release, terraform apply task giving the following error:</p>\n<p>Note: The service connection/Active Directory application having the Owner access.</p>\n<blockquote>\n<p>Error: creating Policy Set Definition &quot;XXXX-tag-def&quot;: policy.SetDefinitionsClient#CreateOrUpdate: Failure responding to request: StatusCode=403 -- Original Error: autorest/azure: Service returned an error. Status=403 Code=&quot;AuthorizationFailed&quot; Message=&quot;The client 'XXXXXXXXXXXXX' with object id 'XXXXXXXXXX' does not have authorization to perform action 'Microsoft.Authorization/policySetDefinitions/write' over scope '/subscriptions/***' or the scope is invalid. If access was recently granted, please refresh your credentials.&quot;</p>\n</blockquote>\n", "OwnerUserId": "5471259", "LastActivityDate": "2021-11-16T14:39:53.213", "Title": "Does not have authorization to perform action 'Microsoft.Authorization/policySetDefinitions/write' over scope '/subscriptions/***'", "Tags": "<azure><azure-active-directory><terraform-provider-azure><azure-policy>", "AnswerCount": "0", "CommentCount": "7", "ContentLicense": "CC BY-SA 4.0", "comments": [{"Id": "123728484", "PostId": "69991136", "Score": "0", "Text": "I'd try two things. First, double check that your pipeline is using the service connection you think it is using, and double check the RBAC role assignments at the subscription level to ensure it is an Owner. Second, even if that works, try assigning Resource Policy Contributor to the service connection's service principal. Owner *should* work, but there have been one or two times where I needed to assign that role as well?", "CreationDate": "2021-11-16T16:56:00.010", "UserId": "14289654", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "Second, even if that works, try assigning Resource Policy Contributor to the service connection's service principal. ", "keywords": ["policy"]}]}, {"Id": "123739570", "PostId": "69991136", "Score": "0", "Text": "@WaitingForGuacamole, The service connection having the Owner role at the subscription level. and assigned Resource Policy Contributor to the service connection. But still getting same error.", "CreationDate": "2021-11-17T05:12:12.760", "UserId": "5471259", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "@WaitingForGuacamole, The service connection having the Owner role at the subscription level. and assigned Resource Policy Contributor to the service connection. ", "keywords": ["policy"]}]}, {"Id": "123748219", "PostId": "69991136", "Score": "0", "Text": "Does the service connection have the owner role to the subscription in which you are creating policy definition?", "CreationDate": "2021-11-17T12:38:02.907", "UserId": "16693876", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "Does the service connection have the owner role to the subscription in which you are creating policy definition?", "keywords": ["policy"]}]}, {"Id": "123752851", "PostId": "69991136", "Score": "0", "Text": "@RamaraoAdapa-MT, Yes the service connection have the owner role at the subscription scope.", "CreationDate": "2021-11-17T15:24:40.803", "UserId": "5471259", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "123753034", "PostId": "69991136", "Score": "0", "Text": "@RamaraoAdapa-MT, I'm trying to create the new subscription and then setting up the policy definitions at the newly created subscription scope.  whatever the service connection I'm using in Azure DevOps it is pointed to main subscription.", "CreationDate": "2021-11-17T15:30:42.180", "UserId": "5471259", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "@RamaraoAdapa-MT, I'm trying to create the new subscription and then setting up the policy definitions at the newly created subscription scope. ", "keywords": ["policy"]}]}, {"Id": "123800147", "PostId": "69991136", "Score": "0", "Text": "@Pradeep, then you need to have a role assignment for the service connection service principal in the newly created subscription as well., Adding a role assignment block for owner access to the service connection object Id in the new subscription scope should resolve the issue", "CreationDate": "2021-11-19T10:41:42.147", "UserId": "15969299", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "123805529", "PostId": "69991136", "Score": "0", "Text": "@AnsumanBal-MT, I have assigned Owner access for the service connection service principal in the newly created subscription. But issue is the same.", "CreationDate": "2021-11-19T14:42:11.067", "UserId": "5471259", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "history": [{"Id": "258103688", "PostHistoryTypeId": "2", "PostId": "69991136", "RevisionGUID": "fcdbfd5d-239d-4456-9741-956ec4469f69", "CreationDate": "2021-11-16T14:39:53.213", "UserId": "5471259", "Text": "I\u2019m creating a new Alias and Subscription for an Enrollment Account by using the following terraform code:\r\n\r\n    data \"azurerm_billing_enrollment_account_scope\" \"example\" {\r\n      billing_account_name    = \"1234567890\"\r\n      enrollment_account_name = \"0123456\"\r\n    }\r\n    \r\n    resource \"azurerm_subscription\" \"example\" {\r\n      subscription_name = \"My Example EA Subscription\"\r\n      billing_scope_id  = data.azurerm_billing_enrollment_account_scope.example.id\r\n    }\r\n\r\nNext, manages a policy set definition and subscription policy assignment by using the following TF code:\r\n\r\n    data \"azurerm_subscriptions\" \"availablesubscriptions\" {\r\n      display_name_prefix = var.subscription_name\r\n    }\r\n    \r\n    resource \"azurerm_policy_set_definition\" \"tag_definition\" {\r\n      name         = \"${var.subscription_name}-tag-def\"\r\n      display_name = \"${var.subscription_name}-tag-def\"\r\n      description  = \"Append the default tags definition\"\r\n      policy_type  = \"Custom\"\r\n      policy_definitions = templatefile(\"${path.module}/templates/tag_definitions.json\",\r\n      { environmentType = var.environment_Type})\r\n      \r\n      metadata = <<METADATA\r\n        { \"category\" : \"Tags\" }\r\n      METADATA\r\n      lifecycle { ignore_changes = [metadata] }\r\n    }\r\n    \r\n    resource \"azurerm_subscription_policy_assignment\" \"tag_assignment\" {\r\n      name         = \"${var.subscription_name}-tag-assignment\"\r\n      display_name = \"${var.subscription_name}-tag-assignment\"\r\n      description  = \"Append the default tags assignment\"\r\n      subscription_id      = data.azurerm_subscriptions.availablesubscriptions.subscriptions[0].subscription_id\r\n      policy_definition_id = azurerm_policy_set_definition.tag_definition.id\r\n    }\r\n\r\nI have configured the release pipeline in Azure DevOps, for creating above infrastructure. But in the release, terraform apply task giving the following error:\r\n\r\nNote: The service connection/Active Directory application having the Owner access.\r\n\r\n> Error: creating Policy Set Definition \"XXXX-tag-def\": policy.SetDefinitionsClient#CreateOrUpdate: Failure responding to request: StatusCode=403 -- Original Error: autorest/azure: Service returned an error. Status=403 Code=\"AuthorizationFailed\" Message=\"The client 'XXXXXXXXXXXXX' with object id 'XXXXXXXXXX' does not have authorization to perform action 'Microsoft.Authorization/policySetDefinitions/write' over scope '/subscriptions/***' or the scope is invalid. If access was recently granted, please refresh your credentials.\"\r\n\r\n", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "I\u2019m creating a new Alias and Subscription for an Enrollment Account by using the following terraform code: data \"azurerm_billing_enrollment_account_scope\" \"example\" { billing_account_name = \"1234567890\" enrollment_account_name = \"0123456\" } resource \"azurerm_subscription\" \"example\" { subscription_name = \"My Example EA Subscription\" billing_scope_id = data.azurerm_billing_enrollment_account_scope.example.id } Next, manages a policy set definition and subscription policy assignment by using the following TF code: data \"azurerm_subscriptions\" \"availablesubscriptions\" { display_name_prefix = var.subscription_name } resource \"azurerm_policy_set_definition\" \"tag_definition\" { name = \"${var.subscription_name}-tag-def\" display_name = \"${var.subscription_name}-tag-def\" description = \"Append the default tags definition\" policy_type = \"Custom\" policy_definitions = templatefile(\"${path.module}/templates/tag_definitions.json\", { environmentType = var.environment_Type}) metadata = < Error: creating Policy Set Definition \"XXXX-tag-def\": policy.SetDefinitionsClient#CreateOrUpdate: Failure responding to request: StatusCode=403 -- Original Error: autorest/azure: Service returned an error. ", "keywords": ["bill", "policy"]}]}, {"Id": "258103690", "PostHistoryTypeId": "1", "PostId": "69991136", "RevisionGUID": "fcdbfd5d-239d-4456-9741-956ec4469f69", "CreationDate": "2021-11-16T14:39:53.213", "UserId": "5471259", "Text": "Does not have authorization to perform action 'Microsoft.Authorization/policySetDefinitions/write' over scope '/subscriptions/***'", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "258103691", "PostHistoryTypeId": "3", "PostId": "69991136", "RevisionGUID": "fcdbfd5d-239d-4456-9741-956ec4469f69", "CreationDate": "2021-11-16T14:39:53.213", "UserId": "5471259", "Text": "<azure><azure-active-directory><terraform-provider-azure><azure-policy>", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "contains-topic": true, "filtered-sentences": [{"source": "Body", "text": "I\u2019m creating a new Alias and Subscription for an Enrollment Account by using the following terraform code: Next, manages a policy set definition and subscription policy assignment by using the following TF code: I have configured the release pipeline in Azure DevOps, for creating above infrastructure. ", "keywords": ["policy"]}, {"source": "Body", "text": "Error: creating Policy Set Definition \"XXXX-tag-def\": policy.SetDefinitionsClient#CreateOrUpdate: Failure responding to request: StatusCode=403 -- Original Error: autorest/azure: Service returned an error. ", "keywords": ["policy"]}]}