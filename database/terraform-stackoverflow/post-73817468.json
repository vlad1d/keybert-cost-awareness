{"Id": "73817468", "PostTypeId": "1", "CreationDate": "2022-09-22T15:46:25.653", "Score": "0", "ViewCount": "190", "Body": "<p>I am fairly new to Terraform so I'm still learning the more advanced elements of the language.</p>\n<p>I have created a template that creates 4 azure virtual desktop host pools. I have also created within the same template scaling plans and was trying to create a for_each loop, on the scaling plan, however when it comes to the hostpool_id requirement on the scaling plan I am not sure how to get it to cycle through the 4 hostpool ids that will be created.</p>\n<p><strong>MAIN</strong></p>\n<pre><code>#############\n# HOSTPOOLS #\n#############\nresource &quot;azurerm_virtual_desktop_host_pool&quot; &quot;developer_dev&quot; {\n    name = var.developer_dev_hostpool.name\n    resource_group_name = var.rg_avd_name\n    location = var.rg_avd_location\n    friendly_name = var.developer_dev_hostpool.friendly_name\n    description = var.developer_dev_hostpool.description\n    type = var.developer_dev_hostpool.type\n    maximum_sessions_allowed = var.developer_dev_hostpool.max_sessions\n    load_balancer_type = var.developer_dev_hostpool.lb_type\n\n    scheduled_agent_updates {\n      enabled = true\n      timezone = &quot;GMT Standard Time&quot;\n      schedule {\n        day_of_week = &quot;Saturday&quot;\n        hour_of_day = &quot;02&quot;\n      }\n    }\n}\n\nresource &quot;azurerm_virtual_desktop_host_pool&quot; &quot;developer_prod&quot; {\n    name = var.developer_prod_hostpool.name\n    resource_group_name = var.rg_avd_name\n    location = var.rg_avd_location\n    friendly_name = var.developer_prod_hostpool.friendly_name\n    description = var.developer_prod_hostpool.description\n    type = var.developer_prod_hostpool.type\n    maximum_sessions_allowed = var.developer_prod_hostpool.max_sessions\n    load_balancer_type = var.developer_prod_hostpool.lb_type\n\n    scheduled_agent_updates {\n      enabled = true\n      timezone = &quot;GMT Standard Time&quot;\n      schedule {\n        day_of_week = &quot;Saturday&quot;\n        hour_of_day = &quot;02&quot;\n      }\n    }\n}\n\nresource &quot;azurerm_virtual_desktop_host_pool&quot; &quot;front_office&quot; {\n    name = var.front_office_hostpool.name\n    resource_group_name = var.rg_avd_name\n    location = var.rg_avd_location\n    friendly_name = var.front_office_hostpool.friendly_name\n    description = var.front_office_hostpool.description\n    type = var.front_office_hostpool.type\n    maximum_sessions_allowed = var.front_office_hostpool.max_sessions\n    load_balancer_type = var.front_office_hostpool.lb_type\n\n    scheduled_agent_updates {\n      enabled = true\n      timezone = &quot;GMT Standard Time&quot;\n      schedule {\n        day_of_week = &quot;Saturday&quot;\n        hour_of_day = &quot;02&quot;\n      }\n    }\n}\n\nresource &quot;azurerm_virtual_desktop_host_pool&quot; &quot;back_office&quot; {\n    name = var.back_office_hostpool.name\n    resource_group_name = var.rg_avd_name\n    location = var.rg_avd_location\n    friendly_name = var.back_office_hostpool.friendly_name\n    description = var.back_office_hostpool.description\n    type = var.back_office_hostpool.type\n    maximum_sessions_allowed = var.back_office_hostpool.max_sessions\n    load_balancer_type = var.back_office_hostpool.lb_type\n\n    scheduled_agent_updates {\n      enabled = true\n      timezone = &quot;GMT Standard Time&quot;\n      schedule {\n        day_of_week = &quot;Saturday&quot;\n        hour_of_day = &quot;02&quot;\n      }\n    }\n}\n\n#################\n# SCALING PLANS #\n#################\nresource &quot;azurerm_virtual_desktop_scaling_plan&quot; &quot;sp_weekdays_developer&quot; {\nfor_each = var.sp_weekdays\n    name = each.value.sp_name\n    resource_group_name = var.rg_avd_name\n    location = var.rg_avd_location\n    friendly_name = each.value.sp_friendly_name\n    description = each.value.sp_description\n    time_zone = &quot;GMT Standard Time&quot;\n\n    schedule {\n      name = each.value.sch_name\n      days_of_week = [&quot;Monday&quot;,&quot;Tuesday&quot;,&quot;Wednesday&quot;,&quot;Thursday&quot;,&quot;Friday&quot;]\n      ramp_up_start_time = &quot;07:30&quot;\n      ramp_up_load_balancing_algorithm = each.value.lb_alg\n      ramp_up_minimum_hosts_percent = each.value.ramp_up_min_hosts\n      ramp_up_capacity_threshold_percent = each.value.ramp_up_cap_threshold\n      peak_start_time = &quot;08:00&quot;\n      peak_load_balancing_algorithm = each.value.lb_alg\n      ramp_down_start_time = &quot;18:00&quot;\n      ramp_down_load_balancing_algorithm = each.value.lb_alg\n      ramp_down_minimum_hosts_percent = &quot;80&quot;\n      ramp_down_force_logoff_users = true\n      ramp_down_wait_time_minutes = &quot;60&quot;\n      ramp_down_notification_message = &quot;Your session will be logged off shortly, please save your work.&quot;\n      ramp_down_capacity_threshold_percent = &quot;20&quot;\n      ramp_down_stop_hosts_when = &quot;ZeroActiveSessions&quot;\n      off_peak_start_time = &quot;20:00&quot;\n      off_peak_load_balancing_algorithm = each.value.lb_alg\n    }\n\n    host_pool {\n      hostpool_id = azurerm_virtual_desktop_host_pool.developer_dev.id\n      scaling_plan_enabled = true\n    }\n}\n</code></pre>\n<p><strong>variables</strong></p>\n<pre><code>######################\n# HOSTPOOL VARIABLES #\n######################\nvariable &quot;developer_dev_hostpool&quot; {\n    default = {\n        name = &quot;avdhp-developer-dev-uks-001&quot;\n        friendly_name = &quot;Developer \u2013 Development&quot;\n        description = &quot;Hostpool for developers and contractors working in the development environment&quot;\n        type = &quot;Pooled&quot;\n        max_sessions = &quot;8&quot;\n        lb_type = &quot;DepthFirst&quot; \n    }\n}\n\nvariable &quot;developer_prod_hostpool&quot; {\n    default = {\n        name = &quot;avdhp-developer-prod-uks-001&quot;\n        friendly_name = &quot;Developer \u2013 Production&quot;\n        description = &quot;Hostpool for developers and contractors working in the production environment&quot;\n        type = &quot;Pooled&quot;\n        max_sessions = &quot;8&quot;\n        lb_type = &quot;DepthFirst&quot;\n    }\n}\n\nvariable &quot;front_office_hostpool&quot; {\n    default = {\n        name = &quot;avdhp-front-office-uks-001&quot;\n        friendly_name = &quot;Front Office&quot;\n        description = &quot;Hostpool for front office staff&quot;\n        type = &quot;Pooled&quot;\n        max_sessions = &quot;16&quot;\n        lb_type = &quot;BreadthFirst&quot;\n    }\n}\n\nvariable &quot;back_office_hostpool&quot; {\n    default = {\n        name = &quot;avdhp-back-office-uks-001&quot;\n        friendly_name = &quot;Back Office    &quot;\n        description = &quot;Hostpool for back office staff&quot;\n        type = &quot;Pooled&quot;\n        max_sessions = &quot;12&quot;\n        lb_type = &quot;DepthFirst&quot;\n    }\n}\n\n##########################\n# SCALING PLAN VARIABLES #\n##########################\nvariable &quot;sp_weekdays&quot; {\n    description = &quot;scaling plan for weekdays&quot;\n    default = {\n        developer_dev = {\n            sp_name = &quot;avdsp1&quot;\n            sp_friendly_name = &quot;Developer Weekday Scaling Plan&quot;\n            sp_description = &quot;This scaling plan is for the developers during the week.&quot;\n            sch_name = &quot;Weekdays&quot;\n            lb_alg = &quot;DepthFirst&quot;\n            ramp_up_min_hosts = &quot;50&quot;\n            ramp_up_cap_threshold = &quot;60&quot;\n        }\n        developer_prod = {\n            sp_name = &quot;avdsp3&quot;\n            sp_friendly_name = &quot;Developer Weekday Scaling Plan&quot;\n            sp_description = &quot;This scaling plan is for the developers during the week.&quot;\n            sch_name = &quot;Weekdays&quot;\n            lb_alg = &quot;DepthFirst&quot;\n            ramp_up_min_hosts = &quot;50&quot;\n            ramp_up_cap_threshold = &quot;60&quot;\n        }\n        back_office = {\n            sp_name = &quot;avdsp4&quot;\n            sp_friendly_name = &quot;Back Office Weekday Scaling Plan&quot;\n            sp_description = &quot;This scaling plan is for the back office during the week.&quot;\n            sch_name = &quot;Weekdays&quot;\n            lb_alg = &quot;DepthFirst&quot;\n            ramp_up_min_hosts = &quot;50&quot;\n            ramp_up_cap_threshold = &quot;60&quot;\n        }\n        front_office = {\n            sp_name = &quot;avdsp5&quot;\n            sp_friendly_name = &quot;Front Office Weekday Scaling Plan&quot;\n            sp_description = &quot;This scaling plan is for the front office during the week.&quot;\n            sch_name = &quot;Weekdays&quot;\n            lg_alg = &quot;BreadthFirst&quot;\n            ramp_up_min_hosts = &quot;30&quot;\n            ramp_up_cap_threshold = &quot;75&quot;\n        }\n    }\n}\n</code></pre>\n", "OwnerUserId": "19950878", "LastActivityDate": "2022-09-22T15:46:25.653", "Title": "AVD host pool and scaling plan assignment issues", "Tags": "<azure><terraform>", "AnswerCount": "0", "CommentCount": "7", "ContentLicense": "CC BY-SA 4.0", "comments": [{"Id": "130344265", "PostId": "73817468", "Score": "0", "Text": "What is the error?", "CreationDate": "2022-09-22T15:49:28.130", "UserId": "8343484", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "130344530", "PostId": "73817468", "Score": "0", "Text": "@MarkoE, that's the point, there isn't an error because I'm not sure what I need to do to get the resource ID from the hostpool resource block/variable and put them into the for_each loop for the scaling plans. It might be that my code isn't efficient as it could be, but looking for advice.", "CreationDate": "2022-09-22T16:01:25.037", "UserId": "19950878", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "It might be that my code isn't efficient as it could be, but looking for advice.", "keywords": ["efficient"]}]}, {"Id": "130344603", "PostId": "73817468", "Score": "0", "Text": "You have only one dev pool? Do you need to have that for every pool?", "CreationDate": "2022-09-22T16:04:18.263", "UserId": "8343484", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "130344642", "PostId": "73817468", "Score": "0", "Text": "@MarkoE I have 4 host pools, being created, and each one has its own resource block, then I have tried to do a for_each loop for the scaling plan, but its the hostpool_id element of the scaling plan that I am struggling to dynamically select each hostpool id.", "CreationDate": "2022-09-22T16:06:13.657", "UserId": "19950878", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "130344681", "PostId": "73817468", "Score": "0", "Text": "You cannot do that unless the host pools are also created with `for_each`, i.e., creating one by one and trying to reference it in the scaling will not work.", "CreationDate": "2022-09-22T16:08:10.697", "UserId": "8343484", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "130344764", "PostId": "73817468", "Score": "0", "Text": "OK, thank you for the advice, could you possible point me in the right direction on where I can learn how to do this as the Terraform site isn't fantastic when it comes to Azure learning?", "CreationDate": "2022-09-22T16:12:35.230", "UserId": "19950878", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "130344805", "PostId": "73817468", "Score": "0", "Text": "I'll try to add an answer and explain. It shouldn't be fantastic for a single (cloud) provider, because `for_each` works the same way for any of those.", "CreationDate": "2022-09-22T16:14:41.123", "UserId": "8343484", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "It shouldn't be fantastic for a single (cloud) provider, because `for_each` works the same way for any of those.", "keywords": ["provider"]}]}], "history": [{"Id": "278743633", "PostHistoryTypeId": "2", "PostId": "73817468", "RevisionGUID": "456f8262-a807-4806-8d33-1d16609f6336", "CreationDate": "2022-09-22T15:46:25.653", "UserId": "19950878", "Text": "I am fairly new to Terraform so I'm still learning the more advanced elements of the language.\r\n\r\nI have created a template that creates 4 azure virtual desktop host pools. I have also created within the same template scaling plans and was trying to create a for_each loop, on the scaling plan, however when it comes to the hostpool_id requirement on the scaling plan I am not sure how to get it to cycle through the 4 hostpool ids that will be created.\r\n\r\n**MAIN**\r\n```\r\n#############\r\n# HOSTPOOLS #\r\n#############\r\nresource \"azurerm_virtual_desktop_host_pool\" \"developer_dev\" {\r\n    name = var.developer_dev_hostpool.name\r\n    resource_group_name = var.rg_avd_name\r\n    location = var.rg_avd_location\r\n    friendly_name = var.developer_dev_hostpool.friendly_name\r\n    description = var.developer_dev_hostpool.description\r\n    type = var.developer_dev_hostpool.type\r\n    maximum_sessions_allowed = var.developer_dev_hostpool.max_sessions\r\n    load_balancer_type = var.developer_dev_hostpool.lb_type\r\n\r\n    scheduled_agent_updates {\r\n      enabled = true\r\n      timezone = \"GMT Standard Time\"\r\n      schedule {\r\n        day_of_week = \"Saturday\"\r\n        hour_of_day = \"02\"\r\n      }\r\n    }\r\n}\r\n\r\nresource \"azurerm_virtual_desktop_host_pool\" \"developer_prod\" {\r\n    name = var.developer_prod_hostpool.name\r\n    resource_group_name = var.rg_avd_name\r\n    location = var.rg_avd_location\r\n    friendly_name = var.developer_prod_hostpool.friendly_name\r\n    description = var.developer_prod_hostpool.description\r\n    type = var.developer_prod_hostpool.type\r\n    maximum_sessions_allowed = var.developer_prod_hostpool.max_sessions\r\n    load_balancer_type = var.developer_prod_hostpool.lb_type\r\n\r\n    scheduled_agent_updates {\r\n      enabled = true\r\n      timezone = \"GMT Standard Time\"\r\n      schedule {\r\n        day_of_week = \"Saturday\"\r\n        hour_of_day = \"02\"\r\n      }\r\n    }\r\n}\r\n\r\nresource \"azurerm_virtual_desktop_host_pool\" \"front_office\" {\r\n    name = var.front_office_hostpool.name\r\n    resource_group_name = var.rg_avd_name\r\n    location = var.rg_avd_location\r\n    friendly_name = var.front_office_hostpool.friendly_name\r\n    description = var.front_office_hostpool.description\r\n    type = var.front_office_hostpool.type\r\n    maximum_sessions_allowed = var.front_office_hostpool.max_sessions\r\n    load_balancer_type = var.front_office_hostpool.lb_type\r\n\r\n    scheduled_agent_updates {\r\n      enabled = true\r\n      timezone = \"GMT Standard Time\"\r\n      schedule {\r\n        day_of_week = \"Saturday\"\r\n        hour_of_day = \"02\"\r\n      }\r\n    }\r\n}\r\n\r\nresource \"azurerm_virtual_desktop_host_pool\" \"back_office\" {\r\n    name = var.back_office_hostpool.name\r\n    resource_group_name = var.rg_avd_name\r\n    location = var.rg_avd_location\r\n    friendly_name = var.back_office_hostpool.friendly_name\r\n    description = var.back_office_hostpool.description\r\n    type = var.back_office_hostpool.type\r\n    maximum_sessions_allowed = var.back_office_hostpool.max_sessions\r\n    load_balancer_type = var.back_office_hostpool.lb_type\r\n\r\n    scheduled_agent_updates {\r\n      enabled = true\r\n      timezone = \"GMT Standard Time\"\r\n      schedule {\r\n        day_of_week = \"Saturday\"\r\n        hour_of_day = \"02\"\r\n      }\r\n    }\r\n}\r\n\r\n#################\r\n# SCALING PLANS #\r\n#################\r\nresource \"azurerm_virtual_desktop_scaling_plan\" \"sp_weekdays_developer\" {\r\nfor_each = var.sp_weekdays\r\n    name = each.value.sp_name\r\n    resource_group_name = var.rg_avd_name\r\n    location = var.rg_avd_location\r\n    friendly_name = each.value.sp_friendly_name\r\n    description = each.value.sp_description\r\n    time_zone = \"GMT Standard Time\"\r\n\r\n    schedule {\r\n      name = each.value.sch_name\r\n      days_of_week = [\"Monday\",\"Tuesday\",\"Wednesday\",\"Thursday\",\"Friday\"]\r\n      ramp_up_start_time = \"07:30\"\r\n      ramp_up_load_balancing_algorithm = each.value.lb_alg\r\n      ramp_up_minimum_hosts_percent = each.value.ramp_up_min_hosts\r\n      ramp_up_capacity_threshold_percent = each.value.ramp_up_cap_threshold\r\n      peak_start_time = \"08:00\"\r\n      peak_load_balancing_algorithm = each.value.lb_alg\r\n      ramp_down_start_time = \"18:00\"\r\n      ramp_down_load_balancing_algorithm = each.value.lb_alg\r\n      ramp_down_minimum_hosts_percent = \"80\"\r\n      ramp_down_force_logoff_users = true\r\n      ramp_down_wait_time_minutes = \"60\"\r\n      ramp_down_notification_message = \"Your session will be logged off shortly, please save your work.\"\r\n      ramp_down_capacity_threshold_percent = \"20\"\r\n      ramp_down_stop_hosts_when = \"ZeroActiveSessions\"\r\n      off_peak_start_time = \"20:00\"\r\n      off_peak_load_balancing_algorithm = each.value.lb_alg\r\n    }\r\n\r\n    host_pool {\r\n      hostpool_id = azurerm_virtual_desktop_host_pool.developer_dev.id\r\n      scaling_plan_enabled = true\r\n    }\r\n}\r\n```\r\n**variables**\r\n```\r\n######################\r\n# HOSTPOOL VARIABLES #\r\n######################\r\nvariable \"developer_dev_hostpool\" {\r\n    default = {\r\n        name = \"avdhp-developer-dev-uks-001\"\r\n        friendly_name = \"Developer \u2013 Development\"\r\n        description = \"Hostpool for developers and contractors working in the development environment\"\r\n        type = \"Pooled\"\r\n        max_sessions = \"8\"\r\n        lb_type = \"DepthFirst\" \r\n    }\r\n}\r\n\r\nvariable \"developer_prod_hostpool\" {\r\n    default = {\r\n        name = \"avdhp-developer-prod-uks-001\"\r\n        friendly_name = \"Developer \u2013 Production\"\r\n        description = \"Hostpool for developers and contractors working in the production environment\"\r\n        type = \"Pooled\"\r\n        max_sessions = \"8\"\r\n        lb_type = \"DepthFirst\"\r\n    }\r\n}\r\n\r\nvariable \"front_office_hostpool\" {\r\n    default = {\r\n        name = \"avdhp-front-office-uks-001\"\r\n        friendly_name = \"Front Office\"\r\n        description = \"Hostpool for front office staff\"\r\n        type = \"Pooled\"\r\n        max_sessions = \"16\"\r\n        lb_type = \"BreadthFirst\"\r\n    }\r\n}\r\n\r\nvariable \"back_office_hostpool\" {\r\n    default = {\r\n        name = \"avdhp-back-office-uks-001\"\r\n        friendly_name = \"Back Office    \"\r\n        description = \"Hostpool for back office staff\"\r\n        type = \"Pooled\"\r\n        max_sessions = \"12\"\r\n        lb_type = \"DepthFirst\"\r\n    }\r\n}\r\n\r\n##########################\r\n# SCALING PLAN VARIABLES #\r\n##########################\r\nvariable \"sp_weekdays\" {\r\n    description = \"scaling plan for weekdays\"\r\n    default = {\r\n        developer_dev = {\r\n            sp_name = \"avdsp1\"\r\n            sp_friendly_name = \"Developer Weekday Scaling Plan\"\r\n            sp_description = \"This scaling plan is for the developers during the week.\"\r\n            sch_name = \"Weekdays\"\r\n            lb_alg = \"DepthFirst\"\r\n            ramp_up_min_hosts = \"50\"\r\n            ramp_up_cap_threshold = \"60\"\r\n        }\r\n        developer_prod = {\r\n            sp_name = \"avdsp3\"\r\n            sp_friendly_name = \"Developer Weekday Scaling Plan\"\r\n            sp_description = \"This scaling plan is for the developers during the week.\"\r\n            sch_name = \"Weekdays\"\r\n            lb_alg = \"DepthFirst\"\r\n            ramp_up_min_hosts = \"50\"\r\n            ramp_up_cap_threshold = \"60\"\r\n        }\r\n        back_office = {\r\n            sp_name = \"avdsp4\"\r\n            sp_friendly_name = \"Back Office Weekday Scaling Plan\"\r\n            sp_description = \"This scaling plan is for the back office during the week.\"\r\n            sch_name = \"Weekdays\"\r\n            lb_alg = \"DepthFirst\"\r\n            ramp_up_min_hosts = \"50\"\r\n            ramp_up_cap_threshold = \"60\"\r\n        }\r\n        front_office = {\r\n            sp_name = \"avdsp5\"\r\n            sp_friendly_name = \"Front Office Weekday Scaling Plan\"\r\n            sp_description = \"This scaling plan is for the front office during the week.\"\r\n            sch_name = \"Weekdays\"\r\n            lg_alg = \"BreadthFirst\"\r\n            ramp_up_min_hosts = \"30\"\r\n            ramp_up_cap_threshold = \"75\"\r\n        }\r\n    }\r\n}", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "278743635", "PostHistoryTypeId": "1", "PostId": "73817468", "RevisionGUID": "456f8262-a807-4806-8d33-1d16609f6336", "CreationDate": "2022-09-22T15:46:25.653", "UserId": "19950878", "Text": "AVD host pool and scaling plan assignment issues", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "278743636", "PostHistoryTypeId": "3", "PostId": "73817468", "RevisionGUID": "456f8262-a807-4806-8d33-1d16609f6336", "CreationDate": "2022-09-22T15:46:25.653", "UserId": "19950878", "Text": "<azure><terraform>", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "contains-topic": true, "filtered-sentences": []}