{"Id": "71214030", "PostTypeId": "1", "AcceptedAnswerId": "71216400", "CreationDate": "2022-02-21T23:03:23.100", "Score": "0", "ViewCount": "160", "Body": "<p>I am new to Terraform and Azure. I am trying to build a Resource Group / Resources using Terraform. Below is the design for the same.</p>\n<p><a href=\"https://i.stack.imgur.com/4lxBx.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.stack.imgur.com/4lxBx.png\" alt=\"enter image description here\" /></a></p>\n<p>I have written Terraform code to build Log Analytics workspace and Automation account.\nNow below are my questions :</p>\n<ol>\n<li>Cost Mgmt / Azure Monitor / Network Watcher / Defender for Cloud ? Can I build all these using Terraform code in this resource group or they need to manually built from Azure portal. When we create any resource on the left hand side options like Cost estimator / management are already available. Does that mean they can be easily selected from there on usage and no need to build from Terraform code ?</li>\n<li>How does we apply Role Entitlement / Policy Assignment from Terraform code ?</li>\n</ol>\n<p>Here is my code what I have written to build Automation account / Log Analytics</p>\n<pre><code>terraform {\n\n  required_version = &quot;&gt;=0.12&quot;\n  \n  required_providers {\n    azurerm = {\n      source = &quot;hashicorp/azurerm&quot;\n      version = &quot;~&gt;2.0&quot;\n    }\n  }\n}\n\nprovider &quot;azurerm&quot; {\n  features {}\n}\n\n  resource &quot;azurerm_resource_group&quot; &quot;management&quot; {\n \n  # Mandatory resource attributes\n  name     = &quot;k8s-log-analytics-test&quot;\n  location = &quot;eastus&quot;\n  \n}\n\nresource &quot;random_id&quot; &quot;workspace&quot; {\n  keepers = {\n    # Generate a new id each time we switch to a new resource group\n    group_name = azurerm_resource_group.management.name\n  }\n\n  byte_length = 8\n}\n\nresource &quot;azurerm_log_analytics_workspace&quot; &quot;management&quot; {\n  \n\n  # Mandatory resource attributes\n  name                = &quot;k8s-workspace-${random_id.workspace.hex}&quot;\n  location            = azurerm_resource_group.management.location\n  resource_group_name = azurerm_resource_group.management.name\n\n  # Optional resource attributes \n  retention_in_days          = 30\n  sku                        = &quot;PerGB2018&quot;\n\n\n}\n\nresource &quot;azurerm_log_analytics_solution&quot; &quot;management&quot; {\n\n  # Mandatory resource attributes\n  solution_name         = &quot;mgmyloganalytsolution&quot;\n  location              = azurerm_resource_group.management.location\n  resource_group_name   = azurerm_resource_group.management.name\n  workspace_resource_id = azurerm_log_analytics_workspace.management.id\n  workspace_name        = azurerm_log_analytics_workspace.management.name\n  plan {\n    publisher = &quot;Microsoft&quot;\n    product   = &quot;OMSGallery/ContainerInsights&quot;\n  }\n\n\n}\n\nresource &quot;azurerm_automation_account&quot; &quot;management&quot; {\n  \n  # Mandatory resource attributes\n  name                = &quot;mgmtautomationaccount&quot;\n  location            = azurerm_resource_group.management.location\n  resource_group_name = azurerm_resource_group.management.name \n  sku_name = &quot;Basic&quot;\n \n\n}\n\nresource &quot;azurerm_log_analytics_linked_service&quot; &quot;management&quot; {\n\n  # Mandatory resource attributes\n  resource_group_name = azurerm_resource_group.management.name\n  workspace_id        = azurerm_log_analytics_workspace.management.id\n  read_access_id  = azurerm_automation_account.management.id\n \n\n}\n \n</code></pre>\n", "OwnerUserId": "662285", "LastEditorUserId": "662285", "LastEditDate": "2022-02-21T23:23:48.750", "LastActivityDate": "2022-02-22T05:40:44.993", "Title": "Azure Terraform Build Generic Components using Infrastructure as Code", "Tags": "<azure><terraform><terraform-provider-azure>", "AnswerCount": "1", "CommentCount": "0", "ContentLicense": "CC BY-SA 4.0", "history": [{"Id": "264629208", "PostHistoryTypeId": "2", "PostId": "71214030", "RevisionGUID": "f15e08c1-2b43-4d60-b373-1647fc2079ae", "CreationDate": "2022-02-21T23:03:23.100", "UserId": "662285", "Text": "I am new to Terraform and Azure. I am trying to build a Resource Group / Resources using Terraform. Below is the design for the same.\r\n\r\n[![enter image description here][1]][1]\r\n\r\n\r\n  [1]: https://i.stack.imgur.com/4lxBx.png\r\n\r\nI have written Terraform code to build Log Analytics workspace and Automation account.\r\nNow below are my questions :\r\n1. Cost Mgmt / Azure Monitor / Network Watcher / Defender for Cloud ? Can I build all these using Terraform code in this resource group or they need to manually built from Azure portal. When we create any resource on the left hand side options like Cost estimator / management are already available. Does that mean they can be easily selected from there on usage and no need to build from Terraform code ?\r\n2. How does we apply Role Entitlement / Policy Assignment from Terraform code ?\r\n\r\nHere is my code what I have written to build Automation account / Log Analytics\r\n\r\n    terraform {\r\n    \r\n      required_version = \">=0.12\"\r\n      \r\n      required_providers {\r\n        azurerm = {\r\n          source = \"hashicorp/azurerm\"\r\n          version = \"~>2.0\"\r\n        }\r\n      }\r\n    }\r\n    \r\n    provider \"azurerm\" {\r\n      features {}\r\n    }\r\n    \r\n      resource \"azurerm_resource_group\" \"management\" {\r\n     \r\n      # Mandatory resource attributes\r\n      name     = \"k8s-log-analytics-test\"\r\n      location = \"eastus\"\r\n      \r\n    }\r\n    \r\n    resource \"random_id\" \"workspace\" {\r\n      keepers = {\r\n        # Generate a new id each time we switch to a new resource group\r\n        group_name = azurerm_resource_group.management.name\r\n      }\r\n    \r\n      byte_length = 8\r\n    }\r\n    \r\n    resource \"azurerm_log_analytics_workspace\" \"management\" {\r\n      \r\n    \r\n      # Mandatory resource attributes\r\n      name                = \"k8s-workspace-${random_id.workspace.hex}\"\r\n      location            = azurerm_resource_group.management.location\r\n      resource_group_name = azurerm_resource_group.management.name\r\n    \r\n      # Optional resource attributes \r\n      retention_in_days          = 30\r\n      sku                        = \"PerGB2018\"\r\n    \r\n    \r\n    }\r\n    \r\n    resource \"azurerm_log_analytics_solution\" \"management\" {\r\n    \r\n      # Mandatory resource attributes\r\n      solution_name         = \"mgmyloganalytsolution\"\r\n      location              = azurerm_resource_group.management.location\r\n      resource_group_name   = azurerm_resource_group.management.name\r\n      workspace_resource_id = azurerm_log_analytics_workspace.management.id\r\n      workspace_name        = azurerm_log_analytics_workspace.management.name\r\n      plan {\r\n        publisher = \"Microsoft\"\r\n        product   = \"OMSGallery/ContainerInsights\"\r\n      }\r\n    \r\n    \r\n    }\r\n    \r\n    resource \"azurerm_automation_account\" \"management\" {\r\n      \r\n      # Mandatory resource attributes\r\n      name                = \"mgmtautomationaccount\"\r\n      location            = azurerm_resource_group.management.location\r\n      resource_group_name = azurerm_resource_group.management.name \r\n      sku_name = \"Basic\"\r\n     \r\n    \r\n    }\r\n    \r\n    resource \"azurerm_log_analytics_linked_service\" \"management\" {\r\n    \r\n      # Mandatory resource attributes\r\n      resource_group_name = azurerm_resource_group.management.name\r\n      workspace_id        = azurerm_log_analytics_workspace.management.id\r\n      read_access_id  = azurerm_automation_account.management.id\r\n     \r\n    \r\n    }\r\n     \r\n\r\n", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "Now below are my questions : 1. Cost Mgmt / Azure Monitor / Network Watcher / Defender for Cloud ? ", "keywords": ["cost"]}, {"source": "Text", "text": "When we create any resource on the left hand side options like Cost estimator / management are already available. ", "keywords": ["cost"]}, {"source": "Text", "text": "How does we apply Role Entitlement / Policy Assignment from Terraform code ? ", "keywords": ["policy"]}, {"source": "Text", "text": "Here is my code what I have written to build Automation account / Log Analytics terraform { required_version = \">=0.12\" required_providers { azurerm = { source = \"hashicorp/azurerm\" version = \"~>2.0\" } } } provider \"azurerm\" { features {} } resource \"azurerm_resource_group\" \"management\" { # Mandatory resource attributes name = \"k8s-log-analytics-test\" location = \"eastus\" } resource \"random_id\" \"workspace\" { keepers = { # Generate a new id each time we switch to a new resource group group_name = azurerm_resource_group.management.name } byte_length = 8 } resource \"azurerm_log_analytics_workspace\" \"management\" { # Mandatory resource attributes name = \"k8s-workspace-${random_id.workspace.hex}\" location = azurerm_resource_group.management.location resource_group_name = azurerm_resource_group.management.name # Optional resource attributes retention_in_days = 30 sku = \"PerGB2018\" } resource \"azurerm_log_analytics_solution\" \"management\" { # Mandatory resource attributes solution_name = \"mgmyloganalytsolution\" location = azurerm_resource_group.management.location resource_group_name = azurerm_resource_group.management.name workspace_resource_id = azurerm_log_analytics_workspace.management.id workspace_name = azurerm_log_analytics_workspace.management.name plan { publisher = \"Microsoft\" product = \"OMSGallery/ContainerInsights\" } } resource \"azurerm_automation_account\" \"management\" { # Mandatory resource attributes name = \"mgmtautomationaccount\" location = azurerm_resource_group.management.location resource_group_name = azurerm_resource_group.management.name sku_name = \"Basic\" } resource \"azurerm_log_analytics_linked_service\" \"management\" { # Mandatory resource attributes resource_group_name = azurerm_resource_group.management.name workspace_id = azurerm_log_analytics_workspace.management.id read_access_id = azurerm_automation_account.management.id }", "keywords": ["provider", "test"]}]}, {"Id": "264629210", "PostHistoryTypeId": "1", "PostId": "71214030", "RevisionGUID": "f15e08c1-2b43-4d60-b373-1647fc2079ae", "CreationDate": "2022-02-21T23:03:23.100", "UserId": "662285", "Text": "Azure Terraform Build Generic Components using Infrastructure as Code", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "264629211", "PostHistoryTypeId": "3", "PostId": "71214030", "RevisionGUID": "f15e08c1-2b43-4d60-b373-1647fc2079ae", "CreationDate": "2022-02-21T23:03:23.100", "UserId": "662285", "Text": "<azure><terraform-provider-azure>", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "264630010", "PostHistoryTypeId": "6", "PostId": "71214030", "RevisionGUID": "67d628d6-95e6-4f21-84f8-d97df1324618", "CreationDate": "2022-02-21T23:23:48.750", "UserId": "662285", "Comment": "edited tags", "Text": "<azure><terraform><terraform-provider-azure>", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "answers": [{"Id": "71216400", "PostTypeId": "2", "ParentId": "71214030", "CreationDate": "2022-02-22T05:40:44.993", "Score": "0", "Body": "<blockquote>\n<p>Cost Mgmt / Azure Monitor / Network Watcher / Defender for Cloud ? Can\nI build all these using Terraform code in this resource group or they\nneed to manually built from Azure portal. When we create any resource\non the left hand side options like Cost estimator / management are\nalready available. Does that mean they can be easily selected from\nthere on usage and no need to build from Terraform code ?</p>\n</blockquote>\n<p><em><strong>Yes , you can create Network Watcher , Azure Monitor resources &amp; Cost Management  using terraform resource blocks as <code>azurerm_network_watcher</code> , <code>azurerm_network_watcher_flow_log</code> ,<code>azurerm_monitor_metric_alert</code> <code>...</code> , <code>azurerm_resource_group_cost_management_export</code>, <code>azurerm_consumption_budget_resource_group</code> etc. <code>Defender for Cloud</code> can't be built from terraform . Yes you are correct , cost management ,monitoring etc are also available on portal but there is a need for its resources to be created like budget alert etc. for simplification it has been added as a blade in portal.</strong></em></p>\n<hr />\n<blockquote>\n<p>How does we apply Role Entitlement / Policy Assignment from Terraform\ncode ?</p>\n</blockquote>\n<p><em><strong>You can use <code>azurerm_role_assignment</code> to assign built-in roles and use <code>azurerm_role_definition</code> to create a custom role and then assign it . For Policy assignment you can use this <code>azurerm_resource_policy_assignment</code> and remediate using <code>azurerm_policy_insights_remediation</code>.</strong></em></p>\n<hr />\n<p><strong>For all the azure resource block you can refer the <a href=\"https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs\" rel=\"nofollow noreferrer\"><code>Official Registry Documentation of Terraform AzureRM Provider</code></a> &amp; <a href=\"https://registry.terraform.io/providers/hashicorp/azuread/latest/docs\" rel=\"nofollow noreferrer\"><code>Terraform AzureAD Provider</code></a>.</strong></p>\n", "OwnerUserId": "15969299", "LastActivityDate": "2022-02-22T05:40:44.993", "CommentCount": "0", "ContentLicense": "CC BY-SA 4.0", "history": [{"Id": "264641838", "PostHistoryTypeId": "2", "PostId": "71216400", "RevisionGUID": "b0f813e7-925c-4900-922b-84df35be5506", "CreationDate": "2022-02-22T05:40:44.993", "UserId": "15969299", "Text": "> Cost Mgmt / Azure Monitor / Network Watcher / Defender for Cloud ? Can\r\n> I build all these using Terraform code in this resource group or they\r\n> need to manually built from Azure portal. When we create any resource\r\n> on the left hand side options like Cost estimator / management are\r\n> already available. Does that mean they can be easily selected from\r\n> there on usage and no need to build from Terraform code ?\r\n\r\n***Yes , you can create Network Watcher , Azure Monitor resources & Cost Management  using terraform resource blocks as `azurerm_network_watcher` , `azurerm_network_watcher_flow_log` ,`azurerm_monitor_metric_alert` `...` , `azurerm_resource_group_cost_management_export`, `azurerm_consumption_budget_resource_group` etc. `Defender for Cloud` can't be built from terraform . Yes you are correct , cost management ,monitoring etc are also available on portal but there is a need for its resources to be created like budget alert etc. for simplification it has been added as a blade in portal.***\r\n\r\n----------------------\r\n\r\n> How does we apply Role Entitlement / Policy Assignment from Terraform\r\n> code ?\r\n\r\n***You can use `azurerm_role_assignment` to assign built-in roles and use `azurerm_role_definition` to create a custom role and then assign it . For Policy assignment you can use this `azurerm_resource_policy_assignment` and remediate using `azurerm_policy_insights_remediation`.***\r\n\r\n-------------\r\n\r\n**For all the azure resource block you can refer the [`Official Registry Documentation of Terraform AzureRM Provider`][1] & [`Terraform AzureAD Provider`][2].**\r\n\r\n\r\n  [1]: https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs\r\n  [2]: https://registry.terraform.io/providers/hashicorp/azuread/latest/docs", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "> Cost Mgmt / Azure Monitor / Network Watcher / Defender for Cloud ? Can > I build all these using Terraform code in this resource group or they > need to manually built from Azure portal. ", "keywords": ["cost"]}, {"source": "Text", "text": "When we create any resource > on the left hand side options like Cost estimator / management are > already available. ", "keywords": ["cost"]}, {"source": "Text", "text": "Does that mean they can be easily selected from > there on usage and no need to build from Terraform code ? ***Yes , you can create Network Watcher , Azure Monitor resources & Cost Management using terraform resource blocks as `azurerm_network_watcher` , `azurerm_network_watcher_flow_log` ,`azurerm_monitor_metric_alert` `...` , `azurerm_resource_group_cost_management_export`, `azurerm_consumption_budget_resource_group` etc. ", "keywords": ["cost"]}, {"source": "Text", "text": "Yes you are correct , cost management ,monitoring etc are also available on portal but there is a need for its resources to be created like budget alert etc. for simplification it has been added as a blade in portal.*** ---------------------- > How does we apply Role Entitlement / Policy Assignment from Terraform > code ? ***You can use `azurerm_role_assignment` to assign built-in roles and use `azurerm_role_definition` to create a custom role and then assign it . ", "keywords": ["cost", "policy"]}, {"source": "Text", "text": "For Policy assignment you can use this `azurerm_resource_policy_assignment` and remediate using `azurerm_policy_insights_remediation`.*** ------------- **For all the azure resource block you can refer the [`Official Registry Documentation of Terraform AzureRM Provider`][1] & [`Terraform AzureAD Provider`][2].** [1]: https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs [2]: https://registry.terraform.io/providers/hashicorp/azuread/latest/docs", "keywords": ["provider", "policy"]}]}], "filtered-sentences": [{"source": "Body", "text": "Cost Mgmt / Azure Monitor / Network Watcher / Defender for Cloud ? ", "keywords": ["cost"]}, {"source": "Body", "text": "When we create any resource on the left hand side options like Cost estimator / management are already available. ", "keywords": ["cost"]}, {"source": "Body", "text": "Yes , you can create Network Watcher , Azure Monitor resources & Cost Management using terraform resource blocks as azurerm_network_watcher , azurerm_network_watcher_flow_log ,azurerm_monitor_metric_alert ... , azurerm_resource_group_cost_management_export, azurerm_consumption_budget_resource_group etc. ", "keywords": ["cost"]}, {"source": "Body", "text": "Yes you are correct , cost management ,monitoring etc are also available on portal but there is a need for its resources to be created like budget alert etc. for simplification it has been added as a blade in portal. ", "keywords": ["cost"]}, {"source": "Body", "text": "How does we apply Role Entitlement / Policy Assignment from Terraform code ? ", "keywords": ["policy"]}, {"source": "Body", "text": "For Policy assignment you can use this azurerm_resource_policy_assignment and remediate using azurerm_policy_insights_remediation. ", "keywords": ["policy"]}, {"source": "Body", "text": "For all the azure resource block you can refer the Official Registry Documentation of Terraform AzureRM Provider & Terraform AzureAD Provider.", "keywords": ["provider"]}]}], "contains-topic": true, "filtered-sentences": [{"source": "Body", "text": "Now below are my questions : Cost Mgmt / Azure Monitor / Network Watcher / Defender for Cloud ? ", "keywords": ["cost"]}, {"source": "Body", "text": "When we create any resource on the left hand side options like Cost estimator / management are already available. ", "keywords": ["cost"]}, {"source": "Body", "text": "How does we apply Role Entitlement / Policy Assignment from Terraform code ? ", "keywords": ["policy"]}]}