{"Id": "51949909", "PostTypeId": "1", "CreationDate": "2018-08-21T13:31:31.443", "Score": "0", "ViewCount": "421", "Body": "<p>As described in <a href=\"https://github.com/hashicorp/terraform/issues/17429\" rel=\"nofollow noreferrer\">https://github.com/hashicorp/terraform/issues/17429</a>\nAfter 7 days the spot request is getting cancelled and the instance is still running. So when I run the \"terraform apply\" its trying to create a new spot. This happens with AWS provider >=1.13.0. </p>\n\n<p>I'm using AWS provider 1.32.0, does anyone know a workaround to this issue? on future installation I will use the valid_until flag which will extend the request lifetime, but what about already installed spots? </p>\n\n<p>Thanks</p>\n\n<pre><code>resource \"aws_spot_instance_request\" \"cheap_worker\" {\n  count = \"${var.kube_master_spot_num}\"\n  ami = \"${data.aws_ami.nat_ami.id}\"\n  availability_zone  =\"${element(slice(data.aws_availability_zones.available.names,var.kube_master_on_demand_num,var.availability_zones_num),count.index)}\"\n  spot_price    = \"3\"\n  instance_type = \"${var.kube_master_type}\"\n  subnet_id = \"${element(module.aws-vpc.aws_subnet_ids,count.index + var.kube_master_on_demand_num)}\" # adjusting to a case with spots &amp; on-demand servers\n  vpc_security_group_ids = [ \"${module.aws-vpc.cluster_sg_id}\", \"${module.aws-vpc.route53_sg_id}\" ]\n  key_name = \"${basename(var.local_ssh_key)}\"\n  associate_public_ip_address = true\n  root_block_device = [{volume_type=\"gp2\",volume_size=\"50\",delete_on_termination=true}]\n  spot_type = \"one-time\"\n  wait_for_fulfillment = true\n\n  tags {\n    Name = \"${var.kube_identify}-${var.kube_type}-master-${count.index}\"\n  }\n  provisioner \"local-exec\" {\n      command = \"sleep 120\"\n  }\n  connection {\n    type = \"ssh\"\n    user = \"ubuntu\"\n    private_key = \"${file(var.local_ssh_key)}\"\n  }\n  provisioner \"remote-exec\" {\n    inline = [\n      \"sudo apt-get update\"\n    ]\n  }\n}\n</code></pre>\n", "OwnerUserId": "6866533", "LastEditorUserId": "6866533", "LastEditDate": "2018-08-21T15:02:44.153", "LastActivityDate": "2018-08-21T15:02:44.153", "Title": "Terraform and AWS spots instances", "Tags": "<amazon-ec2><terraform><terraform-provider-aws>", "AnswerCount": "0", "CommentCount": "4", "ContentLicense": "CC BY-SA 4.0", "comments": [{"Id": "90851534", "PostId": "51949909", "Score": "0", "Text": "Can you share the Terraform code you are using to create the spot instances? Is there a reason you don't want to create one time requests instead of persistent requests? I think that might be causing this behaviour.", "CreationDate": "2018-08-21T14:16:30.467", "UserId": "2291321", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "90853018", "PostId": "51949909", "Score": "0", "Text": "code is attached. I using \"one-time\" requests.", "CreationDate": "2018-08-21T14:54:27.770", "UserId": "6866533", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "90857227", "PostId": "51949909", "Score": "0", "Text": "Have you tried using the `valid_until` command?  https://www.terraform.io/docs/providers/aws/r/spot_instance_request.html", "CreationDate": "2018-08-21T16:56:41.563", "UserId": "1723857", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "90895430", "PostId": "51949909", "Score": "0", "Text": "sure....I have mentioned this in my question", "CreationDate": "2018-08-22T17:48:06.870", "UserId": "6866533", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "history": [{"Id": "180180778", "PostHistoryTypeId": "2", "PostId": "51949909", "RevisionGUID": "b67a0349-705f-44f6-bf10-6b034127eac6", "CreationDate": "2018-08-21T13:31:31.443", "UserId": "6866533", "Text": "As described in https://github.com/hashicorp/terraform/issues/17429\r\nAfter 7 days the spot request is getting cancelled and the instance is still running. So when I run the \"terraform apply\" its trying to create a new spot. This happens with AWS provider >=1.13.0. \r\n\r\nI'm using AWS provider 1.32.0, does anyone know a workaround to this issue?\r\n\r\n\r\nThanks", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "As described in https://github.com/hashicorp/terraform/issues/17429 After 7 days the spot request is getting cancelled and the instance is still running. ", "keywords": ["instance"]}, {"source": "Text", "text": "This happens with AWS provider >=1.13.0. ", "keywords": ["provider"]}, {"source": "Text", "text": "I'm using AWS provider 1.32.0, does anyone know a workaround to this issue? ", "keywords": ["provider"]}]}, {"Id": "180180779", "PostHistoryTypeId": "1", "PostId": "51949909", "RevisionGUID": "b67a0349-705f-44f6-bf10-6b034127eac6", "CreationDate": "2018-08-21T13:31:31.443", "UserId": "6866533", "Text": "Terraform and AWS spots instances", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "180180780", "PostHistoryTypeId": "3", "PostId": "51949909", "RevisionGUID": "b67a0349-705f-44f6-bf10-6b034127eac6", "CreationDate": "2018-08-21T13:31:31.443", "UserId": "6866533", "Text": "<amazon-ec2><terraform><terraform-provider-aws>", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "180186833", "PostHistoryTypeId": "5", "PostId": "51949909", "RevisionGUID": "d681e252-c6f2-4120-ae19-fab4d24fad91", "CreationDate": "2018-08-21T14:53:42.110", "UserId": "6866533", "Comment": "added 1413 characters in body", "Text": "As described in https://github.com/hashicorp/terraform/issues/17429\r\nAfter 7 days the spot request is getting cancelled and the instance is still running. So when I run the \"terraform apply\" its trying to create a new spot. This happens with AWS provider >=1.13.0. \r\n\r\nI'm using AWS provider 1.32.0, does anyone know a workaround to this issue?\r\n\r\n\r\nThanks\r\n\r\n    resource \"aws_spot_instance_request\" \"cheap_worker\" {\r\n      count = \"${var.kube_master_spot_num}\"\r\n      ami = \"${data.aws_ami.nat_ami.id}\"\r\n      availability_zone  =\"${element(slice(data.aws_availability_zones.available.names,var.kube_master_on_demand_num,var.availability_zones_num),count.index)}\"\r\n      spot_price    = \"3\"\r\n      instance_type = \"${var.kube_master_type}\"\r\n      subnet_id = \"${element(module.aws-vpc.aws_subnet_ids,count.index + var.kube_master_on_demand_num)}\" # adjusting to a case with spots & on-demand servers\r\n      vpc_security_group_ids = [ \"${module.aws-vpc.cluster_sg_id}\", \"${module.aws-vpc.route53_sg_id}\" ]\r\n      key_name = \"${basename(var.local_ssh_key)}\"\r\n      associate_public_ip_address = true\r\n      root_block_device = [{volume_type=\"gp2\",volume_size=\"50\",delete_on_termination=true}]\r\n      spot_type = \"one-time\"\r\n      wait_for_fulfillment = true\r\n\r\n      tags {\r\n        Name = \"${var.kube_identify}-${var.kube_type}-master-${count.index}\"\r\n      }\r\n      provisioner \"local-exec\" {\r\n          command = \"sleep 120\"\r\n      }\r\n      connection {\r\n        type = \"ssh\"\r\n        user = \"ubuntu\"\r\n        private_key = \"${file(var.local_ssh_key)}\"\r\n      }\r\n      provisioner \"remote-exec\" {\r\n        inline = [\r\n          \"sudo apt-get update\"\r\n        ]\r\n      }\r\n    }", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "After 7 days the spot request is getting cancelled and the instance is still running. ", "keywords": ["instance"]}, {"source": "Text", "text": "This happens with AWS provider >=1.13.0. ", "keywords": ["provider"]}, {"source": "Text", "text": "I'm using AWS provider 1.32.0, does anyone know a workaround to this issue? ", "keywords": ["provider"]}, {"source": "Text", "text": "Thanks resource \"aws_spot_instance_request\" \"cheap_worker\" { count = \"${var.kube_master_spot_num}\" ami = \"${data.aws_ami.nat_ami.id}\" availability_zone =\"${element(slice(data.aws_availability_zones.available.names,var.kube_master_on_demand_num,var.availability_zones_num),count.index)}\" spot_price = \"3\" instance_type = \"${var.kube_master_type}\" subnet_id = \"${element(module.aws-vpc.aws_subnet_ids,count.index + var.kube_master_on_demand_num)}\" # adjusting to a case with spots & on-demand servers vpc_security_group_ids = [ \"${module.aws-vpc.cluster_sg_id}\", \"${module.aws-vpc.route53_sg_id}\" ] key_name = \"${basename(var.local_ssh_key)}\" associate_public_ip_address = true root_block_device = [{volume_type=\"gp2\",volume_size=\"50\",delete_on_termination=true}] spot_type = \"one-time\" wait_for_fulfillment = true tags { Name = \"${var.kube_identify}-${var.kube_type}-master-${count.index}\" } provisioner \"local-exec\" { command = \"sleep 120\" } connection { type = \"ssh\" user = \"ubuntu\" private_key = \"${file(var.local_ssh_key)}\" ", "keywords": ["cheap"]}]}, {"Id": "180187489", "PostHistoryTypeId": "5", "PostId": "51949909", "RevisionGUID": "f7472032-84cd-422a-8af8-4311a071b27e", "CreationDate": "2018-08-21T15:02:44.153", "UserId": "6866533", "Comment": "added 136 characters in body", "Text": "As described in https://github.com/hashicorp/terraform/issues/17429\r\nAfter 7 days the spot request is getting cancelled and the instance is still running. So when I run the \"terraform apply\" its trying to create a new spot. This happens with AWS provider >=1.13.0. \r\n\r\nI'm using AWS provider 1.32.0, does anyone know a workaround to this issue? on future installation I will use the valid_until flag which will extend the request lifetime, but what about already installed spots? \r\n\r\n\r\nThanks\r\n\r\n    resource \"aws_spot_instance_request\" \"cheap_worker\" {\r\n      count = \"${var.kube_master_spot_num}\"\r\n      ami = \"${data.aws_ami.nat_ami.id}\"\r\n      availability_zone  =\"${element(slice(data.aws_availability_zones.available.names,var.kube_master_on_demand_num,var.availability_zones_num),count.index)}\"\r\n      spot_price    = \"3\"\r\n      instance_type = \"${var.kube_master_type}\"\r\n      subnet_id = \"${element(module.aws-vpc.aws_subnet_ids,count.index + var.kube_master_on_demand_num)}\" # adjusting to a case with spots & on-demand servers\r\n      vpc_security_group_ids = [ \"${module.aws-vpc.cluster_sg_id}\", \"${module.aws-vpc.route53_sg_id}\" ]\r\n      key_name = \"${basename(var.local_ssh_key)}\"\r\n      associate_public_ip_address = true\r\n      root_block_device = [{volume_type=\"gp2\",volume_size=\"50\",delete_on_termination=true}]\r\n      spot_type = \"one-time\"\r\n      wait_for_fulfillment = true\r\n\r\n      tags {\r\n        Name = \"${var.kube_identify}-${var.kube_type}-master-${count.index}\"\r\n      }\r\n      provisioner \"local-exec\" {\r\n          command = \"sleep 120\"\r\n      }\r\n      connection {\r\n        type = \"ssh\"\r\n        user = \"ubuntu\"\r\n        private_key = \"${file(var.local_ssh_key)}\"\r\n      }\r\n      provisioner \"remote-exec\" {\r\n        inline = [\r\n          \"sudo apt-get update\"\r\n        ]\r\n      }\r\n    }", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "As described in https://github.com/hashicorp/terraform/issues/17429 After 7 days the spot request is getting cancelled and the instance is still running. ", "keywords": ["instance"]}, {"source": "Text", "text": "This happens with AWS provider >=1.13.0. ", "keywords": ["provider"]}, {"source": "Text", "text": "I'm using AWS provider 1.32.0, does anyone know a workaround to this issue? on future installation ", "keywords": ["provider"]}, {"source": "Text", "text": "Thanks resource \"aws_spot_instance_request\" \"cheap_worker\" { count = \"${var.kube_master_spot_num}\" ami = \"${data.aws_ami.nat_ami.id}\" availability_zone =\"${element(slice(data.aws_availability_zones.available.names,var.kube_master_on_demand_num,var.availability_zones_num),count.index)}\" spot_price = \"3\" instance_type = \"${var.kube_master_type}\" subnet_id = \"${element(module.aws-vpc.aws_subnet_ids,count.index + var.kube_master_on_demand_num)}\" # adjusting to a case with spots & on-demand servers vpc_security_group_ids = [ \"${module.aws-vpc.cluster_sg_id}\", \"${module.aws-vpc.route53_sg_id}\" ] key_name = \"${basename(var.local_ssh_key)}\" associate_public_ip_address = true root_block_device = [{volume_type=\"gp2\",volume_size=\"50\",delete_on_termination=true}] spot_type = \"one-time\" wait_for_fulfillment = true tags { Name = \"${var.kube_identify}-${var.kube_type}-master-${count.index}\" } provisioner \"local-exec\" { command = \"sleep 120\" ", "keywords": ["cheap"]}]}], "contains-topic": true, "filtered-sentences": [{"source": "Body", "text": "As described in https://github.com/hashicorp/terraform/issues/17429 After 7 days the spot request is getting cancelled and the instance is still running. ", "keywords": ["instance"]}, {"source": "Body", "text": "This happens with AWS provider >=1.13.0. ", "keywords": ["provider"]}, {"source": "Body", "text": "I'm using AWS provider 1.32.0, does anyone know a workaround to this issue? on future installation I will use the valid_until flag which will extend the request lifetime, but what about already installed spots? ", "keywords": ["provider"]}]}