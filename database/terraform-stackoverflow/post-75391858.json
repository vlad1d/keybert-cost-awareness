{"Id": "75391858", "PostTypeId": "1", "AcceptedAnswerId": "75395057", "CreationDate": "2023-02-08T21:19:25.363", "Score": "1", "ViewCount": "597", "Body": "<p>I'm deploying an AKS cluster via Terraform.</p>\n<p>I set an oms_agent block within my aks resource block:</p>\n<pre><code>resource &quot;azurerm_kubernetes_cluster&quot; &quot;tfdemo-cluster&quot; {\n  resource_group_name               = var.resourcegroup_name\n  location                          = var.location\n  name                              = &quot;${var.projectname}-aks&quot;\n  node_resource_group               = &quot;${var.resourcegroup_name}-node&quot;\n  ... omitted to shorten ...\n  \n  oms_agent {\n    log_analytics_workspace_id = var.log_analytics_workspace_id\n  }\n</code></pre>\n<p>Like this it works as aspected.</p>\n<p>But when I add an additional resource of type diagnostic_settings like so</p>\n<pre><code>resource &quot;azurerm_monitor_diagnostic_setting&quot; &quot;aks-diagnostics&quot; {\n  name = &quot;aks-logs&quot;\n  storage_account_id = var.storage_account_id\n  target_resource_id = azurerm_kubernetes_cluster.tfdemo-cluster.id\n\n  log {\n    category = &quot;kube-audit&quot;\n    enabled  = true\n  }\n\n  metric {\n    category = &quot;AllMetrics&quot;\n    retention_policy {\n      days    = 30\n      enabled = true\n    }\n  }\n}\n</code></pre>\n<p>I run into an error that says:</p>\n<p>&quot;diagnosticsettings.DiagnosticSettingsClient#CreateOrUpdate: Failure sending request: StatusCode=409 -- Original Error: autorest/azure: Service returned an error. Status=nil nil&quot;</p>\n<p>When I tried to google that error messages I found issues related to other Azure services where the sku of that service wasn't matching a specified feature or capacity but I'm don't see that here.</p>\n<p>Why I want log analytics workspace AND logs dumped into a storage account: My thinking was just that a log anal. ws is really expensive compared to storage in a storage account. So I thought I send say the audit data for long time retention to the cheap storage account (my settings in the given example might not 100% represent that but it's not the point here I'd say) and still have the &quot;expensive&quot; log analytics service to dig into the cluster performance.</p>\n<p>Thanks a lot for any input!</p>\n", "OwnerUserId": "10429096", "LastActivityDate": "2023-02-09T06:40:02.583", "Title": "Azure AKS - oms agent AND diagnostic settings possible together?", "Tags": "<azure><terraform><azure-aks><monitor>", "AnswerCount": "1", "CommentCount": "0", "ContentLicense": "CC BY-SA 4.0", "history": [{"Id": "287715837", "PostHistoryTypeId": "2", "PostId": "75391858", "RevisionGUID": "5ba36728-76a0-499b-ba19-2f777273f0d4", "CreationDate": "2023-02-08T21:19:25.363", "UserId": "10429096", "Text": "I'm deploying an AKS cluster via Terraform.\r\n\r\nI set an oms_agent block within my aks resource block:\r\n```\r\nresource \"azurerm_kubernetes_cluster\" \"tfdemo-cluster\" {\r\n  resource_group_name               = var.resourcegroup_name\r\n  location                          = var.location\r\n  name                              = \"${var.projectname}-aks\"\r\n  node_resource_group               = \"${var.resourcegroup_name}-node\"\r\n  ... omitted to shorten ...\r\n  \r\n  oms_agent {\r\n    log_analytics_workspace_id = var.log_analytics_workspace_id\r\n  }\r\n```\r\nLike this it works as aspected.\r\n\r\nBut when I add an additional resource of type diagnostic_settings like so\r\n```\r\nresource \"azurerm_monitor_diagnostic_setting\" \"aks-diagnostics\" {\r\n  name = \"aks-logs\"\r\n  storage_account_id = var.storage_account_id\r\n  target_resource_id = azurerm_kubernetes_cluster.tfdemo-cluster.id\r\n\r\n  log {\r\n    category = \"kube-audit\"\r\n    enabled  = true\r\n  }\r\n\r\n  metric {\r\n    category = \"AllMetrics\"\r\n    retention_policy {\r\n      days    = 30\r\n      enabled = true\r\n    }\r\n  }\r\n}\r\n```\r\nI run into an error that says:\r\n\r\n\"diagnosticsettings.DiagnosticSettingsClient#CreateOrUpdate: Failure sending request: StatusCode=409 -- Original Error: autorest/azure: Service returned an error. Status=nil nil\"\r\n\r\nWhen I tried to google that error messages I found issues related to other Azure services where the sku of that service wasn't matching a specified feature or capacity but I'm don't see that here.\r\n\r\nWhy I want log analytics workspace AND logs dumped into a storage account: My thinking was just that a log anal. ws is really expensive compared to storage in a storage account. So I thought I send say the audit data for long time retention to the cheap storage account (my settings in the given example might not 100% represent that but it's not the point here I'd say) and still have the \"expensive\" log analytics service to dig into the cluster performance.\r\n\r\nThanks a lot for any input! \r\n", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "I'm deploying an AKS cluster via Terraform. ", "keywords": ["cluster"]}, {"source": "Text", "text": "I set an oms_agent block within my aks resource block: ``` resource \"azurerm_kubernetes_cluster\" \"tfdemo-cluster\" { resource_group_name = var.resourcegroup_name location = var.location name = \"${var.projectname}-aks\" node_resource_group = \"${var.resourcegroup_name}-node\" ... omitted to shorten ... oms_agent { log_analytics_workspace_id = var.log_analytics_workspace_id } ``` Like this it works as aspected. ", "keywords": ["cluster"]}, {"source": "Text", "text": "But when I add an additional resource of type diagnostic_settings like so ``` resource \"azurerm_monitor_diagnostic_setting\" \"aks-diagnostics\" { name = \"aks-logs\" storage_account_id = var.storage_account_id target_resource_id = azurerm_kubernetes_cluster.tfdemo-cluster.id log { category = \"kube-audit\" enabled = true } metric { category = \"AllMetrics\" retention_policy { days = 30 enabled = true } } } ``` ", "keywords": ["cluster"]}, {"source": "Text", "text": "When I tried to google that error messages I found issues related to other Azure services where the sku of that service wasn't matching a specified feature or capacity but I'm don't see that here. ", "keywords": ["feature"]}, {"source": "Text", "text": "Why I want log analytics workspace AND logs dumped into a storage account: My thinking was just that a log anal. ws is really expensive compared to storage in a storage account. ", "keywords": ["expense", "storage"]}, {"source": "Text", "text": "So I thought I send say the audit data for long time retention to the cheap storage account (my settings in the given example might not 100% represent that but it's not the point here I'd say) and still have the \"expensive\" log analytics service to dig into the cluster performance. ", "keywords": ["cheap", "expense", "storage", "cluster"]}]}, {"Id": "287715839", "PostHistoryTypeId": "1", "PostId": "75391858", "RevisionGUID": "5ba36728-76a0-499b-ba19-2f777273f0d4", "CreationDate": "2023-02-08T21:19:25.363", "UserId": "10429096", "Text": "Azure AKS - oms agent AND diagnostic settings possible together?", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "287715840", "PostHistoryTypeId": "3", "PostId": "75391858", "RevisionGUID": "5ba36728-76a0-499b-ba19-2f777273f0d4", "CreationDate": "2023-02-08T21:19:25.363", "UserId": "10429096", "Text": "<azure><terraform><azure-aks><monitor>", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "answers": [{"Id": "75395057", "PostTypeId": "2", "ParentId": "75391858", "CreationDate": "2023-02-09T06:40:02.583", "Score": "2", "Body": "<p><strong>I Tried to reproduce the same in my environment to Create an Azure AKS cluster with OMS Agent and Diagnostic Setting using Terraform:</strong></p>\n<p>Sending long-term data retention logs to a <strong>Azure Storage Account</strong> can be more cost-effective than keeping them in a <strong>Azure Log Analytics workspace</strong>. However, the <strong>Azure Log Analytics workspace</strong> can still be useful for real-time analysis and performance monitoring.</p>\n<pre><code>    provider &quot;azurerm&quot; {\n  features {}\n}\nresource &quot;azurerm_resource_group&quot; &quot;aksgroup&quot; {\n  name     = &quot;aks-rg&quot;\n  location = &quot;East US&quot;\n}\n\nresource &quot;azurerm_log_analytics_workspace&quot; &quot;oms&quot; {\n  name                = &quot;oms-workspace&quot;\n  location            = azurerm_resource_group.aksgroup.location\n  resource_group_name = azurerm_resource_group.aksgroup.name\n  sku                 = &quot;PerGB2018&quot;\n}\n\nresource &quot;azurerm_kubernetes_cluster&quot; &quot;aks&quot; {\n  name                = &quot;cluster-aks1&quot;\n  location            = azurerm_resource_group.aksgroup.location\n  resource_group_name = azurerm_resource_group.aksgroup.name\n  dns_prefix          = &quot;aks1&quot;\n\n  default_node_pool {\n    name       = &quot;default&quot;\n    node_count = 1\n    vm_size    = &quot;standard_a2_v2&quot;\n  }\n\n  identity {\n    type = &quot;SystemAssigned&quot;\n  }\n\n  tags = {\n    Environment = &quot;Production&quot;\n  }\n  addon_profile {\n      oms_agent {\n        enabled                    = true\n        log_analytics_workspace_id = azurerm_log_analytics_workspace.oms.id\n      }\n    }\n}\n\noutput &quot;client_certificate&quot; {\n  value     = azurerm_kubernetes_cluster.aks.kube_config.0.client_certificate\n  sensitive = true\n}\n\noutput &quot;kube_config&quot; {\n  value = azurerm_kubernetes_cluster.aks.kube_config_raw\n\n  sensitive = true\n}\n\nresource &quot;azurerm_monitor_diagnostic_setting&quot; &quot;aks&quot; {\n  name                 = &quot;aks-diagnostic-setting&quot;\n  target_resource_id   = azurerm_kubernetes_cluster.aks.id\n  storage_account_id   = azurerm_storage_account.aks.id\n  log_analytics_workspace_id = azurerm_log_analytics_workspace.oms.id\n  log {\n    category = &quot;kube-audit&quot;\n    enabled  = true\n  }\n  metric {\n    category = &quot;AllMetrics&quot;\n    retention_policy {\n      days    = 30\n      enabled = true\n    }\n  }\n}\n\nresource &quot;azurerm_storage_account&quot; &quot;aks&quot; {\n  name                = &quot;aksdiagnostic&quot;\n  resource_group_name = azurerm_resource_group.aksgroup.name\n  location            = azurerm_resource_group.aksgroup.location\n  account_tier        = &quot;Standard&quot;\n  account_replication_type = &quot;LRS&quot;\n}\n</code></pre>\n<p><strong>Terraform Apply:</strong></p>\n<p><img src=\"https://i.stack.imgur.com/BRcTk.png\" alt=\"enter image description here\" /></p>\n<p>Once ran the code resources are created, like below.</p>\n<p><img src=\"https://i.stack.imgur.com/36Gko.png\" alt=\"enter image description here\" /></p>\n<p>Azure <strong>AKS Diagnostic</strong> settings created with <strong>Log Analytics settings</strong>.</p>\n<p><img src=\"https://i.stack.imgur.com/maQdI.png\" alt=\"enter image description here\" /></p>\n<p><strong>Log Analytics settings- created</strong>.</p>\n<p><img src=\"https://i.stack.imgur.com/jQi5j.png\" alt=\"enter image description here\" /></p>\n", "OwnerUserId": "20465725", "LastActivityDate": "2023-02-09T06:40:02.583", "CommentCount": "1", "ContentLicense": "CC BY-SA 4.0", "comments": [{"Id": "133048733", "PostId": "75395057", "Score": "0", "Text": "Thanks a lot for that detailed and tested answer! I still don't know what is wrong with my setup / is causing my error, but my initial question whether I can have both log destinations is clearly answered and I will espacially look into having both the storage account and the log analytics ws with the diagnostic settings resource. Thanks!", "CreationDate": "2023-02-09T20:21:56.893", "UserId": "10429096", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "Thanks a lot for that detailed and tested answer! ", "keywords": ["test"]}, {"source": "Text", "text": "I still don't know what is wrong with my setup / is causing my error, but my initial question whether I can have both log destinations is clearly answered and I will espacially look into having both the storage account and the log analytics ws with the diagnostic settings resource. ", "keywords": ["storage"]}]}], "history": [{"Id": "287734693", "PostHistoryTypeId": "2", "PostId": "75395057", "RevisionGUID": "48e86c61-897b-4750-b91c-dc53ecbc64a7", "CreationDate": "2023-02-09T06:40:02.583", "UserId": "20465725", "Text": "**I Tried to reproduce the same in my environment to Create an Azure AKS cluster with OMS Agent and Diagnostic Setting using Terraform:**\r\n\r\n\r\nSending long-term data retention logs to a **Azure Storage Account** can be more cost-effective than keeping them in a **Azure Log Analytics workspace**. However, the **Azure Log Analytics workspace** can still be useful for real-time analysis and performance monitoring.\r\n\r\n\r\n        provider \"azurerm\" {\r\n      features {}\r\n    }\r\n    resource \"azurerm_resource_group\" \"aksgroup\" {\r\n      name     = \"aks-rg\"\r\n      location = \"East US\"\r\n    }\r\n    \r\n    resource \"azurerm_log_analytics_workspace\" \"oms\" {\r\n      name                = \"oms-workspace\"\r\n      location            = azurerm_resource_group.aksgroup.location\r\n      resource_group_name = azurerm_resource_group.aksgroup.name\r\n      sku                 = \"PerGB2018\"\r\n    }\r\n    \r\n    resource \"azurerm_kubernetes_cluster\" \"aks\" {\r\n      name                = \"cluster-aks1\"\r\n      location            = azurerm_resource_group.aksgroup.location\r\n      resource_group_name = azurerm_resource_group.aksgroup.name\r\n      dns_prefix          = \"aks1\"\r\n    \r\n      default_node_pool {\r\n        name       = \"default\"\r\n        node_count = 1\r\n        vm_size    = \"standard_a2_v2\"\r\n      }\r\n    \r\n      identity {\r\n        type = \"SystemAssigned\"\r\n      }\r\n    \r\n      tags = {\r\n        Environment = \"Production\"\r\n      }\r\n      addon_profile {\r\n          oms_agent {\r\n            enabled                    = true\r\n            log_analytics_workspace_id = azurerm_log_analytics_workspace.oms.id\r\n          }\r\n        }\r\n    }\r\n    \r\n    output \"client_certificate\" {\r\n      value     = azurerm_kubernetes_cluster.aks.kube_config.0.client_certificate\r\n      sensitive = true\r\n    }\r\n    \r\n    output \"kube_config\" {\r\n      value = azurerm_kubernetes_cluster.aks.kube_config_raw\r\n    \r\n      sensitive = true\r\n    }\r\n    \r\n    resource \"azurerm_monitor_diagnostic_setting\" \"aks\" {\r\n      name                 = \"aks-diagnostic-setting\"\r\n      target_resource_id   = azurerm_kubernetes_cluster.aks.id\r\n      storage_account_id   = azurerm_storage_account.aks.id\r\n      log_analytics_workspace_id = azurerm_log_analytics_workspace.oms.id\r\n      log {\r\n        category = \"kube-audit\"\r\n        enabled  = true\r\n      }\r\n      metric {\r\n        category = \"AllMetrics\"\r\n        retention_policy {\r\n          days    = 30\r\n          enabled = true\r\n        }\r\n      }\r\n    }\r\n    \r\n    resource \"azurerm_storage_account\" \"aks\" {\r\n      name                = \"aksdiagnostic\"\r\n      resource_group_name = azurerm_resource_group.aksgroup.name\r\n      location            = azurerm_resource_group.aksgroup.location\r\n      account_tier        = \"Standard\"\r\n      account_replication_type = \"LRS\"\r\n    }\r\n\r\n**Terraform Apply:**\r\n\r\n![enter image description here](https://i.stack.imgur.com/BRcTk.png)\r\n\r\nOnce ran the code resources are created, like below.\r\n\r\n![enter image description here](https://i.stack.imgur.com/36Gko.png)\r\n\r\nAzure **AKS Diagnostic** settings created with **Log Analytics settings**.\r\n\r\n![enter image description here](https://i.stack.imgur.com/maQdI.png)\r\n\r\n**Log Analytics settings- created**.\r\n\r\n![enter image description here](https://i.stack.imgur.com/jQi5j.png)\r\n", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "**I Tried to reproduce the same in my environment to Create an Azure AKS cluster with OMS Agent and Diagnostic Setting using Terraform:** Sending long-term data retention logs to a **Azure Storage Account** can be more cost-effective than keeping them in a **Azure Log Analytics workspace**. ", "keywords": ["cost", "storage", "cluster"]}, {"source": "Text", "text": "However, the **Azure Log Analytics workspace** can still be useful for real-time analysis and performance monitoring. provider \"azurerm\" { features {} } resource \"azurerm_resource_group\" \"aksgroup\" { name = \"aks-rg\" location = \"East US\" } resource \"azurerm_log_analytics_workspace\" \"oms\" { name = \"oms-workspace\" location = azurerm_resource_group.aksgroup.location resource_group_name = azurerm_resource_group.aksgroup.name sku = \"PerGB2018\" } resource \"azurerm_kubernetes_cluster\" \"aks\" { name = \"cluster-aks1\" location = azurerm_resource_group.aksgroup.location resource_group_name = azurerm_resource_group.aksgroup.name dns_prefix = \"aks1\" default_node_pool { name = \"default\" node_count = 1 vm_size = \"standard_a2_v2\" } identity { type = \"SystemAssigned\" } tags = { Environment = \"Production\" } addon_profile { oms_agent { enabled = true log_analytics_workspace_id = azurerm_log_analytics_workspace.oms.id } } } output \"client_certificate\" { value = azurerm_kubernetes_cluster.aks.kube_config.0.client_certificate sensitive = true } output \"kube_config\" { value = azurerm_kubernetes_cluster.aks.kube_config_raw sensitive = true } resource \"azurerm_monitor_diagnostic_setting\" \"aks\" { name = \"aks-diagnostic-setting\" target_resource_id = azurerm_kubernetes_cluster.aks.id storage_account_id = azurerm_storage_account.aks.id log_analytics_workspace_id = azurerm_log_analytics_workspace.oms.id log { category = \"kube-audit\" enabled = true } metric { category = \"AllMetrics\" retention_policy { days = 30 enabled = true } } } resource \"azurerm_storage_account\" \"aks\" { name = \"aksdiagnostic\" resource_group_name = azurerm_resource_group.aksgroup.name location = azurerm_resource_group.aksgroup.location account_tier = \"Standard\" account_replication_type = \"LRS\" } **Terraform Apply:** ![enter image description here](https://i.stack.imgur.com/BRcTk.png) Once ran the code resources are created, like below. ![enter image description here](https://i.stack.imgur.com/36Gko.png) Azure **AKS Diagnostic** settings created with **Log Analytics settings**. ![enter image description here](https://i.stack.imgur.com/maQdI.png) **Log Analytics settings- created**. ![enter image description here](https://i.stack.imgur.com/jQi5j.png)", "keywords": ["provider", "cluster"]}]}], "filtered-sentences": [{"source": "Body", "text": "I Tried to reproduce the same in my environment to Create an Azure AKS cluster with OMS Agent and Diagnostic Setting using Terraform: Sending long-term data retention logs to a Azure Storage Account can be more cost-effective than keeping them in a Azure Log Analytics workspace. ", "keywords": ["cost", "storage", "cluster"]}]}], "contains-topic": true, "filtered-sentences": [{"source": "Body", "text": "I'm deploying an AKS cluster via Terraform. ", "keywords": ["cluster"]}, {"source": "Body", "text": "When I tried to google that error messages I found issues related to other Azure services where the sku of that service wasn't matching a specified feature or capacity but I'm don't see that here. ", "keywords": ["feature"]}, {"source": "Body", "text": "Why I want log analytics workspace AND logs dumped into a storage account: My thinking was just that a log anal. ws is really expensive compared to storage in a storage account. ", "keywords": ["expense", "storage"]}, {"source": "Body", "text": "So I thought I send say the audit data for long time retention to the cheap storage account (my settings in the given example might not 100% represent that but it's not the point here I'd say) and still have the \"expensive\" log analytics service to dig into the cluster performance. ", "keywords": ["cheap", "expense", "storage", "cluster"]}]}