{"Id": "48277097", "PostTypeId": "1", "CreationDate": "2018-01-16T08:40:53.873", "Score": "3", "ViewCount": "4402", "Body": "<p>If I launch an EC2, the root EBS will not be encrypted (not sure why, maybe because the EC2 is launched from an public AMI. but even I create my own encrypted AMI, I cannot launch an EC2 from it....)</p>\n<p>Anyway, I know that I can encrypt an EBS from an exist EC2 in this way:</p>\n<ol>\n<li><p>launch an EC2 first, then snapshot it,</p>\n</li>\n<li><p>Then copy the snapshot to a new snapshot and set the new snapshot as encrypted.</p>\n</li>\n<li><p>Then create a volume from the new snapshot, then detach the EC2 from the existing un-encrypted volume.</p>\n</li>\n<li><p>Then attach the EC2 to the new encrypted volume and set device as /dev/sda1.</p>\n</li>\n<li><p>Finally, the EC2\u2019s EBS will become encrypted. As you see, the steps are complex.</p>\n</li>\n</ol>\n<p>In fact, I need to create an EC2, and the EC2 should have root EBS encrypted, using Terraform. The above steps seem complex and I do not know how to develop them using Terraform.</p>\n<p>My question is: How to write Terraform code encrypt EBS, after launching an EC2? Any solution is OK, I just want to develop it using Terraform. if Terraform cannot to do that, what other automation tool I should use?</p>\n", "OwnerUserId": "389955", "LastEditorUserId": "12105019", "LastEditDate": "2022-03-06T12:54:56.987", "LastActivityDate": "2022-10-21T22:26:05.097", "Title": "How to encrypt EBS using Terraform after launching an EC2", "Tags": "<amazon-web-services><encryption><amazon-ec2><terraform><amazon-ebs>", "AnswerCount": "2", "CommentCount": "3", "FavoriteCount": "0", "ContentLicense": "CC BY-SA 4.0", "comments": [{"Id": "83542907", "PostId": "48277097", "Score": "3", "Text": "*\"but even I create my own encrypted AMI, I cannot launch an EC2 from it\"*  Stop, there.  You should be able to do this, and it's the simple/obvious solution.  Why do you say you can't launch an instance from an AMI built with encrypted snapshots?", "CreationDate": "2018-01-16T11:03:10.650", "UserId": "1695906", "ContentLicense": "CC BY-SA 3.0", "filtered-sentences": [{"source": "Text", "text": "Why do you say you can't launch an instance from an AMI built with encrypted snapshots?", "keywords": ["instance"]}]}, {"Id": "83557095", "PostId": "48277097", "Score": "0", "Text": "@Michael - sqlbot: last time after I created my own encrypted AMI from public ubuntu16.4(ami-79aeae19). I launched an EC2 from my own encrypted AMI, it failed. the error message showed: launch failed the encrypted flag cannot be specified since device /dev/sda1 has a snapshot specified. today I tried again, it works! So my solution will be: manually create a encrypted AMI in advance, then use it to launch my EC2 in terraform. Thanks!", "CreationDate": "2018-01-16T16:59:57.450", "UserId": "389955", "ContentLicense": "CC BY-SA 3.0", "filtered-sentences": []}, {"Id": "126110631", "PostId": "48277097", "Score": "0", "Text": "Please read \"[ask]\", \"[Stack Overflow question checklist](https://meta.stackoverflow.com/questions/260648)\", \"[mre]\" and their linked pages. You haven't showed us any code, or effort, toward solving the problem. We need to know what you've tried, otherwise it looks like you didn't try and want us to find or write a solution for you, which is off-topic.", "CreationDate": "2022-03-04T04:02:47.690", "UserId": "128421", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "history": [{"Id": "164751560", "PostHistoryTypeId": "2", "PostId": "48277097", "RevisionGUID": "83397237-c906-4420-8355-ef1bc99abbff", "CreationDate": "2018-01-16T08:40:53.873", "UserId": "389955", "Text": "If I launch an EC2, the root EBS will not be encrypted (not sure why, maybe because the EC2 is launched from an public AMI. but even I create my own encrypted AMI, I cannot launch an EC2 from it....) \r\n\r\nAnyway, I know that I can encrypt an EBS from an exist EC2 in this way: launch an EC2 first, then snapshot it, then copy the snapshot to a new snapshot and set the new snapshot as encrypted, then create a volume from the new snapshot, then detach the EC2 from the existing un-encrypted volume, then attach the EC2 to the new encrypted volume and set device as /dev/sda1. Finally, the EC2\u2019s EBS will become encrypted. As you see, the steps are complex.\r\n\r\nIn fact, I need to create an EC2, and the EC2 should have root EBS encrypted, using Terraform. The above steps seem complex and I do not know how to develop them using Terraform. \r\n\r\nMy question is: How to write Terraform code encrypt EBS, after launching an EC2? Any solution is OK, I just want to develop it using Terraform. if Terraform cannot to do that, what other automation tool I should use?", "ContentLicense": "CC BY-SA 3.0", "filtered-sentences": []}, {"Id": "164751561", "PostHistoryTypeId": "1", "PostId": "48277097", "RevisionGUID": "83397237-c906-4420-8355-ef1bc99abbff", "CreationDate": "2018-01-16T08:40:53.873", "UserId": "389955", "Text": "How to encrypt EBS using Terraform after launching an EC2", "ContentLicense": "CC BY-SA 3.0", "filtered-sentences": []}, {"Id": "164751562", "PostHistoryTypeId": "3", "PostId": "48277097", "RevisionGUID": "83397237-c906-4420-8355-ef1bc99abbff", "CreationDate": "2018-01-16T08:40:53.873", "UserId": "389955", "Text": "<amazon-web-services><encryption><amazon-ec2><terraform><aws-ebs>", "ContentLicense": "CC BY-SA 3.0", "filtered-sentences": []}, {"Id": "265468921", "PostHistoryTypeId": "5", "PostId": "48277097", "RevisionGUID": "34385f8c-6331-4cac-842f-8116090106b4", "CreationDate": "2022-03-06T12:54:56.987", "UserId": "12105019", "Comment": "fixed grammer", "Text": "If I launch an EC2, the root EBS will not be encrypted (not sure why, maybe because the EC2 is launched from an public AMI. but even I create my own encrypted AMI, I cannot launch an EC2 from it....) \r\n\r\nAnyway, I know that I can encrypt an EBS from an exist EC2 in this way:\r\n \r\n1. launch an EC2 first, then snapshot it,\r\n \r\n2. Then copy the snapshot to a new snapshot and set the new snapshot as encrypted.\r\n\r\n3. Then create a volume from the new snapshot, then detach the EC2 from the existing un-encrypted volume.\r\n \r\n4. Then attach the EC2 to the new encrypted volume and set device as /dev/sda1. \r\n\r\n5. Finally, the EC2\u2019s EBS will become encrypted. As you see, the steps are complex.\r\n\r\nIn fact, I need to create an EC2, and the EC2 should have root EBS encrypted, using Terraform. The above steps seem complex and I do not know how to develop them using Terraform. \r\n\r\nMy question is: How to write Terraform code encrypt EBS, after launching an EC2? Any solution is OK, I just want to develop it using Terraform. if Terraform cannot to do that, what other automation tool I should use?", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "265468922", "PostHistoryTypeId": "6", "PostId": "48277097", "RevisionGUID": "34385f8c-6331-4cac-842f-8116090106b4", "CreationDate": "2022-03-06T12:54:56.987", "UserId": "12105019", "Comment": "fixed grammer", "Text": "<amazon-web-services><encryption><amazon-ec2><terraform><amazon-ebs>", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "265468923", "PostHistoryTypeId": "24", "PostId": "48277097", "RevisionGUID": "34385f8c-6331-4cac-842f-8116090106b4", "CreationDate": "2022-03-06T12:54:56.987", "Comment": "Proposed by 12105019 approved by 6463558, 4267244 edit id of 5336599", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "answers": [{"Id": "74070790", "PostTypeId": "2", "ParentId": "48277097", "CreationDate": "2022-10-14T14:31:09.003", "Score": "1", "Body": "<p>Create a KMS key to encrypt the volume and then you can add this to Terraform script</p>\n<pre class=\"lang-json prettyprint-override\"><code>    root_block_device {\n        \n        volume_type = &quot;gp2&quot;\n        volume_size = 100\n        delete_on_termination = true\n        encrypted         = true  \n        kms_key_id        = &quot;arn of key&quot;\n    \n     }\n</code></pre>\n", "OwnerUserId": "19476905", "LastEditorUserId": "1835621", "LastEditDate": "2022-10-21T22:26:05.097", "LastActivityDate": "2022-10-21T22:26:05.097", "CommentCount": "1", "ContentLicense": "CC BY-SA 4.0", "comments": [{"Id": "130879998", "PostId": "74070790", "Score": "0", "Text": "gp3 is cheaper if configured correctly.", "CreationDate": "2022-10-19T16:07:44.957", "UserId": "1835621", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "gp3 is cheaper if configured correctly.", "keywords": ["cheap"]}]}], "history": [{"Id": "280125201", "PostHistoryTypeId": "2", "PostId": "74070790", "RevisionGUID": "072046a9-3451-400c-a012-5bfa85c889f2", "CreationDate": "2022-10-14T14:31:09.003", "UserId": "19476905", "Text": "create kms key to encrypt volume and then you can add this to terraform script\r\n\r\nroot_block_device {\r\n    \r\n    volume_type = \"gp2\"\r\n    volume_size = 100\r\n    delete_on_termination = true\r\n    encrypted         = true  \r\n    kms_key_id        = \"arn of key\"\r\n\r\n }", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "280608593", "PostHistoryTypeId": "5", "PostId": "74070790", "RevisionGUID": "438ea810-8148-4d60-b3b5-5d2e065c9730", "CreationDate": "2022-10-21T22:26:05.097", "UserId": "1835621", "Comment": "Styling and some typos fixed", "Text": "Create a KMS key to encrypt the volume and then you can add this to Terraform script\r\n\r\n```json\r\n    root_block_device {\r\n        \r\n        volume_type = \"gp2\"\r\n        volume_size = 100\r\n        delete_on_termination = true\r\n        encrypted         = true  \r\n        kms_key_id        = \"arn of key\"\r\n    \r\n     }\r\n```", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "280608594", "PostHistoryTypeId": "24", "PostId": "74070790", "RevisionGUID": "438ea810-8148-4d60-b3b5-5d2e065c9730", "CreationDate": "2022-10-21T22:26:05.097", "Comment": "Proposed by 1835621 approved by 8343484, 8442437 edit id of 5430433", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "filtered-sentences": []}, {"Id": "62475330", "PostTypeId": "2", "ParentId": "48277097", "CreationDate": "2020-06-19T17:09:45.237", "Score": "2", "Body": "<p>I had the same issue. You can use below snippet and add this into your terraform script. Next, destroy your infra setup and try to recreate it, all your EC2 instances will created with attached EBS volume which are encrypted in turn.</p>\n<pre><code>resource &quot;aws_ebs_encryption_by_default&quot; &quot;enabled&quot; {\n     enabled = true\n}\n</code></pre>\n", "OwnerUserId": "13777141", "LastEditorUserId": "12105019", "LastEditDate": "2022-03-04T10:22:10.680", "LastActivityDate": "2022-03-04T10:22:10.680", "CommentCount": "0", "ContentLicense": "CC BY-SA 4.0", "history": [{"Id": "224467706", "PostHistoryTypeId": "2", "PostId": "62475330", "RevisionGUID": "b4594642-ae2f-4a96-b822-1afadb7c1c3b", "CreationDate": "2020-06-19T17:09:45.237", "UserId": "13777141", "Text": "I had the same issue. If you add this into your terraform script. And then destroy your build and reapply it, all your Ec2 instances will by default be built with an attached EBS volume which is encrypted.\r\n\r\n     resource \"aws_ebs_encryption_by_default\" \"enabled\" {\r\n     enabled = true\r\n      }\r\n\r\n\r\n", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "265350151", "PostHistoryTypeId": "5", "PostId": "62475330", "RevisionGUID": "ede3e98c-8d1e-44ed-b0fc-2ff38a8d617c", "CreationDate": "2022-03-04T10:22:10.680", "UserId": "12105019", "Comment": "fixed grammer", "Text": "I had the same issue. You can use below snippet and add this into your terraform script. Next, destroy your infra setup and try to recreate it, all your EC2 instances will created with attached EBS volume which are encrypted in turn.\r\n\r\n```\r\nresource \"aws_ebs_encryption_by_default\" \"enabled\" {\r\n     enabled = true\r\n}\r\n```\r\n\r\n\r\n", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "265350152", "PostHistoryTypeId": "24", "PostId": "62475330", "RevisionGUID": "ede3e98c-8d1e-44ed-b0fc-2ff38a8d617c", "CreationDate": "2022-03-04T10:22:10.680", "Comment": "Proposed by 12105019 approved by 6463558, 13661061 edit id of 5336601", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "filtered-sentences": []}], "contains-topic": true, "filtered-sentences": []}