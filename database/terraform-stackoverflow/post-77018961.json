{"Id": "77018961", "PostTypeId": "1", "CreationDate": "2023-08-31T20:03:50.740", "Score": "0", "ViewCount": "27", "Body": "<p>friends! I'm pretty new on deploying golang applications to GCP. So when I try to deploy my golang app on cloud function with terraform it fails.</p>\n<p>This is my main.tf:</p>\n<pre><code>resource &quot;google_storage_bucket&quot; &quot;bucket&quot; {\n  name     = &quot;some-bucket&quot;\n  location = &quot;US&quot;\n  project  = &quot;some-project&quot;\n  uniform_bucket_level_access = true\n}\n\nresource &quot;google_storage_bucket_object&quot; &quot;archive&quot; {\n  name   = &quot;function.zip&quot;\n  bucket = google_storage_bucket.bucket.name\n  source = &quot;C:/Users/User/Downloads/function.zip&quot;\n}\n\nresource &quot;google_cloudfunctions_function&quot; &quot;function&quot; {\n  name        = &quot;some-name&quot;\n  description = &quot;some-description&quot;\n  runtime     = &quot;go119&quot;\n  project     = &quot;some-project&quot;\n  region      = &quot;us-central1&quot;\n\n  available_memory_mb = 128\n\n  source_archive_bucket = google_storage_bucket.bucket.name\n  source_archive_object = google_storage_bucket_object.archive.name\n  entry_point           = &quot;main&quot;\n  trigger_http          = true\n}\n\nresource &quot;google_cloudfunctions_function_iam_member&quot; &quot;invoker&quot; {\n  project        = google_cloudfunctions_function.function.project\n  region         = google_cloudfunctions_function.function.region\n  cloud_function = google_cloudfunctions_function.function.name\n\n  role   = &quot;roles/cloudfunctions.invoker&quot;\n  member = &quot;allUsers&quot;\n}\n</code></pre>\n<p>But when running <code>terraform apply</code> I'm facing this issue:\nError: Error waiting for Creating CloudFunctions Function: Error code 3, message: Build failed: functions.local/app/main.go:18:2: import &quot;example.com/gcp-cost-lambda&quot; is a program, not an importable package; Error ID: 6fba28bd</p>\n<p>This is my project structure:\n<a href=\"https://i.stack.imgur.com/kbBd7.png\" rel=\"nofollow noreferrer\">Project structure</a>\nThis is my main.go imports section:\npackage main</p>\n<pre><code>import (\n    &quot;context&quot;\n    &quot;log&quot;\n    &quot;os&quot;\n    &quot;time&quot;\n\n    &quot;example.com/gcp-cost-lambda/cost&quot;\n    &quot;example.com/gcp-cost-lambda/notification/email&quot;\n    &quot;example.com/gcp-cost-lambda/notification/slack&quot;\n\n    &quot;github.com/joho/godotenv&quot;\n)\n</code></pre>\n<p>And this is a beginning of my go.mod:</p>\n<pre><code>module example.com/gcp-cost-lambda\ngo 1.19\n</code></pre>\n<p>The app itself builds and runs with no problems locally on my PC, but cloud function is not working at all. I would be insanely grateful for any help!</p>\n", "OwnerUserId": "22479961", "LastActivityDate": "2023-08-31T20:03:50.740", "Title": "Cloud function creation on GCP fails with Terraform", "Tags": "<go><google-cloud-platform><deployment><terraform><google-cloud-functions>", "AnswerCount": "0", "CommentCount": "5", "ContentLicense": "CC BY-SA 4.0", "comments": [{"Id": "135774878", "PostId": "77018961", "Score": "0", "Text": "Are you able to deploy the code to GCP *without* using Terraform? That's the first thing I'd try - separate out the Terraform aspect from the function aspect.", "CreationDate": "2023-08-31T20:05:55.003", "UserId": "22656", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "135774975", "PostId": "77018961", "Score": "1", "Text": "Did you try a go mod tidy?", "CreationDate": "2023-08-31T20:13:41.143", "UserId": "11372593", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "135775016", "PostId": "77018961", "Score": "0", "Text": "@JonSkeet Yes, I've tried to deploy it manually. Still fails with same error", "CreationDate": "2023-08-31T20:18:37.627", "UserId": "22479961", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "135775039", "PostId": "77018961", "Score": "0", "Text": "@guillaumeblaquiere Yes, I run go mod tidy several times", "CreationDate": "2023-08-31T20:20:47.857", "UserId": "22479961", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "135775115", "PostId": "77018961", "Score": "0", "Text": "Right, in that case I would suggest getting rid of everything about Terraform from the question. Focus on deploying it manually, and once that's done, hopefully it'll be fine in Terraform.", "CreationDate": "2023-08-31T20:28:31.670", "UserId": "22656", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "history": [{"Id": "297346815", "PostHistoryTypeId": "2", "PostId": "77018961", "RevisionGUID": "56640a0f-a227-4d3a-b769-6603eb52400e", "CreationDate": "2023-08-31T20:03:50.740", "UserId": "22479961", "Text": "friends! I'm pretty new on deploying golang applications to GCP. So when I try to deploy my golang app on cloud function with terraform it fails.\r\n\r\n\r\nThis is my main.tf:\r\n```\r\nresource \"google_storage_bucket\" \"bucket\" {\r\n  name     = \"some-bucket\"\r\n  location = \"US\"\r\n  project  = \"some-project\"\r\n  uniform_bucket_level_access = true\r\n}\r\n\r\nresource \"google_storage_bucket_object\" \"archive\" {\r\n  name   = \"function.zip\"\r\n  bucket = google_storage_bucket.bucket.name\r\n  source = \"C:/Users/User/Downloads/function.zip\"\r\n}\r\n\r\nresource \"google_cloudfunctions_function\" \"function\" {\r\n  name        = \"some-name\"\r\n  description = \"some-description\"\r\n  runtime     = \"go119\"\r\n  project     = \"some-project\"\r\n  region      = \"us-central1\"\r\n\r\n  available_memory_mb = 128\r\n\r\n  source_archive_bucket = google_storage_bucket.bucket.name\r\n  source_archive_object = google_storage_bucket_object.archive.name\r\n  entry_point           = \"main\"\r\n  trigger_http          = true\r\n}\r\n\r\nresource \"google_cloudfunctions_function_iam_member\" \"invoker\" {\r\n  project        = google_cloudfunctions_function.function.project\r\n  region         = google_cloudfunctions_function.function.region\r\n  cloud_function = google_cloudfunctions_function.function.name\r\n\r\n  role   = \"roles/cloudfunctions.invoker\"\r\n  member = \"allUsers\"\r\n}\r\n```\r\nBut when running `terraform apply` I'm facing this issue:\r\nError: Error waiting for Creating CloudFunctions Function: Error code 3, message: Build failed: functions.local/app/main.go:18:2: import \"example.com/gcp-cost-lambda\" is a program, not an importable package; Error ID: 6fba28bd\r\n\r\nThis is my project structure:\r\n[Project structure](https://i.stack.imgur.com/kbBd7.png)\r\nThis is my main.go imports section:\r\npackage main\r\n\r\n```\r\nimport (\r\n \"context\"\r\n \"log\"\r\n \"os\"\r\n \"time\"\r\n\r\n \"example.com/gcp-cost-lambda/cost\"\r\n \"example.com/gcp-cost-lambda/notification/email\"\r\n \"example.com/gcp-cost-lambda/notification/slack\"\r\n\r\n \"github.com/joho/godotenv\"\r\n)\r\n```\r\nAnd this is a beginning of my go.mod:\r\n```\r\nmodule example.com/gcp-cost-lambda\r\ngo 1.19\r\n```\r\n\r\nThe app itself builds and runs with no problems locally on my PC, but cloud function is not working at all. I would be insanely grateful for any help!", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "I'm facing this issue: Error: Error waiting for Creating CloudFunctions Function: Error code 3, message: Build failed: functions.local/app/main.go:18:2: import \"example.com/gcp-cost-lambda\" is a program, not an importable package; Error ID: 6fba28bd This is my project structure: [Project structure](https://i.stack.imgur.com/kbBd7.png) This is my main.go imports section: package main ``` import ( \"context\" \"log\" \"os\" \"time\" \"example.com/gcp-cost-lambda/cost\" \"example.com/gcp-cost-lambda/notification/email\" \"example.com/gcp-cost-lambda/notification/slack\" \"github.com/joho/godotenv\" ) ``` ", "keywords": ["cost"]}, {"source": "Text", "text": "And this is a beginning of my go.mod: ``` module example.com/gcp-cost-lambda go 1.19 ``` ", "keywords": ["cost"]}]}, {"Id": "297346817", "PostHistoryTypeId": "1", "PostId": "77018961", "RevisionGUID": "56640a0f-a227-4d3a-b769-6603eb52400e", "CreationDate": "2023-08-31T20:03:50.740", "UserId": "22479961", "Text": "Cloud function creation on GCP fails with Terraform", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "297346818", "PostHistoryTypeId": "3", "PostId": "77018961", "RevisionGUID": "56640a0f-a227-4d3a-b769-6603eb52400e", "CreationDate": "2023-08-31T20:03:50.740", "UserId": "22479961", "Text": "<go><google-cloud-platform><deployment><terraform><google-cloud-functions>", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "297346819", "PostHistoryTypeId": "66", "PostId": "77018961", "RevisionGUID": "56640a0f-a227-4d3a-b769-6603eb52400e", "CreationDate": "2023-08-31T20:03:50.740", "UserId": "22479961", "filtered-sentences": []}], "contains-topic": false, "filtered-sentences": [{"source": "Body", "text": "This is my main.tf: But when running terraform apply I'm facing this issue: Error: Error waiting for Creating CloudFunctions Function: Error code 3, message: Build failed: functions.local/app/main.go:18:2: import \"example.com/gcp-cost-lambda\" is a program, not an importable package; Error ID: 6fba28bd This is my project structure: Project structure ", "keywords": ["cost"]}]}