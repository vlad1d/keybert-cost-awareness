{"Id": "74122987", "PostTypeId": "1", "CreationDate": "2022-10-19T09:27:31.773", "Score": "0", "ViewCount": "24", "Body": "<p>I would like to merge locals values:</p>\n<p>For now, I have this:</p>\n<pre><code>permission_defaults = {\n  groups = {\n    &quot;group_1&quot; = [&quot;read&quot;]\n    &quot;group_2&quot; = [&quot;read&quot;]\n    &quot;group_3&quot; = [&quot;read&quot;]\n  }\n}\n\npermission_raw = {\n  &quot;prod&quot; = {\n    repositories = [\n      &quot;prod-repo&quot;,\n    ]\n  },\n  &quot;dev&quot; = {\n    repositories = [\n      &quot;dev-repo&quot;,\n    ],\n    groups = {\n      &quot;group_1&quot; = [&quot;read&quot;, &quot;delete&quot;, &quot;write&quot;]\n      &quot;group_2&quot; = [&quot;read&quot;, &quot;delete&quot;, &quot;write&quot;]\n      &quot;group_3&quot; = [&quot;read&quot;, &quot;delete&quot;, &quot;write&quot;]\n    }\n  }\n}\n\npermissions = {\n  for k, v in local.permission_raw : k =&gt; merge(local.permission_defaults, v)\n}\n</code></pre>\n<p>So, basically it's some default permissions that I overwrite with specific values. This works well.</p>\n<p>Now, I want to add a new permission that is the same as <code>dev</code>, <em>plus</em> something else:</p>\n<pre><code>permission_defaults = {\n  groups = {\n    &quot;group_1&quot; = [&quot;read&quot;]\n    &quot;group_2&quot; = [&quot;read&quot;]\n    &quot;group_3&quot; = [&quot;read&quot;]\n  }\n}\n\npermission_raw = {\n  &quot;prod&quot; = {\n    repositories = [\n      &quot;prod-repo&quot;,\n    ]\n  },\n  &quot;dev&quot; = {\n    repositories = [\n      &quot;dev-repo&quot;,\n    ],\n    groups = {\n      &quot;group_1&quot; = [&quot;read&quot;, &quot;delete&quot;, &quot;write&quot;]\n      &quot;group_2&quot; = [&quot;read&quot;, &quot;delete&quot;, &quot;write&quot;]\n      &quot;group_3&quot; = [&quot;read&quot;, &quot;delete&quot;, &quot;write&quot;]\n    }\n  }\n  &quot;dev-local&quot; = {\n    repositories = [\n      &quot;dev-local-repo&quot;,\n    ],\n    groups = {\n      &quot;group_1&quot; = [&quot;read&quot;, &quot;delete&quot;, &quot;write&quot;]\n      &quot;group_2&quot; = [&quot;read&quot;, &quot;delete&quot;, &quot;write&quot;]\n      &quot;group_3&quot; = [&quot;read&quot;, &quot;delete&quot;, &quot;write&quot;]\n      &quot;group_4&quot; = [&quot;read&quot;, &quot;delete&quot;, &quot;write&quot;]\n    }\n  }\n}\n</code></pre>\n<p>This configuration works well but has the problem that if I update <code>dev</code> permissions I'll also have to update <code>dev-local</code>.</p>\n<p>So, is there a way to merge dev and dev-local in order to just have <code>&quot;group_4&quot; = [&quot;read&quot;, &quot;delete&quot;, &quot;write&quot;]</code> for <code>dev-local.groups</code> ?</p>\n<p>Thanks</p>\n", "OwnerUserId": "6240756", "LastActivityDate": "2022-10-19T09:27:31.773", "Title": "How to merge nested map in terraform", "Tags": "<terraform>", "AnswerCount": "0", "CommentCount": "2", "ContentLicense": "CC BY-SA 4.0", "comments": [{"Id": "130872441", "PostId": "74122987", "Score": "0", "Text": "If you want data this robust then you may want to use `external_data` instead of `locals`: https://registry.terraform.io/providers/hashicorp/external/latest/docs/data-sources/data_source. Also you can do this, but it does not scale very well as it will be messy and of dubious cost/benefit.", "CreationDate": "2022-10-19T11:02:56.350", "UserId": "5343387", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "Also you can do this, but it does not scale very well as it will be messy and of dubious cost/benefit.", "keywords": ["cost"]}]}, {"Id": "130874155", "PostId": "74122987", "Score": "0", "Text": "I finally manage to find a solution:\nHaving 2 defaults permission block, one for prod one for dev.\nI then do a first merge between devs, and a second one between dev and prod", "CreationDate": "2022-10-19T12:19:22.137", "UserId": "6240756", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "history": [{"Id": "280414583", "PostHistoryTypeId": "2", "PostId": "74122987", "RevisionGUID": "f1d305e0-2134-4b39-a7fe-70ed3fc38e22", "CreationDate": "2022-10-19T09:27:31.773", "UserId": "6240756", "Text": "I would like to merge locals values:\r\n\r\nFor now, I have this:\r\n```\r\npermission_defaults = {\r\n  groups = {\r\n    \"group_1\" = [\"read\"]\r\n    \"group_2\" = [\"read\"]\r\n    \"group_3\" = [\"read\"]\r\n  }\r\n}\r\n\r\npermission_raw = {\r\n  \"prod\" = {\r\n    repositories = [\r\n      \"prod-repo\",\r\n    ]\r\n  },\r\n  \"dev\" = {\r\n    repositories = [\r\n      \"dev-repo\",\r\n    ],\r\n    groups = {\r\n      \"group_1\" = [\"read\", \"delete\", \"write\"]\r\n      \"group_2\" = [\"read\", \"delete\", \"write\"]\r\n      \"group_3\" = [\"read\", \"delete\", \"write\"]\r\n    }\r\n  }\r\n}\r\n\r\npermissions = {\r\n  for k, v in local.permission_raw : k => merge(local.permission_defaults, v)\r\n}\r\n``` \r\n\r\nSo, basically it's some default permissions that I overwrite with specific values. This works well.\r\n\r\n\r\nNow, I want to add a new permission that is the same as `dev`, *plus* something else:\r\n\r\n\r\n```\r\npermission_defaults = {\r\n  groups = {\r\n    \"group_1\" = [\"read\"]\r\n    \"group_2\" = [\"read\"]\r\n    \"group_3\" = [\"read\"]\r\n  }\r\n}\r\n\r\npermission_raw = {\r\n  \"prod\" = {\r\n    repositories = [\r\n      \"prod-repo\",\r\n    ]\r\n  },\r\n  \"dev\" = {\r\n    repositories = [\r\n      \"dev-repo\",\r\n    ],\r\n    groups = {\r\n      \"group_1\" = [\"read\", \"delete\", \"write\"]\r\n      \"group_2\" = [\"read\", \"delete\", \"write\"]\r\n      \"group_3\" = [\"read\", \"delete\", \"write\"]\r\n    }\r\n  }\r\n  \"dev-local\" = {\r\n    repositories = [\r\n      \"dev-local-repo\",\r\n    ],\r\n    groups = {\r\n      \"group_1\" = [\"read\", \"delete\", \"write\"]\r\n      \"group_2\" = [\"read\", \"delete\", \"write\"]\r\n      \"group_3\" = [\"read\", \"delete\", \"write\"]\r\n      \"group_4\" = [\"read\", \"delete\", \"write\"]\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nThis configuration works well but has the problem that if I update `dev` permissions I'll also have to update `dev-local`.\r\n\r\nSo, is there a way to merge dev and dev-local in order to just have `\"group_4\" = [\"read\", \"delete\", \"write\"]` for `dev-local.groups` ?\r\n\r\nThanks", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "280414585", "PostHistoryTypeId": "1", "PostId": "74122987", "RevisionGUID": "f1d305e0-2134-4b39-a7fe-70ed3fc38e22", "CreationDate": "2022-10-19T09:27:31.773", "UserId": "6240756", "Text": "How to merge nested map in terraform", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "280414586", "PostHistoryTypeId": "3", "PostId": "74122987", "RevisionGUID": "f1d305e0-2134-4b39-a7fe-70ed3fc38e22", "CreationDate": "2022-10-19T09:27:31.773", "UserId": "6240756", "Text": "<terraform>", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "contains-topic": false, "filtered-sentences": []}