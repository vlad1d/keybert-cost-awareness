{"Id": "51407771", "PostTypeId": "1", "AcceptedAnswerId": "53974881", "CreationDate": "2018-07-18T17:23:25.030", "Score": "3", "ViewCount": "1690", "Body": "<p>I am using Hashicorp Terraform to define an AWS API Gateway to hit a Lambda function. I have a requirement that I need to tag my AWS resources with a particular tag so that costs can be tracked. Terraform seems to allow this for most resources. However, when creating an API Gateway stage using <a href=\"https://www.terraform.io/docs/providers/aws/r/api_gateway_deployment.html\" rel=\"nofollow noreferrer\">aws_api_gateway_deployment</a> I do not have the option to specify tags.</p>\n\n<p>I see that Terraform recently added the resource <a href=\"https://www.terraform.io/docs/providers/aws/r/api_gateway_stage.html\" rel=\"nofollow noreferrer\">aws_api_gateway_stage</a>. This one does allow tags to be specified. But, <strong>aws_api_gateway_stage</strong> requires an <strong>aws_api_gateway_deployment</strong>. If I give them the same \"stage_name\" as so:</p>\n\n<pre><code>resource \"aws_api_gateway_stage\" \"PlayLambdaApiGatewayStage\" {\n  stage_name = \"${environment}\"\n  rest_api_id = \"${aws_api_gateway_rest_api.PlayLambdaApiGateway.id}\"\n  deployment_id = \"${aws_api_gateway_deployment.PlayLambdaApiGatewayDeployment.id}\"\n  tags = {\n    cost-allocation = \"play-${var.environment}\"\n  }\n}\n\nresource \"aws_api_gateway_deployment\" \"PlayLambdaApiGatewayDeployment\" {\n  depends_on = [\n    \"aws_api_gateway_integration.PlayLambdaApiLambdaIntegration\",\n    \"aws_api_gateway_integration.PlayLambdaApiLambdaIntegrationRoot\"\n  ]\n\n  rest_api_id = \"${aws_api_gateway_rest_api.PlayLambdaApiGateway.id}\"\n  stage_name  = \"${var.environment}\"\n}\n</code></pre>\n\n<p>Then they both resources try to create the stage and I get an error:</p>\n\n<p><strong>aws_api_gateway_stage.PlayLambdaApiGatewayStage: Error creating API Gateway Stage: ConflictException: Stage already exists\n    status code: 409, request id: f67a10c4-8aad-11e8-b486-c337ea2d214f</strong></p>\n\n<p>Here it would seem that the <strong>aws_api_gateway_deployment</strong> already created the stage, so the <strong>aws_api_gateway_stage</strong> resource failed to create it also. If I add the stage to the deployment's \"depends_on\" so that the stage gets created first, it complains about there being a cycle between the two. </p>\n\n<p>So, it seems like:</p>\n\n<ul>\n<li><strong>aws_api_gateway_stage</strong> is only intended to add additional stages to a deployment, rather than creating a stage to use for the deployment</li>\n<li><strong>aws_api_gateway_deployment</strong> does not allow tags to be specified when it creates the stage.</li>\n</ul>\n\n<p>Any ideas? What am I missing?</p>\n", "OwnerUserId": "1904246", "LastActivityDate": "2018-12-30T02:34:46.113", "Title": "How to assign tags on an AWS API Gateway deployment stage using Terraform", "Tags": "<amazon-web-services><aws-lambda><terraform><aws-serverless>", "AnswerCount": "1", "CommentCount": "1", "FavoriteCount": "0", "ContentLicense": "CC BY-SA 4.0", "comments": [{"Id": "89791381", "PostId": "51407771", "Score": "0", "Text": "Looks like [this issue](https://github.com/terraform-providers/terraform-provider-aws/issues/1153).", "CreationDate": "2018-07-18T19:52:06.610", "UserId": "400222", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "Looks like [this issue](https://github.com/terraform-providers/terraform-provider-aws/issues/1153).", "keywords": ["provider"]}]}], "history": [{"Id": "177926217", "PostHistoryTypeId": "2", "PostId": "51407771", "RevisionGUID": "8ae903fb-3fa0-49a5-b0b6-c92326b537ac", "CreationDate": "2018-07-18T17:23:25.030", "UserId": "1904246", "Text": "I am using Hashicorp Terraform to define an AWS API Gateway to hit a Lambda function. I have a requirement that I need to tag my AWS resources with a particular tag so that costs can be tracked. Terraform seems to allow this for most resources. However, when creating an API Gateway stage using [aws_api_gateway_deployment][1] I do not have the option to specify tags.\r\n\r\nI see that Terraform recently added the resource [aws_api_gateway_stage][2]. This one does allow tags to be specified. But, **aws_api_gateway_stage** requires an **aws_api_gateway_deployment**. If I give them the same \"stage_name\" as so:\r\n\r\n    resource \"aws_api_gateway_stage\" \"PlayLambdaApiGatewayStage\" {\r\n      stage_name = \"${environment}\"\r\n      rest_api_id = \"${aws_api_gateway_rest_api.PlayLambdaApiGateway.id}\"\r\n      deployment_id = \"${aws_api_gateway_deployment.PlayLambdaApiGatewayDeployment.id}\"\r\n      tags = {\r\n        cost-allocation = \"play-${var.environment}\"\r\n      }\r\n    }\r\n\r\n    resource \"aws_api_gateway_deployment\" \"PlayLambdaApiGatewayDeployment\" {\r\n      depends_on = [\r\n        \"aws_api_gateway_integration.PlayLambdaApiLambdaIntegration\",\r\n        \"aws_api_gateway_integration.PlayLambdaApiLambdaIntegrationRoot\"\r\n      ]\r\n\r\n      rest_api_id = \"${aws_api_gateway_rest_api.PlayLambdaApiGateway.id}\"\r\n      stage_name  = \"${var.environment}\"\r\n    }\r\n\r\nThen they both resources try to create the stage and I get an error:\r\n\r\n**aws_api_gateway_stage.PlayLambdaApiGatewayStage: Error creating API Gateway Stage: ConflictException: Stage already exists\r\n status code: 409, request id: f67a10c4-8aad-11e8-b486-c337ea2d214f**\r\n\r\nHere it would seem that the **aws_api_gateway_deployment** already created the stage, so the **aws_api_gateway_stage** resource failed to create it also. If I add the stage to the deployment's \"depends_on\" so that the stage gets created first, it complains about there being a cycle between the two. \r\n\r\nSo, it seems like:\r\n\r\n - **aws_api_gateway_stage** is only intended to add additional stages to a deployment, rather than creating a stage to use for the deployment\r\n - **aws_api_gateway_deployment** does not allow tags to be specified when it creates the stage.\r\n\r\nAny ideas? What am I missing?\r\n\r\n  [1]: https://www.terraform.io/docs/providers/aws/r/api_gateway_deployment.html\r\n  [2]: https://www.terraform.io/docs/providers/aws/r/api_gateway_stage.html", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "If I give them the same \"stage_name\" as so: resource \"aws_api_gateway_stage\" \"PlayLambdaApiGatewayStage\" { stage_name = \"${environment}\" rest_api_id = \"${aws_api_gateway_rest_api.PlayLambdaApiGateway.id}\" deployment_id = \"${aws_api_gateway_deployment.PlayLambdaApiGatewayDeployment.id}\" tags = { cost-allocation = \"play-${var.environment}\" } } resource \"aws_api_gateway_deployment\" \"PlayLambdaApiGatewayDeployment\" { depends_on = [ \"aws_api_gateway_integration.PlayLambdaApiLambdaIntegration\", \"aws_api_gateway_integration.PlayLambdaApiLambdaIntegrationRoot\" ] rest_api_id = \"${aws_api_gateway_rest_api.PlayLambdaApiGateway.id}\" stage_name = \"${var.environment}\" } Then they both resources try to create the stage and I get an error: **aws_api_gateway_stage.PlayLambdaApiGatewayStage: Error creating API Gateway Stage: ConflictException: Stage already exists status code: 409, request id: f67a10c4-8aad-11e8-b486-c337ea2d214f** ", "keywords": ["cost"]}]}, {"Id": "177926218", "PostHistoryTypeId": "1", "PostId": "51407771", "RevisionGUID": "8ae903fb-3fa0-49a5-b0b6-c92326b537ac", "CreationDate": "2018-07-18T17:23:25.030", "UserId": "1904246", "Text": "How to assign tags on an AWS API Gateway deployment stage using Terraform", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "177926219", "PostHistoryTypeId": "3", "PostId": "51407771", "RevisionGUID": "8ae903fb-3fa0-49a5-b0b6-c92326b537ac", "CreationDate": "2018-07-18T17:23:25.030", "UserId": "1904246", "Text": "<amazon-web-services><aws-lambda><terraform><aws-serverless>", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "answers": [{"Id": "53974881", "PostTypeId": "2", "ParentId": "51407771", "CreationDate": "2018-12-30T02:34:46.113", "Score": "2", "Body": "<p>It seems that the <code>stage_name</code> field in the <strong>api_gateway_deployment</strong> should actually be optional. There is a PR open to fix the fact that its not at the moment. A workaround is at the moment to set <code>stage_name</code> to an empty string like this:</p>\n\n<pre><code>resource \"aws_api_gateway_deployment\" \"PlayLambdaApiGatewayDeployment\" {\n  depends_on = [\n    \"aws_api_gateway_integration.PlayLambdaApiLambdaIntegration\",\n    \"aws_api_gateway_integration.PlayLambdaApiLambdaIntegrationRoot\"\n  ]\n\n  rest_api_id = \"${aws_api_gateway_rest_api.PlayLambdaApiGateway.id}\"\n  stage_name  = \"\"\n}\n</code></pre>\n\n<p>Like this there will be no additional stage created other than the one you specify in your <strong>aws_api_gateway_stage</strong> which you can set your tags for.</p>\n", "OwnerUserId": "3768365", "LastActivityDate": "2018-12-30T02:34:46.113", "CommentCount": "0", "ContentLicense": "CC BY-SA 4.0", "history": [{"Id": "188655907", "PostHistoryTypeId": "2", "PostId": "53974881", "RevisionGUID": "ccc6d5f4-a62f-4703-abfc-6498b03a063f", "CreationDate": "2018-12-30T02:34:46.113", "UserId": "3768365", "Text": "It seems that the `stage_name` field in the **api_gateway_deployment** should actually be optional. There is a PR open to fix the fact that its not at the moment. A workaround is at the moment to set `stage_name` to an empty string like this:\r\n\r\n    resource \"aws_api_gateway_deployment\" \"PlayLambdaApiGatewayDeployment\" {\r\n      depends_on = [\r\n        \"aws_api_gateway_integration.PlayLambdaApiLambdaIntegration\",\r\n        \"aws_api_gateway_integration.PlayLambdaApiLambdaIntegrationRoot\"\r\n      ]\r\n    \r\n      rest_api_id = \"${aws_api_gateway_rest_api.PlayLambdaApiGateway.id}\"\r\n      stage_name  = \"\"\r\n    }\r\n\r\nLike this there will be no additional stage created other than the one you specify in your **aws_api_gateway_stage** which you can set your tags for.", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "filtered-sentences": []}], "contains-topic": true, "filtered-sentences": []}