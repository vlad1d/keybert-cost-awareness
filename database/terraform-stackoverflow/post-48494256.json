{"Id": "48494256", "PostTypeId": "1", "AcceptedAnswerId": "48505295", "CreationDate": "2018-01-29T04:09:01.350", "Score": "0", "ViewCount": "865", "Body": "<p>I am new bie to terraform and I am trying to create a service role for creating a spot instances,  Please let me know what is the Service name i should use for spot instances? Does Service: \"ec2.amazonaws.com\" help to create spot instances? </p>\n\n<p>I also noticed that in aws console, we have an option to select an use case for ec2 spot instances.  Does terraform also have an option to select the use case? </p>\n\n<p>Terraform version : Terraform v0.11.0</p>\n\n<pre><code>{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": {\n    \"Effect\": \"Allow\",\n    \"Principal\": {\"Service\": \"ec2.amazonaws.com\"},\n    \"Action\": \"sts:AssumeRole\"\n  }\n}\n</code></pre>\n", "OwnerUserId": "9173609", "LastEditorUserId": "9173609", "LastEditDate": "2018-01-29T04:14:39.340", "LastActivityDate": "2018-01-29T16:22:49.217", "Title": "Terraform service role for creating spot instances", "Tags": "<amazon-web-services><amazon-iam><terraform>", "AnswerCount": "1", "CommentCount": "2", "ContentLicense": "CC BY-SA 3.0", "comments": [{"Id": "83990248", "PostId": "48494256", "Score": "0", "Text": "What do you mean by service role here? Do you want to create an IAM role that can be used by an instance via an instance profile? Or are you wanting some AWS service to be able to create spot instances? AFAIK there's no differing IAM permissions between creating spot instances or on demand instances.", "CreationDate": "2018-01-29T10:00:17.960", "UserId": "2291321", "ContentLicense": "CC BY-SA 3.0", "filtered-sentences": [{"source": "Text", "text": "Do you want to create an IAM role that can be used by an instance via an instance profile? ", "keywords": ["instance"]}]}, {"Id": "83999920", "PostId": "48494256", "Score": "0", "Text": "@ydaetskcoR yes i want to create an IAM role that can be used via instance profile to bring up spot instances without setting up an user or access and secret access key on the console", "CreationDate": "2018-01-29T14:10:33.423", "UserId": "9173609", "ContentLicense": "CC BY-SA 3.0", "filtered-sentences": [{"source": "Text", "text": "@ydaetskcoR yes i want to create an IAM role that can be used via instance profile to bring up spot instances without setting up an user or access and secret access key on the console", "keywords": ["instance"]}]}], "history": [{"Id": "165657308", "PostHistoryTypeId": "2", "PostId": "48494256", "RevisionGUID": "292c4e86-a3f4-45be-aee9-f8d7101ad16f", "CreationDate": "2018-01-29T04:09:01.350", "UserId": "9173609", "Text": "I am trying to create a role for creating a spot instances using terraform,  Please let me know what is the Service name i should use for spot instances? Does Service: \"ec2.amazonaws.com\" help to create spot instances? \r\n\r\nI also noticed that in aws console, we have an option to select an use case for ec2 spot instances.  Does terraform also have an option to select the use case? \r\n\r\nTerraform version : Terraform v0.11.0\r\n\r\n\r\n    {\r\n      \"Version\": \"2012-10-17\",\r\n      \"Statement\": {\r\n        \"Effect\": \"Allow\",\r\n        \"Principal\": {\"Service\": \"ec2.amazonaws.com\"},\r\n        \"Action\": \"sts:AssumeRole\"\r\n      }\r\n    }", "ContentLicense": "CC BY-SA 3.0", "filtered-sentences": []}, {"Id": "165657309", "PostHistoryTypeId": "1", "PostId": "48494256", "RevisionGUID": "292c4e86-a3f4-45be-aee9-f8d7101ad16f", "CreationDate": "2018-01-29T04:09:01.350", "UserId": "9173609", "Text": "Terraform role for creating spot instances", "ContentLicense": "CC BY-SA 3.0", "filtered-sentences": []}, {"Id": "165657310", "PostHistoryTypeId": "3", "PostId": "48494256", "RevisionGUID": "292c4e86-a3f4-45be-aee9-f8d7101ad16f", "CreationDate": "2018-01-29T04:09:01.350", "UserId": "9173609", "Text": "<amazon-web-services><amazon-iam><terraform>", "ContentLicense": "CC BY-SA 3.0", "filtered-sentences": []}, {"Id": "165657493", "PostHistoryTypeId": "5", "PostId": "48494256", "RevisionGUID": "5fc4f5af-76de-441f-91b1-daba589ec4b5", "CreationDate": "2018-01-29T04:14:39.340", "UserId": "9173609", "Comment": "added 14 characters in body", "Text": "I am new bie to terraform and I am trying to create a service role for creating a spot instances,  Please let me know what is the Service name i should use for spot instances? Does Service: \"ec2.amazonaws.com\" help to create spot instances? \r\n\r\nI also noticed that in aws console, we have an option to select an use case for ec2 spot instances.  Does terraform also have an option to select the use case? \r\n\r\nTerraform version : Terraform v0.11.0\r\n\r\n\r\n    {\r\n      \"Version\": \"2012-10-17\",\r\n      \"Statement\": {\r\n        \"Effect\": \"Allow\",\r\n        \"Principal\": {\"Service\": \"ec2.amazonaws.com\"},\r\n        \"Action\": \"sts:AssumeRole\"\r\n      }\r\n    }", "ContentLicense": "CC BY-SA 3.0", "filtered-sentences": []}, {"Id": "165657543", "PostHistoryTypeId": "4", "PostId": "48494256", "RevisionGUID": "5fc4f5af-76de-441f-91b1-daba589ec4b5", "CreationDate": "2018-01-29T04:14:39.340", "UserId": "9173609", "Comment": "added 14 characters in body", "Text": "Terraform service role for creating spot instances", "ContentLicense": "CC BY-SA 3.0", "filtered-sentences": []}], "answers": [{"Id": "48505295", "PostTypeId": "2", "ParentId": "48494256", "CreationDate": "2018-01-29T16:00:14.653", "Score": "0", "Body": "<p>What you have is part of the steps to create an Instance Profile for an EC2 instance to assume an IAM role( step 3 below).</p>\n\n<ol>\n<li>Create an IAM policy for the Role. </li>\n<li>Create the IAM role and attach the policy.</li>\n<li>Give the EC2 instance permission to assume the role.</li>\n</ol>\n\n<pre class=\"lang-json prettyprint-override\"><code>resource \"aws_iam_role_policy\" \"test_policy\" {\n\n name = \"test_policy\"\n\n role = \"${aws_iam_role.test_role.id}\"\n  policy = &lt;&lt;EOF\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Action\": [\n        \"ec2:Describe*\"\n      ],\n      \"Effect\": \"Allow\",\n      \"Resource\": \"*\"\n    }\n  ]\n}\nEOF\n}\n\nresource \"aws_iam_role\" \"test_role\" {\n  name = \"test_role\"\n\n  assume_role_policy = &lt;&lt;EOF\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Action\": \"sts:AssumeRole\",\n      \"Principal\": {\n        \"Service\": \"ec2.amazonaws.com\"\n      },\n      \"Effect\": \"Allow\",\n      \"Sid\": \"\"\n    }\n  ]\n}\nEOF\n}\n\nresource \"aws_spot_fleet_request\" \"cheap_compute\" {\n  iam_fleet_role      = \"arn:aws:iam::12345678:role/spot-fleet\"\n  spot_price          = \"0.03\"\n  allocation_strategy = \"diversified\"\n  target_capacity     = 6\n  valid_until         = \"2019-11-04T20:44:20Z\"\n\n  launch_specification {\n    instance_type     = \"m4.10xlarge\"\n    ami               = \"ami-1234\"\n    spot_price        = \"2.793\"\n    placement_tenancy = \"dedicated\"\n  }\n\n  launch_specification {\n    instance_type     = \"m4.4xlarge\"\n    iam_instance_profile = \"${aws_iam_role.test_role.name}\"\n    ami               = \"ami-5678\"\n    key_name          = \"my-key\"\n    spot_price        = \"1.117\"\n    availability_zone = \"us-west-1a\"\n    subnet_id         = \"subnet-1234\"\n    weighted_capacity = 35\n\n    root_block_device {\n      volume_size = \"300\"\n      volume_type = \"gp2\"\n    }\n\n    tags {\n      Name = \"spot-fleet-example\"\n    }\n  }\n}\n</code></pre>\n\n<p><a href=\"https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_switch-role-ec2.html\" rel=\"nofollow noreferrer\">https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_switch-role-ec2.html</a></p>\n\n<p><a href=\"https://www.terraform.io/docs/providers/aws/r/instance.html#iam_instance_profile\" rel=\"nofollow noreferrer\">https://www.terraform.io/docs/providers/aws/r/instance.html#iam_instance_profile</a></p>\n\n<p><a href=\"https://www.terraform.io/docs/providers/aws/r/iam_role_policy.html\" rel=\"nofollow noreferrer\">https://www.terraform.io/docs/providers/aws/r/iam_role_policy.html</a></p>\n\n<p><a href=\"https://www.terraform.io/docs/providers/aws/r/spot_fleet_request.html\" rel=\"nofollow noreferrer\">https://www.terraform.io/docs/providers/aws/r/spot_fleet_request.html</a></p>\n", "OwnerUserId": "1794802", "LastEditorUserId": "1794802", "LastEditDate": "2018-01-29T16:22:49.217", "LastActivityDate": "2018-01-29T16:22:49.217", "CommentCount": "0", "ContentLicense": "CC BY-SA 3.0", "history": [{"Id": "165701748", "PostHistoryTypeId": "2", "PostId": "48505295", "RevisionGUID": "8bbdf6ed-c5e8-445d-90ca-50130ca0bee8", "CreationDate": "2018-01-29T16:00:14.653", "UserId": "1794802", "Text": "What you have is part of the steps to create an Instance Profile for an EC2 instance to assume an IAM role( step 3 below).\r\n\r\n1. Create an IAM policy for the Role. \r\n2. Create the IAM role and attach the policy.\r\n3. Give the EC2 instance permission to assume the role.\r\n\r\n\r\n    resource \"aws_iam_role_policy\" \"test_policy\" {\r\n      name = \"test_policy\"\r\n      role = \"${aws_iam_role.test_role.id}\"\r\n    \r\n      policy = <<EOF\r\n    {\r\n      \"Version\": \"2012-10-17\",\r\n      \"Statement\": [\r\n        {\r\n          \"Action\": [\r\n            \"ec2:Describe*\"\r\n          ],\r\n          \"Effect\": \"Allow\",\r\n          \"Resource\": \"*\"\r\n        }\r\n      ]\r\n    }\r\n    EOF\r\n    }\r\n    \r\n    resource \"aws_iam_role\" \"test_role\" {\r\n      name = \"test_role\"\r\n    \r\n      assume_role_policy = <<EOF\r\n    {\r\n      \"Version\": \"2012-10-17\",\r\n      \"Statement\": [\r\n        {\r\n          \"Action\": \"sts:AssumeRole\",\r\n          \"Principal\": {\r\n            \"Service\": \"ec2.amazonaws.com\"\r\n          },\r\n          \"Effect\": \"Allow\",\r\n          \"Sid\": \"\"\r\n        }\r\n      ]\r\n    }\r\n    EOF\r\n    }\r\n\r\n\r\nhttps://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_switch-role-ec2.html\r\n\r\nhttps://www.terraform.io/docs/providers/aws/r/instance.html#iam_instance_profile\r\n\r\nhttps://www.terraform.io/docs/providers/aws/r/iam_role_policy.html\r\n", "ContentLicense": "CC BY-SA 3.0", "filtered-sentences": [{"source": "Text", "text": "What you have is part of the steps to create an Instance Profile for an EC2 instance to assume an IAM role( step 3 below). ", "keywords": ["instance"]}, {"source": "Text", "text": "1. Create an IAM policy for the Role. ", "keywords": ["policy"]}, {"source": "Text", "text": "2. Create the IAM role and attach the policy. ", "keywords": ["policy"]}, {"source": "Text", "text": "3. Give the EC2 instance permission to assume the role. resource \"aws_iam_role_policy\" \"test_policy\" { name = \"test_policy\" role = \"${aws_iam_role.test_role.id}\" policy = <<EOF { \"Version\": \"2012-10-17\", \"Statement\": [ { \"Action\": [ \"ec2:Describe*\" ], \"Effect\": \"Allow\", \"Resource\": \"*\" } ] } EOF } resource \"aws_iam_role\" \"test_role\" { name = \"test_role\" assume_role_policy = <<EOF { \"Version\": \"2012-10-17\", \"Statement\": [ { \"Action\": \"sts:AssumeRole\", \"Principal\": { \"Service\": \"ec2.amazonaws.com\" ", "keywords": ["instance", "policy", "test"]}, {"source": "Text", "text": "}, \"Effect\": \"Allow\", \"Sid\": \"\" } ] } EOF } https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_switch-role-ec2.html https://www.terraform.io/docs/providers/aws/r/instance.html#iam_instance_profile https://www.terraform.io/docs/providers/aws/r/iam_role_policy.html", "keywords": ["instance"]}]}, {"Id": "165702735", "PostHistoryTypeId": "5", "PostId": "48505295", "RevisionGUID": "bd54a196-15f9-445a-a57d-2b2e19c03770", "CreationDate": "2018-01-29T16:12:48.953", "UserId": "1794802", "Comment": "added 38 characters in body", "Text": "What you have is part of the steps to create an Instance Profile for an EC2 instance to assume an IAM role( step 3 below).\r\n\r\n1. Create an IAM policy for the Role. \r\n2. Create the IAM role and attach the policy.\r\n3. Give the EC2 instance permission to assume the role.\r\n\r\n<!-- language: lang-json -->\r\n\r\n     resource \"aws_iam_role_policy\" \"test_policy\" {\r\n     \r\n     name = \"test_policy\"\r\n      \r\n     role = \"${aws_iam_role.test_role.id}\"\r\n      policy = <<EOF\r\n    {\r\n      \"Version\": \"2012-10-17\",\r\n      \"Statement\": [\r\n        {\r\n          \"Action\": [\r\n            \"ec2:Describe*\"\r\n          ],\r\n          \"Effect\": \"Allow\",\r\n          \"Resource\": \"*\"\r\n        }\r\n      ]\r\n    }\r\n    EOF\r\n    }\r\n    \r\n    resource \"aws_iam_role\" \"test_role\" {\r\n      name = \"test_role\"\r\n    \r\n      assume_role_policy = <<EOF\r\n    {\r\n      \"Version\": \"2012-10-17\",\r\n      \"Statement\": [\r\n        {\r\n          \"Action\": \"sts:AssumeRole\",\r\n          \"Principal\": {\r\n            \"Service\": \"ec2.amazonaws.com\"\r\n          },\r\n          \"Effect\": \"Allow\",\r\n          \"Sid\": \"\"\r\n        }\r\n      ]\r\n    }\r\n    EOF\r\n    }\r\n\r\n\r\nhttps://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_switch-role-ec2.html\r\n\r\nhttps://www.terraform.io/docs/providers/aws/r/instance.html#iam_instance_profile\r\n\r\nhttps://www.terraform.io/docs/providers/aws/r/iam_role_policy.html\r\n", "ContentLicense": "CC BY-SA 3.0", "filtered-sentences": [{"source": "Text", "text": "What you have is part of the steps to create an Instance Profile for an EC2 instance to assume an IAM role( step 3 below). ", "keywords": ["instance"]}, {"source": "Text", "text": "1. Create an IAM policy for the Role. ", "keywords": ["policy"]}, {"source": "Text", "text": "2. Create the IAM role and attach the policy. ", "keywords": ["policy"]}, {"source": "Text", "text": "3. Give the EC2 instance permission to assume the role. resource \"aws_iam_role_policy\" \"test_policy\" { name = \"test_policy\" role = \"${aws_iam_role.test_role.id}\" policy = <<EOF { \"Version\": \"2012-10-17\", \"Statement\": [ { \"Action\": [ \"ec2:Describe*\" ], \"Effect\": \"Allow\", \"Resource\": \"*\" } ] } EOF } resource \"aws_iam_role\" \"test_role\" { name = \"test_role\" assume_role_policy = <<EOF { \"Version\": \"2012-10-17\", \"Statement\": [ { \"Action\": \"sts:AssumeRole\", \"Principal\": { \"Service\": \"ec2.amazonaws.com\" ", "keywords": ["instance", "policy", "test"]}, {"source": "Text", "text": "}, \"Effect\": \"Allow\", \"Sid\": \"\" } ] } EOF } https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_switch-role-ec2.html https://www.terraform.io/docs/providers/aws/r/instance.html#iam_instance_profile https://www.terraform.io/docs/providers/aws/r/iam_role_policy.html", "keywords": ["instance"]}]}, {"Id": "165703406", "PostHistoryTypeId": "5", "PostId": "48505295", "RevisionGUID": "f5601b8f-a17c-4e4e-bbb0-321c50d6a8ab", "CreationDate": "2018-01-29T16:22:49.217", "UserId": "1794802", "Comment": "added 1139 characters in body", "Text": "What you have is part of the steps to create an Instance Profile for an EC2 instance to assume an IAM role( step 3 below).\r\n\r\n1. Create an IAM policy for the Role. \r\n2. Create the IAM role and attach the policy.\r\n3. Give the EC2 instance permission to assume the role.\r\n\r\n<!-- language: lang-json -->\r\n\r\n    resource \"aws_iam_role_policy\" \"test_policy\" {\r\n     \r\n     name = \"test_policy\"\r\n      \r\n     role = \"${aws_iam_role.test_role.id}\"\r\n      policy = <<EOF\r\n    {\r\n      \"Version\": \"2012-10-17\",\r\n      \"Statement\": [\r\n        {\r\n          \"Action\": [\r\n            \"ec2:Describe*\"\r\n          ],\r\n          \"Effect\": \"Allow\",\r\n          \"Resource\": \"*\"\r\n        }\r\n      ]\r\n    }\r\n    EOF\r\n    }\r\n    \r\n    resource \"aws_iam_role\" \"test_role\" {\r\n      name = \"test_role\"\r\n    \r\n      assume_role_policy = <<EOF\r\n    {\r\n      \"Version\": \"2012-10-17\",\r\n      \"Statement\": [\r\n        {\r\n          \"Action\": \"sts:AssumeRole\",\r\n          \"Principal\": {\r\n            \"Service\": \"ec2.amazonaws.com\"\r\n          },\r\n          \"Effect\": \"Allow\",\r\n          \"Sid\": \"\"\r\n        }\r\n      ]\r\n    }\r\n    EOF\r\n    }\r\n\r\n    resource \"aws_spot_fleet_request\" \"cheap_compute\" {\r\n      iam_fleet_role      = \"arn:aws:iam::12345678:role/spot-fleet\"\r\n      spot_price          = \"0.03\"\r\n      allocation_strategy = \"diversified\"\r\n      target_capacity     = 6\r\n      valid_until         = \"2019-11-04T20:44:20Z\"\r\n    \r\n      launch_specification {\r\n        instance_type     = \"m4.10xlarge\"\r\n        ami               = \"ami-1234\"\r\n        spot_price        = \"2.793\"\r\n        placement_tenancy = \"dedicated\"\r\n      }\r\n    \r\n      launch_specification {\r\n        instance_type     = \"m4.4xlarge\"\r\n        iam_instance_profile = \"${aws_iam_role.test_role.name}\"\r\n        ami               = \"ami-5678\"\r\n        key_name          = \"my-key\"\r\n        spot_price        = \"1.117\"\r\n        availability_zone = \"us-west-1a\"\r\n        subnet_id         = \"subnet-1234\"\r\n        weighted_capacity = 35\r\n    \r\n        root_block_device {\r\n          volume_size = \"300\"\r\n          volume_type = \"gp2\"\r\n        }\r\n    \r\n        tags {\r\n          Name = \"spot-fleet-example\"\r\n        }\r\n      }\r\n    }\r\n\r\n\r\nhttps://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_switch-role-ec2.html\r\n\r\nhttps://www.terraform.io/docs/providers/aws/r/instance.html#iam_instance_profile\r\n\r\nhttps://www.terraform.io/docs/providers/aws/r/iam_role_policy.html\r\n\r\nhttps://www.terraform.io/docs/providers/aws/r/spot_fleet_request.html\r\n", "ContentLicense": "CC BY-SA 3.0", "filtered-sentences": [{"source": "Text", "text": "What you have is part of the steps to create an Instance Profile for an EC2 instance to assume an IAM role( step 3 below). ", "keywords": ["instance"]}, {"source": "Text", "text": "1. Create an IAM policy for the Role. ", "keywords": ["policy"]}, {"source": "Text", "text": "2. Create the IAM role and attach the policy. ", "keywords": ["policy"]}, {"source": "Text", "text": "3. Give the EC2 instance permission to assume the role. resource \"aws_iam_role_policy\" \"test_policy\" { name = \"test_policy\" role = \"${aws_iam_role.test_role.id}\" policy = <<EOF { \"Version\": \"2012-10-17\", \"Statement\": [ { \"Action\": [ \"ec2:Describe*\" ], \"Effect\": \"Allow\", \"Resource\": \"*\" } ] } EOF } resource \"aws_iam_role\" \"test_role\" { name = \"test_role\" assume_role_policy = <<EOF { \"Version\": \"2012-10-17\", \"Statement\": [ { \"Action\": \"sts:AssumeRole\", \"Principal\": { \"Service\": \"ec2.amazonaws.com\" }, \"Effect\": \"Allow\", \"Sid\": \"\" } ] } EOF } resource \"aws_spot_fleet_request\" \"cheap_compute\" { iam_fleet_role = \"arn:aws:iam::12345678:role/spot-fleet\" spot_price = \"0.03\" allocation_strategy = \"diversified\" target_capacity = 6 valid_until = \"2019-11-04T20:44:20Z\" launch_specification { instance_type = \"m4.10xlarge\" ami = \"ami-1234\" spot_price = \"2.793\" placement_tenancy = \"dedicated\" } launch_specification { instance_type = \"m4.4xlarge\" iam_instance_profile = \"${aws_iam_role.test_role.name}\" ami = \"ami-5678\" key_name = \"my-key\" spot_price = \"1.117\" availability_zone = \"us-west-1a\" subnet_id = \"subnet-1234\" weighted_capacity = 35 root_block_device { volume_size = \"300\" volume_type = \"gp2\" ", "keywords": ["cheap", "instance", "policy", "test"]}, {"source": "Text", "text": "} tags { Name = \"spot-fleet-example\" } } } https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_switch-role-ec2.html https://www.terraform.io/docs/providers/aws/r/instance.html#iam_instance_profile https://www.terraform.io/docs/providers/aws/r/iam_role_policy.html https://www.terraform.io/docs/providers/aws/r/spot_fleet_request.html", "keywords": ["instance"]}]}], "filtered-sentences": [{"source": "Body", "text": "What you have is part of the steps to create an Instance Profile for an EC2 instance to assume an IAM role( step 3 below). ", "keywords": ["instance"]}, {"source": "Body", "text": "Create an IAM policy for the Role. ", "keywords": ["policy"]}, {"source": "Body", "text": "Create the IAM role and attach the policy. ", "keywords": ["policy"]}, {"source": "Body", "text": "Give the EC2 instance permission to assume the role. ", "keywords": ["instance"]}, {"source": "Body", "text": "https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_switch-role-ec2.html https://www.terraform.io/docs/providers/aws/r/instance.html#iam_instance_profile https://www.terraform.io/docs/providers/aws/r/iam_role_policy.html https://www.terraform.io/docs/providers/aws/r/spot_fleet_request.html", "keywords": ["instance"]}]}], "contains-topic": true, "filtered-sentences": []}