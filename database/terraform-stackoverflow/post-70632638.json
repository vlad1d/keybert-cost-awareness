{"Id": "70632638", "PostTypeId": "1", "AcceptedAnswerId": "70637677", "CreationDate": "2022-01-08T13:10:09.473", "Score": "0", "ViewCount": "2124", "Body": "<p>I have created an IAM group via terraform using the following code snippet. Later I manually assigned users to this group depending on demands \u2013 therefore these group associations are managed outside terraform.</p>\n<pre><code>resource &quot;aws_iam_group&quot; &quot;eks_user&quot; {\n  name          = &quot;eks_user&quot;\n  path          = &quot;/eks/user/&quot;\n  force_destroy = true\n}\n</code></pre>\n<p>Now I want to delete the group using <code>terraform destroy</code> to save costs at the end of the day, but it fails as the group still has users assigned. How can I still delete resources even they have associations?</p>\n<pre><code>...\nmodule.main.module.vpc.module.vpc.aws_vpc.this[0]: Destruction complete after 0s\nmodule.main.module.eks.module.eks.aws_iam_role.cluster[0]: Destruction complete after 2s\n\u2577\n\u2502 Error: Error deleting IAM Group eks_user: DeleteConflict: Cannot delete entity, must remove users from group first.\n\u2502       status code: 409, request id: 479d0bfb-b099-4d4a-9753-d1c7601d142e\n\u2502\n\u2502\n\u2575\n</code></pre>\n", "OwnerUserId": "227821", "LastEditorUserId": "4586921", "LastEditDate": "2022-01-08T22:46:56.037", "LastActivityDate": "2022-01-09T01:04:01.237", "Title": "Terraform force delete IAM group on destroy", "Tags": "<amazon-web-services><terraform><amazon-iam><terraform-provider-aws>", "AnswerCount": "1", "CommentCount": "4", "ContentLicense": "CC BY-SA 4.0", "comments": [{"Id": "124862687", "PostId": "70632638", "Score": "1", "Text": "You'll need to remove them manually I think.", "CreationDate": "2022-01-08T14:08:06.883", "UserId": "5451492", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "124862895", "PostId": "70632638", "Score": "3", "Text": "If Terraform isn't also creating the users, then it can't handle this delete scenario. You would have to delete the users (or remove them from the group) manually. However your reason for deleting an IAM group (to save costs) isn't really a problem, because IAM groups don't cost anything.", "CreationDate": "2022-01-08T14:21:55.887", "UserId": "13070", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "However your reason for deleting an IAM group (to save costs) isn't really a problem, because IAM groups don't cost anything.", "keywords": ["cost"]}]}, {"Id": "124866302", "PostId": "70632638", "Score": "0", "Text": "@lony As per the AWS documentation, To delete the group, it must not contain any users or have any attached policies. But for some reasons, you need to delete the group along with users in terraform, there is no straight forward way you can do other than using `terraform import` and then destroy the users first and then groups.", "CreationDate": "2022-01-08T18:06:44.640", "UserId": "4586921", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "124869888", "PostId": "70632638", "Score": "0", "Text": "Thanks - that's really unfortunate. When I recreate the group \u2013 can I enable \u201creimporting\u201d it as well if it was not deleted properly?", "CreationDate": "2022-01-08T22:48:45.157", "UserId": "227821", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "history": [{"Id": "261533924", "PostHistoryTypeId": "2", "PostId": "70632638", "RevisionGUID": "5cfca0ab-b873-440d-8a33-6e02ca2cd602", "CreationDate": "2022-01-08T13:10:09.473", "UserId": "227821", "Text": "I create a IAM group via terraform using the following code snipped. Later I manually assign users to this group depending on demands \u2013 therefore this group associations are managed outside terraform.\r\n\r\n    resource \"aws_iam_group\" \"eks_user\" {\r\n      name          = \"eks_user\"\r\n      path          = \"/eks/user/\"\r\n      force_destroy = true\r\n    }\r\n\r\nNow I want to delete the group using `terraform destroy` to save costs at the end of the day, but it fails as the group still has users assigned. How can I still delete resources even they have associations?\r\n\r\n    ...\r\n    module.main.module.vpc.module.vpc.aws_vpc.this[0]: Destruction complete after 0s\r\n    module.main.module.eks.module.eks.aws_iam_role.cluster[0]: Destruction complete after 2s\r\n    \u2577\r\n    \u2502 Error: Error deleting IAM Group eks_user: DeleteConflict: Cannot delete entity, must remove users from group first.\r\n    \u2502       status code: 409, request id: 479d0bfb-b099-4d4a-9753-d1c7601d142e\r\n    \u2502\r\n    \u2502\r\n    \u2575\r\n\r\n", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "module.main.module.vpc.module.vpc.aws_vpc.this[0]: Destruction complete after 0s module.main.module.eks.module.eks.aws_iam_role.cluster[0]: Destruction complete after 2s \u2577 \u2502 Error: Error deleting IAM Group eks_user: DeleteConflict: Cannot delete entity, must remove users from group first. ", "keywords": ["cluster"]}]}, {"Id": "261533926", "PostHistoryTypeId": "1", "PostId": "70632638", "RevisionGUID": "5cfca0ab-b873-440d-8a33-6e02ca2cd602", "CreationDate": "2022-01-08T13:10:09.473", "UserId": "227821", "Text": "Terraform force delete IAM group on destroy", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "261533927", "PostHistoryTypeId": "3", "PostId": "70632638", "RevisionGUID": "5cfca0ab-b873-440d-8a33-6e02ca2cd602", "CreationDate": "2022-01-08T13:10:09.473", "UserId": "227821", "Text": "<amazon-web-services><terraform><amazon-iam><terraform-provider-aws>", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "261557041", "PostHistoryTypeId": "5", "PostId": "70632638", "RevisionGUID": "8c2e0494-abfb-4b0d-af0b-11912d4afcec", "CreationDate": "2022-01-08T22:46:56.037", "UserId": "4586921", "Comment": "Corrected spelling mistakes and few grammars", "Text": "I have created an IAM group via terraform using the following code snippet. Later I manually assigned users to this group depending on demands \u2013 therefore these group associations are managed outside terraform.\r\n\r\n    resource \"aws_iam_group\" \"eks_user\" {\r\n      name          = \"eks_user\"\r\n      path          = \"/eks/user/\"\r\n      force_destroy = true\r\n    }\r\n\r\nNow I want to delete the group using `terraform destroy` to save costs at the end of the day, but it fails as the group still has users assigned. How can I still delete resources even they have associations?\r\n\r\n    ...\r\n    module.main.module.vpc.module.vpc.aws_vpc.this[0]: Destruction complete after 0s\r\n    module.main.module.eks.module.eks.aws_iam_role.cluster[0]: Destruction complete after 2s\r\n    \u2577\r\n    \u2502 Error: Error deleting IAM Group eks_user: DeleteConflict: Cannot delete entity, must remove users from group first.\r\n    \u2502       status code: 409, request id: 479d0bfb-b099-4d4a-9753-d1c7601d142e\r\n    \u2502\r\n    \u2502\r\n    \u2575\r\n\r\n", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "module.main.module.vpc.module.vpc.aws_vpc.this[0]: Destruction complete after 0s module.main.module.eks.module.eks.aws_iam_role.cluster[0]: Destruction complete after 2s \u2577 \u2502 Error: Error deleting IAM Group eks_user: DeleteConflict: Cannot delete entity, must remove users from group first. ", "keywords": ["cluster"]}]}, {"Id": "261557042", "PostHistoryTypeId": "24", "PostId": "70632638", "RevisionGUID": "8c2e0494-abfb-4b0d-af0b-11912d4afcec", "CreationDate": "2022-01-08T22:46:56.037", "Comment": "Proposed by 4586921 approved by 227821 edit id of 5314902", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "answers": [{"Id": "70637677", "PostTypeId": "2", "ParentId": "70632638", "CreationDate": "2022-01-09T00:58:53.740", "Score": "2", "Body": "<p>You can use the AWS CLI to remove those users:<br />\n<code>remove-user-from-group</code><br />\n<a href=\"https://docs.aws.amazon.com/cli/latest/reference/iam/remove-user-from-group.html\" rel=\"nofollow noreferrer\">https://docs.aws.amazon.com/cli/latest/reference/iam/remove-user-from-group.html</a></p>\n<p>And on Terraform you can use a null resource to do the removal when you call destroy,<br />\nsomething like:</p>\n<pre class=\"lang-txt prettyprint-override\"><code>resource &quot;null_resource&quot; &quot;remove_users&quot; {\n  depends_on  = [&quot;aws_iam_group.your_group&quot;]\n  provisioner &quot;local-exec&quot; {\n    when    = &quot;destroy&quot;\n    command = &quot;aws iam remove-user-from-group --user-name Bob --group-name Admins&quot;\n  }\n}\n</code></pre>\n<p>of course that is a very simple command ...<br />\nyou probably will need multiple of those removals or a loop to remove all</p>\n<hr />\n<p>Now if you are exclusively doing this to reduce costs,<br />\nyou might not need to do this, seem the AWS Groups are free<br />\n<a href=\"https://aws.amazon.com/iam/faqs/\" rel=\"nofollow noreferrer\">https://aws.amazon.com/iam/faqs/</a></p>\n<blockquote>\n<p>Any AWS customer can use IAM. The service is offered at no additional charge. You will be charged only for the use of other AWS services by your users.</p>\n</blockquote>\n", "OwnerUserId": "7599833", "LastEditorUserId": "7599833", "LastEditDate": "2022-01-09T01:04:01.237", "LastActivityDate": "2022-01-09T01:04:01.237", "CommentCount": "1", "ContentLicense": "CC BY-SA 4.0", "comments": [{"Id": "124876909", "PostId": "70637677", "Score": "0", "Text": "Thanks a lot \u2013 did expect something like lifecycle hooks.", "CreationDate": "2022-01-09T12:01:19.410", "UserId": "227821", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "history": [{"Id": "261560474", "PostHistoryTypeId": "2", "PostId": "70637677", "RevisionGUID": "0a8a578f-bf0b-40f1-85cc-3fdb856cf06f", "CreationDate": "2022-01-09T00:58:53.740", "UserId": "7599833", "Text": "You can use the AWS CLI to remove those users:   \r\n`remove-user-from-group`  \r\nhttps://docs.aws.amazon.com/cli/latest/reference/iam/remove-user-from-group.html\r\n\r\nAnd on Terraform you can use a null resource to do the removal when you call destroy,  \r\nsomething like:  \r\n``` lang-txt\r\nresource \"null_resource\" \"remove_users\" {\r\n  depends_on  = [\"aws_iam_group.your_group\"]\r\n  provisioner \"local-exec\" {\r\n    when    = \"destroy\"\r\n    command = \"aws iam remove-user-from-group --user-name Bob --group-name Admins\"\r\n  }\r\n}\r\n```\r\n\r\nof course that is a very simple command ...  \r\nyou probably will need multiple of those removals or a loop to remove all\r\n\r\n\r\n___\r\n\r\nNow if you are exclusively doing this to reduce costs,  \r\nyou might not need this, seem the AWS Groups are free   \r\nhttps://aws.amazon.com/iam/faqs/\r\n\r\n> Any AWS customer can use IAM. The service is offered at no additional charge. You will be charged only for the use of other AWS services by your users.", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "261560589", "PostHistoryTypeId": "5", "PostId": "70637677", "RevisionGUID": "1c8aa28a-fea0-4bc4-95ef-f247375da2d6", "CreationDate": "2022-01-09T01:04:01.237", "UserId": "7599833", "Comment": "added 6 characters in body", "Text": "You can use the AWS CLI to remove those users:   \r\n`remove-user-from-group`  \r\nhttps://docs.aws.amazon.com/cli/latest/reference/iam/remove-user-from-group.html\r\n\r\nAnd on Terraform you can use a null resource to do the removal when you call destroy,  \r\nsomething like:  \r\n``` lang-txt\r\nresource \"null_resource\" \"remove_users\" {\r\n  depends_on  = [\"aws_iam_group.your_group\"]\r\n  provisioner \"local-exec\" {\r\n    when    = \"destroy\"\r\n    command = \"aws iam remove-user-from-group --user-name Bob --group-name Admins\"\r\n  }\r\n}\r\n```\r\n\r\nof course that is a very simple command ...  \r\nyou probably will need multiple of those removals or a loop to remove all\r\n\r\n\r\n___\r\n\r\nNow if you are exclusively doing this to reduce costs,  \r\nyou might not need to do this, seem the AWS Groups are free   \r\nhttps://aws.amazon.com/iam/faqs/\r\n\r\n> Any AWS customer can use IAM. The service is offered at no additional charge. You will be charged only for the use of other AWS services by your users.", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "filtered-sentences": []}], "contains-topic": true, "filtered-sentences": []}