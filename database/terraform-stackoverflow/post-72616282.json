{"Id": "72616282", "PostTypeId": "1", "CreationDate": "2022-06-14T11:35:16.187", "Score": "0", "ViewCount": "240", "Body": "<p>We are currently seeing an issue in terraform pipelines running in GKE pods where the datasource internally calling the cloudbilling.googleapis.com returns &quot;Your client does not have permission to get URL&quot;.</p>\n<p>We have added the serviceaccount to the billing account with Billing Account Viewer permission but still seeing the same behaviour(The service account has all other required permissions). A simple curl request to the cloud billing API also returns the same error and we observed this error in GKE Pod &amp; GCP VM as well.</p>\n<p>Previously we were running the terraform code using cloud build private worker pools and were able to access all the API's without any issues.</p>\n<p>Request to the API without the authentication header(observed the same behaviour with auth token as well)</p>\n<pre><code>root@istio-ingressgateway-5944b79fdc-9fp67:/# curl https://cloudbilling.googleapis.com/v1/projects/test-projet/billingInfo\n&lt;!DOCTYPE html&gt;\n&lt;html lang=en&gt;\n  &lt;meta charset=utf-8&gt;\n  &lt;meta name=viewport content=&quot;initial-scale=1, minimum-scale=1, width=device-width&quot;&gt;\n  &lt;title&gt;Error 403 (Forbidden)!!1&lt;/title&gt;\n  &lt;style&gt;\n    *{margin:0;padding:0}html,code{font:15px/22px arial,sans-serif}html{background:#fff;color:#222;padding:15px}body{margin:7% auto 0;max-width:390px;min-height:180px;padding:30px 0 15px}* &gt; body{background:url(//www.google.com/images/errors/robot.png) 100% 5px no-repeat;padding-right:205px}p{margin:11px 0 22px;overflow:hidden}ins{color:#777;text-decoration:none}a img{border:0}@media screen and (max-width:772px){body{background:none;margin-top:0;max-width:none;padding-right:0}}#logo{background:url(//www.google.com/images/branding/googlelogo/1x/googlelogo_color_150x54dp.png) no-repeat;margin-left:-5px}@media only screen and (min-resolution:192dpi){#logo{background:url(//www.google.com/images/branding/googlelogo/2x/googlelogo_color_150x54dp.png) no-repeat 0% 0%/100% 100%;-moz-border-image:url(//www.google.com/images/branding/googlelogo/2x/googlelogo_color_150x54dp.png) 0}}@media only screen and (-webkit-min-device-pixel-ratio:2){#logo{background:url(//www.google.com/images/branding/googlelogo/2x/googlelogo_color_150x54dp.png) no-repeat;-webkit-background-size:100% 100%}}#logo{display:inline-block;height:54px;width:150px}\n  &lt;/style&gt;\n  &lt;a href=//www.google.com/&gt;&lt;span id=logo aria-label=Google&gt;&lt;/span&gt;&lt;/a&gt;\n  &lt;p&gt;&lt;b&gt;403.&lt;/b&gt; &lt;ins&gt;That\u2019s an error.&lt;/ins&gt;\n  &lt;p&gt;Your client does not have permission to get URL &lt;code&gt;/v1/projects/test-project/billingInfo&lt;/code&gt; from this server.  &lt;ins&gt;That\u2019s all we know.&lt;/ins&gt; \n</code></pre>\n<p>Calls to other API's are working as expected</p>\n<pre><code>root@istio-ingressgateway-5944b79fdc-9fp67:/# curl https://monitoring.googleapis.com/v3/projects/test-project/notificationChannels/6321545542211742323\n{\n  &quot;error&quot;: {\n    &quot;code&quot;: 401,\n    &quot;message&quot;: &quot;Request is missing required authentication credential. Expected OAuth 2 access token, login cookie or other valid authentication credential. See https://developers.google.com/identity/sign-in/web/devconsole-project.&quot;,\n    &quot;status&quot;: &quot;UNAUTHENTICATED&quot;,\n    &quot;details&quot;: [\n      {\n        &quot;@type&quot;: &quot;type.googleapis.com/google.rpc.ErrorInfo&quot;,\n        &quot;reason&quot;: &quot;CREDENTIALS_MISSING&quot;,\n        &quot;domain&quot;: &quot;googleapis.com&quot;,\n        &quot;metadata&quot;: {\n          &quot;method&quot;: &quot;google.monitoring.v3.NotificationChannelService.GetNotificationChannel&quot;,\n          &quot;service&quot;: &quot;monitoring.googleapis.com&quot;\n        }\n      }\n    ]\n  }\n}\nroot@istio-ingressgateway-5944b79fdc-9fp67:/# \n</code></pre>\n<p>We are using VPC SC and Google private access is enabled on the subnets. Did anyone face this issue and what is the recommended steps/config to resolve this?</p>\n", "OwnerUserId": "9824120", "LastActivityDate": "2022-06-15T12:11:27.947", "Title": "Unable to access cloudbilling.googleapis.com from GKE pod/GCE VM", "Tags": "<google-cloud-platform><gitlab><terraform><terraform-provider-gcp>", "AnswerCount": "1", "CommentCount": "0", "ContentLicense": "CC BY-SA 4.0", "history": [{"Id": "272218152", "PostHistoryTypeId": "2", "PostId": "72616282", "RevisionGUID": "e9cc68c2-77ce-490f-a572-826725cf5ffd", "CreationDate": "2022-06-14T11:35:16.187", "UserId": "9824120", "Text": "We are currently seeing an issue in terraform pipelines running in GKE pods where the datasource internally calling the cloudbilling.googleapis.com returns \"Your client does not have permission to get URL\". \r\n\r\nWe have added the serviceaccount to the billing account with Billing Account Viewer permission but still seeing the same behaviour(The service account has all other required permissions). A simple curl request to the cloud billing API also returns the same error and we observed this error in GKE Pod & GCP VM as well. \r\n\r\nPreviously we were running the terraform code using cloud build private worker pools and were able to access all the API's without any issues.\r\n\r\nRequest to the API without the authentication header(observed the same behaviour with auth token as well)\r\n\r\n    root@istio-ingressgateway-5944b79fdc-9fp67:/# curl https://cloudbilling.googleapis.com/v1/projects/test-projet/billingInfo\r\n    <!DOCTYPE html>\r\n    <html lang=en>\r\n      <meta charset=utf-8>\r\n      <meta name=viewport content=\"initial-scale=1, minimum-scale=1, width=device-width\">\r\n      <title>Error 403 (Forbidden)!!1</title>\r\n      <style>\r\n        *{margin:0;padding:0}html,code{font:15px/22px arial,sans-serif}html{background:#fff;color:#222;padding:15px}body{margin:7% auto 0;max-width:390px;min-height:180px;padding:30px 0 15px}* > body{background:url(//www.google.com/images/errors/robot.png) 100% 5px no-repeat;padding-right:205px}p{margin:11px 0 22px;overflow:hidden}ins{color:#777;text-decoration:none}a img{border:0}@media screen and (max-width:772px){body{background:none;margin-top:0;max-width:none;padding-right:0}}#logo{background:url(//www.google.com/images/branding/googlelogo/1x/googlelogo_color_150x54dp.png) no-repeat;margin-left:-5px}@media only screen and (min-resolution:192dpi){#logo{background:url(//www.google.com/images/branding/googlelogo/2x/googlelogo_color_150x54dp.png) no-repeat 0% 0%/100% 100%;-moz-border-image:url(//www.google.com/images/branding/googlelogo/2x/googlelogo_color_150x54dp.png) 0}}@media only screen and (-webkit-min-device-pixel-ratio:2){#logo{background:url(//www.google.com/images/branding/googlelogo/2x/googlelogo_color_150x54dp.png) no-repeat;-webkit-background-size:100% 100%}}#logo{display:inline-block;height:54px;width:150px}\r\n      </style>\r\n      <a href=//www.google.com/><span id=logo aria-label=Google></span></a>\r\n      <p><b>403.</b> <ins>That\u2019s an error.</ins>\r\n      <p>Your client does not have permission to get URL <code>/v1/projects/test-project/billingInfo</code> from this server.  <ins>That\u2019s all we know.</ins> \r\n    \r\nCalls to other API's are working as expected\r\n\r\n    root@istio-ingressgateway-5944b79fdc-9fp67:/# curl https://monitoring.googleapis.com/v3/projects/test-project/notificationChannels/6321545542211742323\r\n    {\r\n      \"error\": {\r\n        \"code\": 401,\r\n        \"message\": \"Request is missing required authentication credential. Expected OAuth 2 access token, login cookie or other valid authentication credential. See https://developers.google.com/identity/sign-in/web/devconsole-project.\",\r\n        \"status\": \"UNAUTHENTICATED\",\r\n        \"details\": [\r\n          {\r\n            \"@type\": \"type.googleapis.com/google.rpc.ErrorInfo\",\r\n            \"reason\": \"CREDENTIALS_MISSING\",\r\n            \"domain\": \"googleapis.com\",\r\n            \"metadata\": {\r\n              \"method\": \"google.monitoring.v3.NotificationChannelService.GetNotificationChannel\",\r\n              \"service\": \"monitoring.googleapis.com\"\r\n            }\r\n          }\r\n        ]\r\n      }\r\n    }\r\n    root@istio-ingressgateway-5944b79fdc-9fp67:/# \r\n\r\nWe are using VPC SC and Google private access is enabled on the subnets. Did anyone face this issue and what is the recommended steps/config to resolve this?", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "We have added the serviceaccount to the billing account with Billing Account Viewer permission but still seeing the same behaviour(The service account has all other required permissions). ", "keywords": ["bill"]}, {"source": "Text", "text": "A simple curl request to the cloud billing API also returns the same error and we observed this error in GKE Pod & GCP VM as well. ", "keywords": ["bill"]}, {"source": "Text", "text": "Request to the API without the authentication header(observed the same behaviour with auth token as well) root@istio-ingressgateway-5944b79fdc-9fp67:/# curl https://cloudbilling.googleapis.com/v1/projects/test-projet/billingInfo Error 403 (Forbidden)!!1 403. ", "keywords": ["bill", "test"]}, {"source": "Text", "text": "Your client does not have permission to get URL /v1/projects/test-project/billingInfo from this server. ", "keywords": ["bill", "test"]}, {"source": "Text", "text": "Calls to other API's are working as expected root@istio-ingressgateway-5944b79fdc-9fp67:/# curl https://monitoring.googleapis.com/v3/projects/test-project/notificationChannels/6321545542211742323 ", "keywords": ["test"]}, {"source": "Text", "text": "See https://developers.google.com/identity/sign-in/web/devconsole-project.\", \"status\": \"UNAUTHENTICATED\", \"details\": [ { \"@type\": \"type.googleapis.com/google.rpc.ErrorInfo\", \"reason\": \"CREDENTIALS_MISSING\", \"domain\": \"googleapis.com\", \"metadata\": { \"method\": \"google.monitoring.v3.NotificationChannelService.GetNotificationChannel\", \"service\": \"monitoring.googleapis.com\" } } ] } } root@istio-ingressgateway-5944b79fdc-9fp67:/# ", "keywords": ["domain"]}]}, {"Id": "272218154", "PostHistoryTypeId": "1", "PostId": "72616282", "RevisionGUID": "e9cc68c2-77ce-490f-a572-826725cf5ffd", "CreationDate": "2022-06-14T11:35:16.187", "UserId": "9824120", "Text": "Unable to access cloudbilling.googleapis.com from GKE pod/GCE VM", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "272218155", "PostHistoryTypeId": "3", "PostId": "72616282", "RevisionGUID": "e9cc68c2-77ce-490f-a572-826725cf5ffd", "CreationDate": "2022-06-14T11:35:16.187", "UserId": "9824120", "Text": "<google-cloud-platform><gitlab><terraform><terraform-provider-gcp>", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "answers": [{"Id": "72631167", "PostTypeId": "2", "ParentId": "72616282", "CreationDate": "2022-06-15T12:11:27.947", "Score": "0", "Body": "<p>We are able to resolve this issue after configuring the cloud DNS response policy for cloudbilling.googleapis.com, The previous private google access setup used the restricted.googleapis.com which is not supporting cloudbilling.googleapis.com.</p>\n<p>We had to remove the private zone setup for the google private access and configure response policies for cloudbilling.googleapis.com and *.googleapis.com</p>\n<p>Attached are the screenshots of the response policy configuration and the setup additional response policy rules for the API's that are not covered under SC.</p>\n<p><a href=\"https://i.stack.imgur.com/FKKWH.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.stack.imgur.com/FKKWH.png\" alt=\"enter image description here\" /></a>\n<a href=\"https://i.stack.imgur.com/Ca5b1.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.stack.imgur.com/Ca5b1.png\" alt=\"enter image description here\" /></a>\n<a href=\"https://i.stack.imgur.com/RgCPc.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.stack.imgur.com/RgCPc.png\" alt=\"enter image description here\" /></a>\n<a href=\"https://i.stack.imgur.com/xUpxh.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.stack.imgur.com/xUpxh.png\" alt=\"enter image description here\" /></a></p>\n<p>Note: The terraform google_dns_response_policy_rule is currently not supporting passthrough behaviour so had to use the localdata, you can able to use passthrough behaviour for the API's once this issue is fixed <a href=\"https://github.com/hashicorp/terraform-provider-google/issues/11193\" rel=\"nofollow noreferrer\">https://github.com/hashicorp/terraform-provider-google/issues/11193</a></p>\n", "OwnerUserId": "9824120", "LastActivityDate": "2022-06-15T12:11:27.947", "CommentCount": "1", "ContentLicense": "CC BY-SA 4.0", "comments": [{"Id": "128304488", "PostId": "72631167", "Score": "0", "Text": "1) How would anyone have guessed that this was the problem based on the details in your question? 2) Why are you configuring DNS response policies for those resources? Completely unnecessary. What benefit are you achieving?", "CreationDate": "2022-06-15T16:40:36.553", "UserId": "8016720", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "history": [{"Id": "272297762", "PostHistoryTypeId": "2", "PostId": "72631167", "RevisionGUID": "23aca414-eda2-45d7-940c-939653eca55e", "CreationDate": "2022-06-15T12:11:27.947", "UserId": "9824120", "Text": "We are able to resolve this issue after configuring the cloud DNS response policy for cloudbilling.googleapis.com, The previous private google access setup used the restricted.googleapis.com which is not supporting cloudbilling.googleapis.com. \r\n\r\nWe had to remove the private zone setup for the google private access and configure response policies for cloudbilling.googleapis.com and *.googleapis.com \r\n\r\nAttached are the screenshots of the response policy configuration and the setup additional response policy rules for the API's that are not covered under SC. \r\n\r\n[![enter image description here][1]][1]\r\n[![enter image description here][2]][2]\r\n[![enter image description here][3]][3]\r\n[![enter image description here][4]][4]\r\n\r\nNote: The terraform google_dns_response_policy_rule is currently not supporting passthrough behaviour so had to use the localdata, you can able to use passthrough behaviour for the API's once this issue is fixed https://github.com/hashicorp/terraform-provider-google/issues/11193 \r\n\r\n\r\n  [1]: https://i.stack.imgur.com/FKKWH.png\r\n  [2]: https://i.stack.imgur.com/Ca5b1.png\r\n  [3]: https://i.stack.imgur.com/RgCPc.png\r\n  [4]: https://i.stack.imgur.com/xUpxh.png", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "We are able to resolve this issue after configuring the cloud DNS response policy for cloudbilling.googleapis.com, The previous private google access setup used the restricted.googleapis.com which is not supporting cloudbilling.googleapis.com. ", "keywords": ["policy"]}, {"source": "Text", "text": "Attached are the screenshots of the response policy configuration and the setup additional response policy rules for the API's that are not covered under SC. ", "keywords": ["policy"]}, {"source": "Text", "text": "[![enter image description here][1]][1] [![enter image description here][2]][2] [![enter image description here][3]][3] [![enter image description here][4]][4] Note: The terraform google_dns_response_policy_rule is currently not supporting passthrough behaviour so had to use the localdata, you can able to use passthrough behaviour for the API's once this issue is fixed https://github.com/hashicorp/terraform-provider-google/issues/11193 [1]: https://i.stack.imgur.com/FKKWH.png [2]: https://i.stack.imgur.com/Ca5b1.png [3]: https://i.stack.imgur.com/RgCPc.png [4]: https://i.stack.imgur.com/xUpxh.png", "keywords": ["provider"]}]}], "filtered-sentences": [{"source": "Body", "text": "We are able to resolve this issue after configuring the cloud DNS response policy for cloudbilling.googleapis.com, The previous private google access setup used the restricted.googleapis.com which is not supporting cloudbilling.googleapis.com. ", "keywords": ["policy"]}, {"source": "Body", "text": "Attached are the screenshots of the response policy configuration and the setup additional response policy rules for the API's that are not covered under SC. ", "keywords": ["policy"]}, {"source": "Body", "text": "Note: The terraform google_dns_response_policy_rule is currently not supporting passthrough behaviour so had to use the localdata, you can able to use passthrough behaviour for the API's once this issue is fixed https://github.com/hashicorp/terraform-provider-google/issues/11193", "keywords": ["provider"]}]}], "contains-topic": true, "filtered-sentences": [{"source": "Body", "text": "We have added the serviceaccount to the billing account with Billing Account Viewer permission but still seeing the same behaviour(The service account has all other required permissions). ", "keywords": ["bill"]}, {"source": "Body", "text": "A simple curl request to the cloud billing API also returns the same error and we observed this error in GKE Pod & GCP VM as well. ", "keywords": ["bill"]}]}