{"Id": "76180957", "PostTypeId": "1", "CreationDate": "2023-05-05T09:54:26.613", "Score": "-2", "ViewCount": "244", "Body": "<p>I'm having some trouble deploying the below terraform code. It keeps erroring during apply the following error:</p>\n<blockquote>\n<p>\u2502 Error: Insufficient visibility_config blocks \u2502  \u2502   on ignore.tf\nline 66, in resource &quot;aws_wafv2_web_acl&quot; &quot;this&quot;: \u2502   66:   rule { \u2502  \u2502\nAt least 1 &quot;visibility_config&quot; blocks are required. \u2575 \u2577 \u2502 Error:\nUnsupported block type \u2502  \u2502   on ignore.tf line 78, in resource\n&quot;aws_wafv2_web_acl&quot; &quot;this&quot;: \u2502   78:     visibility_config { \u2502  \u2502\nBlocks of type &quot;visibility_config&quot; are not expected here. \u2575</p>\n</blockquote>\n<p>I have defined it per the instructions and checked the patterns in the Terraform docs by comparing them with other configs. One suggestion was to add the &quot;override action&quot; block inside the rule to count or none but this does not seem to make a difference.</p>\n<p>Any suggestions?</p>\n<p>Thanks.</p>\n<pre><code>//ip-set\nresource &quot;aws_wafv2_ip_set&quot; &quot;this&quot; {\n  name               = &quot;${var.name}-ip-whitelist&quot;\n  description        = var.description\n  scope              = var.scope\n  ip_address_version = var.ip-add-ver\n  addresses          = var.ip-address\n  tags               = var.tags\n}\n\n\n//web acl\nresource &quot;aws_wafv2_web_acl&quot; &quot;this&quot; {\n  name        = &quot;${var.name}-web-acl&quot;\n  description = &quot;${var.name}-web-acl&quot;\n  scope       = var.scope\n  tags        = var.tags\n\n  default_action {\n    allow {}\n  }\n  \n  visibility_config {\n    cloudwatch_metrics_enabled = false\n    metric_name                = &quot;friendly-rule-metric-name&quot;\n    sampled_requests_enabled   = false\n    }\n\n  rule {\n    name     = &quot;ip-set-rule&quot;\n    priority = 1\n\n    override_action {\n      count {}\n    }\n\n    statement {\n      ip_set_reference_statement {\n        arn = aws_wafv2_ip_set.this.arn\n      }\n    visibility_config {\n      cloudwatch_metrics_enabled = false\n      metric_name                = &quot;friendly-rule-metric-name&quot;\n      sampled_requests_enabled   = false\n    }\n    }\n  }\n}\n\n//acl association\nresource &quot;aws_wafv2_web_acl_association&quot; &quot;default_web_acl_association&quot; {\n  resource_arn = var.target_resource\n  web_acl_arn  = aws_wafv2_web_acl.this.arn\n}\n</code></pre>\n", "OwnerUserId": "13341686", "LastEditorUserId": "4408275", "LastEditDate": "2023-06-07T15:23:11.850", "LastActivityDate": "2023-06-07T15:23:11.850", "Title": "issue with aws waf visibility config with terraform", "Tags": "<amazon-web-services><terraform><amazon-waf>", "AnswerCount": "1", "CommentCount": "0", "ContentLicense": "CC BY-SA 4.0", "history": [{"Id": "292368744", "PostHistoryTypeId": "2", "PostId": "76180957", "RevisionGUID": "a250d0cf-620a-4eba-90c6-dc820a330b25", "CreationDate": "2023-05-05T09:54:26.613", "UserId": "13341686", "Text": "I'm having some trouble deploying the below terraform code. It keeps erroring during apply the following error:\r\n\r\n> \u2502 Error: Insufficient visibility_config blocks \u2502  \u2502   on main.tf line\r\n> 48, in resource \"aws_wafv2_web_acl\" \"this\": \u2502   48: resource\r\n> \"aws_wafv2_web_acl\" \"this\" { \u2502  \u2502 At least 1 \"visibility_config\"\r\n> blocks are required.\r\n\r\nI have defined it per the instructions and checked the patterns in the Terraform docs by comparing them with other configs. One suggestion was to add the \"override action\" block inside the rule to count or none but this does not seem to make a difference.\r\n\r\nAny suggestions?\r\n\r\nThanks.\r\n\r\n\r\n\r\n    //ip-set\r\n    resource \"aws_wafv2_ip_set\" \"this\" {\r\n      name               = \"${var.name}-ip-whitelist\"\r\n      description        = var.description\r\n      scope              = var.scope\r\n      ip_address_version = var.ip-add-ver\r\n      addresses          = var.ip-address\r\n      tags               = var.tags\r\n    }\r\n    \r\n    \r\n    //web acl \r\n    resource \"aws_wafv2_web_acl\" \"this\" {\r\n      name        = \"${var.name}-web-acl\"\r\n      description = \"${var.name}-web-acl\"\r\n      scope       = var.scope\r\n      tags        = var.tags\r\n    \r\n      default_action {\r\n        allow {}\r\n      }\r\n    \r\n      rule {\r\n        name     = \"ip-set-rule\"\r\n        priority = 1\r\n    \r\n        override_action {\r\n          count {}\r\n        }\r\n    \r\n        statement {\r\n          ip_set_reference_statement {\r\n            arn = aws_wafv2_ip_set.this.arn\r\n          }\r\n        }\r\n    \r\n        visibility_config {\r\n          cloudwatch_metrics_enabled = false\r\n          metric_name                = \"main-web-acl-metric\"\r\n          sampled_requests_enabled   = false\r\n        }\r\n      }\r\n    }\r\n    \r\n    //acl association\r\n    resource \"aws_wafv2_web_acl_association\" \"default_web_acl_association\" {\r\n      resource_arn = var.target_resource\r\n      web_acl_arn  = aws_wafv2_web_acl.this.arn\r\n    }", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "292368746", "PostHistoryTypeId": "1", "PostId": "76180957", "RevisionGUID": "a250d0cf-620a-4eba-90c6-dc820a330b25", "CreationDate": "2023-05-05T09:54:26.613", "UserId": "13341686", "Text": "issue with aws waf visibility config with terraform", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "292368747", "PostHistoryTypeId": "3", "PostId": "76180957", "RevisionGUID": "a250d0cf-620a-4eba-90c6-dc820a330b25", "CreationDate": "2023-05-05T09:54:26.613", "UserId": "13341686", "Text": "<amazon-web-services><terraform><waf><amazon-waf>", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "292378594", "PostHistoryTypeId": "5", "PostId": "76180957", "RevisionGUID": "66e5a675-2640-467a-8d6f-40a66062a63c", "CreationDate": "2023-05-05T13:18:49.567", "UserId": "13341686", "Comment": "deleted 338 characters in body", "Text": "I'm having some trouble deploying the below terraform code. It keeps erroring during apply the following error:\r\n\r\n> \u2502 Error: Insufficient visibility_config blocks \u2502  \u2502   on main.tf line\r\n> 48, in resource \"aws_wafv2_web_acl\" \"this\": \u2502   48: resource\r\n> \"aws_wafv2_web_acl\" \"this\" { \u2502  \u2502 At least 1 \"visibility_config\"\r\n> blocks are required.\r\n\r\nI have defined it per the instructions and checked the patterns in the Terraform docs by comparing them with other configs. One suggestion was to add the \"override action\" block inside the rule to count or none but this does not seem to make a difference.\r\n\r\nAny suggestions?\r\n\r\nThanks.\r\n\r\n\r\n    //web acl\r\n    resource \"aws_wafv2_web_acl\" \"this\" {\r\n      name        = \"${var.name}-web-acl\"\r\n      description = \"${var.name}-web-acl\"\r\n      scope       = var.scope\r\n      tags        = var.tags\r\n    \r\n      default_action {\r\n        allow {}\r\n      }\r\n      \r\n      visibility_config {\r\n        cloudwatch_metrics_enabled = false\r\n        metric_name                = \"friendly-rule-metric-name\"\r\n        sampled_requests_enabled   = false\r\n        }\r\n    \r\n      rule {\r\n        name     = \"ip-set-rule\"\r\n        priority = 1\r\n    \r\n        override_action {\r\n          count {}\r\n        }\r\n    \r\n        statement {\r\n          ip_set_reference_statement {\r\n            arn = aws_wafv2_ip_set.this.arn\r\n          }\r\n        }\r\n      }\r\n    }\r\n    \r\n    //acl association\r\n    resource \"aws_wafv2_web_acl_association\" \"default_web_acl_association\" {\r\n      resource_arn = var.target_resource\r\n      web_acl_arn  = aws_wafv2_web_acl.this.arn\r\n    }", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "292379239", "PostHistoryTypeId": "5", "PostId": "76180957", "RevisionGUID": "47d050e9-5d18-457f-97ee-24f9e598ae92", "CreationDate": "2023-05-05T13:31:47.653", "UserId": "13341686", "Comment": "added 547 characters in body", "Text": "I'm having some trouble deploying the below terraform code. It keeps erroring during apply the following error:\r\n\r\n> \u2502 Error: Insufficient visibility_config blocks \u2502  \u2502   on ignore.tf\r\n> line 66, in resource \"aws_wafv2_web_acl\" \"this\": \u2502   66:   rule { \u2502  \u2502\r\n> At least 1 \"visibility_config\" blocks are required. \u2575 \u2577 \u2502 Error:\r\n> Unsupported block type \u2502  \u2502   on ignore.tf line 78, in resource\r\n> \"aws_wafv2_web_acl\" \"this\": \u2502   78:     visibility_config { \u2502  \u2502\r\n> Blocks of type \"visibility_config\" are not expected here. \u2575\r\n\r\n\r\nI have defined it per the instructions and checked the patterns in the Terraform docs by comparing them with other configs. One suggestion was to add the \"override action\" block inside the rule to count or none but this does not seem to make a difference.\r\n\r\nAny suggestions?\r\n\r\nThanks.\r\n\r\n   \r\n\r\n    //ip-set\r\n    resource \"aws_wafv2_ip_set\" \"this\" {\r\n      name               = \"${var.name}-ip-whitelist\"\r\n      description        = var.description\r\n      scope              = var.scope\r\n      ip_address_version = var.ip-add-ver\r\n      addresses          = var.ip-address\r\n      tags               = var.tags\r\n    }\r\n    \r\n    \r\n    //web acl\r\n    resource \"aws_wafv2_web_acl\" \"this\" {\r\n      name        = \"${var.name}-web-acl\"\r\n      description = \"${var.name}-web-acl\"\r\n      scope       = var.scope\r\n      tags        = var.tags\r\n    \r\n      default_action {\r\n        allow {}\r\n      }\r\n      \r\n      visibility_config {\r\n        cloudwatch_metrics_enabled = false\r\n        metric_name                = \"friendly-rule-metric-name\"\r\n        sampled_requests_enabled   = false\r\n        }\r\n    \r\n      rule {\r\n        name     = \"ip-set-rule\"\r\n        priority = 1\r\n    \r\n        override_action {\r\n          count {}\r\n        }\r\n    \r\n        statement {\r\n          ip_set_reference_statement {\r\n            arn = aws_wafv2_ip_set.this.arn\r\n          }\r\n        visibility_config {\r\n          cloudwatch_metrics_enabled = false\r\n          metric_name                = \"friendly-rule-metric-name\"\r\n          sampled_requests_enabled   = false\r\n        }\r\n        }\r\n      }\r\n    }\r\n    \r\n    //acl association\r\n    resource \"aws_wafv2_web_acl_association\" \"default_web_acl_association\" {\r\n      resource_arn = var.target_resource\r\n      web_acl_arn  = aws_wafv2_web_acl.this.arn\r\n    }\r\n\r\n", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "293858632", "PostHistoryTypeId": "6", "PostId": "76180957", "RevisionGUID": "89684082-e0f3-4afb-913e-fe8450854460", "CreationDate": "2023-06-07T15:23:11.850", "UserId": "4408275", "Comment": "Remove label that is not relevant to the question", "Text": "<amazon-web-services><terraform><amazon-waf>", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "293858633", "PostHistoryTypeId": "24", "PostId": "76180957", "RevisionGUID": "89684082-e0f3-4afb-913e-fe8450854460", "CreationDate": "2023-06-07T15:23:11.850", "Comment": "Proposed by 4408275 approved by 1413222, 6277104 edit id of 5523972", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "answers": [{"Id": "76181652", "PostTypeId": "2", "ParentId": "76180957", "CreationDate": "2023-05-05T11:23:36.677", "Score": "2", "Body": "<p>Please take a look at <a href=\"https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/wafv2_web_acl\" rel=\"nofollow noreferrer\">the documentation</a>. The very first example on that page shows what you are missing. You need to have a <code>visibility_config</code> block at the top level of the resource, not inside any <code>rule</code> blocks.</p>\n", "OwnerUserId": "13070", "LastActivityDate": "2023-05-05T11:23:36.677", "CommentCount": "5", "ContentLicense": "CC BY-SA 4.0", "comments": [{"Id": "134348641", "PostId": "76181652", "Score": "0", "Text": "I have amended the OP with your suggestion but did try this previously and it failed with the same error. In the doc, there is another example where the visibility_config is nested inside the rule but nevertheless, i seem to be hitting the same issue.", "CreationDate": "2023-05-05T13:22:49.843", "UserId": "13341686", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "134348707", "PostId": "76181652", "Score": "0", "Text": "You moved the visibility `visibility_config` from inside the rule, to outside the rule. You should have left the one in the rule, and added a new one at the top level. You need BOTH.", "CreationDate": "2023-05-05T13:26:01.160", "UserId": "13070", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "134348907", "PostId": "76181652", "Score": "0", "Text": "Thanks for the above. I have added this and tried again but seem to be hitting 2 errors now. The second of which says \"Blocks of type \"visibility_config\" are not expected here.\" I have updated the OP with the the info.", "CreationDate": "2023-05-05T13:39:42.747", "UserId": "13341686", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "134349634", "PostId": "76181652", "Score": "0", "Text": "Please pay attention to the code. You placed the block inside the `statement` block. It should be at the same level as the `statement` block, not inside of it.", "CreationDate": "2023-05-05T14:22:21.523", "UserId": "13070", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "Please pay attention to the code. ", "keywords": ["pay"]}]}, {"Id": "134397121", "PostId": "76181652", "Score": "0", "Text": "thanks for your help and please accept my apologies for the confusion.", "CreationDate": "2023-05-09T15:46:37.810", "UserId": "13341686", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "history": [{"Id": "292372748", "PostHistoryTypeId": "2", "PostId": "76181652", "RevisionGUID": "d3544a6d-2d1b-4c10-802d-5832f884ae83", "CreationDate": "2023-05-05T11:23:36.677", "UserId": "13070", "Text": "Please take a look at [the documentation][1]. The very first example on that page shows what you are missing. You need to have a `visibility_config` block at the top level of the resource, not inside any `rule` blocks.\r\n\r\n\r\n  [1]: https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/wafv2_web_acl", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "filtered-sentences": []}], "contains-topic": false, "filtered-sentences": []}