{"Id": "65591109", "PostTypeId": "1", "CreationDate": "2021-01-06T06:23:51.640", "Score": "0", "ViewCount": "1792", "Body": "<p>I'm trying to create a EKS cluster in a private subnet. I'm having issues getting it working. I get the error <code>unhealthy nodes in the kubernetes cluster</code>. Wonder if its due to security group or some other issues like VPC endpoints?</p>\n<p>When I use NAT gateway setup then it works fine. But I don't want to use nat gateway anymore.</p>\n<p>One think I'm not sure is should the EKS cluster subnet_ids be only private subnets?</p>\n<p>In the below config I'm using both public and private subnets.</p>\n<pre><code>resource &quot;aws_eks_cluster&quot; &quot;main&quot; {\n  name      = var.eks_cluster_name\n  role_arn  = aws_iam_role.eks_cluster.arn\n\n  vpc_config {\n    subnet_ids              = concat(var.public_subnet_ids, var.private_subnet_ids)\n    security_group_ids      = [aws_security_group.eks_cluster.id, aws_security_group.eks_nodes.id, aws_security_group.external_access.id]\n    endpoint_private_access = true\n    endpoint_public_access  = false\n  }\n\n  # Ensure that IAM Role permissions are created before and deleted after EKS Cluster handling.\n  # Otherwise, EKS will not be able to properly delete EKS managed EC2 infrastructure such as Security Groups.\n\n  depends_on = [\n    &quot;aws_iam_role_policy_attachment.aws_eks_cluster_policy&quot;,\n    &quot;aws_iam_role_policy_attachment.aws_eks_service_policy&quot;\n  ]\n}\n</code></pre>\n", "OwnerUserId": "6737245", "LastEditorUserId": "248823", "LastEditDate": "2021-01-06T09:29:36.017", "LastActivityDate": "2021-01-06T09:29:36.017", "Title": "EKS Cluster in a private subnet - unhealthy nodes in the kubernetes cluster", "Tags": "<amazon-web-services><kubernetes><terraform><amazon-eks>", "AnswerCount": "1", "CommentCount": "4", "FavoriteCount": "0", "ContentLicense": "CC BY-SA 4.0", "comments": [{"Id": "115967510", "PostId": "65591109", "Score": "2", "Text": "Do you have any NAT gateway to provide internet access for nodes in private subnets?", "CreationDate": "2021-01-06T06:50:11.290", "UserId": "248823", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "Do you have any NAT gateway to provide internet access for nodes in private subnets?", "keywords": ["nat"]}]}, {"Id": "115969607", "PostId": "65591109", "Score": "0", "Text": "No nat gateway. I don't want to use Nat gateway since its price is higher. I had a different setup which had nat gateway and that worked fine. But I want to implement without a nat gateway and use vpc endpoints.", "CreationDate": "2021-01-06T08:47:37.813", "UserId": "6737245", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "No nat gateway. ", "keywords": ["nat"]}, {"source": "Text", "text": "I don't want to use Nat gateway since its price is higher. ", "keywords": ["nat"]}, {"source": "Text", "text": "I had a different setup which had nat gateway and that worked fine. ", "keywords": ["nat"]}, {"source": "Text", "text": "But I want to implement without a nat gateway and use vpc endpoints.", "keywords": ["nat"]}]}, {"Id": "115969635", "PostId": "65591109", "Score": "0", "Text": "What should be the method for using VPC endpoints instead of nat gateway?", "CreationDate": "2021-01-06T08:48:55.323", "UserId": "6737245", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "What should be the method for using VPC endpoints instead of nat gateway?", "keywords": ["nat"]}]}, {"Id": "121207765", "PostId": "65591109", "Score": "0", "Text": "Did you ever figure this out without a NAT gateway?", "CreationDate": "2021-07-30T01:30:15.413", "UserId": "8354181", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "Did you ever figure this out without a NAT gateway?", "keywords": ["nat"]}]}], "history": [{"Id": "238192222", "PostHistoryTypeId": "2", "PostId": "65591109", "RevisionGUID": "2734d091-4111-4a11-9a66-b0a6e014cb13", "CreationDate": "2021-01-06T06:23:51.640", "UserId": "6737245", "Text": "I'm trying to create a EKS cluster in a private subnet. I'm having issues getting it working. I get the error `unhealthy nodes in the kubernetes cluster`. Wonder if its due to security group or some other issues. \r\n\r\nOne think I'm not sure is should the EKS cluster subnet_ids be only private subnets? \r\n\r\nIn the below config I'm using both public and private subnets.\r\n\r\n    resource \"aws_eks_cluster\" \"main\" {\r\n      name      = var.eks_cluster_name\r\n      role_arn  = aws_iam_role.eks_cluster.arn\r\n    \r\n      vpc_config {\r\n        subnet_ids              = concat(var.public_subnet_ids, var.private_subnet_ids)\r\n        security_group_ids      = [aws_security_group.eks_cluster.id, aws_security_group.eks_nodes.id, aws_security_group.external_access.id]\r\n        endpoint_private_access = true\r\n        endpoint_public_access  = false\r\n      }\r\n    \r\n      # Ensure that IAM Role permissions are created before and deleted after EKS Cluster handling.\r\n      # Otherwise, EKS will not be able to properly delete EKS managed EC2 infrastructure such as Security Groups.\r\n    \r\n      depends_on = [\r\n        \"aws_iam_role_policy_attachment.aws_eks_cluster_policy\",\r\n        \"aws_iam_role_policy_attachment.aws_eks_service_policy\"\r\n      ]\r\n    }\r\n\r\n", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "I'm trying to create a EKS cluster in a private subnet. ", "keywords": ["cluster"]}, {"source": "Text", "text": "I get the error `unhealthy nodes in the kubernetes cluster`. ", "keywords": ["cluster"]}, {"source": "Text", "text": "One think I'm not sure is should the EKS cluster subnet_ids be only private subnets? ", "keywords": ["cluster"]}, {"source": "Text", "text": "resource \"aws_eks_cluster\" \"main\" { name = var.eks_cluster_name role_arn = aws_iam_role.eks_cluster.arn vpc_config { subnet_ids = concat(var.public_subnet_ids, var.private_subnet_ids) security_group_ids = [aws_security_group.eks_cluster.id, aws_security_group.eks_nodes.id, aws_security_group.external_access.id] endpoint_private_access = true endpoint_public_access = false } # Ensure that IAM Role permissions are created before and deleted after EKS Cluster handling. ", "keywords": ["cluster"]}]}, {"Id": "238192223", "PostHistoryTypeId": "1", "PostId": "65591109", "RevisionGUID": "2734d091-4111-4a11-9a66-b0a6e014cb13", "CreationDate": "2021-01-06T06:23:51.640", "UserId": "6737245", "Text": "EKS Cluster in a private subnet - unhealthy nodes in the kubernetes cluster", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "EKS Cluster in a private subnet - unhealthy nodes in the kubernetes cluster", "keywords": ["cluster"]}]}, {"Id": "238192224", "PostHistoryTypeId": "3", "PostId": "65591109", "RevisionGUID": "2734d091-4111-4a11-9a66-b0a6e014cb13", "CreationDate": "2021-01-06T06:23:51.640", "UserId": "6737245", "Text": "<kubernetes><terraform><amazon-eks>", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "238198572", "PostHistoryTypeId": "5", "PostId": "65591109", "RevisionGUID": "f0027e25-2c78-4b16-840b-84e7c1b6b6a4", "CreationDate": "2021-01-06T08:48:27.640", "UserId": "6737245", "Comment": "added 116 characters in body", "Text": "I'm trying to create a EKS cluster in a private subnet. I'm having issues getting it working. I get the error `unhealthy nodes in the kubernetes cluster`. Wonder if its due to security group or some other issues like VPC endpoints? \r\n\r\nWhen I use NAT gateway setup then it works fine. But I don't want to use nat gateway anymore.\r\n\r\nOne think I'm not sure is should the EKS cluster subnet_ids be only private subnets? \r\n\r\nIn the below config I'm using both public and private subnets.\r\n\r\n    resource \"aws_eks_cluster\" \"main\" {\r\n      name      = var.eks_cluster_name\r\n      role_arn  = aws_iam_role.eks_cluster.arn\r\n    \r\n      vpc_config {\r\n        subnet_ids              = concat(var.public_subnet_ids, var.private_subnet_ids)\r\n        security_group_ids      = [aws_security_group.eks_cluster.id, aws_security_group.eks_nodes.id, aws_security_group.external_access.id]\r\n        endpoint_private_access = true\r\n        endpoint_public_access  = false\r\n      }\r\n    \r\n      # Ensure that IAM Role permissions are created before and deleted after EKS Cluster handling.\r\n      # Otherwise, EKS will not be able to properly delete EKS managed EC2 infrastructure such as Security Groups.\r\n    \r\n      depends_on = [\r\n        \"aws_iam_role_policy_attachment.aws_eks_cluster_policy\",\r\n        \"aws_iam_role_policy_attachment.aws_eks_service_policy\"\r\n      ]\r\n    }\r\n\r\n", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "I'm trying to create a EKS cluster in a private subnet. ", "keywords": ["cluster"]}, {"source": "Text", "text": "I get the error `unhealthy nodes in the kubernetes cluster`. ", "keywords": ["cluster"]}, {"source": "Text", "text": "When I use NAT gateway setup then it works fine. ", "keywords": ["nat"]}, {"source": "Text", "text": "But I don't want to use nat gateway anymore. ", "keywords": ["nat"]}, {"source": "Text", "text": "One think I'm not sure is should the EKS cluster subnet_ids be only private subnets? ", "keywords": ["cluster"]}, {"source": "Text", "text": "resource \"aws_eks_cluster\" \"main\" { name = var.eks_cluster_name role_arn = aws_iam_role.eks_cluster.arn vpc_config { subnet_ids = concat(var.public_subnet_ids, var.private_subnet_ids) security_group_ids = [aws_security_group.eks_cluster.id, aws_security_group.eks_nodes.id, aws_security_group.external_access.id] endpoint_private_access = true endpoint_public_access = false } # Ensure that IAM Role permissions are created before and deleted after EKS Cluster handling. ", "keywords": ["cluster"]}]}, {"Id": "238200766", "PostHistoryTypeId": "6", "PostId": "65591109", "RevisionGUID": "eddd8f06-bd34-455f-bc8b-05988975f851", "CreationDate": "2021-01-06T09:29:36.017", "UserId": "248823", "Comment": "edited tags", "Text": "<amazon-web-services><kubernetes><terraform><amazon-eks>", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "answers": [{"Id": "65593238", "PostTypeId": "2", "ParentId": "65591109", "CreationDate": "2021-01-06T09:29:26.600", "Score": "1", "Body": "<p>Since you don't have NAT gateway/instance, your nodes <strong>can't connect to the internet</strong> and fail as they can't &quot;communicate with the control plane and other AWS services&quot;  (from <a href=\"https://docs.aws.amazon.com/eks/latest/userguide/network_reqs.html#vpc-cidr\" rel=\"nofollow noreferrer\">here</a>).</p>\n<p>Thus, you can use <strong>VPC endpoints</strong> to enable communication with the plain and the services. To view the properly setup VPC with <strong>private subnets</strong> for EKS, you can check <a href=\"https://s3.us-west-2.amazonaws.com/amazon-eks/cloudformation/2020-10-29/amazon-eks-fully-private-vpc.yaml\" rel=\"nofollow noreferrer\">AWS provided VPC template for EKS</a> (from <a href=\"https://docs.aws.amazon.com/eks/latest/userguide/create-public-private-vpc.html\" rel=\"nofollow noreferrer\">here</a>).</p>\n<p>From the template, the <strong>VPC endpoints</strong> in <code>us-east-1</code>:</p>\n<ul>\n<li>com.amazonaws.us-east-1.ec2</li>\n<li>com.amazonaws.us-east-1.ecr.api</li>\n<li>com.amazonaws.us-east-1.s3</li>\n<li>com.amazonaws.us-east-1.logs</li>\n<li>com.amazonaws.us-east-1.ecr.dkr</li>\n<li>com.amazonaws.us-east-1.sts</li>\n</ul>\n<p>Please note that all these endpoints, escept S3, are <strong>not free</strong>. So you have to consider if running cheap NAT instances or gateway would be cheaper or more expensive then maintaining these endpoints.</p>\n", "OwnerUserId": "248823", "LastActivityDate": "2021-01-06T09:29:26.600", "CommentCount": "0", "ContentLicense": "CC BY-SA 4.0", "history": [{"Id": "238200757", "PostHistoryTypeId": "2", "PostId": "65593238", "RevisionGUID": "448850c9-f7db-4e9e-a8f5-0d2831cd7a97", "CreationDate": "2021-01-06T09:29:26.600", "UserId": "248823", "Text": "Since you don't have NAT gateway/instance, your nodes **can't connect to the internet** and fail as they can't \"communicate with the control plane and other AWS services\"  (from [here](https://docs.aws.amazon.com/eks/latest/userguide/network_reqs.html#vpc-cidr)). \r\n\r\nThus, you can use **VPC endpoints** to enable communication with the plain and the services. To view the properly setup VPC with **private subnets** for EKS, you can check [AWS provided VPC template for EKS](https://s3.us-west-2.amazonaws.com/amazon-eks/cloudformation/2020-10-29/amazon-eks-fully-private-vpc.yaml) (from [here](https://docs.aws.amazon.com/eks/latest/userguide/create-public-private-vpc.html)). \r\n\r\nFrom the template, the **VPC endpoints** in `us-east-1`:\r\n\r\n - com.amazonaws.us-east-1.ec2\r\n - com.amazonaws.us-east-1.ecr.api\r\n - com.amazonaws.us-east-1.s3\r\n - com.amazonaws.us-east-1.logs\r\n - com.amazonaws.us-east-1.ecr.dkr\r\n - com.amazonaws.us-east-1.sts\r\n\r\nPlease note that all these endpoints, escept S3, are **not free**. So you have to consider if running cheap NAT instances or gateway would be cheaper or more expensive then maintaining these endpoints.", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "Since you don't have NAT gateway/instance, your nodes **can't connect to the internet** and fail as they can't \"communicate with the control plane and other AWS services\" (from [here](https://docs.aws.amazon.com/eks/latest/userguide/network_reqs.html#vpc-cidr)). ", "keywords": ["nat", "instance"]}, {"source": "Text", "text": "So you have to consider if running cheap NAT instances or gateway would be cheaper or more expensive then maintaining these endpoints", "keywords": ["cheap", "expense", "nat"]}]}], "filtered-sentences": [{"source": "Body", "text": "Since you don't have NAT gateway/instance, your nodes can't connect to the internet and fail as they can't \"communicate with the control plane and other AWS services\" (from here). ", "keywords": ["nat", "instance"]}, {"source": "Body", "text": "So you have to consider if running cheap NAT instances or gateway would be cheaper or more expensive then maintaining these endpoints.", "keywords": ["cheap", "expense", "nat"]}]}], "contains-topic": true, "filtered-sentences": [{"source": "Title", "text": "EKS Cluster in a private subnet - unhealthy nodes in the kubernetes cluster", "keywords": ["cluster"]}, {"source": "Body", "text": "I'm trying to create a EKS cluster in a private subnet. ", "keywords": ["cluster"]}, {"source": "Body", "text": "I get the error unhealthy nodes in the kubernetes cluster. ", "keywords": ["cluster"]}, {"source": "Body", "text": "When I use NAT gateway setup then it works fine. ", "keywords": ["nat"]}, {"source": "Body", "text": "But I don't want to use nat gateway anymore. ", "keywords": ["nat"]}, {"source": "Body", "text": "One think I'm not sure is should the EKS cluster subnet_ids be only private subnets? ", "keywords": ["cluster"]}]}