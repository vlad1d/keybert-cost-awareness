{"Id": "70016674", "PostTypeId": "1", "AcceptedAnswerId": "70016808", "CreationDate": "2021-11-18T08:28:07.003", "Score": "1", "ViewCount": "1341", "Body": "<p>I am trying to create a dynamodb table and lambda trigger using Terraform. This is how I define the table, role policy and lambda trigger:</p>\n<pre><code>resource &quot;aws_dynamodb_table&quot; &quot;filenames&quot; {\n  name           = local.dynamodb_table_filenames\n  billing_mode   = &quot;PROVISIONED&quot;\n  read_capacity  = 1000\n  write_capacity = 1000\n  hash_key       = &quot;filename&quot;\n  stream_enabled = true\n  stream_view_type = &quot;NEW_IMAGE&quot;\n\n  #range_key      = &quot;&quot;\n\n  attribute {\n    name = &quot;filename&quot;\n    type = &quot;S&quot;\n  }\n\n  tags = var.tags\n}\n\nresource &quot;aws_iam_role_policy&quot; &quot;dynamodb_policy&quot; {\n  policy = jsonencode(\n  {\n    Version: &quot;2012-10-17&quot;,\n    Statement: [\n      {\n        Action: [\n          &quot;dynamodb:GetItem&quot;,\n          &quot;dynamodb:PutItem&quot;,\n          &quot;dynamodb:UpdateItem&quot;,\n          &quot;dynamodb:Query&quot;,\n          &quot;dynamodb:GetRecords&quot;,\n          &quot;dynamodb:GetShardIterator&quot;,\n          &quot;dynamodb:DescribeStream&quot;,\n          &quot;dynamodb:ListShards&quot;,\n          &quot;dynamodb:ListStreams&quot;,\n        ],\n        Effect: &quot;Allow&quot;,\n        Resource: aws_dynamodb_table.filenames.arn\n      }\n    ]\n  }\n  )\n  role = aws_iam_role.processing_lambda_role.id\n}\n\nresource &quot;aws_lambda_event_source_mapping&quot; &quot;allow_dynamodb_table_to_trigger_lambda&quot; {\n  event_source_arn  = aws_dynamodb_table.filenames.stream_arn\n  function_name     = aws_lambda_function.trigger_stepfunction_lambda.arn\n  starting_position = &quot;LATEST&quot;\n}\n</code></pre>\n<p>I am getting this error even though I have already added the relevant policies added in the role:</p>\n<pre><code>error creating Lambda Event Source Mapping (arn:aws:dynamodb:eu-central-12:table/tablename/stream): InvalidParameterValueException: Cannot access stream arn:aws:dynamodb:eu-central-1:299093934558:table/4tablename/stream. Please ensure the role can perform the GetRecords, GetShardIterator, DescribeStream, ListShards, and ListStreams Actions on your stream in IAM.\n</code></pre>\n<p>How can I fix this?</p>\n", "OwnerDisplayName": "user13067694", "LastActivityDate": "2021-11-18T08:38:34.697", "Title": "InvalidParameterValueException: Cannot access stream", "Tags": "<amazon-web-services><aws-lambda><amazon-dynamodb><terraform><terraform-provider-aws>", "AnswerCount": "1", "CommentCount": "0", "ContentLicense": "CC BY-SA 4.0", "history": [{"Id": "258238428", "PostHistoryTypeId": "2", "PostId": "70016674", "RevisionGUID": "2cd7265d-07f6-48cf-950f-360a99d4ecc3", "CreationDate": "2021-11-18T08:28:07.003", "UserDisplayName": "user13067694", "Text": "I am trying to create a dynamodb table and lambda trigger using Terraform. This is how I define the table, role policy and lambda trigger:\r\n```\r\nresource \"aws_dynamodb_table\" \"filenames\" {\r\n  name           = local.dynamodb_table_filenames\r\n  billing_mode   = \"PROVISIONED\"\r\n  read_capacity  = 1000\r\n  write_capacity = 1000\r\n  hash_key       = \"filename\"\r\n  stream_enabled = true\r\n  stream_view_type = \"NEW_IMAGE\"\r\n\r\n  #range_key      = \"\"\r\n\r\n  attribute {\r\n    name = \"filename\"\r\n    type = \"S\"\r\n  }\r\n\r\n  tags = var.tags\r\n}\r\n\r\nresource \"aws_iam_role_policy\" \"dynamodb_policy\" {\r\n  policy = jsonencode(\r\n  {\r\n    Version: \"2012-10-17\",\r\n    Statement: [\r\n      {\r\n        Action: [\r\n          \"dynamodb:GetItem\",\r\n          \"dynamodb:PutItem\",\r\n          \"dynamodb:UpdateItem\",\r\n          \"dynamodb:Query\",\r\n          \"dynamodb:GetRecords\",\r\n          \"dynamodb:GetShardIterator\",\r\n          \"dynamodb:DescribeStream\",\r\n          \"dynamodb:ListShards\",\r\n          \"dynamodb:ListStreams\",\r\n        ],\r\n        Effect: \"Allow\",\r\n        Resource: aws_dynamodb_table.filenames.arn\r\n      }\r\n    ]\r\n  }\r\n  )\r\n  role = aws_iam_role.processing_lambda_role.id\r\n}\r\n\r\nresource \"aws_lambda_event_source_mapping\" \"allow_dynamodb_table_to_trigger_lambda\" {\r\n  event_source_arn  = aws_dynamodb_table.filenames.stream_arn\r\n  function_name     = aws_lambda_function.trigger_stepfunction_lambda.arn\r\n  starting_position = \"LATEST\"\r\n}\r\n```\r\nI am getting this error even though I have already added the relevant policies added in the role:\r\n```\r\nerror creating Lambda Event Source Mapping (arn:aws:dynamodb:eu-central-12:table/tablename/stream): InvalidParameterValueException: Cannot access stream arn:aws:dynamodb:eu-central-1:299093934558:table/4tablename/stream. Please ensure the role can perform the GetRecords, GetShardIterator, DescribeStream, ListShards, and ListStreams Actions on your stream in IAM.\r\n```\r\nHow can I fix this?", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "This is how I define the table, role policy and lambda trigger: ``` resource \"aws_dynamodb_table\" \"filenames\" { name = local.dynamodb_table_filenames billing_mode = \"PROVISIONED\" read_capacity = 1000 write_capacity = 1000 hash_key = \"filename\" stream_enabled = true stream_view_type = \"NEW_IMAGE\" #range_key = \"\" attribute { name = \"filename\" type = \"S\" } tags = var.tags } resource \"aws_iam_role_policy\" \"dynamodb_policy\" { policy = jsonencode( { Version: \"2012-10-17\", Statement: [ { Action: [ \"dynamodb:GetItem\", \"dynamodb:PutItem\", \"dynamodb:UpdateItem\", \"dynamodb:Query\", \"dynamodb:GetRecords\", \"dynamodb:GetShardIterator\", \"dynamodb:DescribeStream\", \"dynamodb:ListShards\", \"dynamodb:ListStreams\", ], Effect: \"Allow\", Resource: aws_dynamodb_table.filenames.arn } ] } ) role = aws_iam_role.processing_lambda_role.id } resource \"aws_lambda_event_source_mapping\" \"allow_dynamodb_table_to_trigger_lambda\" { event_source_arn = aws_dynamodb_table.filenames.stream_arn function_name = aws_lambda_function.trigger_stepfunction_lambda.arn starting_position = \"LATEST\" } ``` I am getting this error even though I have already added the relevant policies added in the role: ``` error creating Lambda Event Source Mapping (arn:aws:dynamodb:eu-central-12:table/tablename/stream): InvalidParameterValueException: Cannot access stream arn:aws:dynamodb:eu-central-1:299093934558:table/4tablename/stream. ", "keywords": ["bill", "policy"]}]}, {"Id": "258238430", "PostHistoryTypeId": "1", "PostId": "70016674", "RevisionGUID": "2cd7265d-07f6-48cf-950f-360a99d4ecc3", "CreationDate": "2021-11-18T08:28:07.003", "UserDisplayName": "user13067694", "Text": "InvalidParameterValueException: Cannot access stream", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "258238431", "PostHistoryTypeId": "3", "PostId": "70016674", "RevisionGUID": "2cd7265d-07f6-48cf-950f-360a99d4ecc3", "CreationDate": "2021-11-18T08:28:07.003", "UserDisplayName": "user13067694", "Text": "<amazon-web-services><aws-lambda><amazon-dynamodb><terraform><terraform-provider-aws>", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "answers": [{"Id": "70016808", "PostTypeId": "2", "ParentId": "70016674", "CreationDate": "2021-11-18T08:38:34.697", "Score": "2", "Body": "<p>The stream actions apply to streams, not to tables. The ARN for stream has the <a href=\"https://docs.aws.amazon.com/service-authorization/latest/reference/list_amazondynamodb.html#amazondynamodb-stream\" rel=\"nofollow noreferrer\">form</a> of:</p>\n<pre><code>arn:${Partition}:dynamodb:${Region}:${Account}:table/${TableName}/stream/${StreamLabel}\n</code></pre>\n<p>Thus, you should use (or something equivalent):</p>\n<pre><code>Resource: &quot;${aws_dynamodb_table.filenames.arn}/stream/*&quot;\n</code></pre>\n<p>or more general:</p>\n<pre><code>Resource: &quot;${aws_dynamodb_table.filenames.arn}/*&quot;\n</code></pre>\n", "OwnerUserId": "248823", "LastActivityDate": "2021-11-18T08:38:34.697", "CommentCount": "1", "ContentLicense": "CC BY-SA 4.0", "comments": [{"Id": "135164137", "PostId": "70016808", "Score": "0", "Text": "You're a genius, thank you!", "CreationDate": "2023-07-11T18:00:42.513", "UserId": "7199362", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "history": [{"Id": "258239131", "PostHistoryTypeId": "2", "PostId": "70016808", "RevisionGUID": "9eee1751-af2c-4ab2-980f-c2db774fb3e3", "CreationDate": "2021-11-18T08:38:34.697", "UserId": "248823", "Text": "The stream actions apply to streams, not to tables. The ARN for stream has the [form][1] of:\r\n\r\n```\r\narn:${Partition}:dynamodb:${Region}:${Account}:table/${TableName}/stream/${StreamLabel}\r\n```\r\n\r\nThus, you should use (or something equivalent):\r\n\r\n```\r\nResource: \"${aws_dynamodb_table.filenames.arn}/stream/*\"\r\n```\r\n\r\nor more general:\r\n\r\n```\r\nResource: \"${aws_dynamodb_table.filenames.arn}/*\"\r\n```\r\n\r\n\r\n\r\n  [1]: https://docs.aws.amazon.com/service-authorization/latest/reference/list_amazondynamodb.html#amazondynamodb-stream", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "filtered-sentences": []}], "contains-topic": true, "filtered-sentences": [{"source": "Body", "text": "This is how I define the table, role policy and lambda trigger: I am getting this error even though I have already added the relevant policies added in the role: How can I fix this?", "keywords": ["policy"]}]}