{"Id": "75568737", "PostTypeId": "1", "CreationDate": "2023-02-25T22:01:58.263", "Score": "0", "ViewCount": "76", "Body": "<p>I need help and I am sure it is something trivial but after 1 hour I tend to ask the experts.</p>\n<p>When using the TF Module <a href=\"https://registry.terraform.io/modules/terraform-google-modules/project-factory/google/latest\" rel=\"nofollow noreferrer\">GCP project-factory</a> and assigning the variable host_project_id for shared VPC setup the TF apply fails with the following IAM permission error:</p>\n<blockquote>\n<p>Error: Request <code>Create IAM Members roles/compute.networkUser serviceAccount:project-service-account@proj-dev1-compute-b226.iam.gserviceaccount.com for project &quot;projects/shared-network-b8d5/global/networks/development-vpc&quot;</code> returned error: Batch request and retried single request &quot;Create IAM Members roles/compute.networkUser serviceAccount:project-service-account@proj-dev1-compute-b226.iam.gserviceaccount.com for project &quot;projects/shared-network-b8d5/global/networks/development-vpc&quot;&quot; both failed. Final error: Error retrieving IAM policy for project &quot;projects/shared-network-b8d5/global/networks/development-vpc&quot;: googleapi: Error 403: The caller does not have permission, forbidden</p>\n</blockquote>\n<p>There is 3 more IAM errors but they are similar. The TF block that fails is as follows:</p>\n<pre><code>module &quot;dev1-compute&quot; {\n  source                  = &quot;terraform-google-modules/project-factory/google&quot;\n  version                 = &quot;~&gt; 14.0&quot;\n  random_project_id       = true\n  name                    = &quot;proj-dev1-compute&quot;\n  folder_id               = data.terraform_remote_state.gcp-core.outputs.folders_map[&quot;development&quot;].name\n  org_id                  = var.organization_id\n  billing_account         = var.billing_account\n  default_service_account = &quot;deprivilege&quot;\n  svpc_host_project_id    = data.terraform_remote_state.gcp-core.outputs.network_id   //assign host project to this service project\n  activate_apis = [\n    &quot;compute.googleapis.com&quot;,\n    &quot;container.googleapis.com&quot;,\n    &quot;iam.googleapis.com&quot;\n  ]\n}\n</code></pre>\n<p>network_id = projects/shared-network-b8d5/global/networks/development-vpc\nDefault service account name exists</p>\n<p>My understanding is from the module creation documentation that if var.svpc_host_project_id is set but no subnetworks are provided via var.shared_vpc_subnets then the compute.networkUser role is assigned at the host project and the service project will have access to all shared VPC subnetworks.</p>\n<p>My reading of the above error message is this assignment does not work because of IAM permissions which the caller does not have = my TF automation account I use.  (<em>right</em>?!)</p>\n<p>However: My TF automation account which sits at the Org level (my test org...) has:\nCompute Network Admin\nCompute Network User\nCompute Shared VPC Admin\nFolder Admin\nNetwork Management Admin\nOrganization Administrator\nOwner\nProject Creator\nSecurity Admin</p>\n<p><strong>Update:</strong>\nOk before going to bed I realised this might be a misunderstanding how TF Cloud works. I setup the folders and the HOST VPC project (GCP project in itself) in one workspace and the above code is in another workspace. I suspect project creation and Shared VPC assignments cannot be done between two workspaces and I need to create the project and host VPC in one workspace... ?</p>\n", "OwnerUserId": "21244132", "LastEditorUserId": "21244132", "LastEditDate": "2023-02-25T22:06:33.000", "LastActivityDate": "2023-02-25T22:06:33.000", "Title": "IAM permission error with Google Project Factory Module when trying to use Shared VPC on Service Project", "Tags": "<google-cloud-platform><terraform-provider-gcp>", "AnswerCount": "0", "CommentCount": "0", "ContentLicense": "CC BY-SA 4.0", "history": [{"Id": "288747628", "PostHistoryTypeId": "2", "PostId": "75568737", "RevisionGUID": "9af1638d-6ef7-49ca-badc-cb1cbb1ca205", "CreationDate": "2023-02-25T22:01:58.263", "UserId": "21244132", "Text": "I need help and I am sure it is something trivial but after 1 hour I tend to ask the experts.\r\n\r\nWhen using the TF Module [GCP project-factory](https://registry.terraform.io/modules/terraform-google-modules/project-factory/google/latest) and assigning the variable host_project_id for shared VPC setup the TF apply fails with the following IAM permission error:\r\n> Error: Request `Create IAM Members roles/compute.networkUser serviceAccount:project-service-account@proj-dev1-compute-b226.iam.gserviceaccount.com for project \"projects/shared-network-b8d5/global/networks/development-vpc\"` returned error: Batch request and retried single request \"Create IAM Members roles/compute.networkUser serviceAccount:project-service-account@proj-dev1-compute-b226.iam.gserviceaccount.com for project \\\"projects/shared-network-b8d5/global/networks/development-vpc\\\"\" both failed. Final error: Error retrieving IAM policy for project \"projects/shared-network-b8d5/global/networks/development-vpc\": googleapi: Error 403: The caller does not have permission, forbidden\r\n\r\nThere is 3 more IAM errors but they are similar. The TF block that fails is as follows:\r\n```\r\nmodule \"dev1-compute\" {\r\n  source                  = \"terraform-google-modules/project-factory/google\"\r\n  version                 = \"~> 14.0\"\r\n  random_project_id       = true\r\n  name                    = \"proj-dev1-compute\"\r\n  folder_id               = data.terraform_remote_state.gcp-core.outputs.folders_map[\"development\"].name\r\n  org_id                  = var.organization_id\r\n  billing_account         = var.billing_account\r\n  default_service_account = \"deprivilege\"\r\n  svpc_host_project_id    = data.terraform_remote_state.gcp-core.outputs.network_id   //assign host project to this service project\r\n  activate_apis = [\r\n    \"compute.googleapis.com\",\r\n    \"container.googleapis.com\",\r\n    \"iam.googleapis.com\"\r\n  ]\r\n}\r\n```\r\nnetwork_id = projects/shared-network-b8d5/global/networks/development-vpc\r\nDefault service account name exists\r\n\r\nMy understanding is from the module creation documentation that if var.svpc_host_project_id is set but no subnetworks are provided via var.shared_vpc_subnets then the compute.networkUser role is assigned at the host project and the service project will have access to all shared VPC subnetworks.\r\n\r\nMy reading of the above error message is this assignment does not work because of IAM permissions which the caller does not have = my TF automation account I use.  (*right*?!)\r\n\r\nHowever: My TF automation account which sits at the Org level (my test org...) has:\r\nCompute Network Admin\r\nCompute Network User\r\nCompute Shared VPC Admin\r\nFolder Admin\r\nNetwork Management Admin\r\nOrganization Administrator\r\nOwner\r\nProject Creator\r\nSecurity Admin\r\n", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "Final error: Error retrieving IAM policy for project \"projects/shared-network-b8d5/global/networks/development-vpc\": googleapi: Error 403: The caller does not have permission, forbidden ", "keywords": ["policy"]}, {"source": "Text", "text": "The TF block that fails is as follows: ``` module \"dev1-compute\" { source = \"terraform-google-modules/project-factory/google\" version = \"~> 14.0\" random_project_id = true name = \"proj-dev1-compute\" folder_id = data.terraform_remote_state.gcp-core.outputs.folders_map[\"development\"].name org_id = var.organization_id billing_account = var.billing_account default_service_account = \"deprivilege\" svpc_host_project_id = data.terraform_remote_state.gcp-core.outputs.network_id //assign host project to this service project activate_apis = [ \"compute.googleapis.com\", \"container.googleapis.com\", \"iam.googleapis.com\" ] } ``` network_id = projects/shared-network-b8d5/global/networks/development-vpc Default service account name exists ", "keywords": ["bill"]}, {"source": "Text", "text": "However: My TF automation account which sits at the Org level (my test org...) has: Compute Network Admin Compute Network User Compute Shared VPC Admin Folder Admin Network Management Admin Organization Administrator Owner Project Creator Security Admin", "keywords": ["test"]}]}, {"Id": "288747630", "PostHistoryTypeId": "1", "PostId": "75568737", "RevisionGUID": "9af1638d-6ef7-49ca-badc-cb1cbb1ca205", "CreationDate": "2023-02-25T22:01:58.263", "UserId": "21244132", "Text": "IAM permission error with Google Project Factory Module when trying to use Shared VPC on Service Project", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "288747631", "PostHistoryTypeId": "3", "PostId": "75568737", "RevisionGUID": "9af1638d-6ef7-49ca-badc-cb1cbb1ca205", "CreationDate": "2023-02-25T22:01:58.263", "UserId": "21244132", "Text": "<google-cloud-platform><terraform-provider-gcp>", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "288747632", "PostHistoryTypeId": "66", "PostId": "75568737", "RevisionGUID": "9af1638d-6ef7-49ca-badc-cb1cbb1ca205", "CreationDate": "2023-02-25T22:01:58.263", "UserId": "21244132", "filtered-sentences": []}, {"Id": "288747735", "PostHistoryTypeId": "5", "PostId": "75568737", "RevisionGUID": "bd072923-0829-4fff-b2d7-797fc6a17419", "CreationDate": "2023-02-25T22:06:33.000", "UserId": "21244132", "Comment": "added 391 characters in body", "Text": "I need help and I am sure it is something trivial but after 1 hour I tend to ask the experts.\r\n\r\nWhen using the TF Module [GCP project-factory](https://registry.terraform.io/modules/terraform-google-modules/project-factory/google/latest) and assigning the variable host_project_id for shared VPC setup the TF apply fails with the following IAM permission error:\r\n> Error: Request `Create IAM Members roles/compute.networkUser serviceAccount:project-service-account@proj-dev1-compute-b226.iam.gserviceaccount.com for project \"projects/shared-network-b8d5/global/networks/development-vpc\"` returned error: Batch request and retried single request \"Create IAM Members roles/compute.networkUser serviceAccount:project-service-account@proj-dev1-compute-b226.iam.gserviceaccount.com for project \\\"projects/shared-network-b8d5/global/networks/development-vpc\\\"\" both failed. Final error: Error retrieving IAM policy for project \"projects/shared-network-b8d5/global/networks/development-vpc\": googleapi: Error 403: The caller does not have permission, forbidden\r\n\r\nThere is 3 more IAM errors but they are similar. The TF block that fails is as follows:\r\n```\r\nmodule \"dev1-compute\" {\r\n  source                  = \"terraform-google-modules/project-factory/google\"\r\n  version                 = \"~> 14.0\"\r\n  random_project_id       = true\r\n  name                    = \"proj-dev1-compute\"\r\n  folder_id               = data.terraform_remote_state.gcp-core.outputs.folders_map[\"development\"].name\r\n  org_id                  = var.organization_id\r\n  billing_account         = var.billing_account\r\n  default_service_account = \"deprivilege\"\r\n  svpc_host_project_id    = data.terraform_remote_state.gcp-core.outputs.network_id   //assign host project to this service project\r\n  activate_apis = [\r\n    \"compute.googleapis.com\",\r\n    \"container.googleapis.com\",\r\n    \"iam.googleapis.com\"\r\n  ]\r\n}\r\n```\r\nnetwork_id = projects/shared-network-b8d5/global/networks/development-vpc\r\nDefault service account name exists\r\n\r\nMy understanding is from the module creation documentation that if var.svpc_host_project_id is set but no subnetworks are provided via var.shared_vpc_subnets then the compute.networkUser role is assigned at the host project and the service project will have access to all shared VPC subnetworks.\r\n\r\nMy reading of the above error message is this assignment does not work because of IAM permissions which the caller does not have = my TF automation account I use.  (*right*?!)\r\n\r\nHowever: My TF automation account which sits at the Org level (my test org...) has:\r\nCompute Network Admin\r\nCompute Network User\r\nCompute Shared VPC Admin\r\nFolder Admin\r\nNetwork Management Admin\r\nOrganization Administrator\r\nOwner\r\nProject Creator\r\nSecurity Admin\r\n\r\n**Update:**\r\nOk before going to bed I realised this might be a misunderstanding how TF Cloud works. I setup the folders and the HOST VPC project (GCP project in itself) in one workspace and the above code is in another workspace. I suspect project creation and Shared VPC assignments cannot be done between two workspaces and I need to create the project and host VPC in one workspace... ?", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "Final error: Error retrieving IAM policy for project \"projects/shared-network-b8d5/global/networks/development-vpc\": googleapi: Error 403: The caller does not have permission, forbidden ", "keywords": ["policy"]}, {"source": "Text", "text": "The TF block that fails is as follows: ``` module \"dev1-compute\" { source = \"terraform-google-modules/project-factory/google\" version = \"~> 14.0\" random_project_id = true name = \"proj-dev1-compute\" folder_id = data.terraform_remote_state.gcp-core.outputs.folders_map[\"development\"].name org_id = var.organization_id billing_account = var.billing_account default_service_account = \"deprivilege\" svpc_host_project_id = data.terraform_remote_state.gcp-core.outputs.network_id //assign host project to this service project activate_apis = [ \"compute.googleapis.com\", \"container.googleapis.com\", \"iam.googleapis.com\" ] } ``` network_id = projects/shared-network-b8d5/global/networks/development-vpc Default service account name exists ", "keywords": ["bill"]}, {"source": "Text", "text": "However: My TF automation account which sits at the Org level (my test org...) has: Compute Network Admin Compute Network User Compute Shared VPC Admin Folder Admin Network Management Admin Organization Administrator Owner Project Creator Security Admin **Update:** Ok before going to bed I realised this might be a misunderstanding how TF Cloud works. ", "keywords": ["test"]}]}], "contains-topic": true, "filtered-sentences": [{"source": "Body", "text": "Final error: Error retrieving IAM policy for project \"projects/shared-network-b8d5/global/networks/development-vpc\": googleapi: Error 403: ", "keywords": ["policy"]}, {"source": "Body", "text": "However: My TF automation account which sits at the Org level (my test org...) has: Compute Network Admin Compute Network User Compute Shared VPC Admin Folder Admin Network Management Admin Organization Administrator Owner Project Creator Security Admin Update: Ok before going to bed I realised this might be a misunderstanding how TF Cloud works. ", "keywords": ["test"]}]}