{"Id": "76412105", "PostTypeId": "1", "AcceptedAnswerId": "76414625", "CreationDate": "2023-06-06T06:53:06.263", "Score": "0", "ViewCount": "59", "Body": "<p>I have an elastic beanstalk(EB) app setup in a private subnet in my current VPC. I want to have an API REST Gateway that will forward the traffic to elastic beanstalk(EB) app via an VPC_LINK as lambda is too expensive and all i need is proxy the traffic.</p>\n<p>NLB targeting EB ALB</p>\n<pre><code>module &quot;nlb&quot; {\n  source  = &quot;terraform-aws-modules/alb/aws&quot;\n  version = &quot;~&gt; 6.0&quot;\n    \n  name = &quot;${var.eb_env_name}-${var.environment}-internal-nlb&quot;\n    \n  load_balancer_type = &quot;network&quot;\n  internal           = true\n  \n  vpc_id  = module.vpc.vpc_id\n  subnets = module.vpc.private_subnets\n  access_logs = {\n    bucket = &quot;${var.eb_env_name}-${var.environment}-internal-nlb-logs&quot;\n  }\n    \n  target_groups = [\n    {\n      name             = &quot;${var.eb_env_name}-${var.environment}-internal-tg&quot;\n      backend_protocol = &quot;TCP&quot;\n      backend_port     = 80\n      target_type      = &quot;alb&quot;\n      health_check = {\n        enabled             = true\n        interval            = 30\n        path                = &quot;/health&quot;\n        port                = &quot;traffic-port&quot;\n        healthy_threshold   = 3\n        unhealthy_threshold = 3\n        timeout             = 6\n      }\n      targets = [\n        {\n          target_id = aws_elastic_beanstalk_environment.eb_env.load_balancers[0]\n          port      = 80\n        }\n      ]\n    }\n  ]\n    \n  http_tcp_listeners = [\n    {\n       port               = 80\n       protocol           = &quot;TCP&quot;\n       target_group_index = 0\n    }\n  ]\n}\n</code></pre>\n<p>VPC LINK</p>\n<pre><code>resource &quot;aws_api_gateway_vpc_link&quot; &quot;eb_vpc_link&quot; {\n  name        = &quot;${var.eb_app_name}-vpc-link&quot;\n  target_arns = [module.nlb.lb_arn]\n}\n</code></pre>\n<p>API Gateway integration</p>\n<pre><code>resource &quot;aws_api_gateway_integration&quot; &quot;rest_api_get_destinationId_method_integration&quot; {\n  rest_api_id = aws_api_gateway_rest_api.rest_api.id\n  resource_id = aws_api_gateway_resource.rest_api_destinationId_resource.id\n  http_method = aws_api_gateway_method.rest_api_destination_get_method.http_method\n  integration_http_method = &quot;POST&quot;\n  type                    = &quot;AWS_PROXY&quot;\n  uri                     = module.nlb.http_tcp_listener_arns[0]\n  connection_type         = &quot;VPC_LINK&quot;\n  connection_id           = aws_api_gateway_vpc_link.eb_vpc_link.id\n //request_tempates is required to explicitly set the statusCode to an integer value of 200\n  request_templates = {\n    &quot;application/json&quot; = jsonencode({\n       statusCode = 200\n    })\n  }\n    \n  depends_on = [\n    aws_api_gateway_resource.rest_api_destinationId_resource,\n    aws_api_gateway_resource.rest_api_destination_resource, \n    aws_api_gateway_method.rest_api_destination_get_method,\n     aws_api_gateway_vpc_link.eb_vpc_link\n  ]\n}\n</code></pre>\n<p>I keep getting the following error message.</p>\n<blockquote>\n<p>Creating API Gateway Integration: BadRequestException: AWS ARN for integration must contain path or action</p>\n</blockquote>\n<p>The aws_api_gateway_integration above should point to <code>/destination/{destinationId}</code></p>\n", "OwnerUserId": "2650277", "LastEditorUserId": "8343484", "LastEditDate": "2023-06-06T12:28:36.227", "LastActivityDate": "2023-06-08T10:34:54.693", "Title": "API Gateway integration to an elastic beanstalk app with a VPC_LINK fails with AWS ARN for integration must contain path or action", "Tags": "<amazon-web-services><terraform><amazon-elastic-beanstalk><aws-api-gateway><terraform-provider-aws>", "AnswerCount": "1", "CommentCount": "0", "ContentLicense": "CC BY-SA 4.0", "history": [{"Id": "293788032", "PostHistoryTypeId": "2", "PostId": "76412105", "RevisionGUID": "3250d583-bd8d-464e-8e2e-2d208bc222d7", "CreationDate": "2023-06-06T06:53:06.263", "UserId": "2650277", "Text": "I have an elastic beanstalk(EB) app setup in a private subnet in my current VPC. I want to have an API REST Gateway that will forward the traffic to elastic beanstalk(EB) app via an VPC_LINK as lambda is too expensive and all i need is proxy the traffic.\r\n\r\nNLB targeting EB ALB\r\n\r\n    module \"nlb\" {\r\n      source  = \"terraform-aws-modules/alb/aws\"\r\n      version = \"~> 6.0\"\r\n    \r\n      name = \"${var.eb_env_name}-${var.environment}-internal-nlb\"\r\n    \r\n      load_balancer_type = \"network\"\r\n      internal           = true\r\n    \r\n      vpc_id  = module.vpc.vpc_id\r\n      subnets = module.vpc.private_subnets\r\n      access_logs = {\r\n        bucket = \"${var.eb_env_name}-${var.environment}-internal-nlb-logs\"\r\n      }\r\n    \r\n      target_groups = [\r\n        {\r\n          name             = \"${var.eb_env_name}-${var.environment}-internal-tg\"\r\n          backend_protocol = \"TCP\"\r\n          backend_port     = 80\r\n          target_type      = \"alb\"\r\n          health_check = {\r\n            enabled             = true\r\n            interval            = 30\r\n            path                = \"/health\"\r\n            port                = \"traffic-port\"\r\n            healthy_threshold   = 3\r\n            unhealthy_threshold = 3\r\n            timeout             = 6\r\n          }\r\n          targets = [\r\n            {\r\n              target_id = aws_elastic_beanstalk_environment.eb_env.load_balancers[0]\r\n              port      = 80\r\n            }\r\n          ]\r\n        }\r\n      ]\r\n    \r\n      http_tcp_listeners = [\r\n        {\r\n          port               = 80\r\n          protocol           = \"TCP\"\r\n          target_group_index = 0\r\n        }\r\n      ]\r\n    }\r\n\r\nVPC LINK\r\n\r\n    resource \"aws_api_gateway_vpc_link\" \"eb_vpc_link\" {\r\n      name        = \"${var.eb_app_name}-vpc-link\"\r\n      target_arns = [module.nlb.lb_arn]\r\n    }\r\n\r\nAPI Gateway integration\r\n\r\n    resource \"aws_api_gateway_integration\" \"rest_api_get_destinationId_method_integration\" {\r\n      rest_api_id = aws_api_gateway_rest_api.rest_api.id\r\n      resource_id = aws_api_gateway_resource.rest_api_destinationId_resource.id\r\n      http_method = aws_api_gateway_method.rest_api_destination_get_method.http_method\r\n      integration_http_method = \"POST\"\r\n      type                    = \"AWS_PROXY\"\r\n      uri                     = module.nlb.http_tcp_listener_arns[0]\r\n      connection_type         = \"VPC_LINK\"\r\n      connection_id           = aws_api_gateway_vpc_link.eb_vpc_link.id\r\n      //request_tempates is required to explicitly set the statusCode to an integer value of 200\r\n      request_templates = {\r\n        \"application/json\" = jsonencode({\r\n          statusCode = 200\r\n        })\r\n      }\r\n    \r\n       depends_on = [\r\n        aws_api_gateway_resource.rest_api_destinationId_resource,\r\n        aws_api_gateway_resource.rest_api_destination_resource, \r\n        aws_api_gateway_method.rest_api_destination_get_method,\r\n        aws_api_gateway_vpc_link.eb_vpc_link\r\n      ]\r\n    }\r\n\r\n\r\nI keep getting the following error message.\r\n\r\n    Creating API Gateway Integration: BadRequestException: AWS ARN for integration must contain path or action\r\n\r\nThe aws_api_gateway_integration above should point to `/destination/{destinationId}`", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "I want to have an API REST Gateway that will forward the traffic to elastic beanstalk(EB) app via an VPC_LINK as lambda is too expensive and all i need is proxy the traffic. ", "keywords": ["expense"]}]}, {"Id": "293788034", "PostHistoryTypeId": "1", "PostId": "76412105", "RevisionGUID": "3250d583-bd8d-464e-8e2e-2d208bc222d7", "CreationDate": "2023-06-06T06:53:06.263", "UserId": "2650277", "Text": "API Gateway integration to an elastic beanstalk app with a VPC_LINK fails with AWS ARN for integration must contain path or action", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "293788035", "PostHistoryTypeId": "3", "PostId": "76412105", "RevisionGUID": "3250d583-bd8d-464e-8e2e-2d208bc222d7", "CreationDate": "2023-06-06T06:53:06.263", "UserId": "2650277", "Text": "<amazon-web-services><terraform><amazon-elastic-beanstalk><aws-api-gateway>", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "293801915", "PostHistoryTypeId": "5", "PostId": "76412105", "RevisionGUID": "8adb15fc-1cba-4d90-af4d-92ade3c2983f", "CreationDate": "2023-06-06T12:28:36.227", "UserId": "8343484", "Comment": "deleted 234 characters in body; edited tags", "Text": "I have an elastic beanstalk(EB) app setup in a private subnet in my current VPC. I want to have an API REST Gateway that will forward the traffic to elastic beanstalk(EB) app via an VPC_LINK as lambda is too expensive and all i need is proxy the traffic.\r\n\r\nNLB targeting EB ALB\r\n\r\n```hcl\r\nmodule \"nlb\" {\r\n  source  = \"terraform-aws-modules/alb/aws\"\r\n  version = \"~> 6.0\"\r\n    \r\n  name = \"${var.eb_env_name}-${var.environment}-internal-nlb\"\r\n    \r\n  load_balancer_type = \"network\"\r\n  internal           = true\r\n  \r\n  vpc_id  = module.vpc.vpc_id\r\n  subnets = module.vpc.private_subnets\r\n  access_logs = {\r\n    bucket = \"${var.eb_env_name}-${var.environment}-internal-nlb-logs\"\r\n  }\r\n    \r\n  target_groups = [\r\n    {\r\n      name             = \"${var.eb_env_name}-${var.environment}-internal-tg\"\r\n      backend_protocol = \"TCP\"\r\n      backend_port     = 80\r\n      target_type      = \"alb\"\r\n      health_check = {\r\n        enabled             = true\r\n        interval            = 30\r\n        path                = \"/health\"\r\n        port                = \"traffic-port\"\r\n        healthy_threshold   = 3\r\n        unhealthy_threshold = 3\r\n        timeout             = 6\r\n      }\r\n      targets = [\r\n        {\r\n          target_id = aws_elastic_beanstalk_environment.eb_env.load_balancers[0]\r\n          port      = 80\r\n        }\r\n      ]\r\n    }\r\n  ]\r\n    \r\n  http_tcp_listeners = [\r\n    {\r\n       port               = 80\r\n       protocol           = \"TCP\"\r\n       target_group_index = 0\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\nVPC LINK\r\n\r\n```hcl\r\nresource \"aws_api_gateway_vpc_link\" \"eb_vpc_link\" {\r\n  name        = \"${var.eb_app_name}-vpc-link\"\r\n  target_arns = [module.nlb.lb_arn]\r\n}\r\n```\r\n\r\nAPI Gateway integration\r\n\r\n```hcl\r\nresource \"aws_api_gateway_integration\" \"rest_api_get_destinationId_method_integration\" {\r\n  rest_api_id = aws_api_gateway_rest_api.rest_api.id\r\n  resource_id = aws_api_gateway_resource.rest_api_destinationId_resource.id\r\n  http_method = aws_api_gateway_method.rest_api_destination_get_method.http_method\r\n  integration_http_method = \"POST\"\r\n  type                    = \"AWS_PROXY\"\r\n  uri                     = module.nlb.http_tcp_listener_arns[0]\r\n  connection_type         = \"VPC_LINK\"\r\n  connection_id           = aws_api_gateway_vpc_link.eb_vpc_link.id\r\n //request_tempates is required to explicitly set the statusCode to an integer value of 200\r\n  request_templates = {\r\n    \"application/json\" = jsonencode({\r\n       statusCode = 200\r\n    })\r\n  }\r\n    \r\n  depends_on = [\r\n    aws_api_gateway_resource.rest_api_destinationId_resource,\r\n    aws_api_gateway_resource.rest_api_destination_resource, \r\n    aws_api_gateway_method.rest_api_destination_get_method,\r\n     aws_api_gateway_vpc_link.eb_vpc_link\r\n  ]\r\n}\r\n```\r\n\r\n\r\nI keep getting the following error message.\r\n\r\n> Creating API Gateway Integration: BadRequestException: AWS ARN for integration must contain path or action\r\n\r\nThe aws_api_gateway_integration above should point to `/destination/{destinationId}`", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "I want to have an API REST Gateway that will forward the traffic to elastic beanstalk(EB) app via an VPC_LINK as lambda is too expensive and all i need is proxy the traffic. ", "keywords": ["expense"]}]}, {"Id": "293801916", "PostHistoryTypeId": "6", "PostId": "76412105", "RevisionGUID": "8adb15fc-1cba-4d90-af4d-92ade3c2983f", "CreationDate": "2023-06-06T12:28:36.227", "UserId": "8343484", "Comment": "deleted 234 characters in body; edited tags", "Text": "<amazon-web-services><terraform><amazon-elastic-beanstalk><aws-api-gateway><terraform-provider-aws>", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "answers": [{"Id": "76414625", "PostTypeId": "2", "ParentId": "76412105", "CreationDate": "2023-06-06T12:25:10.800", "Score": "2", "Body": "<p>As per the <a href=\"https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-apitgateway-method-integration.html#cfn-apigateway-method-integration-uri\" rel=\"nofollow noreferrer\">CloudFormation documentation</a>, you need to specify the Network Load Balancer DNS name in the <code>uri</code> argument:</p>\n<blockquote>\n<p><code>Uri</code> Specifies Uniform Resource Identifier (URI) of the integration endpoint. [...] If <code>connectionType</code> is <code>VPC_LINK</code> specify the Network Load Balancer DNS name. [...]</p>\n</blockquote>\n<p>So in your case, that would be:</p>\n<pre><code>uri = module.nlb.lb_dns_name\n</code></pre>\n<p>EDIT: As per the comments, the type should be <code>HTTP_PROXY</code>:</p>\n<pre><code>type = &quot;HTTP_PROXY&quot;\n</code></pre>\n", "OwnerUserId": "8343484", "LastEditorUserId": "8343484", "LastEditDate": "2023-06-08T10:34:54.693", "LastActivityDate": "2023-06-08T10:34:54.693", "CommentCount": "4", "ContentLicense": "CC BY-SA 4.0", "comments": [{"Id": "134747662", "PostId": "76414625", "Score": "0", "Text": "I already tried that , i am getting ` Invalid ARN specified in the request`", "CreationDate": "2023-06-06T16:53:03.750", "UserId": "2650277", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "134756120", "PostId": "76414625", "Score": "0", "Text": "Can you share the full error message after changing the `uri`?", "CreationDate": "2023-06-07T10:07:32.260", "UserId": "8343484", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "Can you share the full error message after changing the `uri`?", "keywords": ["change"]}]}, {"Id": "134770528", "PostId": "76414625", "Score": "0", "Text": "I found the fix, type  should be `HTTP_PROXY` as well", "CreationDate": "2023-06-08T10:33:32.453", "UserId": "2650277", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "134770530", "PostId": "76414625", "Score": "0", "Text": "I'll edit the answer to have that as well.", "CreationDate": "2023-06-08T10:33:53.233", "UserId": "8343484", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "history": [{"Id": "293801804", "PostHistoryTypeId": "2", "PostId": "76414625", "RevisionGUID": "476f0a2b-d32e-4d26-8dbf-01dd5e941c04", "CreationDate": "2023-06-06T12:25:10.800", "UserId": "8343484", "Text": "As per the [CloudFormation documentation][1], you need to specify the Network Load Balancer DNS name in the `uri` argument:\r\n\r\n>  `Uri` Specifies Uniform Resource Identifier (URI) of the integration endpoint. [...] If `connectionType` is `VPC_LINK` specify the Network Load Balancer DNS name. [...]\r\n\r\nSo in your case, that would be:\r\n\r\n```hcl\r\nuri = module.nlb.lb_dns_name\r\n```\r\n\r\n  [1]: https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-apitgateway-method-integration.html#cfn-apigateway-method-integration-uri", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "293893597", "PostHistoryTypeId": "5", "PostId": "76414625", "RevisionGUID": "7780d36c-0b1b-466c-8fb3-2c1db0dc5594", "CreationDate": "2023-06-08T10:34:54.693", "UserId": "8343484", "Comment": "added 102 characters in body", "Text": "As per the [CloudFormation documentation][1], you need to specify the Network Load Balancer DNS name in the `uri` argument:\r\n\r\n>  `Uri` Specifies Uniform Resource Identifier (URI) of the integration endpoint. [...] If `connectionType` is `VPC_LINK` specify the Network Load Balancer DNS name. [...]\r\n\r\nSo in your case, that would be:\r\n\r\n```hcl\r\nuri = module.nlb.lb_dns_name\r\n```\r\n\r\nEDIT: As per the comments, the type should be `HTTP_PROXY`:\r\n \r\n```hcl\r\ntype = \"HTTP_PROXY\"\r\n```\r\n\r\n\r\n  [1]: https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-apitgateway-method-integration.html#cfn-apigateway-method-integration-uri", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "filtered-sentences": []}], "contains-topic": true, "filtered-sentences": [{"source": "Body", "text": "I want to have an API REST Gateway that will forward the traffic to elastic beanstalk(EB) app via an VPC_LINK as lambda is too expensive and all i need is proxy the traffic. ", "keywords": ["expense"]}]}