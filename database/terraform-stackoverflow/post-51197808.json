{"Id": "51197808", "PostTypeId": "1", "AcceptedAnswerId": "51204774", "CreationDate": "2018-07-05T18:30:07.987", "Score": "-1", "ViewCount": "729", "Body": "<p>Most probably I am doing something wrong or missing something here.</p>\n\n<p>This is how my terraform template looks like:</p>\n\n<pre><code>locals {\n      credentials_file_path    = \"~/gcp-auth/account.json\"\n    }\n\nterraform {\n  backend \"gcs\" {\n    bucket  = \"somebucket-tf-state\"\n    prefix  = \"terraform/state/\"\n    credentials = \"~/gcp-auth/account.json\"\n  }\n}\n\nprovider \"google\" {\n region = \"${var.region}\"\n credentials = \"${file(local.credentials_file_path)}\"\n}\n\nmodule \"project\" {\n  source = \"../modules/gcp-project/\"\n  project_name      = \"${var.project_name}\"\n  billing_account = \"${var.billing_account}\"\n  org_id          = \"${var.org_id}\"\n}\n</code></pre>\n\n<p>When I run this for multiple times with different parameters, It overwrites the previous state file.</p>\n\n<p>This is what I see in the bucket:</p>\n\n<pre><code>Buckets/somebucket-tf-state/terraform/state/default.tfstate\n</code></pre>\n\n<p>Is there a way I can create different state files per project I run the template for?</p>\n", "OwnerUserId": "395255", "LastActivityDate": "2020-02-25T23:38:07.640", "Title": "Terraform overwriting state file on remote backend", "Tags": "<google-cloud-platform><terraform><terraform-provider-gcp>", "AnswerCount": "2", "CommentCount": "0", "ContentLicense": "CC BY-SA 4.0", "history": [{"Id": "177000955", "PostHistoryTypeId": "2", "PostId": "51197808", "RevisionGUID": "12f1eb44-af6e-4c06-88a5-194a142335e5", "CreationDate": "2018-07-05T18:30:07.987", "UserId": "395255", "Text": "Most probably I am doing something wrong or missing something here.\r\n\r\nThis is how my terraform template looks like:\r\n\r\n    locals {\r\n          credentials_file_path    = \"~/gcp-auth/account.json\"\r\n        }\r\n    \r\n    terraform {\r\n      backend \"gcs\" {\r\n        bucket  = \"somebucket-tf-state\"\r\n        prefix  = \"terraform/state/\"\r\n        credentials = \"~/gcp-auth/account.json\"\r\n      }\r\n    }\r\n    \r\n    provider \"google\" {\r\n     region = \"${var.region}\"\r\n     credentials = \"${file(local.credentials_file_path)}\"\r\n    }\r\n    \r\n    module \"project\" {\r\n      source = \"../modules/gcp-project/\"\r\n      project_name      = \"${var.project_name}\"\r\n      billing_account = \"${var.billing_account}\"\r\n      org_id          = \"${var.org_id}\"\r\n    }\r\n\r\nWhen I run this for multiple times with different parameters, It overwrites the previous state file.\r\n\r\nThis is what I see in the bucket:\r\n\r\n    Buckets/somebucket-tf-state/terraform/state/default.tfstate\r\n\r\nIs there a way I can create different state files per project I run the template for?\r\n", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "This is how my terraform template looks like: locals { credentials_file_path = \"~/gcp-auth/account.json\" } terraform { backend \"gcs\" { bucket = \"somebucket-tf-state\" prefix = \"terraform/state/\" credentials = \"~/gcp-auth/account.json\" } } provider \"google\" { region = \"${var.region}\" credentials = \"${file(local.credentials_file_path)}\" } module \"project\" { source = \"../modules/gcp-project/\" project_name = \"${var.project_name}\" billing_account = \"${var.billing_account}\" org_id = \"${var.org_id}\" ", "keywords": ["bill", "provider"]}]}, {"Id": "177000956", "PostHistoryTypeId": "1", "PostId": "51197808", "RevisionGUID": "12f1eb44-af6e-4c06-88a5-194a142335e5", "CreationDate": "2018-07-05T18:30:07.987", "UserId": "395255", "Text": "Terraform overwriting state file on remote backend", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "177000957", "PostHistoryTypeId": "3", "PostId": "51197808", "RevisionGUID": "12f1eb44-af6e-4c06-88a5-194a142335e5", "CreationDate": "2018-07-05T18:30:07.987", "UserId": "395255", "Text": "<google-cloud-platform><terraform><terraform-provider-gcp>", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "answers": [{"Id": "51204774", "PostTypeId": "2", "ParentId": "51197808", "CreationDate": "2018-07-06T07:04:51.647", "Score": "1", "Body": "<p>If I understand what you're trying to do correctly, then it sounds like what you need is <a href=\"https://www.terraform.io/docs/state/workspaces.html\" rel=\"nofollow noreferrer\">workspaces</a>.</p>\n\n<p>Just do :</p>\n\n<pre><code># Select per-project workspace or create new workspace\nterraform workspace select $GCE_PROJECT || terraform workspace new $GCE_PROJECT\n$ Plan and apply as usual.\nterraform plan -out .terraform/.terraform.plan &amp;&amp; terraform apply .terraform/.terraform.plan\n# Revert to default workspace\nterraform workspace select default\n</code></pre>\n", "OwnerUserId": "633213", "LastActivityDate": "2018-07-06T07:04:51.647", "CommentCount": "0", "ContentLicense": "CC BY-SA 4.0", "history": [{"Id": "177029473", "PostHistoryTypeId": "2", "PostId": "51204774", "RevisionGUID": "b80b4429-6976-48a3-ae13-aeca456aaa78", "CreationDate": "2018-07-06T07:04:51.647", "UserId": "633213", "Text": "If I understand what you're trying to do correctly, then it sounds like what you need is [workspaces][1].\r\n\r\n\r\n  [1]: https://www.terraform.io/docs/state/workspaces.html\r\n\r\nJust do :\r\n\r\n    # Select per-project workspace or create new workspace\r\n    terraform workspace select $GCE_PROJECT || terraform workspace new $GCE_PROJECT\r\n    $ Plan and apply as usual.\r\n    terraform plan -out .terraform/.terraform.plan && terraform apply .terraform/.terraform.plan\r\n    # Revert to default workspace\r\n    terraform workspace select default", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "filtered-sentences": []}, {"Id": "60404725", "PostTypeId": "2", "ParentId": "51197808", "CreationDate": "2020-02-25T23:38:07.640", "Score": "1", "Body": "<p>The better oprion is to use GitOps.  You should create an environment for each branch and for every environment inject the correct value in the bucket name.</p>\n", "OwnerUserId": "9003753", "LastActivityDate": "2020-02-25T23:38:07.640", "CommentCount": "0", "ContentLicense": "CC BY-SA 4.0", "history": [{"Id": "215742302", "PostHistoryTypeId": "2", "PostId": "60404725", "RevisionGUID": "e6c24322-e763-46a4-bc6b-5d08bcd4da21", "CreationDate": "2020-02-25T23:38:07.640", "UserId": "9003753", "Text": "The better oprion is to use GitOps.  You should create an environment for each branch and for every environment inject the correct value in the bucket name.", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "filtered-sentences": []}], "contains-topic": true, "filtered-sentences": []}