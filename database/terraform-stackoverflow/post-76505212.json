{"Id": "76505212", "PostTypeId": "1", "CreationDate": "2023-06-19T09:13:37.880", "Score": "0", "ViewCount": "105", "Body": "<p>My GCP organization has the following structure</p>\n<pre><code>mydomain.com\n  - Root-project \n  - Development\n      - my-project-name\n</code></pre>\n<p>In order to automate the project creation within my <code>Development</code> folder using terraform, I created a service account in the <code>Root</code> project and created an IAM principal in <code>Development</code> and granted <code>Project Creator</code> as well as <code>Project Deleter</code>.</p>\n<p>My terraform script looks something like</p>\n<pre><code>terraform {\n  required_providers {\n    google = {\n      source = &quot;hashicorp/google&quot;\n      version = &quot;4.68.0&quot;\n    }\n  }\n}\n\nprovider &quot;google&quot; {\n  scopes = [\n    &quot;https://www.googleapis.com/auth/cloud-platform&quot;\n  ]\n}\n\nresource &quot;google_project&quot; &quot;project&quot; {\n  name = var.project_name\n  folder_id = var.folder_id\n  project_id = var.project_id\n  billing_account = var.billing_account_id\n}\n</code></pre>\n<p>When I run this script locally using glcoud CLI to authenticate on both my personal account and the service account everthing works fine.</p>\n<p>When I run it after setting the credentials using the environment variable <code>GOOGLE_CREDENTIALS</code> I'm able to create the resources but if I run it again, as Terraform will refresh states, it throws this error</p>\n<pre><code>Error: Error when reading or editing Project &quot;my-project-id&quot;: googleapi: Error 403: Request had insufficient authentication scopes.\n\u2502 Details:\n\u2502 [\n\u2502   {\n\u2502     &quot;@type&quot;: &quot;type.googleapis.com/google.rpc.ErrorInfo&quot;,\n\u2502     &quot;domain&quot;: &quot;googleapis.com&quot;,\n\u2502     &quot;metadata&quot;: {\n\u2502       &quot;method&quot;: &quot;google.cloudresourcemanager.v1.Projects.GetProject&quot;,\n\u2502       &quot;service&quot;: &quot;cloudresourcemanager.googleapis.com&quot;\n\u2502     },\n\u2502     &quot;reason&quot;: &quot;ACCESS_TOKEN_SCOPE_INSUFFICIENT&quot;\n\u2502   }\n\u2502 ]\n\u2502 \n\u2502 More details:\n\u2502 Reason: insufficientPermissions, Message: Insufficient Permission\n\n</code></pre>\n<p>I don't understand how can I be able to create a project but not able to fetch its data. In IAM I see that my service account has the <code>Owner</code> role on <code>my-project-name</code>.</p>\n", "OwnerUserId": "16778998", "LastEditorUserId": "16778998", "LastEditDate": "2023-06-19T09:21:33.113", "LastActivityDate": "2023-06-19T17:04:38.403", "Title": "GCP's service account cannot read project", "Tags": "<google-cloud-platform><terraform><terraform-google-cloud>", "AnswerCount": "1", "CommentCount": "2", "ContentLicense": "CC BY-SA 4.0", "comments": [{"Id": "134896054", "PostId": "76505212", "Score": "1", "Text": "**Looks SA was attempting to reach out to the cloud resource manager and couldn't due to an inactive API**. Check which scope allowed for this to occur, and enable all the API's as a temporary workaround. The possible root cause could be that since the **Service Management** scope can only be set to read-write, which still excludes it from making [IAM changes](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google_service_account.html), it\u2019s unable to make the changes Terraform is enabling.", "CreationDate": "2023-06-19T12:30:55.423", "UserId": "19818461", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "The possible root cause could be that since the **Service Management** scope can only be set to read-write, which still excludes it from making [IAM changes](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google_service_account.html), it\u2019s unable to make the changes Terraform is enabling.", "keywords": ["change"]}]}, {"Id": "134899334", "PostId": "76505212", "Score": "0", "Text": "@VeeraNagireddy Wdym by service management scope ? Is it a IAM permission? \nAlso the resource manager api was already enabled", "CreationDate": "2023-06-19T16:36:20.870", "UserId": "16778998", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "history": [{"Id": "294335865", "PostHistoryTypeId": "2", "PostId": "76505212", "RevisionGUID": "eb7f364d-5295-4905-9628-c8cd672adb2f", "CreationDate": "2023-06-19T09:13:37.880", "UserId": "16778998", "Text": "My GCP organization has the following structure\r\n```\r\nmydomain.com\r\n  - Root-project \r\n  - Development\r\n      - my-project-name\r\n```\r\nIn order to automate the project creation within my `Development` folder using terraform, I created a service account in the `Root` project and created an IAM principal in `Development` and granted `Project Creator` as well as `Project Deleter`. \r\n\r\nMy terraform script looks something like\r\n```terraform\r\nterraform {\r\n  required_providers {\r\n    google = {\r\n      source = \"hashicorp/google\"\r\n      version = \"4.68.0\"\r\n    }\r\n  }\r\n}\r\n\r\nprovider \"google\" {\r\n  scopes = [\r\n    \"https://www.googleapis.com/auth/cloud-platform\"\r\n  ]\r\n}\r\n\r\nresource \"google_project\" \"project\" {\r\n  name = var.project_name\r\n  folder_id = var.folder_id\r\n  project_id = var.project_id\r\n  billing_account = var.billing_account_id\r\n}\r\n```\r\n\r\n\r\n\r\nWhen I run this script locally using glcoud CLI to authenticate on both my personal account and the service account everthing works fine.\r\n\r\nWhen I run it after setting the credentials using the environment variable `GOOGLE_CREDENTIALS` I'm able to create the resources but if I run it again, as Terraform will refresh states, it throws this error\r\n```\r\nError: Error when reading or editing Project \"my-project-id\": googleapi: Error 403: Request had insufficient authentication scopes.\r\n\u2502 Details:\r\n\u2502 [\r\n\u2502   {\r\n\u2502     \"@type\": \"type.googleapis.com/google.rpc.ErrorInfo\",\r\n\u2502     \"domain\": \"googleapis.com\",\r\n\u2502     \"metadata\": {\r\n\u2502       \"method\": \"google.cloudresourcemanager.v1.Projects.GetProject\",\r\n\u2502       \"service\": \"cloudresourcemanager.googleapis.com\"\r\n\u2502     },\r\n\u2502     \"reason\": \"ACCESS_TOKEN_SCOPE_INSUFFICIENT\"\r\n\u2502   }\r\n\u2502 ]\r\n\u2502 \r\n\u2502 More details:\r\n\u2502 Reason: insufficientPermissions, Message: Insufficient Permission\r\n\r\n```\r\n\r\nI don't understand how can I be able to create a project but not able to fetch its data. In IAM I see that my service account has the `Owner` role on `my-project-name`.", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "My terraform script looks something like ```terraform terraform { required_providers { google = { source = \"hashicorp/google\" version = \"4.68.0\" } } } provider \"google\" { scopes = [ \"https://www.googleapis.com/auth/cloud-platform\" ] } resource \"google_project\" \"project\" { name = var.project_name folder_id = var.folder_id project_id = var.project_id billing_account = var.billing_account_id } ``` ", "keywords": ["bill", "provider"]}, {"source": "Text", "text": "Error: Error when reading or editing Project \"my-project-id\": googleapi: Error 403: Request had insufficient authentication scopes. \u2502 Details: \u2502 [ \u2502 { \u2502 \"@type\": \"type.googleapis.com/google.rpc.ErrorInfo\", \u2502 \"domain\": \"googleapis.com\", \u2502 \"metadata\": { \u2502 \"method\": \"google.cloudresourcemanager.v1.Projects.GetProject\", \u2502 \"service\": \"cloudresourcemanager.googleapis.com\" \u2502 }, \u2502 \"reason\": \"ACCESS_TOKEN_SCOPE_INSUFFICIENT\" \u2502 } \u2502 ] \u2502 \u2502 More details: \u2502 Reason: insufficientPermissions, Message: Insufficient Permission ``` I don't understand how can I be able to create a project but not able to fetch its data", "keywords": ["domain"]}]}, {"Id": "294335867", "PostHistoryTypeId": "1", "PostId": "76505212", "RevisionGUID": "eb7f364d-5295-4905-9628-c8cd672adb2f", "CreationDate": "2023-06-19T09:13:37.880", "UserId": "16778998", "Text": "GCP service account cannot created project using terraform", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "294335868", "PostHistoryTypeId": "3", "PostId": "76505212", "RevisionGUID": "eb7f364d-5295-4905-9628-c8cd672adb2f", "CreationDate": "2023-06-19T09:13:37.880", "UserId": "16778998", "Text": "<google-cloud-platform><terraform><terraform-google-cloud>", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "294335869", "PostHistoryTypeId": "66", "PostId": "76505212", "RevisionGUID": "eb7f364d-5295-4905-9628-c8cd672adb2f", "CreationDate": "2023-06-19T09:13:37.880", "UserId": "16778998", "filtered-sentences": []}, {"Id": "294336199", "PostHistoryTypeId": "4", "PostId": "76505212", "RevisionGUID": "ac22fb86-5232-4d50-9c02-b6323f2bd2cb", "CreationDate": "2023-06-19T09:21:33.113", "UserId": "16778998", "Comment": "edited title", "Text": "GCP's service account cannot read project", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "answers": [{"Id": "76508724", "PostTypeId": "2", "ParentId": "76505212", "CreationDate": "2023-06-19T17:04:38.403", "Score": "1", "Body": "<p>When you are using the CLI <code>gcloud</code> you might be using different credentials than Terraform is using. Terraform uses Application Default Credentials (ADC).</p>\n<p>Run this <a href=\"https://cloud.google.com/sdk/gcloud/reference/auth/application-default/login\" rel=\"nofollow noreferrer\">command</a> to make sure ADC is using the correct credentials:</p>\n<pre><code>gcloud auth application-default login\n</code></pre>\n<p>The API that has the permission problem is <code>google.cloudresourcemanager.v1.Projects.GetProject</code></p>\n<p>That API requires the permission <code>resourcemanager.projects.get</code>. <a href=\"https://cloud.google.com/resource-manager/docs/access-control-proj#permissions\" rel=\"nofollow noreferrer\">documentation</a></p>\n<p>There are several <a href=\"https://cloud.google.com/resource-manager/docs/access-control-proj#using_predefined_roles\" rel=\"nofollow noreferrer\">predefined IAM Roles</a> with that permission. Since you need to create projects, add the following role at the organization or parent folder level:</p>\n<pre><code>roles/resourcemanager.projectCreator\n</code></pre>\n<p>The crentials that ADC is configure for, does not have that permission or does not have that permission at the correct level (folder or organization).</p>\n", "OwnerUserId": "8016720", "LastActivityDate": "2023-06-19T17:04:38.403", "CommentCount": "1", "ContentLicense": "CC BY-SA 4.0", "comments": [{"Id": "134909248", "PostId": "76508724", "Score": "0", "Text": "Thanks for the answer but turned out that it was a dumb mistake. In my pipeline I wasn\u2019t passing the key and instead of 401 I got 403 for whatever reason which was confusing. Now everything works perfectly", "CreationDate": "2023-06-20T12:05:08.400", "UserId": "16778998", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "history": [{"Id": "294355773", "PostHistoryTypeId": "2", "PostId": "76508724", "RevisionGUID": "c31dfb8c-aebe-4307-a7ca-489377517fd6", "CreationDate": "2023-06-19T17:04:38.403", "UserId": "8016720", "Text": "When you are using the CLI `gcloud` you might be using different credentials than Terraform is using. Terraform uses Application Default Credentials (ADC).\r\n\r\nRun this [command][1] to make sure ADC is using the correct credentials:\r\n\r\n    gcloud auth application-default login\r\n\r\nThe API that has the permission problem is `google.cloudresourcemanager.v1.Projects.GetProject` \r\n\r\nThat API requires the permission `resourcemanager.projects.get`. [documentation][2]\r\n\r\nThere are several [predefined IAM Roles][3] with that permission. Since you need to create projects, add the following role at the organization or parent folder level:\r\n\r\n    roles/resourcemanager.projectCreator\r\n\r\nThe crentials that ADC is configure for, does not have that permission or does not have that permission at the correct level (folder or organization).\r\n\r\n  [1]: https://cloud.google.com/sdk/gcloud/reference/auth/application-default/login\r\n  [2]: https://cloud.google.com/resource-manager/docs/access-control-proj#permissions\r\n  [3]: https://cloud.google.com/resource-manager/docs/access-control-proj#using_predefined_roles", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "294355775", "PostHistoryTypeId": "33", "PostId": "76508724", "RevisionGUID": "be6f1a5c-5915-4e45-bc9e-a5a7583c536c", "CreationDate": "2023-06-19T17:04:38.403", "UserId": "-1002", "Comment": "323878", "filtered-sentences": []}], "filtered-sentences": []}], "contains-topic": true, "filtered-sentences": []}