{"Id": "70157864", "PostTypeId": "1", "CreationDate": "2021-11-29T16:20:17.643", "Score": "2", "ViewCount": "319", "Body": "<p>I want my target tracking policy to be based on the CPU utilization of my ASG. I know that EC2 provides basic monitoring including a <code>CPUUtilization</code> metric but only at a 5-minute rate. I also know that I could enable detailed monitoring for all instances to enable metrics at a 1-minute interval but as far as I understand this is a &quot;all or nothing&quot; type of thing where I have to pay for ALL the EC2 metrics (network, etc.) as custom metrics (for my instance type there are 16 metrics which means 16 * $0.3 = $4.8 of additional cost / month / instance. please correct me if my assumption is wrong).</p>\n<p>So, instead I use the CloudWatch agent running on the ASG instances with the following <code>amazon-cloudwatch-agent.json</code> config:</p>\n<pre class=\"lang-json prettyprint-override\"><code>...\n&quot;metrics&quot;: {\n    &quot;namespace&quot;: &quot;AWS/EC2&quot;,\n    &quot;append_dimensions&quot;: {\n        &quot;AutoScalingGroupName&quot;: &quot;$${aws:AutoScalingGroupName}&quot;,\n        &quot;InstanceId&quot;: &quot;$${aws:InstanceId}&quot;\n    },\n    &quot;aggregation_dimensions&quot;: [\n        [&quot;AutoScalingGroupName&quot;]\n    ],\n    &quot;metrics_collected&quot;: {\n        ...\n        &quot;cpu&quot;: {\n            &quot;measurement&quot;: [\n                {\n                    &quot;name&quot;: &quot;cpu_usage_user&quot;,\n                    &quot;rename&quot;: &quot;CPUUtilizationUser&quot;\n                },\n                {\n                    &quot;name&quot;: &quot;cpu_usage_system&quot;,\n                    &quot;rename&quot;: &quot;CPUUtilizationSystem&quot;\n                }\n            ],\n            &quot;metrics_collection_interval&quot;: 60,\n            &quot;resources&quot;: [&quot;*&quot;],\n            &quot;totalcpu&quot;: true\n        }\n    }\n}\n</code></pre>\n<p>The sum of <code>CPUUtilizationUser</code> and <code>CPUUtilizationSystem</code> closely matches the actual CPU utilization and I only pay for 2 additional custom metrics per instance instead of 16 (again, please correct me if the assumption is wrong).</p>\n<p><strong>Question is how to use the sum of those two custom metrics for the target tracking policy of my ASG? I know you can use math expressions for CloudWatch alarms, but I don't see that for scaling policies.</strong></p>\n<p>Note that I use Terraform to provision all my AWS resources including the scaling policy. Currently it looks like this:</p>\n<pre><code>resource &quot;aws_autoscaling_policy&quot; &quot;target_tracking&quot; {\n  ...\n  policy_type = &quot;TargetTrackingScaling&quot;\n\n  target_tracking_configuration {\n    customized_metric_specification {\n      metric_name = // here I want CPUUtilizationUser + CPUUtilizationSystem basically\n      namespace = &quot;AWS/EC2&quot;\n      statistic = &quot;Average&quot;\n      metric_dimension {\n        name  = &quot;AutoScalingGroupName&quot;\n        value = aws_autoscaling_group.application.name\n      }\n    }\n  }\n}\n</code></pre>\n<p>Any ideas on how to do this?\nMany thanks!</p>\n", "OwnerDisplayName": "user17157627", "LastActivityDate": "2021-11-29T16:20:17.643", "Title": "ASG Target Tracking policy based on the SUM of two (custom) metrics?", "Tags": "<amazon-web-services><terraform><amazon-cloudwatch><autoscaling>", "AnswerCount": "0", "CommentCount": "0", "ContentLicense": "CC BY-SA 4.0", "history": [{"Id": "259000225", "PostHistoryTypeId": "2", "PostId": "70157864", "RevisionGUID": "e25d1e85-0093-43c4-9ff5-ce5b4c222995", "CreationDate": "2021-11-29T16:20:17.643", "UserDisplayName": "user17157627", "Text": "I want my target tracking policy to be based on the CPU utilization of my ASG. I know that EC2 provides basic monitoring including a `CPUUtilization` metric but only at a 5-minute rate. I also know that I could enable detailed monitoring for all instances to enable metrics at a 1-minute interval but as far as I understand this is a \"all or nothing\" type of thing where I have to pay for ALL the EC2 metrics (network, etc.) as custom metrics (for my instance type there are 16 metrics which means 16 * $0.3 = $4.8 of additional cost / month / instance. please correct me if my assumption is wrong).\r\n\r\nSo, instead I use the CloudWatch agent running on the ASG instances with the following `amazon-cloudwatch-agent.json` config:\r\n```json\r\n...\r\n\"metrics\": {\r\n \"namespace\": \"AWS/EC2\",\r\n \"append_dimensions\": {\r\n  \"AutoScalingGroupName\": \"$${aws:AutoScalingGroupName}\",\r\n  \"InstanceId\": \"$${aws:InstanceId}\"\r\n },\r\n \"aggregation_dimensions\": [\r\n  [\"AutoScalingGroupName\"]\r\n ],\r\n \"metrics_collected\": {\r\n  ...\r\n  \"cpu\": {\r\n   \"measurement\": [\r\n    {\r\n     \"name\": \"cpu_usage_user\",\r\n     \"rename\": \"CPUUtilizationUser\"\r\n    },\r\n    {\r\n     \"name\": \"cpu_usage_system\",\r\n     \"rename\": \"CPUUtilizationSystem\"\r\n    }\r\n   ],\r\n   \"metrics_collection_interval\": 60,\r\n   \"resources\": [\"*\"],\r\n   \"totalcpu\": true\r\n  }\r\n }\r\n}\r\n```\r\n\r\nThe sum of `CPUUtilizationUser` and `CPUUtilizationSystem` closely matches the actual CPU utilization and I only pay for 2 additional custom metrics per instance instead of 16 (again, please correct me if the assumption is wrong).\r\n\r\n**Question is how to use the sum of those two custom metrics for the target tracking policy of my ASG? I know you can use math expressions for CloudWatch alarms, but I don't see that for scaling policies.**\r\n\r\nNote that I use Terraform to provision all my AWS resources including the scaling policy. Currently it looks like this:\r\n```tf\r\nresource \"aws_autoscaling_policy\" \"target_tracking\" {\r\n  ...\r\n  policy_type = \"TargetTrackingScaling\"\r\n\r\n  target_tracking_configuration {\r\n    customized_metric_specification {\r\n      metric_name = // here I want CPUUtilizationUser + CPUUtilizationSystem basically\r\n      namespace = \"AWS/EC2\"\r\n      statistic = \"Average\"\r\n      metric_dimension {\r\n        name  = \"AutoScalingGroupName\"\r\n        value = aws_autoscaling_group.application.name\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nAny ideas on how to do this?\r\nMany thanks!", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "I want my target tracking policy to be based on the CPU utilization of my ASG. ", "keywords": ["cpu", "policy"]}, {"source": "Text", "text": "I also know that I could enable detailed monitoring for all instances to enable metrics at a 1-minute interval but as far as I understand this is a \"all or nothing\" type of thing where I have to pay for ALL the EC2 metrics (network, etc.) as custom metrics (for my instance type there are 16 metrics which means 16 * $0.3 = $4.8 of additional cost / month / instance. please correct me if my assumption is wrong). ", "keywords": ["cost", "pay", "instance"]}, {"source": "Text", "text": "So, instead I use the CloudWatch agent running on the ASG instances with the following `amazon-cloudwatch-agent.json` config: ```json ... \"metrics\": { \"namespace\": \"AWS/EC2\", \"append_dimensions\": { \"AutoScalingGroupName\": \"$${aws:AutoScalingGroupName}\", \"InstanceId\": \"$${aws:InstanceId}\" }, \"aggregation_dimensions\": [ [\"AutoScalingGroupName\"] ], \"metrics_collected\": { ... \"cpu\": { \"measurement\": [ { \"name\": \"cpu_usage_user\", \"rename\": \"CPUUtilizationUser\" }, { \"name\": \"cpu_usage_system\", \"rename\": \"CPUUtilizationSystem\" } ], \"metrics_collection_interval\": 60, \"resources\": [\"*\"], \"totalcpu\": true } } } ``` ", "keywords": ["cpu"]}, {"source": "Text", "text": "The sum of `CPUUtilizationUser` and `CPUUtilizationSystem` closely matches the actual CPU utilization and I only pay for 2 additional custom metrics per instance instead of 16 (again, please correct me if the assumption is wrong). ", "keywords": ["pay", "instance", "cpu"]}, {"source": "Text", "text": "**Question is how to use the sum of those two custom metrics for the target tracking policy of my ASG? ", "keywords": ["policy"]}, {"source": "Text", "text": "Note that I use Terraform to provision all my AWS resources including the scaling policy. ", "keywords": ["policy"]}]}, {"Id": "259000227", "PostHistoryTypeId": "1", "PostId": "70157864", "RevisionGUID": "e25d1e85-0093-43c4-9ff5-ce5b4c222995", "CreationDate": "2021-11-29T16:20:17.643", "UserDisplayName": "user17157627", "Text": "ASG Target Tracking policy based on the SUM of two (custom) metrics?", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "ASG Target Tracking policy based on the SUM of two (custom) metrics?", "keywords": ["policy"]}]}, {"Id": "259000228", "PostHistoryTypeId": "3", "PostId": "70157864", "RevisionGUID": "e25d1e85-0093-43c4-9ff5-ce5b4c222995", "CreationDate": "2021-11-29T16:20:17.643", "UserDisplayName": "user17157627", "Text": "<amazon-web-services><terraform><amazon-cloudwatch><autoscaling>", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "contains-topic": true, "filtered-sentences": [{"source": "Title", "text": "ASG Target Tracking policy based on the SUM of two (custom) metrics?", "keywords": ["policy"]}, {"source": "Body", "text": "I want my target tracking policy to be based on the CPU utilization of my ASG. ", "keywords": ["cpu", "policy"]}, {"source": "Body", "text": "I also know that I could enable detailed monitoring for all instances to enable metrics at a 1-minute interval but as far as I understand this is a \"all or nothing\" type of thing where I have to pay for ALL the EC2 metrics (network, etc.) as custom metrics (for my instance type there are 16 metrics which means 16 * $0.3 = $4.8 of additional cost / month / instance. please correct me if my assumption is wrong). ", "keywords": ["cost", "pay", "instance"]}, {"source": "Body", "text": "So, instead I use the CloudWatch agent running on the ASG instances with the following amazon-cloudwatch-agent.json config: The sum of CPUUtilizationUser and CPUUtilizationSystem closely matches the actual CPU utilization and I only pay for 2 additional custom metrics per instance instead of 16 (again, please correct me if the assumption is wrong). ", "keywords": ["pay", "instance", "cpu"]}, {"source": "Body", "text": "Question is how to use the sum of those two custom metrics for the target tracking policy of my ASG? ", "keywords": ["policy"]}, {"source": "Body", "text": "Note that I use Terraform to provision all my AWS resources including the scaling policy. ", "keywords": ["policy"]}]}