{"Id": "58549030", "PostTypeId": "1", "CreationDate": "2019-10-24T20:56:10.830", "Score": "1", "ViewCount": "689", "Body": "<p>I have a private subnet with default route targeting to a nat-gateway. Both were created by terraform.</p>\n\n<p>Now I have another code to raise an ec2 to use as NAT in my VPC (as cloud-nat-gateway become very expensive). I'm trying to change the default route in my rtb to this new ec2 and getting the error below:</p>\n\n<p>Error: Error applying plan:</p>\n\n<p>1 error occurred:\n        * module.ec2-nat.aws_route.defaultroute_to_ec2-nat: 1 error occurred:\n        * aws_route.defaultroute_to_ec2-nat: Error creating route: RouteAlreadyExists: The route identified by 0.0.0.0/0 already exists.\n        status code: 400, request id: 408deb59-d223-4c9f-9a28-209e2e0478e9</p>\n\n<p>I know this route already exists, but how to change this already existing route to a new target? In this case my new ec2 network interface?</p>\n\n<p>Thanks for your help.</p>\n\n<p>Follow are the code I'm using:</p>\n\n<pre><code>#####################\n# FIRST TERRAFORM\n# create the internet gateway\n\nresource \"aws_internet_gateway\" \"this\" {\n  count = \"${var.create_vpc &amp;&amp; length(var.public_subnets) &gt; 0 ? 1 : 0}\"\n\n  vpc_id = \"${aws_vpc.this.id}\"\n\n  tags = \"${merge(map(\"Name\", format(\"%s\", var.name)), var.igw_tags, var.tags)}\"\n}\n\n# Add default route (0.0.0.0/0) to internet gateway \n\nresource \"aws_route\" \"public_internet_gateway\" {\n  count = \"${var.create_vpc &amp;&amp; length(var.public_subnets) &gt; 0 ? 1 : 0}\"\n\n  route_table_id         = \"${aws_route_table.public.id}\"\n  destination_cidr_block = \"0.0.0.0/0\"\n  gateway_id             = \"${aws_internet_gateway.this.id}\"\n\n  timeouts {\n    create = \"5m\"\n  }\n}\n\n\n#####################\n# SECOND TERRAFORM\n# Spin EC2 to run as NAT\n\nresource \"aws_instance\" \"ec2-nat\" {\n  count                       = \"${var.instance_qtd}\"\n  ami                         = \"${data.aws_ami.nat.id}\"\n  availability_zone           = \"${var.region}a\"\n  instance_type               = \"${var.instance_type}\"\n  key_name                    = \"${var.aws_key_name}\"\n  vpc_security_group_ids      = [\"${var.sg_ec2}\",\"${var.sg_ops}\"]\n  subnet_id                   = \"${var.public_subnet_id}\"\n  iam_instance_profile        = \"${var.iam_instance_profile}\"\n  associate_public_ip_address = true\n  source_dest_check           = false\n\n  tags = {\n    Name                          = \"ec2-nat-${var.brand}-${var.role}-${count.index}\"\n    Brand                         = \"${var.brand}\"\n    Role                          = \"${var.role}\"\n    Type                          = \"ec2-nat\"\n  }\n}\n\n# Add default route (0.0.0.0/0) to aws_instance.ec2-nat\n\nvariable \"default_route\" {\n    default = \"0.0.0.0/0\"\n}\n\nresource \"aws_route\" \"defaultroute_to_ec2-nat\" {\n  route_table_id              = \"${var.private_route_id}\"\n  destination_cidr_block      = \"${var.default_route}\"\n  instance_id                 = \"${element(aws_instance.ec2-nat.*.id, 0)}\"\n}\n</code></pre>\n", "OwnerUserId": "9258415", "LastEditorUserId": "9258415", "LastEditDate": "2019-10-25T14:13:59.937", "LastActivityDate": "2019-10-25T14:13:59.937", "Title": "Terraform AWS - How to change default route to an existing route table from nat-gateway to ec2?", "Tags": "<amazon-web-services><nat><terraform-provider-aws><routetable>", "AnswerCount": "0", "CommentCount": "2", "ContentLicense": "CC BY-SA 4.0", "comments": [{"Id": "103423469", "PostId": "58549030", "Score": "0", "Text": "show your terraform code, need more information.", "CreationDate": "2019-10-25T02:33:24.983", "UserId": "12200437", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "103439529", "PostId": "58549030", "Score": "0", "Text": "@GNOKOHEAT added! Thanks.", "CreationDate": "2019-10-25T14:15:54.413", "UserId": "9258415", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "history": [{"Id": "207908110", "PostHistoryTypeId": "2", "PostId": "58549030", "RevisionGUID": "c6728322-bd34-4663-916b-67bae1f5ab44", "CreationDate": "2019-10-24T20:56:10.830", "UserId": "9258415", "Text": "I have a private subnet with default route targeting to a nat-gateway. Both were created by terraform.\r\n\r\nNow I have another code to raise an ec2 to use as NAT in my VPC (as cloud-nat-gateway become very expensive). I'm trying to change the default route in my rtb to this new ec2 and getting the error below:\r\n\r\nError: Error applying plan:\r\n\r\n1 error occurred:\r\n        * module.ec2-nat.aws_route.defaultroute_to_ec2-nat: 1 error occurred:\r\n        * aws_route.defaultroute_to_ec2-nat: Error creating route: RouteAlreadyExists: The route identified by 0.0.0.0/0 already exists.\r\n        status code: 400, request id: 408deb59-d223-4c9f-9a28-209e2e0478e9\r\n\r\nI know this route already exists, but how to change this already existing route to a new target? In this case my new ec2 network interface?\r\n\r\nThanks for your help.", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "I have a private subnet with default route targeting to a nat-gateway. ", "keywords": ["nat"]}, {"source": "Text", "text": "Now I have another code to raise an ec2 to use as NAT in my VPC (as cloud-nat-gateway become very expensive). ", "keywords": ["expense", "nat"]}, {"source": "Text", "text": "I'm trying to change the default route in my rtb to this new ec2 and getting the error below: Error: Error applying plan: 1 error occurred: * module.ec2-nat.aws_route.defaultroute_to_ec2-nat: 1 error occurred: * aws_route.defaultroute_to_ec2-nat: Error creating route: RouteAlreadyExists: The route identified by 0.0.0.0/0 already exists. status code: 400, request id: 408deb59-d223-4c9f-9a28-209e2e0478e9 I know this route already exists, but how to change this already existing route to a new target? ", "keywords": ["nat", "change"]}]}, {"Id": "207908111", "PostHistoryTypeId": "1", "PostId": "58549030", "RevisionGUID": "c6728322-bd34-4663-916b-67bae1f5ab44", "CreationDate": "2019-10-24T20:56:10.830", "UserId": "9258415", "Text": "Terraform AWS - How to change default route to an existing route table from nat-gateway to ec2?", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "Terraform AWS - How to change default route to an existing route table from nat-gateway to ec2?", "keywords": ["nat", "change"]}]}, {"Id": "207908112", "PostHistoryTypeId": "3", "PostId": "58549030", "RevisionGUID": "c6728322-bd34-4663-916b-67bae1f5ab44", "CreationDate": "2019-10-24T20:56:10.830", "UserId": "9258415", "Text": "<amazon-web-services><nat><terraform-provider-aws><routetable>", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "207953538", "PostHistoryTypeId": "5", "PostId": "58549030", "RevisionGUID": "9bb97dc2-7925-441c-a0ce-b1abdcff8451", "CreationDate": "2019-10-25T14:13:59.937", "UserId": "9258415", "Comment": "added 2021 characters in body", "Text": "I have a private subnet with default route targeting to a nat-gateway. Both were created by terraform.\r\n\r\nNow I have another code to raise an ec2 to use as NAT in my VPC (as cloud-nat-gateway become very expensive). I'm trying to change the default route in my rtb to this new ec2 and getting the error below:\r\n\r\nError: Error applying plan:\r\n\r\n1 error occurred:\r\n        * module.ec2-nat.aws_route.defaultroute_to_ec2-nat: 1 error occurred:\r\n        * aws_route.defaultroute_to_ec2-nat: Error creating route: RouteAlreadyExists: The route identified by 0.0.0.0/0 already exists.\r\n        status code: 400, request id: 408deb59-d223-4c9f-9a28-209e2e0478e9\r\n\r\nI know this route already exists, but how to change this already existing route to a new target? In this case my new ec2 network interface?\r\n\r\nThanks for your help.\r\n\r\nFollow are the code I'm using:\r\n\r\n```\r\n#####################\r\n# FIRST TERRAFORM\r\n# create the internet gateway\r\n\r\nresource \"aws_internet_gateway\" \"this\" {\r\n  count = \"${var.create_vpc && length(var.public_subnets) > 0 ? 1 : 0}\"\r\n\r\n  vpc_id = \"${aws_vpc.this.id}\"\r\n\r\n  tags = \"${merge(map(\"Name\", format(\"%s\", var.name)), var.igw_tags, var.tags)}\"\r\n}\r\n\r\n# Add default route (0.0.0.0/0) to internet gateway \r\n\r\nresource \"aws_route\" \"public_internet_gateway\" {\r\n  count = \"${var.create_vpc && length(var.public_subnets) > 0 ? 1 : 0}\"\r\n\r\n  route_table_id         = \"${aws_route_table.public.id}\"\r\n  destination_cidr_block = \"0.0.0.0/0\"\r\n  gateway_id             = \"${aws_internet_gateway.this.id}\"\r\n\r\n  timeouts {\r\n    create = \"5m\"\r\n  }\r\n}\r\n\r\n\r\n#####################\r\n# SECOND TERRAFORM\r\n# Spin EC2 to run as NAT\r\n\r\nresource \"aws_instance\" \"ec2-nat\" {\r\n  count                       = \"${var.instance_qtd}\"\r\n  ami                         = \"${data.aws_ami.nat.id}\"\r\n  availability_zone           = \"${var.region}a\"\r\n  instance_type               = \"${var.instance_type}\"\r\n  key_name                    = \"${var.aws_key_name}\"\r\n  vpc_security_group_ids      = [\"${var.sg_ec2}\",\"${var.sg_ops}\"]\r\n  subnet_id                   = \"${var.public_subnet_id}\"\r\n  iam_instance_profile        = \"${var.iam_instance_profile}\"\r\n  associate_public_ip_address = true\r\n  source_dest_check           = false\r\n\r\n  tags = {\r\n    Name                          = \"ec2-nat-${var.brand}-${var.role}-${count.index}\"\r\n    Brand                         = \"${var.brand}\"\r\n    Role                          = \"${var.role}\"\r\n    Type                          = \"ec2-nat\"\r\n  }\r\n}\r\n\r\n# Add default route (0.0.0.0/0) to aws_instance.ec2-nat\r\n\r\nvariable \"default_route\" {\r\n    default = \"0.0.0.0/0\"\r\n}\r\n\r\nresource \"aws_route\" \"defaultroute_to_ec2-nat\" {\r\n  route_table_id              = \"${var.private_route_id}\"\r\n  destination_cidr_block      = \"${var.default_route}\"\r\n  instance_id                 = \"${element(aws_instance.ec2-nat.*.id, 0)}\"\r\n}\r\n```", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "I have a private subnet with default route targeting to a nat-gateway. ", "keywords": ["nat"]}, {"source": "Text", "text": "Now I have another code to raise an ec2 to use as NAT in my VPC (as cloud-nat-gateway become very expensive). ", "keywords": ["expense", "nat"]}, {"source": "Text", "text": "I'm trying to change the default route in my rtb to this new ec2 and getting the error below: Error: Error applying plan: 1 error occurred: * module.ec2-nat.aws_route.defaultroute_to_ec2-nat: 1 error occurred: * aws_route.defaultroute_to_ec2-nat: Error creating route: RouteAlreadyExists: The route identified by 0.0.0.0/0 already exists. status code: 400, request id: 408deb59-d223-4c9f-9a28-209e2e0478e9 I know this route already exists, but how to change this already existing route to a new target? ", "keywords": ["nat", "change"]}, {"source": "Text", "text": "Follow are the code I'm using: ``` ##################### # FIRST TERRAFORM # create the internet gateway resource \"aws_internet_gateway\" \"this\" { count = \"${var.create_vpc && length(var.public_subnets) > 0 ? 1 : 0}\" vpc_id = \"${aws_vpc.this.id}\" tags = \"${merge(map(\"Name\", format(\"%s\", var.name)), var.igw_tags, var.tags)}\" } # Add default route (0.0.0.0/0) to internet gateway resource \"aws_route\" \"public_internet_gateway\" { count = \"${var.create_vpc && length(var.public_subnets) > 0 ? 1 : 0}\" route_table_id = \"${aws_route_table.public.id}\" destination_cidr_block = \"0.0.0.0/0\" gateway_id = \"${aws_internet_gateway.this.id}\" timeouts { create = \"5m\" } } ##################### # SECOND TERRAFORM # Spin EC2 to run as NAT resource \"aws_instance\" \"ec2-nat\" { count = \"${var.instance_qtd}\" ami = \"${data.aws_ami.nat.id}\" availability_zone = \"${var.region}a\" instance_type = \"${var.instance_type}\" key_name = \"${var.aws_key_name}\" vpc_security_group_ids = [\"${var.sg_ec2}\",\"${var.sg_ops}\"] subnet_id = \"${var.public_subnet_id}\" iam_instance_profile = \"${var.iam_instance_profile}\" associate_public_ip_address = true source_dest_check = false tags = { Name = \"ec2-nat-${var.brand}-${var.role}-${count.index}\" Brand = \"${var.brand}\" Role = \"${var.role}\" Type = \"ec2-nat\" } } # Add default route (0.0.0.0/0) to aws_instance.ec2-nat variable \"default_route\" { default = \"0.0.0.0/0\" ", "keywords": ["nat"]}, {"source": "Text", "text": "} resource \"aws_route\" \"defaultroute_to_ec2-nat\" { route_table_id = \"${var.private_route_id}\" destination_cidr_block = \"${var.default_route}\" instance_id = \"${element(aws_instance.ec2-nat.*", "keywords": ["nat"]}]}], "contains-topic": true, "filtered-sentences": [{"source": "Title", "text": "Terraform AWS - How to change default route to an existing route table from nat-gateway to ec2?", "keywords": ["nat", "change"]}, {"source": "Body", "text": "I have a private subnet with default route targeting to a nat-gateway. ", "keywords": ["nat"]}, {"source": "Body", "text": "Now I have another code to raise an ec2 to use as NAT in my VPC (as cloud-nat-gateway become very expensive). ", "keywords": ["expense", "nat"]}, {"source": "Body", "text": "I'm trying to change the default route in my rtb to this new ec2 and getting the error below: Error: Error applying plan: 1 error occurred: * module.ec2-nat.aws_route.defaultroute_to_ec2-nat: 1 error occurred: * aws_route.defaultroute_to_ec2-nat: Error creating route: RouteAlreadyExists: The route identified by 0.0.0.0/0 already exists. status code: 400, request id: 408deb59-d223-4c9f-9a28-209e2e0478e9 I know this route already exists, but how to change this already existing route to a new target? ", "keywords": ["nat", "change"]}]}