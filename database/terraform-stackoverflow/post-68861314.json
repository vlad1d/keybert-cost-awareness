{"Id": "68861314", "PostTypeId": "1", "CreationDate": "2021-08-20T11:13:53.960", "Score": "0", "ViewCount": "1293", "Body": "<p>I am trying to create a new project and then a new Google Artifact Registry within the new project.  Here are the Terraform resources:</p>\n<pre><code>resource &quot;google_project&quot; &quot;my_project&quot; {\n  name = &quot;My Project Name&quot;\n  project_id = &quot;my-project-id-abc&quot;\n  billing_account = &quot;BILLING-ACCOUNT-ID&quot;\n}\n\nresource &quot;google_artifact_registry_repository&quot; &quot;my_ar&quot; {\n  provider = google-beta\n  format = &quot;DOCKER&quot;\n  repository_id = &quot;myreponame&quot;\n  location = &quot;europe-west1&quot;\n  project = google_project.my_project.project_id\n  depends_on = [google_project_service.artifactregistry_googleapis_com]\n}\n\nresource &quot;google_project_service&quot; &quot;artifactregistry_googleapis_com&quot; {\n  project = google_project.my_project.project_id\n  service = &quot;artifactregistry.googleapis.com&quot;\n}\n</code></pre>\n<p>This almost always fails on first the <code>terraform apply</code> with the following error message:</p>\n<pre><code>Error: Error creating Repository: googleapi: Error 403: Permission 'artifactregistry.repositories.create' denied on resource '//artifactregistry.googleapis.com/projects/my-project-id-abc/locations/europe-west1' (or it may not exist).\nDetails:\n[\n  {\n    &quot;@type&quot;: &quot;type.googleapis.com/google.rpc.ErrorInfo&quot;,\n    &quot;domain&quot;: &quot;artifactregistry.googleapis.com&quot;,\n    &quot;metadata&quot;: {\n      &quot;permission&quot;: &quot;artifactregistry.repositories.create&quot;,\n      &quot;resource&quot;: &quot;projects/my-project-id-abc/locations/europe-west1&quot;\n    },\n    &quot;reason&quot;: &quot;IAM_PERMISSION_DENIED&quot;\n  }\n]\n</code></pre>\n<p>Running the same command immediately again always succeeds with the following message:</p>\n<pre><code>Terraform will perform the following actions:\n\n  # google_artifact_registry_repository.my_ar will be created\n  + resource &quot;google_artifact_registry_repository&quot; &quot;my_ar&quot; {\n      + create_time   = (known after apply)\n      + format        = &quot;DOCKER&quot;\n      + id            = (known after apply)\n      + location      = &quot;europe-west1&quot;\n      + name          = (known after apply)\n      + project       = &quot;my-project-id-abc&quot;\n      + repository_id = &quot;myreponame&quot;\n      + update_time   = (known after apply)\n    }\n\nPlan: 1 to add, 0 to change, 0 to destroy.\ngoogle_artifact_registry_repository.my_ar: Creating...\ngoogle_artifact_registry_repository.my_ar: Still creating... [10s elapsed]\ngoogle_artifact_registry_repository.my_ar: Creation complete after 12s [id=projects/my-project-id-abc/locations/europe-west1/repositories/myreponame]\n\nApply complete! Resources: 1 added, 0 changed, 0 destroyed.\n</code></pre>\n<p>It the role of the <code>depends_on = [google_project_service.artifactregistry_googleapis_com]</code> attribute not support to wait for everything to be ready before creating the artifact repository?</p>\n", "OwnerUserId": "3652338", "LastActivityDate": "2023-08-02T22:09:06.987", "Title": "google_artifact_registry_repository seems to ignore the 'depends_on' attribute?", "Tags": "<terraform-provider-gcp><google-artifact-registry>", "AnswerCount": "2", "CommentCount": "2", "ContentLicense": "CC BY-SA 4.0", "comments": [{"Id": "121703253", "PostId": "68861314", "Score": "1", "Text": "I haven't faced this issue but this [list of support channels](https://cloud.google.com/docs/terraform#terraform_support_for) for Terraform with GCP might be useful", "CreationDate": "2021-08-20T14:49:11.957", "UserId": "15123894", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "126529121", "PostId": "68861314", "Score": "0", "Text": "I'm getting the same problem - did you manage to solve it?", "CreationDate": "2022-03-23T16:52:09.313", "UserId": "112477", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "history": [{"Id": "252322939", "PostHistoryTypeId": "2", "PostId": "68861314", "RevisionGUID": "0b55f4c3-62eb-4b64-819d-25290070c7ee", "CreationDate": "2021-08-20T11:13:53.960", "UserId": "3652338", "Text": "I am trying to create a new project and then a new Google Artifact Registry within the new project.  Here are the Terraform resources:\r\n\r\n```tf\r\nresource \"google_project\" \"my_project\" {\r\n  name = \"My Project Name\"\r\n  project_id = \"my-project-id-abc\"\r\n  billing_account = \"BILLING-ACCOUNT-ID\"\r\n}\r\n\r\nresource \"google_artifact_registry_repository\" \"my_ar\" {\r\n  provider = google-beta\r\n  format = \"DOCKER\"\r\n  repository_id = \"myreponame\"\r\n  location = \"europe-west1\"\r\n  project = google_project.my_project.project_id\r\n  depends_on = [google_project_service.artifactregistry_googleapis_com]\r\n}\r\n\r\nresource \"google_project_service\" \"artifactregistry_googleapis_com\" {\r\n  project = google_project.my_project.project_id\r\n  service = \"artifactregistry.googleapis.com\"\r\n}\r\n```\r\nThis almost always fails on first the `terraform apply` with the following error message:\r\n```\r\nError: Error creating Repository: googleapi: Error 403: Permission 'artifactregistry.repositories.create' denied on resource '//artifactregistry.googleapis.com/projects/my-project-id-abc/locations/europe-west1' (or it may not exist).\r\nDetails:\r\n[\r\n  {\r\n    \"@type\": \"type.googleapis.com/google.rpc.ErrorInfo\",\r\n    \"domain\": \"artifactregistry.googleapis.com\",\r\n    \"metadata\": {\r\n      \"permission\": \"artifactregistry.repositories.create\",\r\n      \"resource\": \"projects/my-project-id-abc/locations/europe-west1\"\r\n    },\r\n    \"reason\": \"IAM_PERMISSION_DENIED\"\r\n  }\r\n]\r\n```\r\nRunning the same command immediately again always succeeds with the following message:\r\n```\r\nTerraform will perform the following actions:\r\n\r\n  # google_artifact_registry_repository.my_ar will be created\r\n  + resource \"google_artifact_registry_repository\" \"my_ar\" {\r\n      + create_time   = (known after apply)\r\n      + format        = \"DOCKER\"\r\n      + id            = (known after apply)\r\n      + location      = \"europe-west1\"\r\n      + name          = (known after apply)\r\n      + project       = \"my-project-id-abc\"\r\n      + repository_id = \"myreponame\"\r\n      + update_time   = (known after apply)\r\n    }\r\n\r\nPlan: 1 to add, 0 to change, 0 to destroy.\r\ngoogle_artifact_registry_repository.my_ar: Creating...\r\ngoogle_artifact_registry_repository.my_ar: Still creating... [10s elapsed]\r\ngoogle_artifact_registry_repository.my_ar: Creation complete after 12s [id=projects/my-project-id-abc/locations/europe-west1/repositories/myreponame]\r\n\r\nApply complete! Resources: 1 added, 0 changed, 0 destroyed.\r\n```\r\n\r\nIt the role of the `depends_on = [google_project_service.artifactregistry_googleapis_com]` attribute not support to wait for everything to be ready before creating the artifact repository?\r\n", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "Here are the Terraform resources: ```tf resource \"google_project\" \"my_project\" { name = \"My Project Name\" project_id = \"my-project-id-abc\" billing_account = \"BILLING-ACCOUNT-ID\" } resource \"google_artifact_registry_repository\" \"my_ar\" { provider = google-beta format = \"DOCKER\" repository_id = \"myreponame\" location = \"europe-west1\" project = google_project.my_project.project_id depends_on = [google_project_service.artifactregistry_googleapis_com] } resource \"google_project_service\" \"artifactregistry_googleapis_com\" { project = google_project.my_project.project_id service = \"artifactregistry.googleapis.com\" } ``` ", "keywords": ["bill", "provider"]}, {"source": "Text", "text": "Details: [ { \"@type\": \"type.googleapis.com/google.rpc.ErrorInfo\", \"domain\": \"artifactregistry.googleapis.com\", \"metadata\": { \"permission\": \"artifactregistry.repositories.create\", \"resource\": \"projects/my-project-id-abc/locations/europe-west1\" }, \"reason\": \"IAM_PERMISSION_DENIED\" } ] ``` Running the same command immediately again always succeeds with the following message: ``` Terraform will perform the following actions: # google_artifact_registry_repository.my_ar will be created + resource \"google_artifact_registry_repository\" \"my_ar\" { + create_time = (known after apply) + format = \"DOCKER\" + id = (known after apply) + location = \"europe-west1\" + name = (known after apply) + project = \"my-project-id-abc\" + repository_id = \"myreponame\" + update_time = (known after apply) } Plan: 1 to add, 0 to change, 0 to destroy. google_artifact_registry_repository.my_ar: Creating... google_artifact_registry_repository.my_ar: Still creating... [10s elapsed] google_artifact_registry_repository.my_ar: Creation complete after 12s [id=projects/my-project-id-abc/locations/europe-west1/repositories/myreponame] Apply complete! Resources: 1 added, 0 changed, 0 destroyed. ", "keywords": ["domain", "change"]}]}, {"Id": "252322940", "PostHistoryTypeId": "1", "PostId": "68861314", "RevisionGUID": "0b55f4c3-62eb-4b64-819d-25290070c7ee", "CreationDate": "2021-08-20T11:13:53.960", "UserId": "3652338", "Text": "google_artifact_registry_repository seems to ignore the 'depends_on' attribute?", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "252322941", "PostHistoryTypeId": "3", "PostId": "68861314", "RevisionGUID": "0b55f4c3-62eb-4b64-819d-25290070c7ee", "CreationDate": "2021-08-20T11:13:53.960", "UserId": "3652338", "Text": "<terraform-provider-gcp><google-artifact-registry>", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "answers": [{"Id": "71607273", "PostTypeId": "2", "ParentId": "68861314", "CreationDate": "2022-03-24T17:53:46.720", "Score": "0", "Body": "<p>Using the <code>null_resource</code> resource to delay things provided a temporary fix:</p>\n<pre><code>resource &quot;google_artifact_registry_repository&quot; &quot;my_ar&quot; {\n  project = google_project.my_project.project_id\n  provider = google-beta\n  format = &quot;DOCKER&quot;\n  repository_id = &quot;myreponame&quot;\n  location = &quot;europe-west1&quot;\n  depends_on = [null_resource.delay]\n}\n\n# in many scenarios the above artifact registries are created while the apis are not yet active\n# this is a know issue: https://github.com/hashicorp/terraform-provider-google/issues/9902\n# and this delay buys some time before creating the above repositories.\nresource &quot;null_resource&quot; &quot;delay&quot; {\n  depends_on = [ google_project_service.artifactregistry_googleapis_com ]\n  provisioner &quot;local-exec&quot; {\n    command = &quot;sleep 120&quot;\n  }\n  triggers = {\n    project = google_project. my_project.id\n  }\n}\n</code></pre>\n", "OwnerUserId": "3652338", "LastActivityDate": "2022-03-24T17:53:46.720", "CommentCount": "0", "ContentLicense": "CC BY-SA 4.0", "history": [{"Id": "266726277", "PostHistoryTypeId": "2", "PostId": "71607273", "RevisionGUID": "42389803-65a0-4090-88cc-cf2f357c4d1d", "CreationDate": "2022-03-24T17:53:46.720", "UserId": "3652338", "Text": "Using the `null_resource` resource to delay things provided a temporary fix:\r\n```\r\nresource \"google_artifact_registry_repository\" \"my_ar\" {\r\n  project = google_project.my_project.project_id\r\n  provider = google-beta\r\n  format = \"DOCKER\"\r\n  repository_id = \"myreponame\"\r\n  location = \"europe-west1\"\r\n  depends_on = [null_resource.delay]\r\n}\r\n\r\n# in many scenarios the above artifact registries are created while the apis are not yet active\r\n# this is a know issue: https://github.com/hashicorp/terraform-provider-google/issues/9902\r\n# and this delay buys some time before creating the above repositories.\r\nresource \"null_resource\" \"delay\" {\r\n  depends_on = [ google_project_service.artifactregistry_googleapis_com ]\r\n  provisioner \"local-exec\" {\r\n    command = \"sleep 120\"\r\n  }\r\n  triggers = {\r\n    project = google_project. my_project.id\r\n  }\r\n}\r\n```", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "Using the `null_resource` resource to delay things provided a temporary fix: ``` resource \"google_artifact_registry_repository\" \"my_ar\" { project = google_project.my_project.project_id provider = google-beta format = \"DOCKER\" repository_id = \"myreponame\" location = \"europe-west1\" depends_on = [null_resource.delay] } # in many scenarios the above artifact registries are created while the apis are not yet active # this is a know issue: https://github.com/hashicorp/terraform-provider-google/issues/9902 # and this delay buys some time before creating the above repositories. resource \"null_resource\" \"delay\" { depends_on = [ google_project_service.artifactregistry_googleapis_com ] provisioner \"local-exec\" { command = \"sleep 120\" } triggers = { project = google_project. my_project.id } } ```", "keywords": ["provider"]}]}], "filtered-sentences": []}, {"Id": "76823812", "PostTypeId": "2", "ParentId": "68861314", "CreationDate": "2023-08-02T22:09:06.987", "Score": "0", "Body": "<p>More elegant alternative to <code>null_resource</code> for resources that need time to provision is <a href=\"https://registry.terraform.io/providers/hashicorp/time/latest/docs/resources/sleep.html\" rel=\"nofollow noreferrer\">time_sleep</a> resource:</p>\n<pre><code>resource &quot;google_project&quot; &quot;my_project&quot; {...}\n\nresource &quot;time_sleep&quot; &quot;wait-for-my_project&quot; {\n  create_duration = &quot;30s&quot;\n  depends_on = [google_project.my_project]\n}\n\nresource &quot;google_artifact_registry_repository&quot; &quot;my_ar&quot; {\n  ...\n  depends_on = [time_sleep.wait-for-my_project]\n}\n\n# ...etc.\n</code></pre>\n", "OwnerUserId": "2105269", "LastActivityDate": "2023-08-02T22:09:06.987", "CommentCount": "0", "ContentLicense": "CC BY-SA 4.0", "history": [{"Id": "296185481", "PostHistoryTypeId": "2", "PostId": "76823812", "RevisionGUID": "a35c490e-5e8c-4d1c-bfa2-fba75d08ca2c", "CreationDate": "2023-08-02T22:09:06.987", "UserId": "2105269", "Text": "More elegant alternative to `null_resource` for resources that need time to provision is [time_sleep][1] resource:\r\n\r\n```\r\nresource \"google_project\" \"my_project\" {...}\r\n\r\nresource \"time_sleep\" \"wait-for-my_project\" {\r\n  create_duration = \"30s\"\r\n  depends_on = [google_project.my_project]\r\n}\r\n\r\nresource \"google_artifact_registry_repository\" \"my_ar\" {\r\n  ...\r\n  depends_on = [time_sleep.wait-for-my_project]\r\n}\r\n\r\n# ...etc.\r\n```\r\n\r\n  [1]: https://registry.terraform.io/providers/hashicorp/time/latest/docs/resources/sleep.html", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "filtered-sentences": []}], "contains-topic": true, "filtered-sentences": []}