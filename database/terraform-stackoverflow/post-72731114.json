{"Id": "72731114", "PostTypeId": "1", "CreationDate": "2022-06-23T13:36:09.150", "Score": "1", "ViewCount": "611", "Body": "<p>How can I prevent terraform from destroying and recreating azure vm extensions? Life cycle code block isn't working. Terraform persists on destroying the resources and fails when I have the locks enabled. Please can someone tell me where I am going wrong with this</p>\n<p>This is my code</p>\n<pre><code>resource &quot;azurerm_virtual_machine_extension&quot; &quot;dsc&quot; {\n  for_each = var.dsc_agent_name\n\n  name                       = each.key\n  virtual_machine_id         = each.value\n  publisher                  = &quot;Microsoft.Powershell&quot;\n  type                       = &quot;DSC&quot;\n  type_handler_version       = &quot;2.0&quot;\n  auto_upgrade_minor_version = &quot;true&quot;\n  tags                       = local.tags\n  lifecycle {\n    prevent_destroy = true\n  }\n\n  settings = &lt;&lt;SETTINGS\n        {\n            &quot;ModulesUrl&quot;:&quot;&quot;,\n            &quot;SasToken&quot;:&quot;&quot;,\n            &quot;WmfVersion&quot;: &quot;latest&quot;,\n            &quot;Privacy&quot;: {\n                &quot;DataCollection&quot;: &quot;&quot;\n            },\n            &quot;ConfigurationFunction&quot;:&quot;&quot;\n        }\n    SETTINGS\n}\n</code></pre>\n", "OwnerUserId": "12805329", "LastEditorUserId": "12805329", "LastEditDate": "2022-06-23T14:09:01.317", "LastActivityDate": "2022-06-24T14:58:43.867", "Title": "How can I prevent terraform from destroying and recreating vm azure vm extensions. Life cycle block isn't working", "Tags": "<azure><terraform><azure-pipelines><virtual-machine>", "AnswerCount": "3", "CommentCount": "14", "ContentLicense": "CC BY-SA 4.0", "comments": [{"Id": "128467937", "PostId": "72731114", "Score": "1", "Text": "Please do not post sreenshots, they cannot be reproduced.", "CreationDate": "2022-06-23T14:04:01.163", "UserId": "8343484", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "128468070", "PostId": "72731114", "Score": "0", "Text": "@MarkoE I have added updated my post", "CreationDate": "2022-06-23T14:09:45.630", "UserId": "12805329", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "128468659", "PostId": "72731114", "Score": "0", "Text": "Did the value of the variable used in `for_each` change?", "CreationDate": "2022-06-23T14:33:38.170", "UserId": "8343484", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "Did the value of the variable used in `for_each` change?", "keywords": ["change"]}]}, {"Id": "128469648", "PostId": "72731114", "Score": "0", "Text": "@MarkoE No, it's always been the same. Haven't changed it", "CreationDate": "2022-06-23T15:14:31.903", "UserId": "12805329", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "Haven't changed it", "keywords": ["change"]}]}, {"Id": "128469737", "PostId": "72731114", "Score": "0", "Text": "How about `tags`?", "CreationDate": "2022-06-23T15:18:02.800", "UserId": "8343484", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "128469908", "PostId": "72731114", "Score": "0", "Text": "@MarkoE No, tags haven't changed. These are the tags stated whenever it runs \n\n locals {\n  tags = {\n    bill-to       = \"Finance\"\n    created-by    = \"John Doe\"\n    creation-date = \"06/06/2022\"\n    environment   = \"CORE\"\n    Service       = \"Virtual Machine Extensions\"\n    Role          = \"Extension for updating virtual machines\"\n  }\n}", "CreationDate": "2022-06-23T15:25:13.563", "UserId": "12805329", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "No, tags haven't changed. ", "keywords": ["change"]}, {"source": "Text", "text": "These are the tags stated whenever it runs locals { tags = { bill-to = \"Finance\" created-by = \"John Doe\" creation-date = \"06/06/2022\" environment = \"CORE\" Service = \"Virtual Machine Extensions\" Role = \"Extension for updating virtual machines\" } }", "keywords": ["bill"]}]}, {"Id": "128470212", "PostId": "72731114", "Score": "0", "Text": "@MarkoE This is what's showing from the logs \n\n - auto_upgrade_minor_version = false -> null\n      - automatic_upgrade_enabled  = false -> null", "CreationDate": "2022-06-23T15:37:23.687", "UserId": "12805329", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "128470542", "PostId": "72731114", "Score": "0", "Text": "Ah, it's probably a change in the API. Add those two arguments and set them to `false` and it shouldn't try to destroy it anymore.", "CreationDate": "2022-06-23T15:52:20.057", "UserId": "8343484", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "Ah, it's probably a change in the API. ", "keywords": ["change"]}]}, {"Id": "128485237", "PostId": "72731114", "Score": "0", "Text": "@MarkoE So i have updated as per your suggestion and now it's showing this in the logs \n\n-/+ resource \"azurerm_virtual_machine_extension\" \"VMDiagnosticsSettings\" {", "CreationDate": "2022-06-24T09:27:14.223", "UserId": "12805329", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "128485830", "PostId": "72731114", "Score": "0", "Text": "And what was it previously, an in-place update? I saw that you have already set one of the arguments to `true`, so leave that one, add the second one that is missing from the resource, set it to `false` and remove the `lifecycle` to see what happens.", "CreationDate": "2022-06-24T09:57:18.950", "UserId": "8343484", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "128488073", "PostId": "72731114", "Score": "0", "Text": "@MarkoE I tried it and it's still persisting on destroying/recreating them. The issue with this is I need to make sure all my resources within the subscription are locked but this won't let me as it is forcing on destroying the resources :(", "CreationDate": "2022-06-24T11:42:08.153", "UserId": "12805329", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "128490032", "PostId": "72731114", "Score": "0", "Text": "Can you post the `terraform plan` output? That might be helpful to figure out where or why does it want to recreate it. Btw, do you happen to have `.terraform.lock.hcl` file and do you know with which version of the Azure provider has this initially been created?", "CreationDate": "2022-06-24T13:06:35.147", "UserId": "8343484", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "Btw, do you happen to have `.terraform.lock.hcl` file and do you know with which version of the Azure provider has this initially been created?", "keywords": ["provider"]}]}, {"Id": "128490705", "PostId": "72731114", "Score": "0", "Text": "@MarkoE its being created 2.99.0 hashicorp/azurerm. The output has some sensitive information like subs id so might be worth posting it here", "CreationDate": "2022-06-24T13:34:05.427", "UserId": "12805329", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "128494922", "PostId": "72731114", "Score": "0", "Text": "Sure, if you can't omit it from the output when pasting here, than don't. :)", "CreationDate": "2022-06-24T17:00:28.687", "UserId": "8343484", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "history": [{"Id": "272839564", "PostHistoryTypeId": "2", "PostId": "72731114", "RevisionGUID": "b4e3ea4e-a0c9-4fb9-a850-7b7ee0b931d9", "CreationDate": "2022-06-23T13:36:09.150", "UserId": "12805329", "Text": "How can I prevent terraform from destroying and recreating azure vm extensions? Life cycle code block isn't working. Terraform persists on destroying the resources and fails when I have the locks enabled. \r\n\r\nThis is my code\r\n\r\n[enter image description here][1]\r\n\r\n\r\n  [1]: https://i.stack.imgur.com/y2fje.png", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "272839566", "PostHistoryTypeId": "1", "PostId": "72731114", "RevisionGUID": "b4e3ea4e-a0c9-4fb9-a850-7b7ee0b931d9", "CreationDate": "2022-06-23T13:36:09.150", "UserId": "12805329", "Text": "How can I prevent terraform from destroying and recreating vm azure vm extensions. Life cycle block isn't working", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "272839567", "PostHistoryTypeId": "3", "PostId": "72731114", "RevisionGUID": "b4e3ea4e-a0c9-4fb9-a850-7b7ee0b931d9", "CreationDate": "2022-06-23T13:36:09.150", "UserId": "12805329", "Text": "<azure><terraform><azure-pipelines><virtual-machine>", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "272842173", "PostHistoryTypeId": "5", "PostId": "72731114", "RevisionGUID": "68a80fc6-d694-4f26-bdee-b03dc3bc9a7c", "CreationDate": "2022-06-23T14:09:01.317", "UserId": "12805329", "Comment": "added 807 characters in body", "Text": "How can I prevent terraform from destroying and recreating azure vm extensions? Life cycle code block isn't working. Terraform persists on destroying the resources and fails when I have the locks enabled. Please can someone tell me where I am going wrong with this\r\n\r\nThis is my code\r\n\r\n    resource \"azurerm_virtual_machine_extension\" \"dsc\" {\r\n      for_each = var.dsc_agent_name\r\n    \r\n      name                       = each.key\r\n      virtual_machine_id         = each.value\r\n      publisher                  = \"Microsoft.Powershell\"\r\n      type                       = \"DSC\"\r\n      type_handler_version       = \"2.0\"\r\n      auto_upgrade_minor_version = \"true\"\r\n      tags                       = local.tags\r\n      lifecycle {\r\n        prevent_destroy = true\r\n      }\r\n    \r\n      settings = <<SETTINGS\r\n            {\r\n                \"ModulesUrl\":\"\",\r\n                \"SasToken\":\"\",\r\n                \"WmfVersion\": \"latest\",\r\n                \"Privacy\": {\r\n                    \"DataCollection\": \"\"\r\n                },\r\n                \"ConfigurationFunction\":\"\"\r\n            }\r\n        SETTINGS\r\n    }\r\n    \r\n    ", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "answers": [{"Id": "72732881", "PostTypeId": "2", "ParentId": "72731114", "CreationDate": "2022-06-23T15:36:38.213", "Score": "0", "Body": "<p>Try removing the lifecycle block and then run 'terraform plan' - it should then show you which configuration item is causing it to be destroyed / re-created</p>\n", "OwnerUserId": "12774330", "LastActivityDate": "2022-06-23T15:36:38.213", "CommentCount": "1", "ContentLicense": "CC BY-SA 4.0", "comments": [{"Id": "128485260", "PostId": "72732881", "Score": "0", "Text": "I have done it and showing \n\n-/+ resource \"azurerm_virtual_machine_extension\" \"VMDiagnosticsSettings\" {", "CreationDate": "2022-06-24T09:28:22.987", "UserId": "12805329", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "history": [{"Id": "272848986", "PostHistoryTypeId": "2", "PostId": "72732881", "RevisionGUID": "bc471b4b-f87a-4583-8b1f-f371006ced9a", "CreationDate": "2022-06-23T15:36:38.213", "UserId": "12774330", "Text": "Try removing the lifecycle block and then run 'terraform plan' - it should then show you which configuration item is causing it to be destroyed / re-created ", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "filtered-sentences": []}, {"Id": "72745945", "PostTypeId": "2", "ParentId": "72731114", "CreationDate": "2022-06-24T14:58:43.867", "Score": "0", "Body": "<p>Managed to resolve this - I basically used ignore changes on all the properties\nMassive thanks to @MarkoE and AC81</p>\n", "OwnerUserId": "12805329", "LastActivityDate": "2022-06-24T14:58:43.867", "CommentCount": "1", "ContentLicense": "CC BY-SA 4.0", "comments": [{"Id": "128543262", "PostId": "72745945", "Score": "0", "Text": "Your answer could be improved with additional supporting information. Please [edit] to add further details, such as citations or documentation, so that others can confirm that your answer is correct. You can find more information on how to write good answers [in the help center](/help/how-to-answer).", "CreationDate": "2022-06-27T15:39:07.730", "UserId": "-1", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "history": [{"Id": "272918440", "PostHistoryTypeId": "2", "PostId": "72745945", "RevisionGUID": "e3787b48-d145-42b9-a594-62cd9b91d51f", "CreationDate": "2022-06-24T14:58:43.867", "UserId": "12805329", "Text": "Managed to resolve this - I basically used ignore changes on all the properties\r\nMassive thanks to @MarkoE and AC81", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "Managed to resolve this - I basically used ignore changes on all the properties Massive thanks to @MarkoE and AC81", "keywords": ["change"]}]}], "filtered-sentences": [{"source": "Body", "text": "Managed to resolve this - I basically used ignore changes on all the properties Massive thanks to @MarkoE and AC81", "keywords": ["change"]}]}, {"Id": "72744897", "PostTypeId": "2", "ParentId": "72731114", "CreationDate": "2022-06-24T13:35:06.307", "Score": "1", "Body": "<p>You can try to put an ignore section in:</p>\n<pre><code>lifecycle {\n    prevent_destroy = true\n    ignore_changes = [ VMDiagnosticsSettings ]\n}\n</code></pre>\n<p>That way it will ignore what has been set on the resource in Azure with what is being declared (if anything for this section) in TF</p>\n", "OwnerUserId": "12774330", "LastActivityDate": "2022-06-24T13:35:06.307", "CommentCount": "1", "ContentLicense": "CC BY-SA 4.0", "comments": [{"Id": "128491216", "PostId": "72744897", "Score": "1", "Text": "I don't this would work as ignore_changes property only requires a specific attribute not specifying the whole resource name. Please correct me if im wrong", "CreationDate": "2022-06-24T13:56:53.020", "UserId": "12805329", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "history": [{"Id": "272912829", "PostHistoryTypeId": "2", "PostId": "72744897", "RevisionGUID": "d2c67536-64f9-4164-84c2-b2d2b0760bbc", "CreationDate": "2022-06-24T13:35:06.307", "UserId": "12774330", "Text": "You can try to put an ignore section in:  \r\n\r\n    lifecycle {\r\n        prevent_destroy = true\r\n        ignore_changes = [ VMDiagnosticsSettings ]\r\n    }\r\n\r\nThat way it will ignore what has been set on the resource in Azure with what is being declared (if anything for this section) in TF", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "filtered-sentences": []}], "contains-topic": true, "filtered-sentences": []}