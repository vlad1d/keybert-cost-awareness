{"Id": "57497584", "PostTypeId": "1", "CreationDate": "2019-08-14T15:16:39.270", "Score": "0", "ViewCount": "417", "Body": "<p>I read this article on using Terraform with GCP:</p>\n\n<p><a href=\"https://cloud.google.com/community/tutorials/managing-gcp-projects-with-terraform\" rel=\"nofollow noreferrer\">https://cloud.google.com/community/tutorials/managing-gcp-projects-with-terraform</a></p>\n\n<p>I almost have it working, but I ran into some issues and wanted some clarification. </p>\n\n<p>I made a terraform admin project, and made a service account in that project with the roles/viewer and roles/storage.admin roles. I then made a bucket in the admin project and use that as the terraform backend storage.</p>\n\n<pre><code>terraform {                                                                                                                                                                                                        \n  backend \"gcs\" {                                                                                                                                                                                                  \n    bucket      = \"test-terraform-admin-1\"                                                                                                                                                                         \n    prefix      = \"terraform/state\"                                                                                                                                                                                \n    credentials = \"service-account.json\"                                                                                                                                                                           \n  }                                                                                                                                                                                                                \n}\n</code></pre>\n\n<p>I then use that service account to create another project and provision resources in that project:</p>\n\n<pre><code>provider \"google\" {                                                                                                                                                                                                \n  alias       = \"company_a\"                                                                                                                                                                                    \n  credentials = \"./service-account.json\"                                                                                                                                                                           \n  region      = \"us-east4\"                                                                                                                                                                                         \n  zone        = \"us-east4-c\"                                                                                                                                                                                       \n  version = \"~&gt; 2.12\"                                                                                                                                                                                              \n}\n\nresource \"google_project\" \"project\" {                                                                                                                                                                              \n  name            = var.project_name                                                                                                                                                                               \n  project_id      = \"${random_id.id.hex}\"                                                                                                                                                                          \n  billing_account = \"${var.billing_account}\"                                                                                                                                                                       \n  org_id          = \"${var.org_id}\"                                                                                                                                                                                \n}\n</code></pre>\n\n<p>I thought that it would be sufficient to enable services for the project created with terraform like this:</p>\n\n<pre><code>resource \"google_project_service\" \"container_service\" {                                                                                                                                                            \n  project = \"${google_project.project.project_id}\"                                                                                                                                                                 \n  service = \"container.googleapis.com\"                                                                                                                                                                             \n}\n</code></pre>\n\n<p>However, I got an error when terraform tried to create my gke cluster:</p>\n\n<pre><code>resource \"google_container_cluster\" \"primary\" {                                                                                                                                                                    \n  project = \"${google_project.project.project_id}\"                                                                                                                                                                 \n  name    = \"main-gke-cluster\"                                                                                                                                                                                     \n\n  node_pool {                                                                                                                                                                                                      \n    ....\n  }                                                                                                                                                                                                             \n  network = \"${google_compute_network.vpc_network.self_link}\"                                                                                                                                                      \n}\n</code></pre>\n\n<p>It said that the container service was not enabled yet for my project, and it referenced the terraform admin project ID (not the project created with the google_project resource!). It seems that I have to enable the services on the terraform admin project in order for the service account to access those services on any projects created by the service account. </p>\n\n<p>In fact, I can get it working without ever enabling the container, servicenetworking, etc. services on the create project as long as they are enabled on the terraform admin project.</p>\n\n<p>Is there some parent/child relationship between the projects where services in one project are inherited by projects created from a service account in the parent project? This seems to be the case, but I cannot find any documentation about this anywhere. </p>\n\n<p>Thanks for listening!</p>\n", "OwnerUserId": "10365734", "LastActivityDate": "2019-08-14T18:49:19.860", "Title": "Need clarification on using Terraform to manage Google Cloud projects", "Tags": "<google-cloud-platform><terraform-provider-gcp>", "AnswerCount": "1", "CommentCount": "0", "ContentLicense": "CC BY-SA 4.0", "history": [{"Id": "203492367", "PostHistoryTypeId": "2", "PostId": "57497584", "RevisionGUID": "760fe2b2-c91e-4626-9f86-8322752bf556", "CreationDate": "2019-08-14T15:16:39.270", "UserId": "10365734", "Text": "I read this article on using Terraform with GCP:\r\n\r\nhttps://cloud.google.com/community/tutorials/managing-gcp-projects-with-terraform\r\n\r\nI almost have it working, but I ran into some issues and wanted some clarification. \r\n\r\nI made a terraform admin project, and made a service account in that project with the roles/viewer and roles/storage.admin roles. I then made a bucket in the admin project and use that as the terraform backend storage.\r\n\r\n```\r\nterraform {                                                                                                                                                                                                        \r\n  backend \"gcs\" {                                                                                                                                                                                                  \r\n    bucket      = \"test-terraform-admin-1\"                                                                                                                                                                         \r\n    prefix      = \"terraform/state\"                                                                                                                                                                                \r\n    credentials = \"service-account.json\"                                                                                                                                                                           \r\n  }                                                                                                                                                                                                                \r\n}\r\n```\r\n\r\nI then use that service account to create another project and provision resources in that project:\r\n\r\n```\r\nprovider \"google\" {                                                                                                                                                                                                \r\n  alias       = \"company_a\"                                                                                                                                                                                    \r\n  credentials = \"./service-account.json\"                                                                                                                                                                           \r\n  region      = \"us-east4\"                                                                                                                                                                                         \r\n  zone        = \"us-east4-c\"                                                                                                                                                                                       \r\n  version = \"~> 2.12\"                                                                                                                                                                                              \r\n}\r\n\r\nresource \"google_project\" \"project\" {                                                                                                                                                                              \r\n  name            = var.project_name                                                                                                                                                                               \r\n  project_id      = \"${random_id.id.hex}\"                                                                                                                                                                          \r\n  billing_account = \"${var.billing_account}\"                                                                                                                                                                       \r\n  org_id          = \"${var.org_id}\"                                                                                                                                                                                \r\n}\r\n```\r\n\r\nI thought that it would be sufficient to enable services for the project created with terraform like this:\r\n\r\n```                                                                                                                                                                                                                  \r\nresource \"google_project_service\" \"container_service\" {                                                                                                                                                            \r\n  project = \"${google_project.project.project_id}\"                                                                                                                                                                 \r\n  service = \"container.googleapis.com\"                                                                                                                                                                             \r\n}\r\n```\r\n\r\nHowever, I got an error when terraform tried to create my gke cluster:\r\n\r\n```\r\nresource \"google_container_cluster\" \"primary\" {                                                                                                                                                                    \r\n  project = \"${google_project.project.project_id}\"                                                                                                                                                                 \r\n  name    = \"main-gke-cluster\"                                                                                                                                                                                     \r\n                                                                                                                                                                                                                   \r\n  node_pool {                                                                                                                                                                                                      \r\n    ....\r\n  }                                                                                                                                                                                                             \r\n  network = \"${google_compute_network.vpc_network.self_link}\"                                                                                                                                                      \r\n}\r\n```\r\n\r\nIt said that the container service was not enabled yet for my project, and it referenced the terraform admin project ID (not the project created with the google_project resource!). It seems that I have to enable the services on the terraform admin project in order for the service account to access those services on any projects created by the service account. \r\n\r\nIn fact, I can get it working without ever enabling the container, servicenetworking, etc. services on the create project as long as they are enabled on the terraform admin project.\r\n\r\nIs there some parent/child relationship between the projects where services in one project are inherited by projects created from a service account in the parent project? This seems to be the case, but I cannot find any documentation about this anywhere. \r\n\r\nThanks for listening!\r\n", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "I made a terraform admin project, and made a service account in that project with the roles/viewer and roles/storage.admin roles. ", "keywords": ["storage"]}, {"source": "Text", "text": "I then made a bucket in the admin project and use that as the terraform backend storage. ", "keywords": ["storage"]}, {"source": "Text", "text": "``` terraform { backend \"gcs\" { bucket = \"test-terraform-admin-1\" prefix = \"terraform/state\" credentials = \"service-account.json\" } } ``` ", "keywords": ["test"]}, {"source": "Text", "text": "I then use that service account to create another project and provision resources in that project: ``` provider \"google\" { alias = \"company_a\" credentials = \"./service-account.json\" region = \"us-east4\" zone = \"us-east4-c\" version = \"~> 2.12\" } resource \"google_project\" \"project\" { name = var.project_name project_id = \"${random_id.id.hex}\" billing_account = \"${var.billing_account}\" org_id = \"${var.org_id}\" } ``` I thought that it would be sufficient to enable services for the project created with terraform like this: ``` resource \"google_project_service\" \"container_service\" { project = \"${google_project.project.project_id}\" service = \"container.googleapis.com\" } ``` However, I got an error when terraform tried to create my gke cluster: ``` resource \"google_container_cluster\" \"primary\" { project = \"${google_project.project.project_id}\" name = \"main-gke-cluster\" node_pool { .... } network = \"${google_compute_network.vpc_network.self_link}\" } ``` ", "keywords": ["bill", "provider", "cluster"]}]}, {"Id": "203492368", "PostHistoryTypeId": "1", "PostId": "57497584", "RevisionGUID": "760fe2b2-c91e-4626-9f86-8322752bf556", "CreationDate": "2019-08-14T15:16:39.270", "UserId": "10365734", "Text": "Need clarification on using Terraform to manage Google Cloud projects", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "203492369", "PostHistoryTypeId": "3", "PostId": "57497584", "RevisionGUID": "760fe2b2-c91e-4626-9f86-8322752bf556", "CreationDate": "2019-08-14T15:16:39.270", "UserId": "10365734", "Text": "<google-cloud-platform><terraform-provider-gcp>", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "answers": [{"Id": "57500440", "PostTypeId": "2", "ParentId": "57497584", "CreationDate": "2019-08-14T18:49:19.860", "Score": "1", "Body": "<p>In my company, we created a folder and a service account in this folder. Then, we created a project for terraform and each terraform job use the folder level service account for creating projects and resources into this folder. </p>\n\n<p>As the role and permission are inherited from folder to lower level (folders or projects) we don't have issue to create resources.</p>\n\n<p>I don't if it helps your specific issue, but for us, it solved a lot and simplify the service account management.</p>\n", "OwnerUserId": "11372593", "LastActivityDate": "2019-08-14T18:49:19.860", "CommentCount": "2", "ContentLicense": "CC BY-SA 4.0", "comments": [{"Id": "101502771", "PostId": "57500440", "Score": "0", "Text": "Interesting, I was not aware that service accounts could be bound to a folder. Thanks for the tip!", "CreationDate": "2019-08-16T00:00:07.217", "UserId": "10365734", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "101509986", "PostId": "57500440", "Score": "0", "Text": "Same thing for organisation level. And you can define role for user, group and user account at each level. Very interesting for supervisor team which need a while view on all projects. Add only a group, if a person leave the team/group, the authorization are automatically removed. It's powerful for resource administration", "CreationDate": "2019-08-16T08:53:22.930", "UserId": "11372593", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "history": [{"Id": "203504063", "PostHistoryTypeId": "2", "PostId": "57500440", "RevisionGUID": "87e4759e-9afc-4678-9446-4b525e07cbf5", "CreationDate": "2019-08-14T18:49:19.860", "UserId": "11372593", "Text": "In my company, we created a folder and a service account in this folder. Then, we created a project for terraform and each terraform job use the folder level service account for creating projects and resources into this folder. \r\n\r\nAs the role and permission are inherited from folder to lower level (folders or projects) we don't have issue to create resources.\r\n\r\nI don't if it helps your specific issue, but for us, it solved a lot and simplify the service account management.", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "filtered-sentences": []}], "contains-topic": true, "filtered-sentences": [{"source": "Body", "text": "I made a terraform admin project, and made a service account in that project with the roles/viewer and roles/storage.admin roles. ", "keywords": ["storage"]}, {"source": "Body", "text": "I then made a bucket in the admin project and use that as the terraform backend storage. ", "keywords": ["storage"]}, {"source": "Body", "text": "I then use that service account to create another project and provision resources in that project: I thought that it would be sufficient to enable services for the project created with terraform like this: However, I got an error when terraform tried to create my gke cluster: It said that the container service was not enabled yet for my project, and it referenced the terraform admin project ID (not the project created with the google_project resource!). ", "keywords": ["cluster"]}]}