{"Id": "46964397", "PostTypeId": "1", "AcceptedAnswerId": "47561362", "CreationDate": "2017-10-26T21:51:17.520", "Score": "0", "ViewCount": "371", "Body": "<p>I'm attempting to setup a Consul 1.0 cluster in ECS using Terraform. I am able to get Consul up and running as a cluster, but I am running into ACL errors, as documented <a href=\"https://www.consul.io/docs/guides/acl.html#create-an-agent-token\" rel=\"nofollow noreferrer\">here</a>. The problem I am having is running the associated curl scripts to create a token with the proper rules, saving that outputted token, and running it on every member of the autoscale group both for the first time and every time the group scales up. </p>\n\n<p>Does anyone have any suggestions on how to get this knocked out?</p>\n", "OwnerUserId": "1309452", "LastActivityDate": "2017-11-29T20:34:15.157", "Title": "Consul acl_agent_token setup on bootstrap", "Tags": "<amazon-web-services><terraform><consul>", "AnswerCount": "2", "CommentCount": "0", "ContentLicense": "CC BY-SA 3.0", "history": [{"Id": "159241649", "PostHistoryTypeId": "2", "PostId": "46964397", "RevisionGUID": "9c6a9395-7169-474b-96fe-4b96202fbbe4", "CreationDate": "2017-10-26T21:51:17.520", "UserId": "1309452", "Text": "I'm attempting to setup a Consul 1.0 cluster in ECS using Terraform. I am able to get Consul up and running as a cluster, but I am running into ACL errors, as documented [here][1]. The problem I am having is running the associated curl scripts to create a token with the proper rules, saving that outputted token, and running it on every member of the autoscale group both for the first time and every time the group scales up. \r\n\r\n\r\nDoes anyone have any suggestions on how to get this knocked out?\r\n\r\n  [1]: https://www.consul.io/docs/guides/acl.html#create-an-agent-token", "ContentLicense": "CC BY-SA 3.0", "filtered-sentences": [{"source": "Text", "text": "I'm attempting to setup a Consul 1.0 cluster in ECS using Terraform. ", "keywords": ["cluster"]}, {"source": "Text", "text": "I am able to get Consul up and running as a cluster, but I am running into ACL errors, as documented [here][1]. ", "keywords": ["cluster"]}]}, {"Id": "159241650", "PostHistoryTypeId": "1", "PostId": "46964397", "RevisionGUID": "9c6a9395-7169-474b-96fe-4b96202fbbe4", "CreationDate": "2017-10-26T21:51:17.520", "UserId": "1309452", "Text": "Consul acl_agent_token setup on bootstrap", "ContentLicense": "CC BY-SA 3.0", "filtered-sentences": []}, {"Id": "159241651", "PostHistoryTypeId": "3", "PostId": "46964397", "RevisionGUID": "9c6a9395-7169-474b-96fe-4b96202fbbe4", "CreationDate": "2017-10-26T21:51:17.520", "UserId": "1309452", "Text": "<amazon-web-services><terraform><consul>", "ContentLicense": "CC BY-SA 3.0", "filtered-sentences": []}], "answers": [{"Id": "47116615", "PostTypeId": "2", "ParentId": "46964397", "CreationDate": "2017-11-04T23:22:35.863", "Score": "0", "Body": "<p>One way of implementing this is storing the created token in Vault or S3 (encrypted with KMS) add a few lines to user data to retrieve it back, locking it down with the appropriate IAM policies.</p>\n", "OwnerUserId": "1869360", "LastActivityDate": "2017-11-04T23:22:35.863", "CommentCount": "1", "ContentLicense": "CC BY-SA 3.0", "comments": [{"Id": "82080345", "PostId": "47116615", "Score": "0", "Text": "This definitely worked, but it was less expensive (compute) to do this in the SSM Parameter Store.", "CreationDate": "2017-11-29T20:34:50.700", "UserId": "1309452", "ContentLicense": "CC BY-SA 3.0", "filtered-sentences": [{"source": "Text", "text": "This definitely worked, but it was less expensive (compute) to do this in the SSM Parameter Store.", "keywords": ["expense"]}]}], "history": [{"Id": "159881485", "PostHistoryTypeId": "2", "PostId": "47116615", "RevisionGUID": "47a8b847-8a1c-475b-b557-5e6218ffd628", "CreationDate": "2017-11-04T23:22:35.863", "UserId": "1869360", "Text": "One way of implementing this is storing the created token in Vault or S3 (encrypted with KMS) add a few lines to user data to retrieve it back, locking it down with the appropriate IAM policies.", "ContentLicense": "CC BY-SA 3.0", "filtered-sentences": []}], "filtered-sentences": []}, {"Id": "47561362", "PostTypeId": "2", "ParentId": "46964397", "CreationDate": "2017-11-29T20:34:15.157", "Score": "1", "Body": "<p>So what I ended up doing was creating a lambda script to handle 2 types of events: bootstrap and adding new nodes, which is triggered by either a local_exec in TF (bootstrap) or an autoscaling group sns notification (add new node). The bootstrap function stored the acl_agent_token in an SSM Parameter Store and applied it initially to the members of the cluster. The function that adds new nodes queries the parameter store and adds the node via the rest api.</p>\n", "OwnerUserId": "1309452", "LastActivityDate": "2017-11-29T20:34:15.157", "CommentCount": "0", "ContentLicense": "CC BY-SA 3.0", "history": [{"Id": "161726256", "PostHistoryTypeId": "2", "PostId": "47561362", "RevisionGUID": "858e10d9-a354-44d9-8d14-8590432a21dc", "CreationDate": "2017-11-29T20:34:15.157", "UserId": "1309452", "Text": "So what I ended up doing was creating a lambda script to handle 2 types of events: bootstrap and adding new nodes, which is triggered by either a local_exec in TF (bootstrap) or an autoscaling group sns notification (add new node). The bootstrap function stored the acl_agent_token in an SSM Parameter Store and applied it initially to the members of the cluster. The function that adds new nodes queries the parameter store and adds the node via the rest api.", "ContentLicense": "CC BY-SA 3.0", "filtered-sentences": [{"source": "Text", "text": "The bootstrap function stored the acl_agent_token in an SSM Parameter Store and applied it initially to the members of the cluster. ", "keywords": ["cluster"]}]}], "filtered-sentences": [{"source": "Body", "text": "The bootstrap function stored the acl_agent_token in an SSM Parameter Store and applied it initially to the members of the cluster. ", "keywords": ["cluster"]}]}], "contains-topic": true, "filtered-sentences": [{"source": "Body", "text": "I'm attempting to setup a Consul 1.0 cluster in ECS using Terraform. ", "keywords": ["cluster"]}, {"source": "Body", "text": "I am able to get Consul up and running as a cluster, but I am running into ACL errors, as documented here. ", "keywords": ["cluster"]}]}