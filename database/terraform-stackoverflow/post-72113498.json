{"Id": "72113498", "PostTypeId": "1", "CreationDate": "2022-05-04T13:07:34.013", "Score": "0", "ViewCount": "506", "Body": "<p>I have a container running in ECS and it's using boto3 to connect to <code>ssm.us-east-2.amazonaws.com</code>. The connection is timing out. The container is using network mode <code>awsvpc</code> and I don't have a NAT Gateway. I thought this wouldn't be a problem since the EC2 instance and the container are both in a public subnet\u2026 but I could be wrong. When I ssh into the EC2 instance that's running the container, I'm able to ping the ssm host, but somehow the container can't reach it.</p>\n<p>I had a situation last month where a container was relaunching repeatedly and accessing ECR through a NAT Gateway, and the result was terabytes of traffic and a huge bill. I'd really like to avoid using a NAT Gateway if possible.</p>\n<p>How do I diagnose the problem here? The app is quitting immediately because it fails to access AWS SSM. Here is the security group for the EC2 instance:</p>\n<pre class=\"lang-hcl prettyprint-override\"><code>module &quot;sg&quot; {\n  source  = &quot;cloudposse/security-group/aws&quot;\n  version = &quot;0.4.3&quot;\n\n  # Allow unlimited egress\n  allow_all_egress = true\n\n  rules_map = {\n    &quot;API&quot; = [{\n      type        = &quot;ingress&quot;\n      from_port   = 5050\n      to_port     = 5050\n      protocol    = &quot;tcp&quot;\n      cidr_blocks = module.subnets.public_subnet_cidrs\n      self        = null\n      description = &quot;Allow calling API (HTTP) from IPs in our public subnets (which includes the ALB)&quot;\n    }],\n    &quot;SSH&quot; = [{\n      type        = &quot;ingress&quot;\n      from_port   = 22\n      to_port     = 22\n      protocol    = &quot;tcp&quot;\n      cidr_blocks = [&quot;0.0.0.0/0&quot;]\n      self        = null\n      description = &quot;Allow SSH from all IPs&quot;\n    }]\n  }\n\n  vpc_id  = module.vpc.vpc_id\n  context = module.this.context\n}\n</code></pre>\n<p>I'm also using this security group with the <code>ecs-alb-service-task</code> I declared in <a href=\"https://stackoverflow.com/q/72086037/1749551\">a previous question</a>. I am not sure whether the problem is with a security group, the networking mode, or something else. The AWS documentation on network modes strongly suggests that <code>awsvpc</code> is the preferred mode, but I still don't really understand the implications or how to pick the right one. I have also tried using the default mode (<code>bridge</code> since I'm on Amazon Linux) and I get the same error.</p>\n", "OwnerUserId": "1749551", "LastEditorUserId": "712765", "LastEditDate": "2022-08-24T19:42:36.857", "LastActivityDate": "2022-08-24T19:42:36.857", "Title": "ECS container in public subnet cannot connect to a public AWS SSM service", "Tags": "<amazon-web-services><terraform><amazon-ecs><amazon-vpc><cloudposse>", "AnswerCount": "0", "CommentCount": "4", "ContentLicense": "CC BY-SA 4.0", "comments": [{"Id": "127417686", "PostId": "72113498", "Score": "1", "Text": "The security group allows all egress, so that isn't your issue. My first guess is the ECS task isn't receiving a public IP address. In your `cloudposse/ecs-alb-service-task/aws` that I saw you using in your previous question, you would need to set `assign_public_ip = true`.", "CreationDate": "2022-05-04T13:12:10.453", "UserId": "13070", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "127420137", "PostId": "72113498", "Score": "0", "Text": "Thank you for the suggestion. I have tried to enable that, but [it wouldn't accept it](https://github.com/aws/aws-cdk/issues/13348#issuecomment-791061624) with `network_mode = \"awsvpc\"`. So then I tried changing the `network_mode` to `null` [as specified by the docs](https://registry.terraform.io/modules/cloudposse/ecs-alb-service-task/aws/latest#input_network_mode), but the Apply is still failling with \"Network Configuration must be provided when networkMode 'awsvpc' is specified\". But I'm not specifying `awsvpc` anymore!", "CreationDate": "2022-05-04T14:44:02.683", "UserId": "1749551", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "So then I tried changing the `network_mode` to `null` [as specified by the docs](https://registry.terraform.io/modules/cloudposse/ecs-alb-service-task/aws/latest#input_network_mode), but the Apply is still failling with \"Network Configuration must be provided when networkMode 'awsvpc' is specified\"", "keywords": ["change"]}]}, {"Id": "127420574", "PostId": "72113498", "Score": "0", "Text": "I didn't realize that limitation existed. I've long since switched everything from EC2 deployments to Fargate on the projects I work on. It looks like if you are using EC2 deployments you are stuck using a NAT Gateway, or you need to create a VPC Endpoint for SSM.", "CreationDate": "2022-05-04T15:00:15.637", "UserId": "13070", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "It looks like if you are using EC2 deployments you are stuck using a NAT Gateway, or you need to create a VPC Endpoint for SSM.", "keywords": ["nat"]}]}, {"Id": "127426533", "PostId": "72113498", "Score": "0", "Text": "Thanks for the advice. I have switched to Fargate, which TBH wasn't that difficult, and it's working now.", "CreationDate": "2022-05-04T19:37:43.040", "UserId": "1749551", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "links": [{"Id": "1971206429", "CreationDate": "2022-05-04T13:07:34.013", "PostId": "72113498", "RelatedPostId": "72086037", "LinkTypeId": "1"}], "history": [{"Id": "269463003", "PostHistoryTypeId": "2", "PostId": "72113498", "RevisionGUID": "265bcffc-f594-49ee-8d39-4f0473fbf1bf", "CreationDate": "2022-05-04T13:07:34.013", "UserId": "1749551", "Text": "I have a container running in ECS and it's using boto3 to connect to `ssm.us-east-2.amazonaws.com`. The connection is timing out. The container is using network mode `awsvpc` and I don't have a NAT Gateway. I thought this wouldn't be a problem since the EC2 instance and the container are both in a public subnet\u2026 but I could be wrong. When I ssh into the EC2 instance that's running the container, I'm able to ping the ssm host, but somehow the container can't reach it.\r\n\r\nI had a situation last month where a container was relaunching repeatedly and accessing ECR through a NAT Gateway, and the result was terabytes of traffic and a huge bill. I'd really like to avoid using a NAT Gateway if possible.\r\n\r\nHow do I diagnose the problem here? The app is quitting immediately because it fails to access AWS SSM. Here is the security group for the EC2 instance:\r\n\r\n```lang-hcl\r\nmodule \"sg\" {\r\n  source  = \"cloudposse/security-group/aws\"\r\n  version = \"0.4.3\"\r\n\r\n  # Allow unlimited egress\r\n  allow_all_egress = true\r\n\r\n  rules_map = {\r\n    \"API\" = [{\r\n      type        = \"ingress\"\r\n      from_port   = 5050\r\n      to_port     = 5050\r\n      protocol    = \"tcp\"\r\n      cidr_blocks = module.subnets.public_subnet_cidrs\r\n      self        = null\r\n      description = \"Allow calling API (HTTP) from IPs in our public subnets (which includes the ALB)\"\r\n    }],\r\n    \"SSH\" = [{\r\n      type        = \"ingress\"\r\n      from_port   = 22\r\n      to_port     = 22\r\n      protocol    = \"tcp\"\r\n      cidr_blocks = [\"0.0.0.0/0\"]\r\n      self        = null\r\n      description = \"Allow SSH from all IPs\"\r\n    }]\r\n  }\r\n\r\n  vpc_id  = module.vpc.vpc_id\r\n  context = module.this.context\r\n}\r\n```\r\n\r\nI'm also using this security group with the `ecs-alb-service-task` I declared in [a previous question][1]. I am not sure whether the problem is with a security group, the networking mode, or something else. The AWS documentation on network modes strongly suggests that `awsvpc` is the preferred mode, but I still don't really understand the implications or how to pick the right one. I have also tried using the default mode (`bridge` since I'm on Amazon Linux) and I get the same error.\r\n\r\n\r\n  [1]: https://stackoverflow.com/q/72086037/1749551", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": [{"source": "Text", "text": "The container is using network mode `awsvpc` and I don't have a NAT Gateway. ", "keywords": ["nat", "billing mode"]}, {"source": "Text", "text": "I thought this wouldn't be a problem since the EC2 instance and the container are both in a public subnet\u2026 but I could be wrong. ", "keywords": ["instance"]}, {"source": "Text", "text": "When I ssh into the EC2 instance that's running the container, I'm able to ping the ssm host, but somehow the container can't reach it. ", "keywords": ["instance"]}, {"source": "Text", "text": "I had a situation last month where a container was relaunching repeatedly and accessing ECR through a NAT Gateway, and the result was terabytes of traffic and a huge bill. ", "keywords": ["bill", "nat"]}, {"source": "Text", "text": "I'd really like to avoid using a NAT Gateway if possible. ", "keywords": ["nat"]}, {"source": "Text", "text": "Here is the security group for the EC2 instance: ```lang-hcl module \"sg\" { source = \"cloudposse/security-group/aws\" version = \"0.4.3\" # Allow unlimited egress allow_all_egress = true rules_map = { \"API\" = [{ type = \"ingress\" from_port = 5050 to_port = 5050 protocol = \"tcp\" cidr_blocks = module.subnets.public_subnet_cidrs self = null description = \"Allow calling API (HTTP) from IPs in our public subnets (which includes the ALB)\" }], \"SSH\" = [{ type = \"ingress\" from_port = 22 to_port = 22 protocol = \"tcp\" cidr_blocks = [\"0.0.0.0/0\"] self = null description = \"Allow SSH from all IPs\" }] } vpc_id = module.vpc.vpc_id context = module.this.context } ``` I'm also using this security group with the `ecs-alb-service-task` ", "keywords": ["instance"]}, {"source": "Text", "text": "I am not sure whether the problem is with a security group, the networking mode, or something else. ", "keywords": ["networking", "billing mode"]}, {"source": "Text", "text": "The AWS documentation on network modes strongly suggests that `awsvpc` is the preferred mode, but I still don't really understand the implications or how to pick the right one. ", "keywords": ["billing mode"]}, {"source": "Text", "text": "I have also tried using the default mode (`bridge` since I'm on Amazon Linux) and I get the same error. ", "keywords": ["billing mode"]}]}, {"Id": "269463005", "PostHistoryTypeId": "1", "PostId": "72113498", "RevisionGUID": "265bcffc-f594-49ee-8d39-4f0473fbf1bf", "CreationDate": "2022-05-04T13:07:34.013", "UserId": "1749551", "Text": "ECS container in public subnet cannot connect to a public AWS SSM service", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "269463006", "PostHistoryTypeId": "3", "PostId": "72113498", "RevisionGUID": "265bcffc-f594-49ee-8d39-4f0473fbf1bf", "CreationDate": "2022-05-04T13:07:34.013", "UserId": "1749551", "Text": "<amazon-web-services><terraform><terraform-provider-aws>", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "269463076", "PostHistoryTypeId": "6", "PostId": "72113498", "RevisionGUID": "12f55fd0-1229-4aec-a2d0-78a68409a11c", "CreationDate": "2022-05-04T13:08:34.020", "UserId": "13070", "Comment": "edited tags", "Text": "<amazon-web-services><terraform><amazon-ecs><terraform-provider-aws><amazon-vpc>", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}, {"Id": "276907963", "PostHistoryTypeId": "6", "PostId": "72113498", "RevisionGUID": "276ec7a6-756d-46c5-ae58-169dc6d53202", "CreationDate": "2022-08-24T19:42:36.857", "UserId": "712765", "Comment": "edited tags", "Text": "<amazon-web-services><terraform><amazon-ecs><amazon-vpc><cloudposse>", "ContentLicense": "CC BY-SA 4.0", "filtered-sentences": []}], "contains-topic": true, "filtered-sentences": [{"source": "Body", "text": "The container is using network mode awsvpc and I don't have a NAT Gateway. ", "keywords": ["nat", "billing mode"]}, {"source": "Body", "text": "I thought this wouldn't be a problem since the EC2 instance and the container are both in a public subnet\u2026 but I could be wrong. ", "keywords": ["instance"]}, {"source": "Body", "text": "When I ssh into the EC2 instance that's running the container, I'm able to ping the ssm host, but somehow the container can't reach it. ", "keywords": ["instance"]}, {"source": "Body", "text": "I had a situation last month where a container was relaunching repeatedly and accessing ECR through a NAT Gateway, and the result was terabytes of traffic and a huge bill. ", "keywords": ["bill", "nat"]}, {"source": "Body", "text": "I'd really like to avoid using a NAT Gateway if possible. ", "keywords": ["nat"]}, {"source": "Body", "text": "Here is the security group for the EC2 instance: I'm also using this security group with the ecs-alb-service-task I declared in a previous question. ", "keywords": ["instance"]}, {"source": "Body", "text": "I am not sure whether the problem is with a security group, the networking mode, or something else. ", "keywords": ["networking", "billing mode"]}, {"source": "Body", "text": "The AWS documentation on network modes strongly suggests that awsvpc is the preferred mode, but I still don't really understand the implications or how to pick the right one. ", "keywords": ["billing mode"]}, {"source": "Body", "text": "I have also tried using the default mode (bridge since I'm on Amazon Linux) and I get the same error.", "keywords": ["billing mode"]}]}